<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <!-- Access Control -->
    <script src="../../../../components/AccessGuard.js"></script>
    <script>AccessGuard.require('sorted');</script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CLH-003: Pattern Hunting - House of Script</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 100%);
            height: 100vh;
            overflow: hidden;
            color: #00ff41;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 1fr 400px;
            height: 100vh;
            overflow: hidden;
        }

        .main-panel {
            display: flex;
            flex-direction: column;
            border-right: 2px solid #00ff41;
            height: 100vh;
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #0d1117 0%, #161b22 100%);
            padding: 10px 20px;
            border-bottom: 2px solid #00ff41;
            flex-shrink: 0;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .lab-badge {
            background: rgba(0, 255, 65, 0.2);
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.75em;
            color: #00ff41;
            border: 1px solid #00ff41;
            white-space: nowrap;
            font-family: 'Cascadia Code', monospace;
        }

        .header h1 {
            color: #00ff41;
            font-size: 1.1em;
            margin: 0;
            font-weight: 600;
            text-shadow: 0 0 10px rgba(0, 255, 65, 0.5);
        }

        .back-link {
            color: #00ff41;
            text-decoration: none;
            padding: 6px 12px;
            background: rgba(0, 255, 65, 0.1);
            border: 1px solid #00ff41;
            border-radius: 6px;
            transition: all 0.3s;
            font-size: 0.85em;
        }

        .back-link:hover {
            background: rgba(0, 255, 65, 0.2);
            box-shadow: 0 0 10px rgba(0, 255, 65, 0.3);
        }

        .terminal-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #0a0a0a;
            min-height: 0;
            overflow: hidden;
        }

        .terminal-header {
            background: #0d1117;
            padding: 10px 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            border-bottom: 1px solid #30363d;
            flex-shrink: 0;
        }

        .terminal-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        .dot-red { background: #ff5f56; }
        .dot-yellow { background: #ffbd2e; }
        .dot-green { background: #27ca3f; }

        .terminal-title {
            color: #00ff41;
            font-size: 0.9em;
            margin-left: 10px;
            font-family: 'Cascadia Code', monospace;
        }

        .terminal {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            min-height: 0;
            font-family: 'Cascadia Code', 'Fira Code', 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.6;
        }

        .terminal-line {
            margin-bottom: 5px;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .prompt { color: #00ff41; font-weight: bold; }
        .command { color: #00ff41; }
        .output { color: #8b949e; }
        .error { color: #f85149; }
        .success { color: #3fb950; }
        .highlight { color: #ffa657; }
        .dir { color: #58a6ff; font-weight: bold; }
        .exec { color: #3fb950; }
        .warning { color: #d29922; }
        .match { color: #f85149; font-weight: bold; }

        .input-line {
            display: flex;
            align-items: center;
            padding: 12px 20px;
            background: #0d1117;
            border-top: 1px solid #30363d;
            flex-shrink: 0;
        }

        .input-prompt {
            color: #00ff41;
            font-weight: bold;
            font-family: 'Cascadia Code', 'Courier New', monospace;
            margin-right: 8px;
            white-space: nowrap;
        }

        #commandInput {
            flex: 1;
            background: transparent;
            border: none;
            color: #00ff41;
            font-family: 'Cascadia Code', 'Courier New', monospace;
            font-size: 14px;
            outline: none;
        }

        #commandInput::placeholder {
            color: #484f58;
        }

        .mission-panel {
            background: rgba(13, 17, 23, 0.95);
            border-top: 2px solid #00ff41;
            padding: 20px;
            flex-shrink: 0;
        }

        .mission-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .mission-header h3 {
            color: #00ff41;
            font-size: 1.1em;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .mission-header h3::before {
            content: '>';
            animation: blink 1s infinite;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0; }
        }

        .step-indicators {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .step-dot {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8em;
            font-weight: bold;
            transition: all 0.3s ease;
            border: 2px solid #30363d;
            background: transparent;
            color: #484f58;
        }

        .step-dot.active {
            border-color: #ffa657;
            background: rgba(255, 166, 87, 0.2);
            color: #ffa657;
            transform: scale(1.1);
            box-shadow: 0 0 10px rgba(255, 166, 87, 0.3);
        }

        .step-dot.completed {
            border-color: #3fb950;
            background: #3fb950;
            color: #0d1117;
        }

        .step-connector {
            width: 20px;
            height: 2px;
            background: #30363d;
            transition: background 0.3s;
        }

        .step-connector.completed {
            background: #3fb950;
        }

        .current-mission {
            padding: 15px;
            background: rgba(255, 166, 87, 0.1);
            border-radius: 8px;
            border-left: 3px solid #ffa657;
            animation: missionSlideIn 0.3s ease;
        }

        @keyframes missionSlideIn {
            from { opacity: 0; transform: translateX(-10px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .current-mission h4 {
            color: #ffa657;
            font-size: 1em;
            margin-bottom: 8px;
            font-family: 'Cascadia Code', monospace;
        }

        .current-mission p {
            color: #8b949e;
            font-size: 0.9em;
            line-height: 1.5;
        }

        .current-mission .hint {
            margin-top: 10px;
            padding: 8px 12px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 6px;
            font-family: 'Cascadia Code', monospace;
            color: #00ff41;
            font-size: 0.85em;
            border: 1px solid #30363d;
        }

        .all-complete {
            text-align: center;
            padding: 20px;
            color: #3fb950;
        }

        .all-complete .checkmark {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 0 0 20px rgba(63, 185, 80, 0.5);
        }

        .intel-panel {
            background: rgba(13, 17, 23, 0.95);
            padding: 25px;
            overflow-y: auto;
            height: 100vh;
            border-left: 1px solid #30363d;
        }

        .intel-panel h2 {
            color: #00ff41;
            font-size: 1.3em;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #00ff41;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .intel-panel h2::before {
            content: '[';
            color: #ffa657;
        }

        .intel-panel h2::after {
            content: ']';
            color: #ffa657;
        }

        .intel-section {
            margin-bottom: 25px;
        }

        .intel-section h3 {
            color: #58a6ff;
            font-size: 1.05em;
            margin-bottom: 12px;
        }

        .intel-section p {
            color: #8b949e;
            font-size: 0.9em;
            line-height: 1.7;
            margin-bottom: 10px;
        }

        .code-box {
            background: #0a0a0a;
            border: 1px solid #30363d;
            border-radius: 8px;
            padding: 12px 15px;
            margin: 10px 0;
            font-family: 'Cascadia Code', monospace;
            font-size: 0.85em;
        }

        .code-box .cmd {
            color: #00ff41;
        }

        .code-box .output {
            color: #8b949e;
            margin-top: 5px;
        }

        .code-box .match {
            color: #f85149;
            font-weight: bold;
        }

        .warning-box {
            background: rgba(210, 153, 34, 0.1);
            border-left: 3px solid #d29922;
            padding: 12px 15px;
            margin: 15px 0;
            border-radius: 0 8px 8px 0;
        }

        .warning-box strong {
            color: #d29922;
        }

        .warning-box p {
            color: #c9d1d9;
            margin: 0;
        }

        .tip-box {
            background: rgba(0, 255, 65, 0.1);
            border-left: 3px solid #00ff41;
            padding: 12px 15px;
            margin: 15px 0;
            border-radius: 0 8px 8px 0;
        }

        .tip-box strong {
            color: #00ff41;
        }

        .tip-box p {
            color: #c9d1d9;
            margin: 0;
        }

        .secret-code {
            background: rgba(248, 81, 73, 0.2);
            border: 1px solid #f85149;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            text-align: center;
        }

        .secret-code .label {
            color: #f85149;
            font-size: 0.8em;
            letter-spacing: 0.2em;
            margin-bottom: 8px;
        }

        .secret-code .code {
            color: #00ff41;
            font-family: 'Cascadia Code', monospace;
            font-size: 1.5em;
            text-shadow: 0 0 10px rgba(0, 255, 65, 0.5);
        }

        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-overlay.show {
            display: flex;
        }

        .modal {
            background: linear-gradient(135deg, #0d1117, #161b22);
            border: 2px solid #00ff41;
            border-radius: 16px;
            padding: 40px;
            text-align: center;
            max-width: 450px;
            animation: modalPop 0.3s ease;
            box-shadow: 0 0 40px rgba(0, 255, 65, 0.3);
        }

        @keyframes modalPop {
            from { transform: scale(0.8); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        .modal h2 {
            color: #00ff41;
            font-size: 1.8em;
            margin-bottom: 15px;
            text-shadow: 0 0 20px rgba(0, 255, 65, 0.5);
        }

        .modal p {
            color: #8b949e;
            margin-bottom: 25px;
        }

        .modal .xp-earned {
            color: #ffa657;
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 20px;
        }

        .modal .secret-found {
            background: rgba(0, 255, 65, 0.1);
            border: 1px solid #00ff41;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .modal .secret-found .label {
            color: #8b949e;
            font-size: 0.8em;
            margin-bottom: 5px;
        }

        .modal .secret-found .value {
            color: #00ff41;
            font-family: 'Cascadia Code', monospace;
            font-size: 1.3em;
        }

        .modal-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
        }

        .modal-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s;
            font-family: 'Cascadia Code', monospace;
        }

        .modal-btn.primary {
            background: #00ff41;
            color: #0d1117;
        }

        .modal-btn.primary:hover {
            box-shadow: 0 0 20px rgba(0, 255, 65, 0.5);
        }

        .modal-btn.secondary {
            background: transparent;
            color: #00ff41;
            border: 2px solid #00ff41;
        }

        .modal-btn.secondary:hover {
            background: rgba(0, 255, 65, 0.1);
        }

        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #0d1117; }
        ::-webkit-scrollbar-thumb { background: #30363d; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #00ff41; }

        @media (max-width: 1024px) {
            .container {
                grid-template-columns: 1fr;
            }
            .intel-panel {
                border-top: 2px solid #00ff41;
                border-left: none;
                height: auto;
                max-height: 50vh;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="main-panel">
            <div class="header">
                <div class="header-content">
                    <div class="header-left">
                        <span class="lab-badge">CLH-003</span>
                        <h1>Pattern Hunting</h1>
                    </div>
                    <a href="../../index.html" class="back-link">< Script House</a>
                </div>
            </div>

            <div class="terminal-container">
                <div class="terminal-header">
                    <span class="terminal-dot dot-red"></span>
                    <span class="terminal-dot dot-yellow"></span>
                    <span class="terminal-dot dot-green"></span>
                    <span class="terminal-title" id="terminalTitle">operator@shadow:~</span>
                </div>
                <div class="terminal" id="terminal">
                    <div class="terminal-line output">[SYSTEM] Pattern analysis module loaded</div>
                    <div class="terminal-line output">[INTEL] A file contains a hidden secret code</div>
                    <div class="terminal-line output">[INTEL] The code format is: letters followed by numbers and letters</div>
                    <div class="terminal-line output" style="margin-top: 10px; color: #ffa657;">> Mission: Hunt for the hidden code using pattern matching</div>
                    <div class="terminal-line output">Type <span class="highlight">help</span> to see available commands.</div>
                    <div class="terminal-line"></div>
                </div>
                <div class="input-line">
                    <span class="input-prompt" id="promptDisplay">operator@shadow:~$</span>
                    <input type="text" id="commandInput" autocomplete="off" autofocus placeholder="Enter command...">
                </div>
            </div>

            <div class="mission-panel">
                <div class="mission-header">
                    <h3>CURRENT OBJECTIVE</h3>
                    <div class="step-indicators">
                        <div class="step-dot active" id="step-1">1</div>
                        <div class="step-connector" id="conn-1"></div>
                        <div class="step-dot" id="step-2">2</div>
                        <div class="step-connector" id="conn-2"></div>
                        <div class="step-dot" id="step-3">3</div>
                        <div class="step-connector" id="conn-3"></div>
                        <div class="step-dot" id="step-4">4</div>
                        <div class="step-connector" id="conn-4"></div>
                        <div class="step-dot" id="step-5">5</div>
                    </div>
                </div>
                <div id="currentMissionDisplay">
                    <div class="current-mission">
                        <h4 id="missionTitle">RECON: Survey the Evidence</h4>
                        <p id="missionDescription">Examine the evidence directory. What files are available for analysis?</p>
                        <div class="hint" id="missionHint">$ ls evidence/</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="intel-panel">
            <h2>INTEL BRIEFING</h2>

            <div class="intel-section">
                <h3>The Hunt</h3>
                <p>Intelligence reports indicate a secret code is hidden within a text file. Your mission: locate and extract the code using pattern hunting techniques.</p>
                <p>The code follows a specific format but is buried in noise. You'll need <strong style="color: #00ff41;">grep</strong> to find it.</p>
            </div>

            <div class="intel-section">
                <h3>Command: grep</h3>
                <p><strong>G</strong>lobal <strong>R</strong>egular <strong>E</strong>xpression <strong>P</strong>rint - the pattern hunter's primary weapon.</p>
                <div class="code-box">
                    <div class="cmd">$ grep "pattern" filename</div>
                    <div class="output">Lines containing "pattern" are displayed</div>
                </div>
            </div>

            <div class="intel-section">
                <h3>Useful grep Options</h3>
                <div class="code-box">
                    <div class="cmd">grep -i "pattern" file</div>
                    <div class="output">Case-insensitive search</div>
                </div>
                <div class="code-box">
                    <div class="cmd">grep -n "pattern" file</div>
                    <div class="output">Show line numbers</div>
                </div>
                <div class="code-box">
                    <div class="cmd">grep -c "pattern" file</div>
                    <div class="output">Count matching lines</div>
                </div>
            </div>

            <div class="intel-section">
                <h3>Pattern Clue</h3>
                <p>The secret code contains the word "Code" or "Secret". Use this to narrow your search.</p>
            </div>

            <div class="warning-box">
                <strong>OPSEC NOTE:</strong>
                <p>In real forensics, always document your search patterns. A well-crafted grep command can mean the difference between finding evidence and missing it entirely.</p>
            </div>

            <div class="tip-box">
                <strong>PRO TIP:</strong>
                <p>Combine options: <code style="color: #00ff41;">grep -in "secret" file</code> for case-insensitive search with line numbers.</p>
            </div>
        </div>
    </div>

    <!-- Completion Modal -->
    <div class="modal-overlay" id="completionModal">
        <div class="modal">
            <h2>CODE EXTRACTED</h2>
            <div class="secret-found">
                <div class="label">SECRET CODE RECOVERED</div>
                <div class="value" id="foundCode">42XDFL</div>
            </div>
            <p>Pattern hunting successful.<br>You've extracted the hidden intelligence.</p>
            <div class="xp-earned">+100 XP</div>
            <div class="modal-buttons">
                <button class="modal-btn secondary" onclick="closeModal()">Stay Here</button>
                <button class="modal-btn primary" onclick="goToNextLab()">Next Mission ></button>
            </div>
        </div>
    </div>

    <!-- LinuxTerminal Engine -->
    <script src="../../../../components/LinuxTerminal.js"></script>

    <script>
        // ═══════════════════════════════════════════════════════════
        // MISSION CONFIGURATION
        // ═══════════════════════════════════════════════════════════

        const SECRET_CODE = '42XDFL';
        let codeFound = false;

        const missionData = {
            1: {
                title: 'RECON: Survey the Evidence',
                description: 'Examine the evidence directory. What files are available for analysis?',
                hint: '$ ls evidence/',
                check: (cmd) => cmd.includes('ls') && cmd.includes('evidence')
            },
            2: {
                title: 'INTEL: Examine the Target File',
                description: 'The mystery.txt file is your target. Preview its contents to understand what you\'re dealing with.',
                hint: '$ cat evidence/mystery.txt',
                check: (cmd) => cmd.includes('cat') && cmd.includes('mystery')
            },
            3: {
                title: 'HUNT: Search for "Secret"',
                description: 'Use grep to search for lines containing "Secret" in the mystery file.',
                hint: '$ grep "Secret" evidence/mystery.txt',
                check: (cmd) => cmd.includes('grep') && (cmd.includes('Secret') || cmd.includes('secret'))
            },
            4: {
                title: 'EXTRACT: Find the Code Pattern',
                description: 'The code follows "Secret Code:" - search for this exact pattern.',
                hint: '$ grep "Secret Code" evidence/mystery.txt',
                check: (cmd, terminal, output) => {
                    // Check if output contains the secret code
                    return output && output.includes(SECRET_CODE);
                }
            },
            5: {
                title: 'VERIFY: Confirm with Line Number',
                description: 'Document your finding. Use grep -n to show which line contains the code.',
                hint: '$ grep -n "Secret Code" evidence/mystery.txt',
                check: (cmd) => cmd.includes('grep') && cmd.includes('-n') &&
                               (cmd.includes('Secret') || cmd.includes('Code'))
            }
        };

        const missions = {
            1: { completed: false },
            2: { completed: false },
            3: { completed: false },
            4: { completed: false },
            5: { completed: false }
        };

        let currentMission = 1;
        let lastOutput = '';

        // ═══════════════════════════════════════════════════════════
        // TERMINAL INITIALIZATION
        // ═══════════════════════════════════════════════════════════

        const terminal = new LinuxTerminal({
            container: '#terminal',
            inputElement: '#commandInput',
            user: 'operator',
            hostname: 'shadow',
            startDir: '/home/operator',
            onCommand: (cmdLine, output, cmd, args) => {
                lastOutput = output;
                checkMissionCompletion(cmdLine, output);
                updatePromptDisplay();
            }
        });

        // Mystery file content - lorem ipsum with hidden code
        const mysteryContent = `Lorem ipsum dolor sit amet, consectetur adipiscing elit.
Sed do eiusmod tempor incididunt ut labore et dolore magna aliqua.
Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris.
Nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in
reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla.
Pariatur excepteur sint occaecat cupidatat non proident, sunt in culpa.
Qui officia deserunt mollit anim id est laborum. Curabitur pretium
tincidunt lacus. Nulla gravida orci a odio. Nullam varius, turpis et
commodo pharetra, est eros bibendum elit, nec luctus magna felis.
Sollicitudin mauris. Maecenas fermentum consequat mi. Donec fermentum.
Secret Code: ${SECRET_CODE}
Pellentesque malesuada nulla a mi. Duis sapien sem, aliquet sed,
vestibulum sit amet, malesuada in, hendrerit gravida. Mauris ac felis.
Nulla facilisi. Integer lacinia sollicitudin massa. Cras metus.
Sed aliquet risus a tortor. Integer id quam. Morbi mi. Quisque nisl felis,
venenatis tristique, dignissim in, ultrices sit amet, augue. Proin sodales
libero eget ante. Nulla quam. Aenean laoreet. Vestibulum nisi lectus,
commodo ac, facilisis ac, ultricies eu, pede. Ut orci risus, accumsan
porttitor, cursus quis, aliquet eget, justo.`;

        // Customize filesystem for this mission
        terminal.fs['/home/operator'] = {
            type: 'dir',
            contents: {
                'evidence': { type: 'dir', contents: {
                    'mystery.txt': { type: 'file', content: mysteryContent },
                    'notes.txt': { type: 'file', content: 'Case #2847\nSuspect communications intercepted.\nEvidence stored in mystery.txt\nAnalyst notes: Look for patterns.\n' },
                    'README.txt': { type: 'file', content: 'EVIDENCE DIRECTORY\n==================\nFiles in this directory are part of ongoing investigation.\nUse grep to search for patterns.\nDo not modify original evidence.\n' }
                }},
                'tools': { type: 'dir', contents: {
                    'search.sh': { type: 'file', content: '#!/bin/bash\n# Quick search script\ngrep -rn "$1" ./evidence/\n', permissions: 'rwxr-xr-x' }
                }},
                '.bash_history': { type: 'file', content: 'ls\ncd evidence\ncat mystery.txt\n', hidden: true }
            }
        };

        function updatePromptDisplay() {
            const cwd = terminal.getCwd();
            const displayPath = cwd === '/home/operator' ? '~' :
                               cwd.replace('/home/operator', '~');
            document.getElementById('promptDisplay').textContent =
                `operator@shadow:${displayPath}$`;
            document.getElementById('terminalTitle').textContent =
                `operator@shadow:${displayPath}`;
        }

        // ═══════════════════════════════════════════════════════════
        // MISSION MANAGEMENT
        // ═══════════════════════════════════════════════════════════

        function checkMissionCompletion(cmdLine, output) {
            const mission = missionData[currentMission];
            if (!mission || missions[currentMission].completed) return;

            let passed = false;
            if (typeof mission.check === 'function') {
                passed = mission.check(cmdLine, terminal, output);
            }

            // Track if code was found
            if (output && output.includes(SECRET_CODE)) {
                codeFound = true;
            }

            if (passed) {
                completeMission(currentMission);
            }
        }

        function completeMission(missionNum) {
            missions[missionNum].completed = true;

            const stepDot = document.getElementById(`step-${missionNum}`);
            stepDot.classList.remove('active');
            stepDot.classList.add('completed');
            stepDot.innerHTML = '✓';

            if (missionNum < 5) {
                document.getElementById(`conn-${missionNum}`).classList.add('completed');
            }

            terminal.print(`[SUCCESS] Objective ${missionNum} complete`, 'success');

            if (missionNum < 5) {
                currentMission = missionNum + 1;
                document.getElementById(`step-${currentMission}`).classList.add('active');
                showNextMission(currentMission);
            } else {
                showAllComplete();
            }
        }

        function showNextMission(missionNum) {
            const mission = missionData[missionNum];
            document.getElementById('currentMissionDisplay').innerHTML = `
                <div class="current-mission">
                    <h4 id="missionTitle">${mission.title}</h4>
                    <p id="missionDescription">${mission.description}</p>
                    <div class="hint" id="missionHint">${mission.hint}</div>
                </div>
            `;
        }

        function showAllComplete() {
            document.getElementById('currentMissionDisplay').innerHTML = `
                <div class="all-complete">
                    <div class="checkmark">✓</div>
                    <h4>CODE EXTRACTED</h4>
                    <p>Secret Code: <span style="color: #00ff41; font-family: monospace;">${SECRET_CODE}</span></p>
                </div>
            `;

            setTimeout(() => {
                document.getElementById('completionModal').classList.add('show');
                saveProgress();
            }, 800);
        }

        function saveProgress() {
            const progress = JSON.parse(localStorage.getItem('hexworth_progress') || '{}');
            if (!progress.script) progress.script = {};
            progress.script['clh-003'] = {
                completed: true,
                completedAt: new Date().toISOString(),
                xpEarned: 100,
                secretFound: SECRET_CODE
            };
            localStorage.setItem('hexworth_progress', JSON.stringify(progress));

            // Update title progression
            const clhProgress = JSON.parse(localStorage.getItem('clh_progress') || '{}');
            clhProgress.completedLabs = (clhProgress.completedLabs || 0) + 1;
            clhProgress.codesFound = (clhProgress.codesFound || []);
            clhProgress.codesFound.push(SECRET_CODE);
            if (clhProgress.completedLabs >= 5) {
                clhProgress.title = 'CLI Specialist';
            }
            localStorage.setItem('clh_progress', JSON.stringify(clhProgress));
        }

        function closeModal() {
            document.getElementById('completionModal').classList.remove('show');
        }

        function goToNextLab() {
            window.location.href = 'clh-004-process-investigation.html';
        }
    </script>

    <!-- Flux Capacitor - House Navigation -->
    <script src="../../../../components/FluxCapacitor.js"></script>
</body>
</html>
