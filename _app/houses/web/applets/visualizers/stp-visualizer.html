<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <!-- Access Control -->
    <script src="../../../../components/AccessGuard.js"></script>
    <script>
        AccessGuard.require('sorted');
    </script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>STP Visualizer - Interactive Learning Tool</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh;
            color: #e0e0e0;
        }

        /* Header */
        .header {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .header h1 {
            font-size: 1.5em;
            color: #fff;
        }

        .header h1 span {
            color: #10b981;
        }

        .back-btn {
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
            border: 1px solid #10b981;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            text-decoration: none;
            font-size: 0.9em;
            transition: all 0.3s;
        }

        .back-btn:hover {
            background: #10b981;
            color: #fff;
        }

        /* Tabs */
        .tab-container {
            display: flex;
            background: rgba(0, 0, 0, 0.2);
            padding: 0 20px;
            overflow-x: auto;
        }

        .tab {
            padding: 15px 25px;
            cursor: pointer;
            color: #888;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
            font-weight: 500;
            white-space: nowrap;
        }

        .tab:hover {
            color: #bbb;
            background: rgba(255, 255, 255, 0.05);
        }

        .tab.active {
            color: #10b981;
            border-bottom-color: #10b981;
            background: rgba(16, 185, 129, 0.1);
        }

        /* Main Content */
        .main-content {
            padding: 20px;
            height: calc(100vh - 120px);
            overflow-y: auto;
        }

        .tab-content {
            display: none;
            height: 100%;
        }

        .tab-content.active {
            display: block;
        }

        /* ==================== TAB 1: What is STP? ==================== */
        .info-tab {
            max-width: 1000px;
            margin: 0 auto;
        }

        .info-section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            border-left: 4px solid #10b981;
        }

        .info-section h2 {
            color: #fff;
            margin-bottom: 15px;
            font-size: 1.4em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .info-section p {
            line-height: 1.8;
            color: #c0c0c0;
            font-size: 1.1em;
        }

        .info-section .highlight {
            color: #10b981;
            font-weight: 600;
        }

        .info-section .danger {
            color: #f44336;
            font-weight: 600;
        }

        .info-section .analogy {
            background: rgba(16, 185, 129, 0.15);
            padding: 15px 20px;
            border-radius: 8px;
            margin: 15px 0;
            font-style: italic;
            border-left: 3px solid #10b981;
        }

        /* The Problem Box */
        .problem-box {
            background: linear-gradient(135deg, rgba(244, 67, 54, 0.2), rgba(183, 28, 28, 0.2));
            border-radius: 12px;
            padding: 25px;
            margin: 25px 0;
            border: 2px solid rgba(244, 67, 54, 0.5);
        }

        .problem-box h3 {
            color: #f44336;
            font-size: 1.3em;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Solution Box */
        .solution-box {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.2), rgba(5, 150, 105, 0.2));
            border-radius: 12px;
            padding: 25px;
            margin: 25px 0;
            border: 2px solid rgba(16, 185, 129, 0.5);
        }

        .solution-box h3 {
            color: #10b981;
            font-size: 1.3em;
            margin-bottom: 15px;
        }

        /* Storm Animation */
        .storm-demo {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
        }

        .storm-demo svg {
            max-width: 100%;
            height: auto;
        }

        .storm-btn {
            background: #f44336;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1em;
            margin-top: 15px;
            transition: all 0.3s;
        }

        .storm-btn:hover {
            background: #d32f2f;
            transform: scale(1.05);
        }

        .storm-btn.running {
            background: #ff9800;
        }

        /* Port State Table */
        .state-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }

        .state-table th,
        .state-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .state-table th {
            background: rgba(16, 185, 129, 0.2);
            color: #fff;
            font-weight: 600;
        }

        .state-table tr:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .state-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.85em;
            font-weight: 600;
        }

        .state-blocking { background: #f44336; color: white; }
        .state-listening { background: #ff9800; color: white; }
        .state-learning { background: #ffc107; color: #333; }
        .state-forwarding { background: #10b981; color: white; }
        .state-disabled { background: #555; color: white; }

        /* Expandable Sections */
        .expandable {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            margin: 10px 0;
            overflow: hidden;
        }

        .expandable-header {
            padding: 15px 20px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.3s;
        }

        .expandable-header:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .expandable-header h4 {
            color: #10b981;
            font-size: 1em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .expandable-header .arrow {
            color: #10b981;
            transition: transform 0.3s;
        }

        .expandable.open .expandable-header .arrow {
            transform: rotate(180deg);
        }

        .expandable-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
            background: rgba(0, 0, 0, 0.2);
        }

        .expandable.open .expandable-content {
            max-height: 600px;
        }

        .expandable-content-inner {
            padding: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .expandable-content code {
            background: rgba(0, 0, 0, 0.4);
            padding: 2px 8px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            color: #4fc3f7;
        }

        .expandable-content pre {
            background: rgba(0, 0, 0, 0.4);
            padding: 15px;
            border-radius: 6px;
            overflow-x: auto;
            margin: 10px 0;
            font-family: 'Courier New', monospace;
            color: #4fc3f7;
        }

        /* ==================== TAB 2-4: Visualizer ==================== */
        .visualizer-container {
            display: flex;
            height: 100%;
            gap: 20px;
        }

        .topology-panel {
            flex: 1;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 12px;
            position: relative;
            overflow: hidden;
        }

        .topology-canvas {
            width: 100%;
            height: 100%;
        }

        .info-panel {
            width: 350px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 12px;
            padding: 20px;
            overflow-y: auto;
        }

        .info-panel h3 {
            color: #fff;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Legend */
        .legend {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .legend h4 {
            color: #fff;
            margin-bottom: 10px;
            font-size: 0.9em;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 8px 0;
            font-size: 0.85em;
            color: #bbb;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
        }

        .legend-line {
            width: 30px;
            height: 4px;
            border-radius: 2px;
        }

        /* Instructions */
        .instructions {
            background: rgba(255, 193, 7, 0.1);
            border: 1px solid rgba(255, 193, 7, 0.3);
            padding: 12px 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 0.85em;
            color: #ffc107;
        }

        /* Election Display */
        .election-display {
            background: rgba(0, 0, 0, 0.2);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .election-display h4 {
            color: #fff;
            margin-bottom: 10px;
        }

        .candidate-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .candidate-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 8px;
            border-left: 3px solid #888;
            transition: all 0.3s;
        }

        .candidate-item.root {
            border-left-color: #10b981;
            background: rgba(16, 185, 129, 0.15);
        }

        .candidate-item .switch-name {
            font-weight: bold;
            color: #fff;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .candidate-item .switch-name .crown {
            color: #ffc107;
        }

        .candidate-item .bridge-id {
            font-size: 0.85em;
            color: #888;
            margin-top: 5px;
            font-family: monospace;
        }

        .candidate-item .priority {
            color: #10b981;
        }

        .candidate-item .mac {
            color: #64b5f6;
        }

        /* Port Info */
        .port-info {
            margin-top: 15px;
        }

        .port-item {
            background: rgba(0, 0, 0, 0.2);
            padding: 10px 12px;
            border-radius: 6px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .port-item .port-name {
            font-weight: 600;
            color: #fff;
        }

        .port-item .port-role {
            font-size: 0.8em;
            padding: 3px 8px;
            border-radius: 10px;
        }

        .role-root { background: #10b981; color: white; }
        .role-designated { background: #2196f3; color: white; }
        .role-blocked { background: #f44336; color: white; }
        .role-alternate { background: #ff9800; color: white; }

        /* Selection Info */
        .selection-info {
            background: rgba(16, 185, 129, 0.15);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .selection-info p {
            margin: 5px 0;
            font-size: 0.9em;
        }

        .selection-info .label {
            color: #888;
        }

        .selection-info .value {
            color: #fff;
            font-weight: 600;
        }

        /* Controls */
        .controls {
            background: rgba(0, 0, 0, 0.2);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .controls h4 {
            color: #fff;
            margin-bottom: 10px;
            font-size: 0.95em;
        }

        .control-btn {
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
            border: 1px solid #10b981;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85em;
            margin: 5px 5px 5px 0;
            transition: all 0.3s;
        }

        .control-btn:hover {
            background: #10b981;
            color: #fff;
        }

        .control-btn.danger {
            border-color: #f44336;
            color: #f44336;
        }

        .control-btn.danger:hover {
            background: #f44336;
            color: #fff;
        }

        /* Priority Slider */
        .priority-control {
            margin: 15px 0;
        }

        .priority-control label {
            display: block;
            color: #bbb;
            margin-bottom: 8px;
            font-size: 0.9em;
        }

        .priority-control select {
            width: 100%;
            padding: 8px;
            border-radius: 6px;
            border: 1px solid #444;
            background: #2a2a3e;
            color: #fff;
            font-size: 0.9em;
        }

        /* No selection message */
        .no-selection {
            text-align: center;
            padding: 30px;
            color: #888;
        }

        .no-selection .icon {
            font-size: 3em;
            margin-bottom: 15px;
        }

        /* Failed link indicator */
        .failed-links {
            margin-top: 10px;
        }

        .failed-link-item {
            background: rgba(244, 67, 54, 0.2);
            padding: 8px 12px;
            border-radius: 4px;
            margin: 5px 0;
            font-size: 0.85em;
            color: #f44336;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .restore-btn {
            background: transparent;
            border: 1px solid #f44336;
            color: #f44336;
            padding: 2px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8em;
        }

        .restore-btn:hover {
            background: #f44336;
            color: #fff;
        }

        /* Convergence Timer */
        .convergence-timer {
            background: rgba(255, 152, 0, 0.2);
            border: 1px solid #ff9800;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            text-align: center;
        }

        .convergence-timer.complete {
            background: rgba(16, 185, 129, 0.2);
            border-color: #10b981;
        }

        .convergence-timer h4 {
            color: #ff9800;
            margin-bottom: 8px;
        }

        .convergence-timer.complete h4 {
            color: #10b981;
        }

        .convergence-timer .time {
            font-size: 2em;
            font-weight: bold;
            color: #fff;
        }

        /* Tree visualization */
        .tree-info {
            background: rgba(16, 185, 129, 0.1);
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }

        .tree-info h4 {
            color: #10b981;
            margin-bottom: 10px;
        }

        .tree-path {
            font-family: monospace;
            color: #c0c0c0;
            line-height: 1.8;
        }

        /* Switch node styling */
        .switch-node {
            cursor: pointer;
            transition: all 0.2s;
        }

        .switch-node:hover rect {
            filter: brightness(1.2);
        }

        .switch-node.selected rect {
            stroke: #ffc107;
            stroke-width: 3;
        }

        .switch-node.root rect {
            stroke: #10b981;
            stroke-width: 4;
        }

        /* Link styling */
        .link-line {
            transition: all 0.3s;
        }

        .link-line.forwarding {
            stroke: #10b981;
        }

        .link-line.blocked {
            stroke: #f44336;
            stroke-dasharray: 8,4;
            opacity: 0.6;
        }

        .link-line.failed {
            stroke: #555;
            stroke-dasharray: 4,4;
            opacity: 0.3;
        }

        /* BPDU Animation */
        @keyframes bpduPulse {
            0% { r: 4; opacity: 1; }
            100% { r: 12; opacity: 0; }
        }

        .bpdu-packet {
            fill: #ffc107;
        }

        /* Broadcast storm animation */
        @keyframes stormPacket {
            0% { offset-distance: 0%; opacity: 1; }
            100% { offset-distance: 100%; opacity: 1; }
        }

        .storm-packet {
            fill: #f44336;
            offset-rotate: 0deg;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1><span>STP</span> Visualizer - Spanning Tree Protocol</h1>
        <a href="../../../../index.html" class="back-btn">‚Üê Back to House</a>
    </div>

    <div class="tab-container">
        <div class="tab active" data-tab="info">What is STP?</div>
        <div class="tab" data-tab="election">Root Bridge Election</div>
        <div class="tab" data-tab="ports">Port Roles Explorer</div>
        <div class="tab" data-tab="what-if">What-If Simulator</div>
    </div>

    <div class="main-content">
        <!-- ==================== TAB 1: What is STP? ==================== -->
        <div class="tab-content active" id="tab-info">
            <div class="info-tab">
                <div class="info-section">
                    <h2>üå≥ The Big Picture</h2>
                    <p>Spanning Tree Protocol (STP) is the <span class="highlight">traffic cop for your switches</span>. Its job? <strong>Prevent loops</strong> that could crash your entire network in seconds.</p>
                    <p>Here's the thing: network engineers <em>want</em> redundant connections (backups!), but without STP, those backups become a disaster waiting to happen.</p>
                </div>

                <div class="problem-box">
                    <h3>üí• The Problem: Broadcast Storms</h3>
                    <p>Imagine you have three switches connected in a triangle (for redundancy). A computer sends out a broadcast message asking "Who has IP 192.168.1.1?"</p>
                    <p><strong>Without STP, here's what happens:</strong></p>
                    <ul style="margin: 15px 0 15px 25px; line-height: 2; color: #ffcdd2;">
                        <li>Switch 1 sends the broadcast to Switch 2 AND Switch 3</li>
                        <li>Switch 2 forwards it to Switch 3, Switch 3 forwards it to Switch 2</li>
                        <li>Both switches send it back to Switch 1</li>
                        <li><strong>The broadcast loops forever, multiplying each time!</strong></li>
                        <li>Within seconds: 100% CPU, network crash, angry users üò±</li>
                    </ul>
                    <div class="storm-demo">
                        <svg id="storm-demo-svg" viewBox="0 0 400 250"></svg>
                        <br>
                        <button class="storm-btn" id="storm-btn">üå™Ô∏è Show Broadcast Storm</button>
                    </div>
                </div>

                <div class="solution-box">
                    <h3>‚úÖ The Solution: STP Creates a Tree</h3>
                    <p>STP looks at your mesh of switches and <span class="highlight">logically blocks certain ports</span> to create a loop-free "tree" structure.</p>
                    <div class="analogy">
                        "Think of it like a family tree. Everyone is still connected, but there's only ONE path from any person to any other person - no circles allowed!"
                    </div>
                    <p>The blocked ports aren't wasted - they're <strong>standing by as backups</strong>. If an active link fails, STP automatically unblocks a backup port. Your network heals itself!</p>
                </div>

                <div class="info-section">
                    <h2>üéØ Three Simple Rules</h2>
                    <p>STP follows three rules, always in this order:</p>
                    <ol style="margin: 15px 0 15px 25px; line-height: 2.2;">
                        <li><strong>Elect a Root Bridge</strong> - One switch becomes the "center" of the tree (the trunk)</li>
                        <li><strong>Find the Best Path</strong> - Every other switch picks its best port toward the Root</li>
                        <li><strong>Block the Rest</strong> - Any extra paths get blocked to prevent loops</li>
                    </ol>
                </div>

                <div class="info-section">
                    <h2>‚è±Ô∏è Why Does STP Take 30-50 Seconds?</h2>
                    <p>When a link changes, ports go through several states before forwarding traffic:</p>
                    <table class="state-table">
                        <thead>
                            <tr>
                                <th>State</th>
                                <th>Duration</th>
                                <th>What's Happening</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><span class="state-badge state-blocking">Blocking</span></td>
                                <td>20 sec (Max Age)</td>
                                <td>Listening for BPDUs, not forwarding anything</td>
                            </tr>
                            <tr>
                                <td><span class="state-badge state-listening">Listening</span></td>
                                <td>15 sec</td>
                                <td>Participating in election, still not forwarding</td>
                            </tr>
                            <tr>
                                <td><span class="state-badge state-learning">Learning</span></td>
                                <td>15 sec</td>
                                <td>Building MAC table, almost ready...</td>
                            </tr>
                            <tr>
                                <td><span class="state-badge state-forwarding">Forwarding</span></td>
                                <td>‚àû</td>
                                <td>üéâ Traffic flows!</td>
                            </tr>
                        </tbody>
                    </table>
                    <p style="margin-top: 15px; color: #ffc107;">‚ö†Ô∏è This is why RSTP (Rapid STP) was invented - it converges in 1-2 seconds instead of 30-50!</p>
                </div>

                <div class="info-section">
                    <h2>üîç Want More Detail?</h2>

                    <div class="expandable">
                        <div class="expandable-header">
                            <h4>üì° What are BPDUs?</h4>
                            <span class="arrow">‚ñº</span>
                        </div>
                        <div class="expandable-content">
                            <div class="expandable-content-inner">
                                <p><strong>BPDU = Bridge Protocol Data Unit</strong></p>
                                <p>These are special messages switches send to each other every 2 seconds. They contain:</p>
                                <ul style="margin: 10px 0 10px 20px; line-height: 1.8;">
                                    <li><strong>Root Bridge ID:</strong> "Who I think is the Root"</li>
                                    <li><strong>Path Cost:</strong> "How far I am from the Root"</li>
                                    <li><strong>Sender Bridge ID:</strong> "Who I am"</li>
                                    <li><strong>Port ID:</strong> "Which port sent this"</li>
                                </ul>
                                <p style="margin-top: 10px;">Switches compare BPDUs to determine the best paths and who should be Root.</p>
                            </div>
                        </div>
                    </div>

                    <div class="expandable">
                        <div class="expandable-header">
                            <h4>üè∑Ô∏è What's a Bridge ID?</h4>
                            <span class="arrow">‚ñº</span>
                        </div>
                        <div class="expandable-content">
                            <div class="expandable-content-inner">
                                <p>Every switch has a unique identifier:</p>
                                <pre>Bridge ID = Priority (2 bytes) + MAC Address (6 bytes)</pre>
                                <p style="margin-top: 15px;"><strong>Priority:</strong></p>
                                <ul style="margin: 10px 0 10px 20px; line-height: 1.8;">
                                    <li>Default: <strong>32768</strong></li>
                                    <li>Range: 0 to 61440</li>
                                    <li>Must be a multiple of 4096</li>
                                    <li>Lower = more likely to become Root</li>
                                </ul>
                                <p style="margin-top: 10px;"><strong>MAC Address:</strong> Tiebreaker if priorities are equal. Lower MAC wins.</p>
                            </div>
                        </div>
                    </div>

                    <div class="expandable">
                        <div class="expandable-header">
                            <h4>‚öôÔ∏è How do I configure STP?</h4>
                            <span class="arrow">‚ñº</span>
                        </div>
                        <div class="expandable-content">
                            <div class="expandable-content-inner">
                                <p><strong>Make a switch the Root Bridge:</strong></p>
                                <pre>Switch(config)# spanning-tree vlan 1 root primary</pre>
                                <p style="margin-top: 10px;">Or set priority manually:</p>
                                <pre>Switch(config)# spanning-tree vlan 1 priority 4096</pre>

                                <p style="margin-top: 15px;"><strong>View STP status:</strong></p>
                                <pre>Switch# show spanning-tree
Switch# show spanning-tree vlan 1</pre>

                                <p style="margin-top: 15px;"><strong>Enable PortFast (for end devices only!):</strong></p>
                                <pre>Switch(config-if)# spanning-tree portfast</pre>
                                <p style="font-size: 0.9em; color: #ffc107;">‚ö†Ô∏è Never use PortFast on switch-to-switch links!</p>
                            </div>
                        </div>
                    </div>

                    <div class="expandable">
                        <div class="expandable-header">
                            <h4>üìä STP Port Cost Values</h4>
                            <span class="arrow">‚ñº</span>
                        </div>
                        <div class="expandable-content">
                            <div class="expandable-content-inner">
                                <p>STP uses cost to determine the "best" path. Lower cost = faster link:</p>
                                <table class="state-table">
                                    <thead>
                                        <tr>
                                            <th>Link Speed</th>
                                            <th>Original Cost</th>
                                            <th>Revised Cost</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr><td>10 Gbps</td><td>1</td><td>2</td></tr>
                                        <tr><td>1 Gbps</td><td>1</td><td>4</td></tr>
                                        <tr><td>100 Mbps</td><td>19</td><td>19</td></tr>
                                        <tr><td>10 Mbps</td><td>100</td><td>100</td></tr>
                                    </tbody>
                                </table>
                                <p style="margin-top: 10px; font-size: 0.9em; color: #888;">Modern switches use the "revised" costs to better distinguish between fast links.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div style="text-align: center; margin-top: 30px;">
                    <p style="color: #888;">Ready to see the election in action? Try the interactive tabs above! ‚Üí</p>
                </div>
            </div>
        </div>

        <!-- ==================== TAB 2: Root Bridge Election ==================== -->
        <div class="tab-content" id="tab-election">
            <div class="visualizer-container">
                <div class="topology-panel">
                    <svg class="topology-canvas" id="canvas-election"></svg>
                </div>
                <div class="info-panel">
                    <div class="instructions">
                        üí° Click any switch to change its priority and watch the election happen in real-time!
                    </div>

                    <div class="legend">
                        <h4>Switch States</h4>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #10b981; border: 2px solid #ffc107;"></div>
                            <span>Root Bridge (üëë Crown)</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #2196f3;"></div>
                            <span>Non-Root Switch</span>
                        </div>
                    </div>

                    <div class="election-display">
                        <h4>üó≥Ô∏è Election Results</h4>
                        <div class="candidate-list" id="candidate-list">
                            <!-- Populated by JS -->
                        </div>
                    </div>

                    <div class="controls">
                        <h4>Change Priority</h4>
                        <div id="priority-controls">
                            <p style="color: #888; font-size: 0.9em;">Select a switch to change its priority</p>
                        </div>
                    </div>

                    <div class="expandable" style="margin-top: 15px;">
                        <div class="expandable-header">
                            <h4>üìñ Election Rules</h4>
                            <span class="arrow">‚ñº</span>
                        </div>
                        <div class="expandable-content">
                            <div class="expandable-content-inner">
                                <ol style="line-height: 2;">
                                    <li><strong>Lowest Priority wins</strong></li>
                                    <li>If tied: <strong>Lowest MAC wins</strong></li>
                                </ol>
                                <p style="margin-top: 10px;">Default priority: <code>32768</code></p>
                                <p>Valid values: 0, 4096, 8192, 12288, 16384, 20480, 24576, 28672, 32768...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ==================== TAB 3: Port Roles Explorer ==================== -->
        <div class="tab-content" id="tab-ports">
            <div class="visualizer-container">
                <div class="topology-panel">
                    <svg class="topology-canvas" id="canvas-ports"></svg>
                </div>
                <div class="info-panel">
                    <div class="instructions">
                        üí° Click any switch to see its port roles and the path to the Root Bridge
                    </div>

                    <div class="legend">
                        <h4>Port Roles</h4>
                        <div class="legend-item">
                            <span class="port-role role-root">Root Port</span>
                            <span>Best path TO Root</span>
                        </div>
                        <div class="legend-item">
                            <span class="port-role role-designated">Designated</span>
                            <span>Best path FROM Root</span>
                        </div>
                        <div class="legend-item">
                            <span class="port-role role-blocked">Blocked</span>
                            <span>Backup (prevents loop)</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-line" style="background: #10b981;"></div>
                            <span>Forwarding Link</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-line" style="background: #f44336; border-top: 3px dashed #f44336; height: 0;"></div>
                            <span>Blocked Link</span>
                        </div>
                    </div>

                    <div id="ports-info">
                        <div class="no-selection">
                            <div class="icon">üîå</div>
                            <p>Click a switch to view<br>its port roles and costs</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ==================== TAB 4: What-If Simulator ==================== -->
        <div class="tab-content" id="tab-what-if">
            <div class="visualizer-container">
                <div class="topology-panel">
                    <svg class="topology-canvas" id="canvas-what-if"></svg>
                </div>
                <div class="info-panel">
                    <div class="instructions">
                        üí° Click any <strong>link</strong> to fail it and watch STP reconverge!
                    </div>

                    <div class="controls">
                        <h4>Simulation Controls</h4>
                        <button class="control-btn" id="btn-reset-stp">üîÑ Reset All Links</button>
                        <button class="control-btn" id="btn-fail-root-link">üí• Fail Root Link</button>
                    </div>

                    <div class="legend">
                        <h4>Link States</h4>
                        <div class="legend-item">
                            <div class="legend-line" style="background: #10b981;"></div>
                            <span>Forwarding</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-line" style="background: #f44336; border-top: 3px dashed #f44336; height: 0;"></div>
                            <span>Blocked (Backup)</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-line" style="background: #555;"></div>
                            <span>Failed</span>
                        </div>
                    </div>

                    <div id="whatif-info">
                        <div class="no-selection">
                            <div class="icon">üîß</div>
                            <p>Fail links to see how STP<br>activates backup paths</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==================== NETWORK TOPOLOGY DATA ====================
        // 8 switches in a realistic enterprise topology
        const switches = [
            { id: 'SW1', x: 400, y: 60, priority: 4096, mac: '0000.0C11.1111', label: 'Core-1' },
            { id: 'SW2', x: 600, y: 60, priority: 8192, mac: '0000.0C22.2222', label: 'Core-2' },
            { id: 'SW3', x: 200, y: 180, priority: 32768, mac: '0000.0C33.3333', label: 'Dist-1' },
            { id: 'SW4', x: 400, y: 180, priority: 32768, mac: '0000.0C44.4444', label: 'Dist-2' },
            { id: 'SW5', x: 600, y: 180, priority: 32768, mac: '0000.0C55.5555', label: 'Dist-3' },
            { id: 'SW6', x: 800, y: 180, priority: 32768, mac: '0000.0C66.6666', label: 'Dist-4' },
            { id: 'SW7', x: 300, y: 320, priority: 32768, mac: '0000.0C77.7777', label: 'Access-1' },
            { id: 'SW8', x: 700, y: 320, priority: 32768, mac: '0000.0C88.8888', label: 'Access-2' }
        ];

        // Links between switches with costs
        const links = [
            // Core interconnect
            { from: 'SW1', to: 'SW2', cost: 4 },
            // Core to Distribution
            { from: 'SW1', to: 'SW3', cost: 4 },
            { from: 'SW1', to: 'SW4', cost: 4 },
            { from: 'SW2', to: 'SW5', cost: 4 },
            { from: 'SW2', to: 'SW6', cost: 4 },
            // Distribution cross-connects (redundancy)
            { from: 'SW3', to: 'SW4', cost: 4 },
            { from: 'SW4', to: 'SW5', cost: 4 },
            { from: 'SW5', to: 'SW6', cost: 4 },
            // Distribution to Access
            { from: 'SW3', to: 'SW7', cost: 19 },
            { from: 'SW4', to: 'SW7', cost: 19 },
            { from: 'SW5', to: 'SW8', cost: 19 },
            { from: 'SW6', to: 'SW8', cost: 19 },
            // Extra redundant link (creates loop scenario)
            { from: 'SW7', to: 'SW8', cost: 100 }
        ];

        // State management
        let state = {
            activeTab: 'info',
            rootBridge: null,
            selectedSwitch: null,
            failedLinks: new Set(),
            portRoles: {},
            stormRunning: false
        };

        // ==================== TAB SWITCHING ====================
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                const tabId = tab.dataset.tab;

                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');

                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                document.getElementById(`tab-${tabId}`).classList.add('active');

                state.activeTab = tabId;

                if (tabId !== 'info') {
                    calculateSTP();
                    initializeCanvas(tabId);
                }
            });
        });

        // ==================== EXPANDABLE SECTIONS ====================
        document.querySelectorAll('.expandable-header').forEach(header => {
            header.addEventListener('click', () => {
                header.parentElement.classList.toggle('open');
            });
        });

        // ==================== STP CALCULATION ====================
        function calculateSTP() {
            // Find Root Bridge (lowest Bridge ID)
            let root = switches[0];
            switches.forEach(sw => {
                if (sw.priority < root.priority ||
                    (sw.priority === root.priority && sw.mac < root.mac)) {
                    root = sw;
                }
            });
            state.rootBridge = root.id;

            // Calculate port roles for each switch
            state.portRoles = {};

            switches.forEach(sw => {
                state.portRoles[sw.id] = {};

                if (sw.id === state.rootBridge) {
                    // Root Bridge: all ports are Designated
                    links.forEach(link => {
                        if (link.from === sw.id || link.to === sw.id) {
                            const portId = link.from === sw.id ? link.to : link.from;
                            state.portRoles[sw.id][portId] = 'designated';
                        }
                    });
                }
            });

            // For non-root switches, find Root Port (lowest cost to root)
            switches.forEach(sw => {
                if (sw.id === state.rootBridge) return;

                let bestPort = null;
                let bestCost = Infinity;

                // Find direct and indirect paths to root
                links.forEach(link => {
                    const linkId = `${link.from}-${link.to}`;
                    const linkIdReverse = `${link.to}-${link.from}`;
                    if (state.failedLinks.has(linkId) || state.failedLinks.has(linkIdReverse)) return;

                    let neighbor = null;
                    if (link.from === sw.id) neighbor = link.to;
                    else if (link.to === sw.id) neighbor = link.from;

                    if (neighbor) {
                        const pathCost = calculatePathCost(neighbor, state.rootBridge, new Set([sw.id]));
                        const totalCost = link.cost + pathCost;

                        if (totalCost < bestCost) {
                            bestCost = totalCost;
                            bestPort = neighbor;
                        }
                    }
                });

                if (bestPort) {
                    state.portRoles[sw.id][bestPort] = 'root';
                }
            });

            // Determine Designated and Blocked ports for each segment
            links.forEach(link => {
                const linkId = `${link.from}-${link.to}`;
                const linkIdReverse = `${link.to}-${link.from}`;
                if (state.failedLinks.has(linkId) || state.failedLinks.has(linkIdReverse)) return;

                const sw1 = switches.find(s => s.id === link.from);
                const sw2 = switches.find(s => s.id === link.to);

                // If one side is root port, other side is designated
                if (state.portRoles[sw1.id][sw2.id] === 'root') {
                    if (!state.portRoles[sw2.id][sw1.id]) {
                        state.portRoles[sw2.id][sw1.id] = 'designated';
                    }
                } else if (state.portRoles[sw2.id][sw1.id] === 'root') {
                    if (!state.portRoles[sw1.id][sw2.id]) {
                        state.portRoles[sw1.id][sw2.id] = 'designated';
                    }
                } else {
                    // Neither is root port - determine designated vs blocked
                    const cost1 = calculatePathCost(sw1.id, state.rootBridge, new Set());
                    const cost2 = calculatePathCost(sw2.id, state.rootBridge, new Set());

                    if (cost1 < cost2 || (cost1 === cost2 && sw1.mac < sw2.mac)) {
                        state.portRoles[sw1.id][sw2.id] = state.portRoles[sw1.id][sw2.id] || 'designated';
                        state.portRoles[sw2.id][sw1.id] = state.portRoles[sw2.id][sw1.id] || 'blocked';
                    } else {
                        state.portRoles[sw2.id][sw1.id] = state.portRoles[sw2.id][sw1.id] || 'designated';
                        state.portRoles[sw1.id][sw2.id] = state.portRoles[sw1.id][sw2.id] || 'blocked';
                    }
                }
            });
        }

        function calculatePathCost(fromId, toId, visited) {
            if (fromId === toId) return 0;
            if (visited.has(fromId)) return Infinity;

            visited.add(fromId);
            let minCost = Infinity;

            links.forEach(link => {
                const linkId = `${link.from}-${link.to}`;
                const linkIdReverse = `${link.to}-${link.from}`;
                if (state.failedLinks.has(linkId) || state.failedLinks.has(linkIdReverse)) return;

                let neighbor = null;
                if (link.from === fromId) neighbor = link.to;
                else if (link.to === fromId) neighbor = link.from;

                if (neighbor && !visited.has(neighbor)) {
                    const pathCost = link.cost + calculatePathCost(neighbor, toId, new Set(visited));
                    minCost = Math.min(minCost, pathCost);
                }
            });

            return minCost;
        }

        // ==================== CANVAS RENDERING ====================
        function initializeCanvas(tabId) {
            const canvasMap = {
                'election': 'canvas-election',
                'ports': 'canvas-ports',
                'what-if': 'canvas-what-if'
            };

            const canvas = document.getElementById(canvasMap[tabId]);
            if (!canvas) return;

            renderTopology(canvas, tabId);

            if (tabId === 'election') {
                updateElectionDisplay();
            }
        }

        function renderTopology(canvas, mode) {
            const width = canvas.clientWidth || 900;
            const height = canvas.clientHeight || 450;

            canvas.innerHTML = '';
            canvas.setAttribute('viewBox', `0 0 ${width} ${height}`);

            // Scale positions
            const scaleX = (width - 100) / 900;
            const scaleY = (height - 80) / 400;
            const scale = Math.min(scaleX, scaleY, 1);
            const offsetX = (width - 900 * scale) / 2;
            const offsetY = 40;

            // Draw links first
            const linksGroup = document.createElementNS('http://www.w3.org/2000/svg', 'g');

            links.forEach(link => {
                const sw1 = switches.find(s => s.id === link.from);
                const sw2 = switches.find(s => s.id === link.to);

                const x1 = sw1.x * scale + offsetX;
                const y1 = sw1.y * scale + offsetY;
                const x2 = sw2.x * scale + offsetX;
                const y2 = sw2.y * scale + offsetY;

                const linkId = `${link.from}-${link.to}`;
                const isFailed = state.failedLinks.has(linkId);

                // Determine link state based on port roles
                let linkClass = 'forwarding';
                if (isFailed) {
                    linkClass = 'failed';
                } else if (mode === 'ports' || mode === 'what-if') {
                    const role1 = state.portRoles[sw1.id]?.[sw2.id];
                    const role2 = state.portRoles[sw2.id]?.[sw1.id];
                    if (role1 === 'blocked' || role2 === 'blocked') {
                        linkClass = 'blocked';
                    }
                }

                const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                line.setAttribute('x1', x1);
                line.setAttribute('y1', y1);
                line.setAttribute('x2', x2);
                line.setAttribute('y2', y2);
                line.setAttribute('stroke-width', 4 * scale);
                line.setAttribute('class', `link-line ${linkClass}`);
                line.setAttribute('data-link-id', linkId);

                if (linkClass === 'forwarding') {
                    line.setAttribute('stroke', '#10b981');
                } else if (linkClass === 'blocked') {
                    line.setAttribute('stroke', '#f44336');
                    line.setAttribute('stroke-dasharray', '8,4');
                    line.setAttribute('opacity', '0.6');
                } else if (linkClass === 'failed') {
                    line.setAttribute('stroke', '#555');
                    line.setAttribute('stroke-dasharray', '4,4');
                    line.setAttribute('opacity', '0.3');
                }

                // Click handler for what-if mode
                if (mode === 'what-if') {
                    line.style.cursor = 'pointer';
                    line.addEventListener('click', () => toggleLinkFailure(linkId, mode));
                    line.addEventListener('mouseenter', () => {
                        if (!isFailed) line.setAttribute('stroke-width', 6 * scale);
                    });
                    line.addEventListener('mouseleave', () => {
                        line.setAttribute('stroke-width', 4 * scale);
                    });
                }

                linksGroup.appendChild(line);

                // Add cost label
                const midX = (x1 + x2) / 2;
                const midY = (y1 + y2) / 2;

                const costBg = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                costBg.setAttribute('x', midX - 12);
                costBg.setAttribute('y', midY - 8);
                costBg.setAttribute('width', 24);
                costBg.setAttribute('height', 16);
                costBg.setAttribute('fill', 'rgba(0,0,0,0.7)');
                costBg.setAttribute('rx', 3);
                if (isFailed) costBg.setAttribute('opacity', '0.3');
                linksGroup.appendChild(costBg);

                const costLabel = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                costLabel.setAttribute('x', midX);
                costLabel.setAttribute('y', midY + 4);
                costLabel.setAttribute('text-anchor', 'middle');
                costLabel.setAttribute('fill', isFailed ? '#555' : '#fff');
                costLabel.setAttribute('font-size', '11');
                costLabel.setAttribute('font-weight', 'bold');
                costLabel.textContent = link.cost;
                linksGroup.appendChild(costLabel);
            });

            canvas.appendChild(linksGroup);

            // Draw switches
            const switchesGroup = document.createElementNS('http://www.w3.org/2000/svg', 'g');

            switches.forEach(sw => {
                const x = sw.x * scale + offsetX;
                const y = sw.y * scale + offsetY;
                const isRoot = sw.id === state.rootBridge;
                const isSelected = sw.id === state.selectedSwitch;

                const group = document.createElementNS('http://www.w3.org/2000/svg', 'g');
                group.setAttribute('class', `switch-node ${isRoot ? 'root' : ''} ${isSelected ? 'selected' : ''}`);
                group.setAttribute('data-switch-id', sw.id);
                group.style.cursor = 'pointer';

                // Switch rectangle
                const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                rect.setAttribute('x', x - 35);
                rect.setAttribute('y', y - 20);
                rect.setAttribute('width', 70);
                rect.setAttribute('height', 40);
                rect.setAttribute('rx', 6);
                rect.setAttribute('fill', isRoot ? '#10b981' : '#2196f3');
                rect.setAttribute('stroke', isRoot ? '#ffc107' : '#fff');
                rect.setAttribute('stroke-width', isRoot ? 4 : 2);
                group.appendChild(rect);

                // Crown for root
                if (isRoot) {
                    const crown = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                    crown.setAttribute('x', x);
                    crown.setAttribute('y', y - 28);
                    crown.setAttribute('text-anchor', 'middle');
                    crown.setAttribute('font-size', '18');
                    crown.textContent = 'üëë';
                    group.appendChild(crown);
                }

                // Switch label
                const label = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                label.setAttribute('x', x);
                label.setAttribute('y', y - 2);
                label.setAttribute('text-anchor', 'middle');
                label.setAttribute('fill', '#fff');
                label.setAttribute('font-size', '12');
                label.setAttribute('font-weight', 'bold');
                label.textContent = sw.id;
                group.appendChild(label);

                // Priority label
                const priority = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                priority.setAttribute('x', x);
                priority.setAttribute('y', y + 12);
                priority.setAttribute('text-anchor', 'middle');
                priority.setAttribute('fill', 'rgba(255,255,255,0.8)');
                priority.setAttribute('font-size', '10');
                priority.textContent = `Pri: ${sw.priority}`;
                group.appendChild(priority);

                // Click handler
                group.addEventListener('click', () => handleSwitchClick(sw.id, mode));

                switchesGroup.appendChild(group);
            });

            canvas.appendChild(switchesGroup);
        }

        // ==================== INTERACTION HANDLERS ====================
        function handleSwitchClick(switchId, mode) {
            state.selectedSwitch = switchId;

            if (mode === 'election') {
                showPriorityControls(switchId);
                initializeCanvas('election');
            } else if (mode === 'ports') {
                showPortsInfo(switchId);
                initializeCanvas('ports');
            } else if (mode === 'what-if') {
                showWhatIfInfo(switchId);
                initializeCanvas('what-if');
            }
        }

        function toggleLinkFailure(linkId, mode) {
            if (state.failedLinks.has(linkId)) {
                state.failedLinks.delete(linkId);
            } else {
                state.failedLinks.add(linkId);
            }

            calculateSTP();
            initializeCanvas(mode);
            updateWhatIfDisplay();
        }

        // ==================== ELECTION TAB ====================
        function updateElectionDisplay() {
            const container = document.getElementById('candidate-list');

            // Sort switches by Bridge ID
            const sorted = [...switches].sort((a, b) => {
                if (a.priority !== b.priority) return a.priority - b.priority;
                return a.mac.localeCompare(b.mac);
            });

            let html = '';
            sorted.forEach((sw, index) => {
                const isRoot = sw.id === state.rootBridge;
                html += `
                    <div class="candidate-item ${isRoot ? 'root' : ''}">
                        <div class="switch-name">
                            ${isRoot ? '<span class="crown">üëë</span>' : `#${index + 1}`}
                            ${sw.id} (${sw.label})
                        </div>
                        <div class="bridge-id">
                            <span class="priority">${sw.priority}</span> +
                            <span class="mac">${sw.mac}</span>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function showPriorityControls(switchId) {
            const container = document.getElementById('priority-controls');
            const sw = switches.find(s => s.id === switchId);

            const priorities = [0, 4096, 8192, 12288, 16384, 20480, 24576, 28672, 32768, 36864, 40960, 45056, 49152];

            let options = priorities.map(p =>
                `<option value="${p}" ${p === sw.priority ? 'selected' : ''}>${p}${p === 32768 ? ' (default)' : ''}</option>`
            ).join('');

            container.innerHTML = `
                <div class="priority-control">
                    <label>Priority for ${sw.id} (${sw.label}):</label>
                    <select id="priority-select" onchange="changePriority('${switchId}', this.value)">
                        ${options}
                    </select>
                </div>
            `;
        }

        function changePriority(switchId, newPriority) {
            const sw = switches.find(s => s.id === switchId);
            sw.priority = parseInt(newPriority);

            calculateSTP();
            initializeCanvas('election');
            updateElectionDisplay();
        }

        // ==================== PORTS TAB ====================
        function showPortsInfo(switchId) {
            const container = document.getElementById('ports-info');
            const sw = switches.find(s => s.id === switchId);
            const isRoot = switchId === state.rootBridge;

            let html = `
                <div class="selection-info">
                    <p><span class="label">Selected:</span> <span class="value">${sw.id} (${sw.label})</span></p>
                    <p><span class="label">Role:</span> <span class="value">${isRoot ? 'üëë Root Bridge' : 'Non-Root Switch'}</span></p>
                    <p><span class="label">Priority:</span> <span class="value">${sw.priority}</span></p>
                </div>
            `;

            if (!isRoot) {
                const pathCost = calculatePathCost(switchId, state.rootBridge, new Set());
                html += `
                    <div class="tree-info">
                        <h4>üìç Path to Root</h4>
                        <p>Total Cost: <strong>${pathCost}</strong></p>
                        <div class="tree-path">${getPathToRoot(switchId)}</div>
                    </div>
                `;
            }

            html += `<h3 style="margin-top: 15px;">Port Roles</h3><div class="port-info">`;

            const ports = state.portRoles[switchId] || {};
            Object.entries(ports).forEach(([neighbor, role]) => {
                const link = links.find(l =>
                    (l.from === switchId && l.to === neighbor) ||
                    (l.to === switchId && l.from === neighbor)
                );
                const cost = link ? link.cost : '?';

                html += `
                    <div class="port-item">
                        <span class="port-name">‚Üí ${neighbor} (cost ${cost})</span>
                        <span class="port-role role-${role}">${role.charAt(0).toUpperCase() + role.slice(1)}</span>
                    </div>
                `;
            });

            html += '</div>';
            container.innerHTML = html;
        }

        function getPathToRoot(fromId) {
            if (fromId === state.rootBridge) return fromId;

            const ports = state.portRoles[fromId] || {};
            for (const [neighbor, role] of Object.entries(ports)) {
                if (role === 'root') {
                    return `${fromId} ‚Üí ${getPathToRoot(neighbor)}`;
                }
            }
            return fromId + ' ‚Üí ?';
        }

        // ==================== WHAT-IF TAB ====================
        function showWhatIfInfo(switchId) {
            const container = document.getElementById('whatif-info');
            const sw = switches.find(s => s.id === switchId);
            const isRoot = switchId === state.rootBridge;

            let html = `
                <div class="selection-info">
                    <p><span class="label">Selected:</span> <span class="value">${sw.id}</span></p>
                    <p><span class="label">Role:</span> <span class="value">${isRoot ? 'üëë Root Bridge' : 'Non-Root'}</span></p>
                </div>
            `;

            if (state.failedLinks.size > 0) {
                html += `<div class="failed-links"><h4 style="color: #f44336; margin-bottom: 10px;">Failed Links (${state.failedLinks.size}):</h4>`;
                state.failedLinks.forEach(linkId => {
                    html += `
                        <div class="failed-link-item">
                            <span>${linkId.replace('-', ' ‚Üî ')}</span>
                            <button class="restore-btn" onclick="restoreLink('${linkId}')">Restore</button>
                        </div>
                    `;
                });
                html += '</div>';
            }

            // Show current port states
            html += `<h3 style="margin-top: 15px;">Current Port States</h3><div class="port-info">`;
            const ports = state.portRoles[switchId] || {};
            Object.entries(ports).forEach(([neighbor, role]) => {
                html += `
                    <div class="port-item">
                        <span class="port-name">‚Üí ${neighbor}</span>
                        <span class="port-role role-${role}">${role.charAt(0).toUpperCase() + role.slice(1)}</span>
                    </div>
                `;
            });
            html += '</div>';

            container.innerHTML = html;
        }

        function updateWhatIfDisplay() {
            if (state.selectedSwitch) {
                showWhatIfInfo(state.selectedSwitch);
            }
        }

        function restoreLink(linkId) {
            state.failedLinks.delete(linkId);
            calculateSTP();
            initializeCanvas('what-if');
            updateWhatIfDisplay();
        }

        // ==================== STORM DEMO ====================
        function initStormDemo() {
            const svg = document.getElementById('storm-demo-svg');
            svg.innerHTML = `
                <rect x="50" y="50" width="60" height="40" rx="5" fill="#2196f3" stroke="#fff" stroke-width="2"/>
                <text x="80" y="75" text-anchor="middle" fill="#fff" font-size="12" font-weight="bold">SW1</text>

                <rect x="170" y="150" width="60" height="40" rx="5" fill="#2196f3" stroke="#fff" stroke-width="2"/>
                <text x="200" y="175" text-anchor="middle" fill="#fff" font-size="12" font-weight="bold">SW2</text>

                <rect x="290" y="50" width="60" height="40" rx="5" fill="#2196f3" stroke="#fff" stroke-width="2"/>
                <text x="320" y="75" text-anchor="middle" fill="#fff" font-size="12" font-weight="bold">SW3</text>

                <line x1="110" y1="70" x2="170" y2="150" stroke="#10b981" stroke-width="3" id="link1"/>
                <line x1="230" y1="150" x2="290" y2="70" stroke="#10b981" stroke-width="3" id="link2"/>
                <line x1="110" y1="70" x2="290" y2="70" stroke="#10b981" stroke-width="3" id="link3"/>

                <circle cx="50" cy="120" r="15" fill="#ffc107"/>
                <text x="50" y="124" text-anchor="middle" fill="#333" font-size="10" font-weight="bold">PC</text>
                <line x1="50" y1="105" x2="50" y2="90" stroke="#ffc107" stroke-width="2"/>
                <line x1="50" y1="90" x2="80" y2="70" stroke="#ffc107" stroke-width="2"/>
            `;
        }

        let stormInterval = null;
        document.getElementById('storm-btn').addEventListener('click', function() {
            const btn = this;
            const svg = document.getElementById('storm-demo-svg');

            if (state.stormRunning) {
                state.stormRunning = false;
                btn.textContent = 'üå™Ô∏è Show Broadcast Storm';
                btn.classList.remove('running');
                clearInterval(stormInterval);
                initStormDemo();
                return;
            }

            state.stormRunning = true;
            btn.textContent = '‚èπÔ∏è Stop Storm';
            btn.classList.add('running');

            let packetCount = 0;
            stormInterval = setInterval(() => {
                if (!state.stormRunning) return;

                packetCount++;
                const packet = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                packet.setAttribute('r', '6');
                packet.setAttribute('fill', '#f44336');
                packet.setAttribute('opacity', '0.8');

                // Random path
                const paths = [
                    { x1: 80, y1: 70, x2: 200, y2: 170 },
                    { x1: 200, y1: 170, x2: 320, y2: 70 },
                    { x1: 320, y1: 70, x2: 80, y2: 70 },
                    { x1: 200, y1: 170, x2: 80, y2: 70 },
                    { x1: 320, y1: 70, x2: 200, y2: 170 },
                    { x1: 80, y1: 70, x2: 320, y2: 70 }
                ];
                const path = paths[packetCount % paths.length];

                packet.setAttribute('cx', path.x1);
                packet.setAttribute('cy', path.y1);
                svg.appendChild(packet);

                // Animate
                let progress = 0;
                const animate = setInterval(() => {
                    progress += 0.05;
                    if (progress >= 1) {
                        clearInterval(animate);
                        packet.remove();
                        return;
                    }
                    packet.setAttribute('cx', path.x1 + (path.x2 - path.x1) * progress);
                    packet.setAttribute('cy', path.y1 + (path.y2 - path.y1) * progress);
                }, 30);

            }, 100);
        });

        // ==================== CONTROL BUTTONS ====================
        document.getElementById('btn-reset-stp').addEventListener('click', () => {
            state.failedLinks.clear();
            calculateSTP();
            initializeCanvas('what-if');
            document.getElementById('whatif-info').innerHTML = `
                <div class="no-selection">
                    <div class="icon">üîß</div>
                    <p>Fail links to see how STP<br>activates backup paths</p>
                </div>
            `;
        });

        document.getElementById('btn-fail-root-link').addEventListener('click', () => {
            // Find a link connected to root
            const rootLink = links.find(l => l.from === state.rootBridge || l.to === state.rootBridge);
            if (rootLink) {
                const linkId = `${rootLink.from}-${rootLink.to}`;
                if (!state.failedLinks.has(linkId)) {
                    state.failedLinks.add(linkId);
                    calculateSTP();
                    initializeCanvas('what-if');
                    updateWhatIfDisplay();
                }
            }
        });

        // Make functions globally available
        window.changePriority = changePriority;
        window.restoreLink = restoreLink;

        // Initialize
        initStormDemo();
        calculateSTP();
    </script>
<script src="../../../../components/FluxCapacitor.js"></script>
</body>
</html>
