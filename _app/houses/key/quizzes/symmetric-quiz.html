<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <!-- Access Control -->
    <script src="../../../components/AccessGuard.js"></script>
    <script>
        AccessGuard.require('sorted');
    </script>
    <!-- Achievement & Progress Integration -->
    <script src="../../../components/AchievementManager.js"></script>
    <script src="../../../components/ModuleProgress.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Symmetric Encryption Quiz - House of the Key</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --house-color: #f59e0b;
            --house-glow: rgba(245, 158, 11, 0.4);
            --bg-dark: #0a0a12;
            --bg-card: rgba(15, 15, 25, 0.8);
            --text-primary: #e8e8f0;
            --text-secondary: #8888aa;
            --success-green: #10b981;
            --warning-red: #ef4444;
            --info-blue: #3b82f6;
        }

        body {
            min-height: 100vh;
            background: var(--bg-dark);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: var(--text-primary);
            overflow-x: hidden;
        }

        /* Header */
        .module-header {
            padding: 20px 30px;
            background: rgba(10, 10, 18, 0.95);
            border-bottom: 1px solid rgba(245, 158, 11, 0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .back-btn {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            border: 1px solid rgba(245, 158, 11, 0.3);
            background: transparent;
            color: var(--house-color);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .back-btn:hover {
            background: rgba(245, 158, 11, 0.1);
        }

        .module-title {
            font-size: 1rem;
            font-weight: 500;
            color: var(--text-primary);
        }

        .house-badge {
            font-size: 0.7rem;
            padding: 4px 12px;
            background: rgba(245, 158, 11, 0.15);
            border: 1px solid rgba(245, 158, 11, 0.3);
            border-radius: 20px;
            color: var(--house-color);
            letter-spacing: 0.1em;
        }

        /* Container */
        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 40px 30px;
        }

        /* Intro */
        .intro {
            text-align: center;
            margin-bottom: 40px;
        }

        .intro-icon {
            font-size: 3rem;
            margin-bottom: 15px;
        }

        .intro-title {
            font-size: 2rem;
            font-weight: 300;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #fff, var(--house-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .intro-subtitle {
            color: var(--text-secondary);
            margin-bottom: 20px;
        }

        .quiz-info {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-top: 20px;
        }

        .quiz-stat {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--house-color);
        }

        .stat-label {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        /* Question Card */
        .question-card {
            background: var(--bg-card);
            border: 1px solid rgba(245, 158, 11, 0.2);
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 25px;
        }

        .question-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .question-number {
            font-size: 0.85rem;
            color: var(--house-color);
            font-weight: 600;
            letter-spacing: 0.05em;
        }

        .question-points {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .question-text {
            font-size: 1.1rem;
            color: var(--text-primary);
            line-height: 1.6;
            margin-bottom: 20px;
        }

        /* Answer Options */
        .answer-options {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .answer-option {
            background: rgba(0, 0, 0, 0.3);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 15px 20px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .answer-option:hover {
            border-color: rgba(245, 158, 11, 0.5);
            background: rgba(245, 158, 11, 0.05);
        }

        .answer-option input[type="radio"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
            accent-color: var(--house-color);
        }

        .answer-option label {
            flex: 1;
            cursor: pointer;
            color: var(--text-secondary);
            line-height: 1.5;
        }

        .answer-option.selected {
            border-color: var(--house-color);
            background: rgba(245, 158, 11, 0.1);
        }

        .answer-option.correct {
            border-color: var(--success-green);
            background: rgba(16, 185, 129, 0.1);
        }

        .answer-option.incorrect {
            border-color: var(--warning-red);
            background: rgba(239, 68, 68, 0.1);
        }

        /* Explanation */
        .explanation {
            background: rgba(59, 130, 246, 0.1);
            border-left: 4px solid var(--info-blue);
            border-radius: 8px;
            padding: 15px 20px;
            margin-top: 15px;
            display: none;
        }

        .explanation.visible {
            display: block;
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .explanation-title {
            color: var(--info-blue);
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }

        .explanation-text {
            color: var(--text-secondary);
            font-size: 0.85rem;
            line-height: 1.6;
        }

        /* Action Buttons */
        .quiz-actions {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 30px 0;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--house-color), #ea580c);
            color: #fff;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(245, 158, 11, 0.4);
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        /* Results Section */
        .results-section {
            background: var(--bg-card);
            border: 1px solid rgba(245, 158, 11, 0.2);
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            display: none;
        }

        .results-section.visible {
            display: block;
            animation: slideDown 0.5s ease;
        }

        .results-icon {
            font-size: 4rem;
            margin-bottom: 20px;
        }

        .results-title {
            font-size: 1.8rem;
            color: var(--text-primary);
            margin-bottom: 15px;
        }

        .results-score {
            font-size: 3rem;
            font-weight: 700;
            margin: 20px 0;
        }

        .results-score.pass {
            color: var(--success-green);
        }

        .results-score.fail {
            color: var(--warning-red);
        }

        .results-feedback {
            color: var(--text-secondary);
            line-height: 1.8;
            margin-bottom: 30px;
        }

        .results-breakdown {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin: 30px 0;
        }

        .breakdown-stat {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            padding: 20px;
        }

        .breakdown-value {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .breakdown-label {
            font-size: 0.8rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        /* Progress Indicator */
        .progress-indicator {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin: 30px 0;
        }

        .progress-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
        }

        .progress-dot.answered {
            background: var(--house-color);
        }

        .progress-dot.current {
            transform: scale(1.3);
            background: var(--house-color);
            box-shadow: 0 0 10px rgba(245, 158, 11, 0.5);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .quiz-info {
                flex-direction: column;
                gap: 15px;
            }

            .results-breakdown {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="module-header">
        <div class="header-left">
            <button class="back-btn" onclick="window.location.href='../index.html'">‚Üê</button>
            <h1 class="module-title">Advanced Symmetric Encryption Quiz</h1>
        </div>
        <div class="house-badge">HOUSE OF THE KEY</div>
    </header>

    <!-- Main Content -->
    <main class="container">
        <!-- Intro Section -->
        <div id="intro-section" class="intro">
            <div class="intro-icon">üìù</div>
            <h2 class="intro-title">Test Your Knowledge</h2>
            <p class="intro-subtitle">
                Answer 10 questions about AES, block cipher modes, and symmetric encryption best practices.
                You need 70% or higher to pass.
            </p>
            <div class="quiz-info">
                <div class="quiz-stat">
                    <div class="stat-value">10</div>
                    <div class="stat-label">QUESTIONS</div>
                </div>
                <div class="quiz-stat">
                    <div class="stat-value">70%</div>
                    <div class="stat-label">PASSING SCORE</div>
                </div>
                <div class="quiz-stat">
                    <div class="stat-value">~10min</div>
                    <div class="stat-label">DURATION</div>
                </div>
            </div>
            <div class="quiz-actions" style="margin-top: 30px;">
                <button class="btn btn-primary" onclick="startQuiz()">Start Quiz</button>
            </div>
        </div>

        <!-- Progress Indicator -->
        <div id="progress-indicator" class="progress-indicator" style="display: none;"></div>

        <!-- Quiz Questions -->
        <div id="quiz-container" style="display: none;">
            <!-- Questions will be inserted here dynamically -->
        </div>

        <!-- Quiz Actions -->
        <div id="quiz-actions" class="quiz-actions" style="display: none;">
            <button class="btn btn-secondary" onclick="previousQuestion()" id="prev-btn">‚Üê Previous</button>
            <button class="btn btn-primary" onclick="nextQuestion()" id="next-btn">Next ‚Üí</button>
            <button class="btn btn-primary" onclick="submitQuiz()" id="submit-btn" style="display: none;">Submit Quiz</button>
        </div>

        <!-- Results Section -->
        <div id="results-section" class="results-section">
            <div class="results-icon" id="results-icon">üéâ</div>
            <h2 class="results-title" id="results-title">Quiz Complete!</h2>
            <div class="results-score" id="results-score">85%</div>
            <p class="results-feedback" id="results-feedback"></p>

            <div class="results-breakdown">
                <div class="breakdown-stat">
                    <div class="breakdown-value" style="color: var(--success-green);" id="correct-count">8</div>
                    <div class="breakdown-label">Correct</div>
                </div>
                <div class="breakdown-stat">
                    <div class="breakdown-value" style="color: var(--warning-red);" id="incorrect-count">2</div>
                    <div class="breakdown-label">Incorrect</div>
                </div>
                <div class="breakdown-stat">
                    <div class="breakdown-value" style="color: var(--house-color);" id="total-questions">10</div>
                    <div class="breakdown-label">Total</div>
                </div>
            </div>

            <div class="quiz-actions">
                <button class="btn btn-secondary" onclick="reviewAnswers()">Review Answers</button>
                <button class="btn btn-primary" onclick="returnToDashboard()">Return to Dashboard</button>
            </div>
        </div>
    </main>

    <script>
        // Quiz Questions
        const questions = [
            {
                question: "How many rounds does AES-256 use during encryption?",
                options: [
                    "10 rounds",
                    "12 rounds",
                    "14 rounds",
                    "16 rounds"
                ],
                correct: 2,
                explanation: "AES-256 uses 14 rounds. AES-128 uses 10 rounds, and AES-192 uses 12 rounds. The number of rounds increases with key size for enhanced security."
            },
            {
                question: "What is the primary security weakness of ECB (Electronic Codebook) mode?",
                options: [
                    "It's too slow for practical use",
                    "Identical plaintext blocks produce identical ciphertext blocks",
                    "It requires too much memory",
                    "It can't encrypt data larger than 128 bits"
                ],
                correct: 1,
                explanation: "ECB's fatal flaw is that identical plaintext blocks produce identical ciphertext blocks, revealing patterns in the data. This is why you should NEVER use ECB mode for structured data."
            },
            {
                question: "What does GCM mode provide that CBC mode does not?",
                options: [
                    "Faster encryption speed",
                    "Smaller ciphertext size",
                    "Built-in authentication and integrity verification",
                    "Support for larger block sizes"
                ],
                correct: 2,
                explanation: "GCM (Galois/Counter Mode) provides Authenticated Encryption with Associated Data (AEAD). It combines CTR mode encryption with GMAC authentication, providing both confidentiality and integrity/authenticity. CBC only provides confidentiality."
            },
            {
                question: "Why must the IV (Initialization Vector) be unique for each message in CBC mode?",
                options: [
                    "To increase encryption speed",
                    "To prevent the same plaintext from producing the same ciphertext",
                    "To reduce memory usage",
                    "To make the key longer"
                ],
                correct: 1,
                explanation: "A unique IV ensures semantic security - the same plaintext encrypted twice produces different ciphertext. Without a unique IV, an attacker can detect when identical messages are sent, breaking confidentiality guarantees."
            },
            {
                question: "In CTR (Counter) mode, what happens to turn a block cipher into a stream cipher?",
                options: [
                    "The plaintext is XORed with the encrypted counter values",
                    "The plaintext is divided into smaller blocks",
                    "The key is used multiple times",
                    "Padding is applied to each block"
                ],
                correct: 0,
                explanation: "CTR mode encrypts sequential counter values (nonce + counter) to generate a keystream, which is then XORed with the plaintext. This effectively turns the block cipher into a stream cipher, allowing encryption of any length data without padding."
            },
            {
                question: "What is the recommended nonce size for AES-GCM mode?",
                options: [
                    "64 bits (8 bytes)",
                    "96 bits (12 bytes)",
                    "128 bits (16 bytes)",
                    "256 bits (32 bytes)"
                ],
                correct: 1,
                explanation: "The recommended nonce size for GCM is 96 bits (12 bytes). While other sizes are possible, 96-bit nonces are processed more efficiently and are the standard recommendation in cryptographic protocols like TLS 1.3."
            },
            {
                question: "What is the purpose of PKCS#7 padding in block cipher encryption?",
                options: [
                    "To compress the plaintext before encryption",
                    "To ensure plaintext is a multiple of the block size",
                    "To add randomness to the encryption process",
                    "To authenticate the ciphertext"
                ],
                correct: 1,
                explanation: "PKCS#7 padding adds bytes to the plaintext to make it a multiple of the block size (16 bytes for AES). The padding value indicates how many bytes were added, allowing proper removal during decryption. Note: CTR and GCM modes don't require padding."
            },
            {
                question: "Which AES operation is responsible for 'confusion' in the encryption process?",
                options: [
                    "ShiftRows",
                    "MixColumns",
                    "SubBytes (S-box substitution)",
                    "AddRoundKey"
                ],
                correct: 2,
                explanation: "SubBytes (S-box substitution) provides confusion by making the relationship between the key and ciphertext complex and non-linear. ShiftRows and MixColumns provide diffusion (spreading plaintext influence across ciphertext)."
            },
            {
                question: "What is a 'padding oracle attack' and which mode is most vulnerable?",
                options: [
                    "An attack on ECB mode exploiting repeated blocks",
                    "An attack on CBC mode exploiting padding validation errors",
                    "An attack on CTR mode exploiting nonce reuse",
                    "An attack on GCM mode exploiting authentication tags"
                ],
                correct: 1,
                explanation: "A padding oracle attack exploits applications that reveal whether padding is valid during CBC decryption. By observing errors or timing differences, attackers can decrypt ciphertext without the key. Defense: use authenticated encryption (GCM) or constant-time padding validation."
            },
            {
                question: "Why should you use a Key Derivation Function (KDF) like PBKDF2 when deriving keys from passwords?",
                options: [
                    "To make the password longer",
                    "To convert variable-length passwords into fixed-length keys and slow down brute-force attacks",
                    "To encrypt the password before use",
                    "To store the password securely"
                ],
                correct: 1,
                explanation: "KDFs like PBKDF2 serve two purposes: (1) convert variable-length, low-entropy passwords into fixed-length, high-entropy keys suitable for AES, and (2) use many iterations to slow down brute-force attacks. Salt prevents rainbow table attacks."
            }
        ];

        // Quiz State
        let currentQuestion = 0;
        let userAnswers = new Array(questions.length).fill(null);
        let quizSubmitted = false;

        // Start Quiz
        function startQuiz() {
            document.getElementById('intro-section').style.display = 'none';
            document.getElementById('quiz-container').style.display = 'block';
            document.getElementById('quiz-actions').style.display = 'flex';
            document.getElementById('progress-indicator').style.display = 'flex';

            renderProgressIndicator();
            renderQuestion();
        }

        // Render Progress Indicator
        function renderProgressIndicator() {
            const indicator = document.getElementById('progress-indicator');
            indicator.innerHTML = '';

            for (let i = 0; i < questions.length; i++) {
                const dot = document.createElement('div');
                dot.className = 'progress-dot';
                if (userAnswers[i] !== null) dot.classList.add('answered');
                if (i === currentQuestion) dot.classList.add('current');
                indicator.appendChild(dot);
            }
        }

        // Render Question
        function renderQuestion() {
            const container = document.getElementById('quiz-container');
            const q = questions[currentQuestion];

            container.innerHTML = `
                <div class="question-card">
                    <div class="question-header">
                        <div class="question-number">QUESTION ${currentQuestion + 1} OF ${questions.length}</div>
                        <div class="question-points">1 POINT</div>
                    </div>
                    <div class="question-text">${q.question}</div>
                    <div class="answer-options" id="answer-options">
                        ${q.options.map((option, index) => `
                            <div class="answer-option ${userAnswers[currentQuestion] === index ? 'selected' : ''}" onclick="selectAnswer(${index})">
                                <input type="radio" name="answer" value="${index}" ${userAnswers[currentQuestion] === index ? 'checked' : ''}>
                                <label>${option}</label>
                            </div>
                        `).join('')}
                    </div>
                    <div class="explanation" id="explanation-${currentQuestion}">
                        <div class="explanation-title">üí° Explanation</div>
                        <div class="explanation-text">${q.explanation}</div>
                    </div>
                </div>
            `;

            updateNavigationButtons();
            renderProgressIndicator();

            // Show explanation if already submitted
            if (quizSubmitted) {
                showExplanation();
            }
        }

        // Select Answer
        function selectAnswer(index) {
            if (quizSubmitted) return; // Don't allow changes after submission

            userAnswers[currentQuestion] = index;

            // Update UI
            const options = document.querySelectorAll('.answer-option');
            options.forEach((opt, i) => {
                opt.classList.toggle('selected', i === index);
                const radio = opt.querySelector('input[type="radio"]');
                radio.checked = (i === index);
            });

            renderProgressIndicator();
        }

        // Update Navigation Buttons
        function updateNavigationButtons() {
            const prevBtn = document.getElementById('prev-btn');
            const nextBtn = document.getElementById('next-btn');
            const submitBtn = document.getElementById('submit-btn');

            prevBtn.style.display = currentQuestion === 0 ? 'none' : 'inline-block';

            if (currentQuestion === questions.length - 1) {
                nextBtn.style.display = 'none';
                submitBtn.style.display = 'inline-block';
            } else {
                nextBtn.style.display = 'inline-block';
                submitBtn.style.display = 'none';
            }
        }

        // Previous Question
        function previousQuestion() {
            if (currentQuestion > 0) {
                currentQuestion--;
                renderQuestion();
            }
        }

        // Next Question
        function nextQuestion() {
            if (currentQuestion < questions.length - 1) {
                currentQuestion++;
                renderQuestion();
            }
        }

        // Submit Quiz
        function submitQuiz() {
            // Check if all questions are answered
            const unanswered = userAnswers.filter(a => a === null).length;
            if (unanswered > 0) {
                if (!confirm(`You have ${unanswered} unanswered question(s). Submit anyway?`)) {
                    return;
                }
            }

            quizSubmitted = true;

            // Calculate score
            let correct = 0;
            userAnswers.forEach((answer, index) => {
                if (answer === questions[index].correct) {
                    correct++;
                }
            });

            const percentage = Math.round((correct / questions.length) * 100);
            const passed = percentage >= 70;

            // Show results
            document.getElementById('quiz-container').style.display = 'none';
            document.getElementById('quiz-actions').style.display = 'none';
            document.getElementById('progress-indicator').style.display = 'none';

            const resultsSection = document.getElementById('results-section');
            const resultsIcon = document.getElementById('results-icon');
            const resultsTitle = document.getElementById('results-title');
            const resultsScore = document.getElementById('results-score');
            const resultsFeedback = document.getElementById('results-feedback');

            if (passed) {
                resultsIcon.textContent = 'üéâ';
                resultsTitle.textContent = 'Congratulations! You Passed!';
                resultsScore.textContent = `${percentage}%`;
                resultsScore.className = 'results-score pass';
                resultsFeedback.innerHTML = `
                    You correctly answered <strong>${correct}</strong> out of <strong>${questions.length}</strong> questions.<br>
                    You've demonstrated strong understanding of advanced symmetric encryption concepts!
                `;
            } else {
                resultsIcon.textContent = 'üìö';
                resultsTitle.textContent = 'Keep Studying!';
                resultsScore.textContent = `${percentage}%`;
                resultsScore.className = 'results-score fail';
                resultsFeedback.innerHTML = `
                    You answered <strong>${correct}</strong> out of <strong>${questions.length}</strong> questions correctly.<br>
                    Review the presentation and lab materials, then try again!
                `;
            }

            document.getElementById('correct-count').textContent = correct;
            document.getElementById('incorrect-count').textContent = questions.length - correct;
            document.getElementById('total-questions').textContent = questions.length;

            resultsSection.classList.add('visible');

            // Save progress using ModuleProgress
            ModuleProgress.completeQuiz('key', 'symmetric-quiz', percentage, {
                silent: false,
                returnToDashboard: false,
                passingScore: 70
            });
        }

        // Review Answers
        function reviewAnswers() {
            document.getElementById('results-section').classList.remove('visible');
            document.getElementById('quiz-container').style.display = 'block';
            document.getElementById('quiz-actions').style.display = 'flex';
            document.getElementById('progress-indicator').style.display = 'flex';

            currentQuestion = 0;
            renderQuestion();
            highlightAnswers();
        }

        // Highlight Correct/Incorrect Answers
        function highlightAnswers() {
            const options = document.querySelectorAll('.answer-option');
            options.forEach((opt, index) => {
                const isCorrect = index === questions[currentQuestion].correct;
                const isSelected = index === userAnswers[currentQuestion];

                if (isCorrect) {
                    opt.classList.add('correct');
                } else if (isSelected && !isCorrect) {
                    opt.classList.add('incorrect');
                }
            });

            showExplanation();
        }

        // Show Explanation
        function showExplanation() {
            const explanation = document.getElementById(`explanation-${currentQuestion}`);
            if (explanation) {
                explanation.classList.add('visible');
            }

            // Highlight answers if quiz is submitted
            if (quizSubmitted) {
                highlightAnswers();
            }
        }

        // Return to Dashboard
        function returnToDashboard() {
            window.location.href = '../index.html';
        }
    </script>
</body>
</html>
