<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <!-- Access Control -->
    <script src="../../../components/AccessGuard.js"></script>
    <script>
        AccessGuard.require('sorted');
    </script>
    <!-- Achievement & Progress Integration -->
    <script src="../../../components/AchievementManager.js"></script>
    <script src="../../../components/ModuleProgress.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cryptanalysis Quiz - House of the Key</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --house-color: #06b6d4;
            --house-glow: rgba(6, 182, 212, 0.4);
            --bg-dark: #0a0a12;
            --bg-card: rgba(15, 15, 25, 0.8);
            --text-primary: #e8e8f0;
            --text-secondary: #8888aa;
            --success-green: #10b981;
            --warning-red: #ef4444;
            --info-blue: #3b82f6;
        }

        body {
            min-height: 100vh;
            background: var(--bg-dark);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: var(--text-primary);
            overflow-x: hidden;
        }

        /* Header */
        .module-header {
            padding: 20px 30px;
            background: rgba(10, 10, 18, 0.95);
            border-bottom: 1px solid rgba(6, 182, 212, 0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .back-btn {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            border: 1px solid rgba(6, 182, 212, 0.3);
            background: transparent;
            color: var(--house-color);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .back-btn:hover {
            background: rgba(6, 182, 212, 0.1);
        }

        .module-title {
            font-size: 1rem;
            font-weight: 500;
            color: var(--text-primary);
        }

        .house-badge {
            font-size: 0.7rem;
            padding: 4px 12px;
            background: rgba(6, 182, 212, 0.15);
            border: 1px solid rgba(6, 182, 212, 0.3);
            border-radius: 20px;
            color: var(--house-color);
            letter-spacing: 0.1em;
        }

        /* Container */
        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 40px 30px;
        }

        /* Intro Section */
        .intro-section {
            text-align: center;
            margin-bottom: 40px;
            padding: 30px 20px;
            background: linear-gradient(135deg, rgba(6, 182, 212, 0.05), rgba(6, 182, 212, 0.02));
            border-radius: 12px;
            border: 1px solid rgba(6, 182, 212, 0.1);
        }

        .intro-icon {
            font-size: 3rem;
            margin-bottom: 15px;
            filter: drop-shadow(0 0 20px var(--house-glow));
        }

        .intro-title {
            font-size: 1.8rem;
            font-weight: 600;
            margin-bottom: 10px;
            background: linear-gradient(135deg, var(--house-color), #0891b2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .intro-subtitle {
            color: var(--text-secondary);
            line-height: 1.6;
        }

        /* Quiz Info */
        .quiz-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 40px;
        }

        .info-card {
            background: var(--bg-card);
            border: 1px solid rgba(6, 182, 212, 0.15);
            border-radius: 10px;
            padding: 20px;
            text-align: center;
        }

        .info-card-value {
            font-size: 1.8rem;
            font-weight: 600;
            color: var(--house-color);
            margin-bottom: 5px;
        }

        .info-card-label {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        /* Question Card */
        .question-card {
            background: var(--bg-card);
            border: 1px solid rgba(6, 182, 212, 0.15);
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 25px;
            transition: all 0.3s ease;
        }

        .question-card.answered-correct {
            border-color: var(--success-green);
            background: rgba(16, 185, 129, 0.05);
        }

        .question-card.answered-incorrect {
            border-color: var(--warning-red);
            background: rgba(239, 68, 68, 0.05);
        }

        .question-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
        }

        .question-number {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--house-color), #0891b2);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 1.1rem;
            flex-shrink: 0;
        }

        .question-text {
            font-size: 1.1rem;
            font-weight: 500;
            color: var(--text-primary);
            line-height: 1.6;
        }

        /* Options */
        .options {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 20px;
        }

        .option {
            background: rgba(255, 255, 255, 0.03);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 15px 20px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .option:hover {
            background: rgba(6, 182, 212, 0.05);
            border-color: rgba(6, 182, 212, 0.3);
        }

        .option.selected {
            background: rgba(6, 182, 212, 0.1);
            border-color: var(--house-color);
        }

        .option.correct {
            background: rgba(16, 185, 129, 0.1);
            border-color: var(--success-green);
        }

        .option.incorrect {
            background: rgba(239, 68, 68, 0.1);
            border-color: var(--warning-red);
        }

        .option.disabled {
            cursor: not-allowed;
            opacity: 0.6;
        }

        .option-indicator {
            width: 24px;
            height: 24px;
            border: 2px solid var(--text-secondary);
            border-radius: 50%;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
        }

        .option.selected .option-indicator {
            border-color: var(--house-color);
            background: var(--house-color);
        }

        .option.correct .option-indicator {
            border-color: var(--success-green);
            background: var(--success-green);
        }

        .option.correct .option-indicator::after {
            content: '‚úì';
            color: white;
        }

        .option.incorrect .option-indicator {
            border-color: var(--warning-red);
            background: var(--warning-red);
        }

        .option.incorrect .option-indicator::after {
            content: '‚úó';
            color: white;
        }

        .option-text {
            flex: 1;
            line-height: 1.5;
        }

        /* Explanation */
        .explanation {
            background: rgba(59, 130, 246, 0.1);
            border-left: 4px solid var(--info-blue);
            border-radius: 0 8px 8px 0;
            padding: 15px 20px;
            margin-top: 15px;
            display: none;
        }

        .explanation.show {
            display: block;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .explanation-title {
            color: var(--info-blue);
            font-weight: 600;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .explanation-content {
            color: var(--text-secondary);
            line-height: 1.7;
            font-size: 0.95rem;
        }

        /* Submit Button */
        .submit-section {
            text-align: center;
            margin-top: 40px;
        }

        .submit-btn {
            background: linear-gradient(135deg, var(--house-color), #0891b2);
            border: none;
            border-radius: 10px;
            padding: 15px 50px;
            font-size: 1.1rem;
            font-weight: 600;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(6, 182, 212, 0.3);
        }

        .submit-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(6, 182, 212, 0.4);
        }

        .submit-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Results */
        .results-section {
            display: none;
            background: var(--bg-card);
            border: 2px solid var(--house-color);
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            margin-top: 40px;
        }

        .results-section.show {
            display: block;
            animation: slideIn 0.5s ease;
        }

        .results-icon {
            font-size: 4rem;
            margin-bottom: 20px;
        }

        .results-title {
            font-size: 2rem;
            font-weight: 600;
            margin-bottom: 15px;
            background: linear-gradient(135deg, var(--house-color), #0891b2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .results-score {
            font-size: 3rem;
            font-weight: 700;
            color: var(--house-color);
            margin-bottom: 20px;
        }

        .results-message {
            font-size: 1.1rem;
            color: var(--text-secondary);
            line-height: 1.7;
            margin-bottom: 30px;
        }

        .results-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-item {
            padding: 15px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 8px;
        }

        .stat-value {
            font-size: 1.8rem;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .stat-value.correct {
            color: var(--success-green);
        }

        .stat-value.incorrect {
            color: var(--warning-red);
        }

        .stat-label {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 30px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--house-color), #0891b2);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(6, 182, 212, 0.3);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: var(--text-primary);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 10px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-dark);
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(6, 182, 212, 0.3);
            border-radius: 5px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(6, 182, 212, 0.5);
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="module-header">
        <div class="header-left">
            <button class="back-btn" onclick="window.location.href='../../../index.html'">‚Üê</button>
            <h1 class="module-title">Cryptanalysis Quiz</h1>
        </div>
        <div class="header-right">
            <span class="house-badge">HOUSE OF THE KEY</span>
        </div>
    </header>

    <!-- Main Container -->
    <main class="container">
        <!-- Introduction -->
        <section class="intro-section">
            <div class="intro-icon">üìù</div>
            <h1 class="intro-title">Test Your Cryptanalysis Knowledge</h1>
            <p class="intro-subtitle">
                10 questions covering attack models, vulnerabilities, defenses, and real-world cryptanalysis
            </p>
        </section>

        <!-- Quiz Info -->
        <div class="quiz-info">
            <div class="info-card">
                <div class="info-card-value">10</div>
                <div class="info-card-label">Questions</div>
            </div>
            <div class="info-card">
                <div class="info-card-value">70%</div>
                <div class="info-card-label">Passing Score</div>
            </div>
            <div class="info-card">
                <div class="info-card-value" id="time-display">0:00</div>
                <div class="info-card-label">Time Elapsed</div>
            </div>
        </div>

        <!-- Questions -->
        <div id="quiz-questions">
            <!-- Questions will be inserted here by JavaScript -->
        </div>

        <!-- Submit Button -->
        <div class="submit-section">
            <button class="submit-btn" id="submit-btn" onclick="submitQuiz()" disabled>
                Submit Quiz
            </button>
        </div>

        <!-- Results -->
        <div id="results-section" class="results-section">
            <!-- Results will be inserted here by JavaScript -->
        </div>
    </main>

    <script>
        // Quiz data
        const quizData = [
            {
                question: "Which attack model gives the attacker the MOST information?",
                options: [
                    "Ciphertext-only attack",
                    "Known-plaintext attack",
                    "Chosen-plaintext attack",
                    "Adaptive chosen-ciphertext attack"
                ],
                correct: 3,
                explanation: "Adaptive chosen-ciphertext attack gives the attacker the most power: they can decrypt chosen ciphertexts and adapt their strategy based on previous results. This is the strongest realistic attack model. Padding oracle attacks are a real-world example."
            },
            {
                question: "For a hash function with 256-bit output, approximately how many hash operations are needed for a 50% collision probability (birthday attack)?",
                options: [
                    "2^64 operations",
                    "2^128 operations",
                    "2^192 operations",
                    "2^256 operations"
                ],
                correct: 1,
                explanation: "Birthday attacks reduce security from 2^n to 2^(n/2). For a 256-bit hash, collision probability reaches ~50% at 2^128 operations. This is why 256-bit hashes provide approximately 128-bit collision resistance security."
            },
            {
                question: "Why are MD5 and SHA-1 deprecated for security applications?",
                options: [
                    "They are too slow for modern systems",
                    "Practical collision attacks have been demonstrated",
                    "They use too much memory",
                    "They are not standardized by NIST"
                ],
                correct: 1,
                explanation: "MD5 (broken in 2004) and SHA-1 (SHAttered attack in 2017) have demonstrated practical collision attacks. MD5 collisions can be generated in seconds, and SHA-1 collisions cost ~$110,000. Both must be replaced with SHA-256 or SHA-3 for any security purpose."
            },
            {
                question: "What does a padding oracle attack require to succeed?",
                options: [
                    "Access to the encryption key",
                    "A server that reveals padding validity",
                    "Knowledge of the plaintext",
                    "Quantum computing capabilities"
                ],
                correct: 1,
                explanation: "Padding oracle attacks exploit servers that leak information about padding validity (e.g., returning different errors for 'invalid padding' vs. 'decryption failed'). This seemingly tiny leak allows complete decryption of ciphertext without the key. POODLE (2014) exploited this in SSLv3."
            },
            {
                question: "In CBC mode, modifying ciphertext block C[i] directly affects which plaintext block?",
                options: [
                    "P[i] only",
                    "P[i+1] only",
                    "Both P[i] and P[i+1]",
                    "All subsequent blocks"
                ],
                correct: 2,
                explanation: "In CBC mode, P[i] = Decrypt(C[i]) ‚äï C[i-1]. Modifying C[i] corrupts P[i] (random garbage) but causes predictable XOR changes in P[i+1]. This is the basis of CBC bit-flipping attacks. Defense: use authenticated encryption (AES-GCM)."
            },
            {
                question: "Which hash construction is vulnerable to length extension attacks?",
                options: [
                    "HMAC-SHA256",
                    "SHA-3",
                    "SHA-256(secret || message)",
                    "Argon2"
                ],
                correct: 2,
                explanation: "Merkle-Damg√•rd constructions (MD5, SHA-1, SHA-2) are vulnerable to length extension when used as hash(secret||message). Attackers can compute hash(secret||message||padding||extension) without knowing the secret. Always use HMAC for authentication, or use SHA-3 (sponge construction, immune to length extension)."
            },
            {
                question: "What is the primary defense against timing attacks?",
                options: [
                    "Use faster hardware",
                    "Add random delays to all operations",
                    "Implement constant-time algorithms",
                    "Encrypt all timing information"
                ],
                correct: 2,
                explanation: "Constant-time algorithms ensure execution time doesn't depend on secret data. This means no early returns, no secret-dependent branches, and no secret-dependent memory access. Random delays help but aren't sufficient alone (can be averaged out). Modern crypto libraries provide constant-time primitives."
            },
            {
                question: "The ROBOT attack (2017) exploited a vulnerability in which cryptographic mechanism?",
                options: [
                    "AES-GCM encryption",
                    "RSA with PKCS#1 v1.5 padding",
                    "Elliptic curve key exchange",
                    "SHA-256 hashing"
                ],
                correct: 1,
                explanation: "ROBOT revived Bleichenbacher's 1998 padding oracle attack against RSA PKCS#1 v1.5. Despite being 20 years old, the vulnerability still affected 27% of top domains in 2017. Modern systems use RSA-OAEP padding instead of PKCS#1 v1.5 to prevent these attacks."
            },
            {
                question: "Which of the following provides both confidentiality AND integrity in a single operation?",
                options: [
                    "AES-CBC",
                    "AES-GCM",
                    "RSA encryption",
                    "SHA-256"
                ],
                correct: 1,
                explanation: "AES-GCM is an AEAD (Authenticated Encryption with Associated Data) mode that provides both confidentiality and integrity. It prevents padding oracle attacks, bit-flipping attacks, and detects any ciphertext modification. Other AEAD options include ChaCha20-Poly1305 and AES-CCM."
            },
            {
                question: "What was the computational cost of the SHAttered attack that broke SHA-1 in 2017?",
                options: [
                    "2^32 operations (~4 billion)",
                    "2^63 operations (~9 quintillion)",
                    "2^80 operations (theoretical)",
                    "2^160 operations (infeasible)"
                ],
                correct: 1,
                explanation: "The SHAttered attack required approximately 2^63 SHA-1 operations (9,223,372,036,854,775,808 computations), costing about $110,000 in cloud computing. This broke SHA-1's collision resistance in practice. All major systems have since migrated to SHA-256 or SHA-3."
            }
        ];

        // State
        let answers = {};
        let startTime = Date.now();
        let timerInterval;

        // Initialize quiz
        function initQuiz() {
            const container = document.getElementById('quiz-questions');
            quizData.forEach((q, index) => {
                const questionCard = createQuestionCard(q, index);
                container.appendChild(questionCard);
            });

            // Start timer
            timerInterval = setInterval(updateTimer, 1000);
        }

        // Create question card
        function createQuestionCard(data, index) {
            const card = document.createElement('div');
            card.className = 'question-card';
            card.id = `question-${index}`;

            card.innerHTML = `
                <div class="question-header">
                    <div class="question-number">${index + 1}</div>
                    <div class="question-text">${data.question}</div>
                </div>
                <div class="options">
                    ${data.options.map((option, optIndex) => `
                        <div class="option" onclick="selectOption(${index}, ${optIndex})">
                            <div class="option-indicator"></div>
                            <div class="option-text">${option}</div>
                        </div>
                    `).join('')}
                </div>
                <div class="explanation" id="explanation-${index}">
                    <div class="explanation-title">
                        <span>üí°</span> Explanation
                    </div>
                    <div class="explanation-content">${data.explanation}</div>
                </div>
            `;

            return card;
        }

        // Select option
        function selectOption(questionIndex, optionIndex) {
            // Don't allow changes after submission
            if (document.getElementById('results-section').classList.contains('show')) {
                return;
            }

            answers[questionIndex] = optionIndex;

            // Update UI
            const card = document.getElementById(`question-${questionIndex}`);
            const options = card.querySelectorAll('.option');
            options.forEach((opt, idx) => {
                if (idx === optionIndex) {
                    opt.classList.add('selected');
                } else {
                    opt.classList.remove('selected');
                }
            });

            // Check if all questions answered
            checkAllAnswered();
        }

        // Check if all answered
        function checkAllAnswered() {
            const allAnswered = Object.keys(answers).length === quizData.length;
            document.getElementById('submit-btn').disabled = !allAnswered;
        }

        // Update timer
        function updateTimer() {
            const elapsed = Math.floor((Date.now() - startTime) / 1000);
            const minutes = Math.floor(elapsed / 60);
            const seconds = elapsed % 60;
            document.getElementById('time-display').textContent =
                `${minutes}:${seconds.toString().padStart(2, '0')}`;
        }

        // Submit quiz
        function submitQuiz() {
            clearInterval(timerInterval);

            let correct = 0;
            let incorrect = 0;

            // Grade each question
            quizData.forEach((q, index) => {
                const userAnswer = answers[index];
                const isCorrect = userAnswer === q.correct;

                if (isCorrect) {
                    correct++;
                } else {
                    incorrect++;
                }

                // Update question card
                const card = document.getElementById(`question-${index}`);
                card.classList.add(isCorrect ? 'answered-correct' : 'answered-incorrect');

                // Update options
                const options = card.querySelectorAll('.option');
                options.forEach((opt, idx) => {
                    opt.classList.add('disabled');
                    if (idx === q.correct) {
                        opt.classList.add('correct');
                    } else if (idx === userAnswer && !isCorrect) {
                        opt.classList.add('incorrect');
                    }
                });

                // Show explanation
                document.getElementById(`explanation-${index}`).classList.add('show');
            });

            // Calculate score
            const score = Math.round((correct / quizData.length) * 100);
            const passed = score >= 70;

            // Show results
            showResults(score, correct, incorrect, passed);

            // Hide submit button
            document.getElementById('submit-btn').style.display = 'none';

            // Complete module if passed
            if (passed) {
                if (typeof ModuleProgress !== 'undefined') {
                    ModuleProgress.completeQuiz('key', 'key-cryptanalysis-quiz', score);
                }

                if (typeof AchievementManager !== 'undefined') {
                    AchievementManager.unlock('cryptanalysis-master', {
                        title: 'Cryptanalysis Master',
                        description: 'Passed the Cryptanalysis Quiz',
                        house: 'key',
                        icon: 'üéì'
                    });
                }
            }

            // Scroll to results
            setTimeout(() => {
                document.getElementById('results-section').scrollIntoView({
                    behavior: 'smooth',
                    block: 'start'
                });
            }, 500);
        }

        // Show results
        function showResults(score, correct, incorrect, passed) {
            const resultsSection = document.getElementById('results-section');

            const icon = passed ? 'üéâ' : 'üìö';
            const title = passed ? 'Congratulations!' : 'Keep Learning!';
            const message = passed
                ? 'You have demonstrated strong understanding of cryptanalysis concepts. You are well-equipped to identify and defend against cryptographic attacks.'
                : 'Review the explanations and try again. Understanding cryptanalysis is crucial for building secure systems.';

            resultsSection.innerHTML = `
                <div class="results-icon">${icon}</div>
                <div class="results-title">${title}</div>
                <div class="results-score">${score}%</div>
                <div class="results-message">${message}</div>
                <div class="results-stats">
                    <div class="stat-item">
                        <div class="stat-value correct">${correct}</div>
                        <div class="stat-label">Correct</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value incorrect">${incorrect}</div>
                        <div class="stat-label">Incorrect</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" style="color: var(--house-color);">${score}%</div>
                        <div class="stat-label">Score</div>
                    </div>
                </div>
                <div class="action-buttons">
                    ${!passed ? '<button class="btn btn-primary" onclick="location.reload()">Retake Quiz</button>' : ''}
                    <button class="btn ${passed ? 'btn-primary' : 'btn-secondary'}" onclick="window.location.href='../../../index.html'">
                        Return to Key House
                    </button>
                </div>
            `;

            resultsSection.classList.add('show');
        }

        // Initialize on load
        window.addEventListener('load', initQuiz);
    </script>
</body>
</html>
