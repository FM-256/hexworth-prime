<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <!-- Access Control -->
    <script src="../../../components/AccessGuard.js"></script>
    <script>
        AccessGuard.require('sorted');
    </script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KDF Hands-On Lab - House of the Key</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --house-color: #f59e0b;
            --house-glow: rgba(245, 158, 11, 0.4);
            --bg-dark: #0a0a12;
            --bg-card: rgba(15, 15, 25, 0.8);
            --text-primary: #e8e8f0;
            --text-secondary: #8888aa;
            --cyan-accent: #06b6d4;
            --success-green: #10b981;
            --warning-red: #ef4444;
            --info-blue: #3b82f6;
        }

        body {
            min-height: 100vh;
            background: var(--bg-dark);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: var(--text-primary);
            overflow-x: hidden;
        }

        /* Header */
        .module-header {
            padding: 20px 30px;
            background: rgba(10, 10, 18, 0.95);
            border-bottom: 1px solid rgba(245, 158, 11, 0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(10px);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .back-btn {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            border: 1px solid rgba(245, 158, 11, 0.3);
            background: transparent;
            color: var(--house-color);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            font-size: 1.2rem;
        }

        .back-btn:hover {
            background: rgba(245, 158, 11, 0.1);
            transform: translateX(-2px);
        }

        .module-title {
            font-size: 1rem;
            font-weight: 500;
            color: var(--text-primary);
        }

        .house-badge {
            font-size: 0.7rem;
            padding: 4px 12px;
            background: rgba(245, 158, 11, 0.15);
            border: 1px solid rgba(245, 158, 11, 0.3);
            border-radius: 20px;
            color: var(--house-color);
            letter-spacing: 0.1em;
        }

        .progress-display {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .progress-count {
            padding: 4px 12px;
            background: rgba(6, 182, 212, 0.2);
            border: 1px solid rgba(6, 182, 212, 0.3);
            border-radius: 5px;
            color: var(--cyan-accent);
            font-weight: 600;
        }

        /* Container */
        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 40px 30px;
        }

        .intro {
            text-align: center;
            margin-bottom: 40px;
            padding: 30px;
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.05), rgba(6, 182, 212, 0.05));
            border-radius: 12px;
            border: 1px solid rgba(245, 158, 11, 0.2);
        }

        .intro h1 {
            font-size: 2rem;
            margin-bottom: 10px;
            background: linear-gradient(135deg, var(--house-color), var(--cyan-accent));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .intro p {
            color: var(--text-secondary);
            line-height: 1.6;
        }

        /* Exercise Card */
        .exercise-card {
            background: var(--bg-card);
            border: 1px solid rgba(245, 158, 11, 0.2);
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
            transition: all 0.3s ease;
        }

        .exercise-card.completed {
            border-color: rgba(16, 185, 129, 0.4);
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.05), rgba(15, 15, 25, 0.8));
        }

        .exercise-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid rgba(245, 158, 11, 0.2);
        }

        .exercise-title {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .exercise-number {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--house-color), var(--cyan-accent));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 1.1rem;
        }

        .exercise-title h2 {
            font-size: 1.4rem;
            color: var(--house-color);
        }

        .exercise-status {
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .exercise-status.pending {
            background: rgba(245, 158, 11, 0.1);
            border: 1px solid rgba(245, 158, 11, 0.3);
            color: var(--house-color);
        }

        .exercise-status.completed {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.3);
            color: var(--success-green);
        }

        .exercise-description {
            color: var(--text-secondary);
            line-height: 1.8;
            margin-bottom: 20px;
        }

        .exercise-objective {
            background: rgba(6, 182, 212, 0.1);
            border-left: 4px solid var(--cyan-accent);
            padding: 15px 20px;
            margin: 20px 0;
            border-radius: 5px;
        }

        .exercise-objective strong {
            color: var(--cyan-accent);
            display: block;
            margin-bottom: 8px;
        }

        /* Terminal */
        .terminal {
            background: #000;
            border: 1px solid rgba(6, 182, 212, 0.3);
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
        }

        .terminal-header {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(6, 182, 212, 0.2);
        }

        .terminal-btn {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        .terminal-btn.red { background: #ef4444; }
        .terminal-btn.yellow { background: #f59e0b; }
        .terminal-btn.green { background: #10b981; }

        .terminal-output {
            color: #0f0;
            max-height: 300px;
            overflow-y: auto;
            line-height: 1.6;
        }

        .terminal-input {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 15px;
        }

        .terminal-prompt {
            color: var(--cyan-accent);
        }

        .terminal-input input {
            flex: 1;
            background: transparent;
            border: none;
            color: #0f0;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            outline: none;
        }

        /* Code Block */
        .code-block {
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(245, 158, 11, 0.3);
            border-radius: 8px;
            padding: 20px;
            margin: 15px 0;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            color: var(--house-color);
            overflow-x: auto;
        }

        .code-block pre {
            margin: 0;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        /* Buttons */
        .btn {
            padding: 12px 28px;
            background: linear-gradient(135deg, var(--house-color), var(--cyan-accent));
            border: none;
            border-radius: 8px;
            color: white;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-right: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(245, 158, 11, 0.3);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: rgba(245, 158, 11, 0.1);
            color: var(--house-color);
            border: 1px solid rgba(245, 158, 11, 0.3);
        }

        .btn-check {
            background: linear-gradient(135deg, #10b981, #06b6d4);
        }

        /* Input Groups */
        .input-group {
            margin: 15px 0;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .input-group input,
        .input-group select {
            width: 100%;
            padding: 12px;
            background: rgba(20, 20, 30, 0.8);
            border: 1px solid rgba(245, 158, 11, 0.2);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 0.95rem;
        }

        .input-group input:focus,
        .input-group select:focus {
            outline: none;
            border-color: var(--house-color);
            box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.1);
        }

        /* Result Box */
        .result-box {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(6, 182, 212, 0.3);
            border-radius: 8px;
            padding: 20px;
            margin: 15px 0;
        }

        .result-box h3 {
            color: var(--cyan-accent);
            margin-bottom: 15px;
            font-size: 1.1rem;
        }

        .result-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .result-item:last-child {
            border-bottom: none;
        }

        .result-label {
            color: var(--text-secondary);
        }

        .result-value {
            color: var(--text-primary);
            font-weight: 600;
            font-family: 'Courier New', monospace;
            word-break: break-all;
        }

        /* Feedback */
        .feedback {
            padding: 15px 20px;
            border-radius: 8px;
            margin: 15px 0;
            display: flex;
            gap: 12px;
            align-items: start;
        }

        .feedback.success {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.3);
            color: var(--success-green);
        }

        .feedback.error {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: var(--warning-red);
        }

        .feedback.info {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.3);
            color: var(--info-blue);
        }

        /* Hint Box */
        .hint-box {
            background: rgba(245, 158, 11, 0.05);
            border: 1px solid rgba(245, 158, 11, 0.2);
            border-radius: 8px;
            padding: 15px 20px;
            margin: 15px 0;
        }

        .hint-toggle {
            color: var(--house-color);
            cursor: pointer;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .hint-content {
            display: none;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid rgba(245, 158, 11, 0.2);
            color: var(--text-secondary);
            line-height: 1.6;
        }

        .hint-content.show {
            display: block;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 20px 15px;
            }

            .exercise-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="module-header">
        <div class="header-left">
            <button class="back-btn" onclick="window.location.href='../../../index.html'" title="Back to Key House">‚Üê</button>
            <h1 class="module-title">KDF Hands-On Lab</h1>
            <span class="house-badge">HOUSE OF THE KEY</span>
        </div>
        <div class="progress-display">
            <span>Progress:</span>
            <span class="progress-count" id="progress-count">0/8</span>
        </div>
    </header>

    <!-- Main Container -->
    <div class="container">
        <div class="intro">
            <h1>Key Derivation Functions Lab</h1>
            <p>
                Master KDFs through hands-on exercises. Generate salts, hash passwords with different algorithms,
                tune parameters, and understand real-world implementation challenges.
            </p>
        </div>

        <!-- Exercise 1: Generate Secure Salt -->
        <div class="exercise-card" id="exercise-1">
            <div class="exercise-header">
                <div class="exercise-title">
                    <div class="exercise-number">1</div>
                    <h2>Generate Secure Salt</h2>
                </div>
                <div class="exercise-status pending">
                    <span>‚óã</span>
                    <span>Pending</span>
                </div>
            </div>

            <div class="exercise-description">
                Every password needs a unique salt to prevent rainbow table attacks. Your first task is to generate
                cryptographically secure random salts.
            </div>

            <div class="exercise-objective">
                <strong>Objective:</strong>
                Generate a 32-byte (256-bit) cryptographically secure salt and display it in hexadecimal format.
            </div>

            <div class="input-group">
                <label>Salt Length (bytes)</label>
                <select id="ex1-salt-length">
                    <option value="16">16 bytes</option>
                    <option value="32" selected>32 bytes</option>
                    <option value="64">64 bytes</option>
                </select>
            </div>

            <button class="btn" onclick="generateSaltEx1()">Generate Salt</button>

            <div id="ex1-output"></div>

            <div class="hint-box">
                <div class="hint-toggle" onclick="toggleHint('ex1-hint')">
                    <span>üí°</span>
                    <span>Show Hint</span>
                </div>
                <div class="hint-content" id="ex1-hint">
                    Use a cryptographically secure random number generator (CSRNG). In JavaScript, that's
                    <code>crypto.getRandomValues()</code>. In Python, use <code>os.urandom()</code>.
                    Never use <code>Math.random()</code> for cryptographic purposes!
                </div>
            </div>
        </div>

        <!-- Exercise 2: Hash Password with PBKDF2 -->
        <div class="exercise-card" id="exercise-2">
            <div class="exercise-header">
                <div class="exercise-title">
                    <div class="exercise-number">2</div>
                    <h2>Hash Password with PBKDF2</h2>
                </div>
                <div class="exercise-status pending">
                    <span>‚óã</span>
                    <span>Pending</span>
                </div>
            </div>

            <div class="exercise-description">
                PBKDF2 is a widely-supported KDF based on HMAC. Implement password hashing using PBKDF2 with
                proper parameters.
            </div>

            <div class="exercise-objective">
                <strong>Objective:</strong>
                Hash a password using PBKDF2-HMAC-SHA256 with at least 600,000 iterations (NIST 2024 recommendation).
            </div>

            <div class="input-group">
                <label>Password</label>
                <input type="text" id="ex2-password" placeholder="Enter password to hash">
            </div>

            <div class="input-group">
                <label>Iterations</label>
                <input type="number" id="ex2-iterations" value="600000" min="100000">
            </div>

            <button class="btn" onclick="hashPBKDF2Ex2()">Hash with PBKDF2</button>
            <button class="btn btn-secondary" onclick="verifyPBKDF2Ex2()">Verify Hash</button>

            <div id="ex2-output"></div>

            <div class="hint-box">
                <div class="hint-toggle" onclick="toggleHint('ex2-hint')">
                    <span>üí°</span>
                    <span>Show Hint</span>
                </div>
                <div class="hint-content" id="ex2-hint">
                    PBKDF2 parameters: PRF (HMAC-SHA256), salt (32 bytes), iterations (600k+), output length (32 bytes).
                    Store the salt alongside the hash‚Äîit's not secret. Format: <code>algorithm$iterations$salt$hash</code>
                </div>
            </div>
        </div>

        <!-- Exercise 3: Implement bcrypt Hashing -->
        <div class="exercise-card" id="exercise-3">
            <div class="exercise-header">
                <div class="exercise-title">
                    <div class="exercise-number">3</div>
                    <h2>Implement bcrypt Hashing</h2>
                </div>
                <div class="exercise-status pending">
                    <span>‚óã</span>
                    <span>Pending</span>
                </div>
            </div>

            <div class="exercise-description">
                bcrypt uses a cost factor that doubles work with each increment. Understanding the exponential
                growth of computation time is critical for parameter selection.
            </div>

            <div class="exercise-objective">
                <strong>Objective:</strong>
                Hash a password with bcrypt using cost factor 12 (current minimum recommendation).
            </div>

            <div class="input-group">
                <label>Password</label>
                <input type="text" id="ex3-password" placeholder="Enter password">
            </div>

            <div class="input-group">
                <label>Cost Factor (rounds = 2^cost)</label>
                <select id="ex3-cost">
                    <option value="10">10 (1,024 rounds - Fast but weak)</option>
                    <option value="12" selected>12 (4,096 rounds - Recommended)</option>
                    <option value="14">14 (16,384 rounds - High security)</option>
                </select>
            </div>

            <button class="btn" onclick="hashBcryptEx3()">Hash with bcrypt</button>

            <div id="ex3-output"></div>

            <div class="hint-box">
                <div class="hint-toggle" onclick="toggleHint('ex3-hint')">
                    <span>üí°</span>
                    <span>Show Hint</span>
                </div>
                <div class="hint-content" id="ex3-hint">
                    bcrypt hash format: <code>$2b$cost$salt(22chars)$hash(31chars)</code>. The cost factor is
                    logarithmic: cost=12 means 2<sup>12</sup> = 4,096 iterations. Each increment doubles the work.
                </div>
            </div>
        </div>

        <!-- Exercise 4: Configure Argon2 Parameters -->
        <div class="exercise-card" id="exercise-4">
            <div class="exercise-header">
                <div class="exercise-title">
                    <div class="exercise-number">4</div>
                    <h2>Configure Argon2 Parameters</h2>
                </div>
                <div class="exercise-status pending">
                    <span>‚óã</span>
                    <span>Pending</span>
                </div>
            </div>

            <div class="exercise-description">
                Argon2 has three tunable parameters: memory, time, and parallelism. Balancing these correctly
                is essential for optimal security and performance.
            </div>

            <div class="exercise-objective">
                <strong>Objective:</strong>
                Configure Argon2id with parameters that achieve ~200-400ms authentication time on typical hardware.
            </div>

            <div class="input-group">
                <label>Password</label>
                <input type="text" id="ex4-password" placeholder="Enter password">
            </div>

            <div class="input-group">
                <label>Memory Cost (MB)</label>
                <select id="ex4-memory">
                    <option value="32">32 MB (Low)</option>
                    <option value="64" selected>64 MB (Recommended)</option>
                    <option value="128">128 MB (High)</option>
                    <option value="256">256 MB (Very High)</option>
                </select>
            </div>

            <div class="input-group">
                <label>Time Cost (iterations)</label>
                <select id="ex4-time">
                    <option value="2">2</option>
                    <option value="3" selected>3</option>
                    <option value="4">4</option>
                    <option value="5">5</option>
                </select>
            </div>

            <div class="input-group">
                <label>Parallelism (threads)</label>
                <select id="ex4-parallel">
                    <option value="2">2</option>
                    <option value="4" selected>4</option>
                    <option value="8">8</option>
                </select>
            </div>

            <button class="btn" onclick="hashArgon2Ex4()">Hash with Argon2id</button>

            <div id="ex4-output"></div>

            <div class="hint-box">
                <div class="hint-toggle" onclick="toggleHint('ex4-hint')">
                    <span>üí°</span>
                    <span>Show Hint</span>
                </div>
                <div class="hint-content" id="ex4-hint">
                    Start with m=64MB, t=3, p=4 and adjust based on performance testing. Memory cost is your
                    primary defense against GPU attacks. Format: <code>$argon2id$v=19$m=65536,t=3,p=4$salt$hash</code>
                </div>
            </div>
        </div>

        <!-- Exercise 5: Benchmark Work Factors -->
        <div class="exercise-card" id="exercise-5">
            <div class="exercise-header">
                <div class="exercise-title">
                    <div class="exercise-number">5</div>
                    <h2>Benchmark Different Work Factors</h2>
                </div>
                <div class="exercise-status pending">
                    <span>‚óã</span>
                    <span>Pending</span>
                </div>
            </div>

            <div class="exercise-description">
                Understanding the performance impact of different work factors helps you make informed decisions
                about security vs usability trade-offs.
            </div>

            <div class="exercise-objective">
                <strong>Objective:</strong>
                Run benchmarks comparing PBKDF2 at different iteration counts to understand performance scaling.
            </div>

            <button class="btn" onclick="runBenchmarkEx5()">Run Benchmark</button>

            <div id="ex5-output"></div>

            <div class="hint-box">
                <div class="hint-toggle" onclick="toggleHint('ex5-hint')">
                    <span>üí°</span>
                    <span>Show Hint</span>
                </div>
                <div class="hint-content" id="ex5-hint">
                    Measure the time it takes to hash with different iteration counts: 10k, 100k, 600k, 1M.
                    Notice the linear relationship‚Äîdoubling iterations doubles the time. This is why attackers
                    suffer: legitimate users hash once, but attackers hash billions of guesses.
                </div>
            </div>
        </div>

        <!-- Exercise 6: Verify Password Against Hash -->
        <div class="exercise-card" id="exercise-6">
            <div class="exercise-header">
                <div class="exercise-title">
                    <div class="exercise-number">6</div>
                    <h2>Verify Password Against Stored Hash</h2>
                </div>
                <div class="exercise-status pending">
                    <span>‚óã</span>
                    <span>Pending</span>
                </div>
            </div>

            <div class="exercise-description">
                Password verification must extract the salt and parameters from the stored hash, then recompute
                the hash with the provided password to check for a match.
            </div>

            <div class="exercise-objective">
                <strong>Objective:</strong>
                Implement password verification that correctly extracts salt and parameters from a stored hash.
            </div>

            <div class="code-block">
                <pre>Stored Hash (PBKDF2):
pbkdf2_sha256$600000$a3f9e2b1c5d7e4f2$d4a8b3c29f1e6d3a7b5c8e4f1a2d9c7e</pre>
            </div>

            <div class="input-group">
                <label>Enter Password to Verify</label>
                <input type="text" id="ex6-password" placeholder="Try: SecurePassword123">
            </div>

            <button class="btn btn-check" onclick="verifyPasswordEx6()">Verify Password</button>

            <div id="ex6-output"></div>

            <div class="hint-box">
                <div class="hint-toggle" onclick="toggleHint('ex6-hint')">
                    <span>üí°</span>
                    <span>Show Hint</span>
                </div>
                <div class="hint-content" id="ex6-hint">
                    Parse the hash format: <code>algorithm$iterations$salt$hash</code>. Extract the salt and
                    iterations, then re-hash the input password with those same parameters. Use constant-time
                    comparison to prevent timing attacks. The correct password is "SecurePassword123".
                </div>
            </div>
        </div>

        <!-- Exercise 7: Derive Encryption Key from Passphrase -->
        <div class="exercise-card" id="exercise-7">
            <div class="exercise-header">
                <div class="exercise-title">
                    <div class="exercise-number">7</div>
                    <h2>Derive Encryption Key from Passphrase</h2>
                </div>
                <div class="exercise-status pending">
                    <span>‚óã</span>
                    <span>Pending</span>
                </div>
            </div>

            <div class="exercise-description">
                KDFs aren't just for password storage‚Äîthey're also used to derive encryption keys from
                human-memorable passphrases for file encryption, disk encryption, and key wrapping.
            </div>

            <div class="exercise-objective">
                <strong>Objective:</strong>
                Derive a 256-bit AES key from a passphrase using Argon2, suitable for file encryption.
            </div>

            <div class="input-group">
                <label>Passphrase</label>
                <input type="text" id="ex7-passphrase" placeholder="Enter a strong passphrase">
            </div>

            <div class="input-group">
                <label>Use Case</label>
                <select id="ex7-usecase">
                    <option value="interactive">Interactive (human waiting) - Lower parameters</option>
                    <option value="noninteractive" selected>Non-interactive (file encryption) - Higher parameters</option>
                </select>
            </div>

            <button class="btn" onclick="deriveKeyEx7()">Derive Encryption Key</button>

            <div id="ex7-output"></div>

            <div class="hint-box">
                <div class="hint-toggle" onclick="toggleHint('ex7-hint')">
                    <span>üí°</span>
                    <span>Show Hint</span>
                </div>
                <div class="hint-content" id="ex7-hint">
                    For file encryption, you can afford higher parameters (m=256MB, t=5) since it's a one-time
                    operation. Store the salt with the encrypted file. The derived key is used for AES-256-GCM
                    encryption. Never reuse the same (key, nonce) pair!
                </div>
            </div>
        </div>

        <!-- Exercise 8: Migrate from Weak to Strong Hashing -->
        <div class="exercise-card" id="exercise-8">
            <div class="exercise-header">
                <div class="exercise-title">
                    <div class="exercise-number">8</div>
                    <h2>Migrate from Weak to Strong Hashing</h2>
                </div>
                <div class="exercise-status pending">
                    <span>‚óã</span>
                    <span>Pending</span>
                </div>
            </div>

            <div class="exercise-description">
                Legacy systems often use weak hashing (MD5, SHA1, or low-iteration PBKDF2). Learn the lazy
                migration pattern to upgrade without forcing password resets.
            </div>

            <div class="exercise-objective">
                <strong>Objective:</strong>
                Implement a migration strategy that upgrades hashes on successful login without disrupting users.
            </div>

            <div class="code-block">
                <pre>Legacy Database:
username: alice
hash: md5:5f4dcc3b5aa765d61d8327deb882cf99  (password: password)</pre>
            </div>

            <div class="input-group">
                <label>Username</label>
                <input type="text" id="ex8-username" value="alice" readonly>
            </div>

            <div class="input-group">
                <label>Password</label>
                <input type="text" id="ex8-password" placeholder="Enter password">
            </div>

            <button class="btn" onclick="migrateHashEx8()">Attempt Login & Migrate</button>

            <div id="ex8-output"></div>

            <div class="hint-box">
                <div class="hint-toggle" onclick="toggleHint('ex8-hint')">
                    <span>üí°</span>
                    <span>Show Hint</span>
                </div>
                <div class="hint-content" id="ex8-hint">
                    Lazy migration pattern: (1) Check hash format, (2) Verify with old algorithm, (3) On success,
                    immediately rehash with new algorithm and update database. This transparently upgrades security
                    without forcing password resets. The password is "password".
                </div>
            </div>
        </div>
    </div>

    <script>
        // Exercise state tracking
        const exerciseState = {
            completed: new Set(),
            salts: {},
            hashes: {}
        };

        function updateProgress() {
            const total = 8;
            const completed = exerciseState.completed.size;
            document.getElementById('progress-count').textContent = `${completed}/${total}`;

            // Update each exercise status
            for (let i = 1; i <= total; i++) {
                const card = document.getElementById(`exercise-${i}`);
                const status = card.querySelector('.exercise-status');
                if (exerciseState.completed.has(i)) {
                    card.classList.add('completed');
                    status.className = 'exercise-status completed';
                    status.innerHTML = '<span>‚úì</span><span>Completed</span>';
                }
            }
        }

        function completeExercise(num) {
            exerciseState.completed.add(num);
            updateProgress();
        }

        function toggleHint(hintId) {
            const hint = document.getElementById(hintId);
            hint.classList.toggle('show');
        }

        // Exercise 1: Generate Salt
        function generateSaltEx1() {
            const length = parseInt(document.getElementById('ex1-salt-length').value);
            const saltBytes = new Uint8Array(length);
            crypto.getRandomValues(saltBytes);
            const saltHex = Array.from(saltBytes).map(b => b.toString(16).padStart(2, '0')).join('');

            exerciseState.salts.ex1 = saltHex;

            const output = document.getElementById('ex1-output');
            output.innerHTML = `
                <div class="result-box">
                    <h3>Generated Salt</h3>
                    <div class="result-item">
                        <span class="result-label">Length:</span>
                        <span class="result-value">${length} bytes (${length * 8} bits)</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">Hex:</span>
                        <span class="result-value" style="font-size: 0.75rem;">${saltHex}</span>
                    </div>
                </div>
                <div class="feedback success">
                    <span style="font-size: 1.2rem;">‚úì</span>
                    <div>
                        <strong>Success!</strong> You've generated a cryptographically secure salt using
                        crypto.getRandomValues(). This salt is unique and suitable for password hashing.
                        Remember: every password gets its own salt!
                    </div>
                </div>
            `;

            completeExercise(1);
        }

        // Exercise 2: PBKDF2 Hashing
        async function hashPBKDF2Ex2() {
            const password = document.getElementById('ex2-password').value;
            const iterations = parseInt(document.getElementById('ex2-iterations').value);

            if (!password) {
                alert('Please enter a password');
                return;
            }

            if (iterations < 600000) {
                alert('Iterations must be at least 600,000 (NIST 2024 recommendation)');
                return;
            }

            // Generate salt
            const saltBytes = new Uint8Array(32);
            crypto.getRandomValues(saltBytes);
            const saltHex = Array.from(saltBytes).map(b => b.toString(16).padStart(2, '0')).join('');

            // Simulate PBKDF2 (browser doesn't have native PBKDF2 in all versions)
            const startTime = performance.now();
            const hash = await simulatePBKDF2(password, saltHex, iterations);
            const endTime = performance.now();

            exerciseState.hashes.ex2 = {
                algorithm: 'pbkdf2_sha256',
                iterations,
                salt: saltHex,
                hash
            };

            const output = document.getElementById('ex2-output');
            output.innerHTML = `
                <div class="result-box">
                    <h3>PBKDF2 Hash Generated</h3>
                    <div class="result-item">
                        <span class="result-label">Algorithm:</span>
                        <span class="result-value">PBKDF2-HMAC-SHA256</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">Iterations:</span>
                        <span class="result-value">${iterations.toLocaleString()}</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">Time:</span>
                        <span class="result-value">${(endTime - startTime).toFixed(2)} ms</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">Salt:</span>
                        <span class="result-value" style="font-size: 0.7rem;">${saltHex}</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">Hash:</span>
                        <span class="result-value" style="font-size: 0.7rem;">${hash}</span>
                    </div>
                </div>
                <div class="code-block">
                    <pre>Stored format:
pbkdf2_sha256$${iterations}$${saltHex}$${hash}</pre>
                </div>
                <div class="feedback success">
                    <span style="font-size: 1.2rem;">‚úì</span>
                    <div>
                        <strong>Excellent!</strong> You've hashed a password with PBKDF2. Notice the computation
                        time‚Äîthis delay is acceptable for legitimate users but devastating for attackers trying
                        billions of guesses.
                    </div>
                </div>
            `;

            completeExercise(2);
        }

        async function verifyPBKDF2Ex2() {
            if (!exerciseState.hashes.ex2) {
                alert('Please hash a password first');
                return;
            }

            const password = document.getElementById('ex2-password').value;
            const stored = exerciseState.hashes.ex2;

            const computedHash = await simulatePBKDF2(password, stored.salt, stored.iterations);
            const match = computedHash === stored.hash;

            const output = document.getElementById('ex2-output');
            if (match) {
                output.innerHTML += `
                    <div class="feedback success">
                        <span style="font-size: 1.2rem;">‚úì</span>
                        <div><strong>Password Verified!</strong> The hash matches.</div>
                    </div>
                `;
            } else {
                output.innerHTML += `
                    <div class="feedback error">
                        <span style="font-size: 1.2rem;">‚úó</span>
                        <div><strong>Verification Failed!</strong> Password doesn't match.</div>
                    </div>
                `;
            }
        }

        async function simulatePBKDF2(password, salt, iterations) {
            // Simple simulation using repeated hashing (NOT actual PBKDF2!)
            const encoder = new TextEncoder();
            let data = encoder.encode(password + salt);

            for (let i = 0; i < Math.min(iterations, 1000); i++) {
                const hashBuffer = await crypto.subtle.digest('SHA-256', data);
                data = new Uint8Array(hashBuffer);
            }

            return Array.from(data).map(b => b.toString(16).padStart(2, '0')).join('');
        }

        // Exercise 3: bcrypt Hashing
        function hashBcryptEx3() {
            const password = document.getElementById('ex3-password').value;
            const cost = parseInt(document.getElementById('ex3-cost').value);

            if (!password) {
                alert('Please enter a password');
                return;
            }

            // Generate salt (bcrypt uses 16 bytes = 128 bits)
            const saltBytes = new Uint8Array(16);
            crypto.getRandomValues(saltBytes);
            const saltB64 = btoa(String.fromCharCode(...saltBytes)).substring(0, 22);

            // Simulate hash (real bcrypt would go here)
            const hashBytes = new Uint8Array(23);
            crypto.getRandomValues(hashBytes);
            const hashB64 = btoa(String.fromCharCode(...hashBytes)).substring(0, 31);

            const bcryptHash = `$2b$${cost.toString().padStart(2, '0')}$${saltB64}${hashB64}`;
            const rounds = Math.pow(2, cost);

            exerciseState.hashes.ex3 = bcryptHash;

            const output = document.getElementById('ex3-output');
            output.innerHTML = `
                <div class="result-box">
                    <h3>bcrypt Hash Generated</h3>
                    <div class="result-item">
                        <span class="result-label">Cost Factor:</span>
                        <span class="result-value">${cost}</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">Rounds:</span>
                        <span class="result-value">${rounds.toLocaleString()}</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">bcrypt Hash:</span>
                        <span class="result-value" style="font-size: 0.75rem;">${bcryptHash}</span>
                    </div>
                </div>
                <div class="feedback info">
                    <span style="font-size: 1.2rem;">‚Ñπ</span>
                    <div>
                        <strong>Hash Format Breakdown:</strong><br>
                        <code>$2b$</code> = bcrypt algorithm identifier<br>
                        <code>${cost.toString().padStart(2, '0')}$</code> = cost factor (2^${cost} = ${rounds.toLocaleString()} rounds)<br>
                        <code>${saltB64}</code> = 22-character salt (base64)<br>
                        <code>${hashB64}</code> = 31-character hash (base64)
                    </div>
                </div>
                <div class="feedback success">
                    <span style="font-size: 1.2rem;">‚úì</span>
                    <div>
                        <strong>Success!</strong> bcrypt's logarithmic cost factor makes it easy to increase
                        security over time. Each increment doubles the work.
                    </div>
                </div>
            `;

            completeExercise(3);
        }

        // Exercise 4: Argon2 Configuration
        function hashArgon2Ex4() {
            const password = document.getElementById('ex4-password').value;
            const memory = parseInt(document.getElementById('ex4-memory').value);
            const time = parseInt(document.getElementById('ex4-time').value);
            const parallel = parseInt(document.getElementById('ex4-parallel').value);

            if (!password) {
                alert('Please enter a password');
                return;
            }

            // Generate salt
            const saltBytes = new Uint8Array(16);
            crypto.getRandomValues(saltBytes);
            const saltB64 = btoa(String.fromCharCode(...saltBytes));

            // Simulate hash
            const hashBytes = new Uint8Array(32);
            crypto.getRandomValues(hashBytes);
            const hashB64 = btoa(String.fromCharCode(...hashBytes));

            const memoryKB = memory * 1024;
            const argon2Hash = `$argon2id$v=19$m=${memoryKB},t=${time},p=${parallel}$${saltB64}$${hashB64}`;

            const estTime = memory * time * 0.5;

            const output = document.getElementById('ex4-output');
            output.innerHTML = `
                <div class="result-box">
                    <h3>Argon2id Hash Generated</h3>
                    <div class="result-item">
                        <span class="result-label">Memory Cost:</span>
                        <span class="result-value">${memory} MB (${memoryKB} KB)</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">Time Cost:</span>
                        <span class="result-value">${time} iterations</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">Parallelism:</span>
                        <span class="result-value">${parallel} threads</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">Est. Time:</span>
                        <span class="result-value">~${estTime.toFixed(0)} ms</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">Argon2 Hash:</span>
                        <span class="result-value" style="font-size: 0.7rem;">${argon2Hash}</span>
                    </div>
                </div>
                <div class="feedback success">
                    <span style="font-size: 1.2rem;">‚úì</span>
                    <div>
                        <strong>Excellent!</strong> Argon2's memory-hard design makes GPU/ASIC attacks
                        economically infeasible. The ${memory} MB memory requirement defeats parallel attacks.
                    </div>
                </div>
            `;

            completeExercise(4);
        }

        // Exercise 5: Benchmark
        async function runBenchmarkEx5() {
            const output = document.getElementById('ex5-output');
            output.innerHTML = '<div class="feedback info"><span>‚è±</span><div>Running benchmarks...</div></div>';

            const iterations = [10000, 100000, 600000, 1000000];
            const results = [];

            for (const iter of iterations) {
                const startTime = performance.now();
                await simulatePBKDF2('TestPassword123', 'a'.repeat(64), iter);
                const endTime = performance.now();
                results.push({ iterations: iter, time: endTime - startTime });
            }

            let tableHTML = `
                <div class="result-box">
                    <h3>PBKDF2 Benchmark Results</h3>
                    <table style="width: 100%; margin-top: 15px; border-collapse: collapse;">
                        <thead>
                            <tr style="border-bottom: 2px solid rgba(6, 182, 212, 0.3);">
                                <th style="padding: 10px; text-align: left; color: var(--cyan-accent);">Iterations</th>
                                <th style="padding: 10px; text-align: right; color: var(--cyan-accent);">Time (ms)</th>
                                <th style="padding: 10px; text-align: right; color: var(--cyan-accent);">Relative</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            const baseTime = results[0].time;
            results.forEach(r => {
                const relative = (r.time / baseTime).toFixed(2);
                tableHTML += `
                    <tr style="border-bottom: 1px solid rgba(255, 255, 255, 0.05);">
                        <td style="padding: 10px; color: var(--text-secondary);">${r.iterations.toLocaleString()}</td>
                        <td style="padding: 10px; text-align: right; color: var(--text-primary); font-weight: 600;">${r.time.toFixed(2)}</td>
                        <td style="padding: 10px; text-align: right; color: var(--house-color);">${relative}x</td>
                    </tr>
                `;
            });

            tableHTML += '</tbody></table></div>';

            output.innerHTML = tableHTML + `
                <div class="feedback success">
                    <span style="font-size: 1.2rem;">‚úì</span>
                    <div>
                        <strong>Benchmark Complete!</strong> Notice the linear scaling‚Äîdoubling iterations
                        doubles the time. This is why high iteration counts are effective: users wait milliseconds,
                        but attackers need years to try all passwords.
                    </div>
                </div>
            `;

            completeExercise(5);
        }

        // Exercise 6: Verify Password
        async function verifyPasswordEx6() {
            const password = document.getElementById('ex6-password').value;
            const correctPassword = 'SecurePassword123';
            const storedHash = 'pbkdf2_sha256$600000$a3f9e2b1c5d7e4f2$d4a8b3c29f1e6d3a7b5c8e4f1a2d9c7e';

            const output = document.getElementById('ex6-output');

            // Parse hash
            const parts = storedHash.split('$');
            const algorithm = parts[0];
            const iterations = parseInt(parts[1]);
            const salt = parts[2];
            const hash = parts[3];

            // Verify
            const match = password === correctPassword;

            if (match) {
                output.innerHTML = `
                    <div class="result-box">
                        <h3>Hash Parsing</h3>
                        <div class="result-item">
                            <span class="result-label">Algorithm:</span>
                            <span class="result-value">${algorithm}</span>
                        </div>
                        <div class="result-item">
                            <span class="result-label">Iterations:</span>
                            <span class="result-value">${iterations.toLocaleString()}</span>
                        </div>
                        <div class="result-item">
                            <span class="result-label">Salt:</span>
                            <span class="result-value">${salt}</span>
                        </div>
                    </div>
                    <div class="feedback success">
                        <span style="font-size: 1.2rem;">‚úì</span>
                        <div>
                            <strong>Password Verified!</strong> You successfully parsed the stored hash format,
                            extracted the salt and parameters, and verified the password match.
                        </div>
                    </div>
                `;
                completeExercise(6);
            } else {
                output.innerHTML = `
                    <div class="feedback error">
                        <span style="font-size: 1.2rem;">‚úó</span>
                        <div>
                            <strong>Verification Failed!</strong> The password doesn't match.
                            Hint: Check the hint section for the correct password.
                        </div>
                    </div>
                `;
            }
        }

        // Exercise 7: Derive Encryption Key
        function deriveKeyEx7() {
            const passphrase = document.getElementById('ex7-passphrase').value;
            const useCase = document.getElementById('ex7-usecase').value;

            if (!passphrase) {
                alert('Please enter a passphrase');
                return;
            }

            const params = useCase === 'interactive'
                ? { memory: 64, time: 3, parallel: 4 }
                : { memory: 256, time: 5, parallel: 4 };

            // Generate salt
            const saltBytes = new Uint8Array(32);
            crypto.getRandomValues(saltBytes);
            const saltHex = Array.from(saltBytes).map(b => b.toString(16).padStart(2, '0')).join('');

            // Simulate key derivation
            const keyBytes = new Uint8Array(32);
            crypto.getRandomValues(keyBytes);
            const keyHex = Array.from(keyBytes).map(b => b.toString(16).padStart(2, '0')).join('');

            const output = document.getElementById('ex7-output');
            output.innerHTML = `
                <div class="result-box">
                    <h3>Encryption Key Derived</h3>
                    <div class="result-item">
                        <span class="result-label">Use Case:</span>
                        <span class="result-value">${useCase === 'interactive' ? 'Interactive' : 'File Encryption'}</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">Parameters:</span>
                        <span class="result-value">m=${params.memory}MB, t=${params.time}, p=${params.parallel}</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">Salt (hex):</span>
                        <span class="result-value" style="font-size: 0.7rem;">${saltHex}</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">AES-256 Key:</span>
                        <span class="result-value" style="font-size: 0.7rem;">${keyHex}</span>
                    </div>
                </div>
                <div class="code-block">
                    <pre>Usage with AES-256-GCM:
const key = deriveKey(passphrase, salt, params);
const iv = crypto.randomBytes(12);  // 96-bit nonce for GCM
const cipher = crypto.createCipheriv('aes-256-gcm', key, iv);
// ... encrypt data ...</pre>
                </div>
                <div class="feedback success">
                    <span style="font-size: 1.2rem;">‚úì</span>
                    <div>
                        <strong>Key Derived!</strong> This 256-bit key is suitable for AES-256 encryption.
                        Store the salt with the encrypted file‚Äîit's needed for decryption. Never reuse keys!
                    </div>
                </div>
            `;

            completeExercise(7);
        }

        // Exercise 8: Migration
        async function migrateHashEx8() {
            const password = document.getElementById('ex8-password').value;
            const correctPassword = 'password';

            if (!password) {
                alert('Please enter a password');
                return;
            }

            const output = document.getElementById('ex8-output');

            // Simulate MD5 verification (in real code, never use MD5!)
            const match = password === correctPassword;

            if (match) {
                // Generate new Argon2 hash
                const saltBytes = new Uint8Array(16);
                crypto.getRandomValues(saltBytes);
                const saltB64 = btoa(String.fromCharCode(...saltBytes));
                const hashBytes = new Uint8Array(32);
                crypto.getRandomValues(hashBytes);
                const hashB64 = btoa(String.fromCharCode(...hashBytes));
                const newHash = `$argon2id$v=19$m=65536,t=3,p=4$${saltB64}$${hashB64}`;

                output.innerHTML = `
                    <div class="result-box">
                        <h3>Migration Process</h3>
                        <div class="result-item">
                            <span class="result-label">Step 1:</span>
                            <span class="result-value" style="color: var(--success-green);">‚úì Detected legacy MD5 hash</span>
                        </div>
                        <div class="result-item">
                            <span class="result-label">Step 2:</span>
                            <span class="result-value" style="color: var(--success-green);">‚úì Verified password with MD5</span>
                        </div>
                        <div class="result-item">
                            <span class="result-label">Step 3:</span>
                            <span class="result-value" style="color: var(--success-green);">‚úì Generated new Argon2id hash</span>
                        </div>
                        <div class="result-item">
                            <span class="result-label">Step 4:</span>
                            <span class="result-value" style="color: var(--success-green);">‚úì Updated database</span>
                        </div>
                    </div>
                    <div class="code-block">
                        <pre>Old Hash (MD5 - INSECURE):
md5:5f4dcc3b5aa765d61d8327deb882cf99

New Hash (Argon2id - SECURE):
${newHash}</pre>
                    </div>
                    <div class="feedback success">
                        <span style="font-size: 1.2rem;">‚úì</span>
                        <div>
                            <strong>Migration Successful!</strong> The user's hash has been transparently upgraded
                            from MD5 to Argon2id without requiring a password reset. Future logins will use the
                            secure hash. This lazy migration pattern is the industry-standard way to upgrade legacy systems.
                        </div>
                    </div>
                `;

                completeExercise(8);
            } else {
                output.innerHTML = `
                    <div class="feedback error">
                        <span style="font-size: 1.2rem;">‚úó</span>
                        <div>
                            <strong>Login Failed!</strong> Password doesn't match. Migration only occurs on
                            successful authentication. Check the hint for the correct password.
                        </div>
                    </div>
                `;
            }
        }
    </script>
<script src="../../../components/FluxCapacitor.js"></script>
</body>
</html>
