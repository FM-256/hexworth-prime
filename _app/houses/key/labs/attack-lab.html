<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <!-- Access Control -->
    <script src="../../../components/AccessGuard.js"></script>
    <script>
        AccessGuard.require('sorted');
    </script>
    <!-- Achievement & Progress Integration -->
    <script src="../../../components/AchievementManager.js"></script>
    <script src="../../../components/ModuleProgress.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cryptanalysis Attack Lab - House of the Key</title>
    <!-- CryptoJS for demonstrations -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.2.0/crypto-js.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --house-color: #06b6d4;
            --house-glow: rgba(6, 182, 212, 0.4);
            --bg-dark: #0a0a12;
            --bg-card: rgba(15, 15, 25, 0.8);
            --text-primary: #e8e8f0;
            --text-secondary: #8888aa;
            --input-bg: rgba(20, 20, 30, 0.8);
            --success-green: #10b981;
            --warning-red: #ef4444;
            --info-blue: #3b82f6;
        }

        body {
            min-height: 100vh;
            background: var(--bg-dark);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: var(--text-primary);
            overflow-x: hidden;
        }

        /* Header */
        .module-header {
            padding: 20px 30px;
            background: rgba(10, 10, 18, 0.95);
            border-bottom: 1px solid rgba(6, 182, 212, 0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .back-btn {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            border: 1px solid rgba(6, 182, 212, 0.3);
            background: transparent;
            color: var(--house-color);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .back-btn:hover {
            background: rgba(6, 182, 212, 0.1);
        }

        .module-title {
            font-size: 1rem;
            font-weight: 500;
            color: var(--text-primary);
        }

        .house-badge {
            font-size: 0.7rem;
            padding: 4px 12px;
            background: rgba(6, 182, 212, 0.15);
            border: 1px solid rgba(6, 182, 212, 0.3);
            border-radius: 20px;
            color: var(--house-color);
            letter-spacing: 0.1em;
        }

        /* Progress Bar */
        .progress-section {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .progress-text {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .progress-bar {
            width: 150px;
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--house-color), #0891b2);
            transition: width 0.5s ease;
        }

        /* Main Container */
        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 40px 30px;
        }

        .intro-section {
            text-align: center;
            margin-bottom: 40px;
            padding: 30px 20px;
            background: linear-gradient(135deg, rgba(6, 182, 212, 0.05), rgba(6, 182, 212, 0.02));
            border-radius: 12px;
            border: 1px solid rgba(6, 182, 212, 0.1);
        }

        .intro-icon {
            font-size: 3rem;
            margin-bottom: 15px;
            filter: drop-shadow(0 0 20px var(--house-glow));
        }

        .intro-title {
            font-size: 1.8rem;
            font-weight: 600;
            margin-bottom: 10px;
            background: linear-gradient(135deg, var(--house-color), #0891b2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .intro-subtitle {
            color: var(--text-secondary);
            line-height: 1.6;
        }

        /* Ethics Notice */
        .ethics-notice {
            background: rgba(239, 68, 68, 0.1);
            border: 2px solid rgba(239, 68, 68, 0.3);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 40px;
            display: flex;
            gap: 15px;
        }

        .ethics-icon {
            font-size: 1.5rem;
            color: var(--warning-red);
            flex-shrink: 0;
        }

        .ethics-content h3 {
            color: var(--warning-red);
            margin-bottom: 8px;
        }

        .ethics-content p {
            color: var(--text-secondary);
            line-height: 1.6;
            font-size: 0.95rem;
        }

        /* Exercise Card */
        .exercise-card {
            background: var(--bg-card);
            border: 1px solid rgba(6, 182, 212, 0.15);
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
            transition: all 0.3s ease;
        }

        .exercise-card.completed {
            border-color: var(--success-green);
            background: rgba(16, 185, 129, 0.05);
        }

        .exercise-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .exercise-title-section {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .exercise-number {
            width: 45px;
            height: 45px;
            background: linear-gradient(135deg, var(--house-color), #0891b2);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 1.3rem;
        }

        .exercise-title {
            font-size: 1.4rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .exercise-status {
            padding: 6px 15px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .exercise-status.pending {
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-secondary);
        }

        .exercise-status.completed {
            background: rgba(16, 185, 129, 0.2);
            color: var(--success-green);
        }

        .exercise-description {
            color: var(--text-secondary);
            line-height: 1.7;
            margin-bottom: 20px;
        }

        .exercise-objective {
            background: rgba(59, 130, 246, 0.1);
            border-left: 4px solid var(--info-blue);
            padding: 15px 20px;
            border-radius: 0 8px 8px 0;
            margin-bottom: 20px;
        }

        .exercise-objective h4 {
            color: var(--info-blue);
            margin-bottom: 8px;
            font-size: 0.95rem;
        }

        .exercise-objective p {
            color: var(--text-secondary);
            font-size: 0.9rem;
            line-height: 1.6;
        }

        /* Input Area */
        .input-group {
            margin-bottom: 20px;
        }

        .input-label {
            display: block;
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .text-input {
            width: 100%;
            background: var(--input-bg);
            border: 1px solid rgba(6, 182, 212, 0.2);
            border-radius: 8px;
            padding: 12px;
            color: var(--text-primary);
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            resize: vertical;
        }

        .text-input:focus {
            outline: none;
            border-color: var(--house-color);
            box-shadow: 0 0 0 3px rgba(6, 182, 212, 0.1);
        }

        /* Code Block */
        .code-block {
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(6, 182, 212, 0.2);
            border-radius: 8px;
            padding: 20px;
            margin: 15px 0;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            color: #00ff88;
            overflow-x: auto;
        }

        .code-block .comment {
            color: #888;
        }

        .code-block .keyword {
            color: #ff79c6;
        }

        .code-block .string {
            color: #f1fa8c;
        }

        /* Buttons */
        .btn {
            padding: 12px 28px;
            background: linear-gradient(135deg, var(--house-color), #0891b2);
            border: none;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-right: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(6, 182, 212, 0.3);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.1);
            box-shadow: none;
        }

        .btn-hint {
            background: rgba(59, 130, 246, 0.2);
            border: 1px solid var(--info-blue);
            color: var(--info-blue);
        }

        /* Result Box */
        .result-box {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(6, 182, 212, 0.2);
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
            display: none;
        }

        .result-box.show {
            display: block;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .result-box.success {
            border-color: var(--success-green);
            background: rgba(16, 185, 129, 0.1);
        }

        .result-box.error {
            border-color: var(--warning-red);
            background: rgba(239, 68, 68, 0.1);
        }

        .result-icon {
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .result-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .result-content {
            color: var(--text-secondary);
            line-height: 1.7;
        }

        /* Hint Box */
        .hint-box {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid var(--info-blue);
            border-radius: 8px;
            padding: 15px 20px;
            margin-top: 15px;
            display: none;
        }

        .hint-box.show {
            display: block;
            animation: slideIn 0.3s ease;
        }

        .hint-title {
            color: var(--info-blue);
            font-weight: 600;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .hint-content {
            color: var(--text-secondary);
            line-height: 1.6;
            font-size: 0.9rem;
        }

        /* Defense Section */
        .defense-section {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid var(--success-green);
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
        }

        .defense-title {
            color: var(--success-green);
            font-weight: 600;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .defense-content {
            color: var(--text-secondary);
            line-height: 1.7;
        }

        .defense-content ul {
            list-style: none;
            margin-top: 10px;
        }

        .defense-content li {
            padding: 8px 0;
            padding-left: 25px;
            position: relative;
        }

        .defense-content li::before {
            content: '‚úì';
            position: absolute;
            left: 0;
            color: var(--success-green);
            font-weight: 600;
        }

        /* Complete Section */
        .complete-section {
            text-align: center;
            margin-top: 50px;
            padding: 40px 20px;
            background: linear-gradient(135deg, rgba(6, 182, 212, 0.05), rgba(6, 182, 212, 0.02));
            border-radius: 12px;
        }

        .complete-btn {
            background: linear-gradient(135deg, var(--house-color), #0891b2);
            border: none;
            border-radius: 10px;
            padding: 15px 40px;
            font-size: 1.1rem;
            font-weight: 600;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(6, 182, 212, 0.3);
        }

        .complete-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(6, 182, 212, 0.4);
        }

        .complete-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 10px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-dark);
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(6, 182, 212, 0.3);
            border-radius: 5px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(6, 182, 212, 0.5);
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="module-header">
        <div class="header-left">
            <button class="back-btn" onclick="window.location.href='../../../index.html'">‚Üê</button>
            <h1 class="module-title">Cryptanalysis Attack Lab</h1>
        </div>
        <div class="header-right">
            <span class="house-badge">HOUSE OF THE KEY</span>
            <div class="progress-section">
                <span class="progress-text" id="progress-text">0/7 Complete</span>
                <div class="progress-bar">
                    <div class="progress-fill" id="progress-fill" style="width: 0%"></div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Container -->
    <main class="container">
        <!-- Introduction -->
        <section class="intro-section">
            <div class="intro-icon">üéØ</div>
            <h1 class="intro-title">Hands-On Attack Exercises</h1>
            <p class="intro-subtitle">
                Practice real cryptanalytic techniques in a safe, educational environment.
                Each exercise teaches you how attacks work and how to defend against them.
            </p>
        </section>

        <!-- Ethics Notice -->
        <div class="ethics-notice">
            <div class="ethics-icon">‚öñÔ∏è</div>
            <div class="ethics-content">
                <h3>Educational Purpose Only</h3>
                <p>
                    These exercises are designed to teach defensive security. Understanding how attacks work
                    is essential for building secure systems. Never use these techniques against systems
                    you don't own or without explicit authorization. Unauthorized access is illegal.
                </p>
            </div>
        </div>

        <!-- Exercise 1: Caesar Cipher -->
        <div class="exercise-card" data-exercise="1">
            <div class="exercise-header">
                <div class="exercise-title-section">
                    <div class="exercise-number">1</div>
                    <h2 class="exercise-title">Break a Caesar Cipher</h2>
                </div>
                <span class="exercise-status pending">Pending</span>
            </div>

            <p class="exercise-description">
                The Caesar cipher is a simple substitution cipher where each letter is shifted by a fixed number.
                Use frequency analysis to determine the shift value and decrypt the message.
            </p>

            <div class="exercise-objective">
                <h4>Objective:</h4>
                <p>Decrypt the ciphertext below using frequency analysis. The most common letter in English is 'E'.</p>
            </div>

            <div class="code-block">
WKDW LV D VHFUHW PHVVDJH HQFUBSWHG ZLWK D VLPSOH FDHVDU FLSKHU
            </div>

            <div class="input-group">
                <label class="input-label">Enter the decrypted plaintext:</label>
                <input type="text" id="caesar-answer" class="text-input" placeholder="that is a secret..." style="min-height: auto;">
            </div>

            <button class="btn" onclick="checkCaesar()">Check Answer</button>
            <button class="btn btn-hint" onclick="showHint(1)">Show Hint</button>

            <div id="caesar-hint" class="hint-box">
                <div class="hint-title">üí° Hint</div>
                <div class="hint-content">
                    Count the most frequent letter in the ciphertext. If it's 'W', and 'E' is most common in English,
                    the shift is (W - E) = 22, or equivalently -4. Try shifting all letters back by 3 or forward by 23.
                </div>
            </div>

            <div id="caesar-result" class="result-box"></div>

            <div class="defense-section">
                <div class="defense-title">üõ°Ô∏è Defense Strategy</div>
                <div class="defense-content">
                    <p>Caesar ciphers are trivially broken and should never be used for real security. Modern defenses include:</p>
                    <ul>
                        <li>Use cryptographically secure algorithms (AES, ChaCha20)</li>
                        <li>Never rely on "security through obscurity"</li>
                        <li>Assume attackers know your algorithm (Kerckhoffs's principle)</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Exercise 2: Birthday Attack Probability -->
        <div class="exercise-card" data-exercise="2">
            <div class="exercise-header">
                <div class="exercise-title-section">
                    <div class="exercise-number">2</div>
                    <h2 class="exercise-title">Calculate Birthday Attack Probability</h2>
                </div>
                <span class="exercise-status pending">Pending</span>
            </div>

            <p class="exercise-description">
                The birthday paradox shows that collisions occur much faster than intuition suggests.
                Calculate how many hash operations are needed for a 50% collision probability.
            </p>

            <div class="exercise-objective">
                <h4>Objective:</h4>
                <p>For a 64-bit hash function, how many hash operations give approximately 50% collision probability?</p>
            </div>

            <div class="code-block">
<span class="comment"># Birthday attack formula:</span>
<span class="comment"># For 50% collision probability: n ‚âà ‚àö(2 √ó 2^b √ó ln(2))</span>
<span class="comment"># Simplified: n ‚âà 2^(b/2) √ó 1.177</span>
<span class="comment"># For practical purposes: n ‚âà 2^(b/2)</span>

<span class="comment"># For 64-bit hash:</span>
b = 64
n = 2^(b/2) = 2^32
            </div>

            <div class="input-group">
                <label class="input-label">Enter the approximate number of operations (as a power of 2, e.g., "32" for 2^32):</label>
                <input type="number" id="birthday-answer" class="text-input" placeholder="32" style="min-height: auto;">
            </div>

            <button class="btn" onclick="checkBirthday()">Check Answer</button>
            <button class="btn btn-hint" onclick="showHint(2)">Show Hint</button>

            <div id="birthday-hint" class="hint-box">
                <div class="hint-title">üí° Hint</div>
                <div class="hint-content">
                    The birthday attack reduces the security of a hash function from 2^n to approximately 2^(n/2).
                    For a 64-bit hash, you need 2^(64/2) = 2^32 operations for ~50% collision probability.
                </div>
            </div>

            <div id="birthday-result" class="result-box"></div>

            <div class="defense-section">
                <div class="defense-title">üõ°Ô∏è Defense Strategy</div>
                <div class="defense-content">
                    <p>To resist birthday attacks:</p>
                    <ul>
                        <li>Use hash functions with output size ‚â•256 bits (SHA-256, SHA-3)</li>
                        <li>Understand that effective security is half the bit length</li>
                        <li>For digital signatures, 128-bit collision resistance is minimum (requires 256-bit hash)</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Exercise 3: MD5 Collision -->
        <div class="exercise-card" data-exercise="3">
            <div class="exercise-header">
                <div class="exercise-title-section">
                    <div class="exercise-number">3</div>
                    <h2 class="exercise-title">Demonstrate MD5 Collision</h2>
                </div>
                <span class="exercise-status pending">Pending</span>
            </div>

            <p class="exercise-description">
                MD5 is cryptographically broken. Using known colliding inputs, demonstrate that two different
                messages can produce the same MD5 hash.
            </p>

            <div class="exercise-objective">
                <h4>Objective:</h4>
                <p>Calculate MD5 hashes for two different inputs to verify they produce identical hashes.</p>
            </div>

            <button class="btn" onclick="demonstrateMD5Collision()">Generate MD5 Collision</button>
            <button class="btn btn-hint" onclick="showHint(3)">Show Hint</button>

            <div id="md5-hint" class="hint-box">
                <div class="hint-title">üí° Hint</div>
                <div class="hint-content">
                    Click the "Generate MD5 Collision" button to see two different hex strings that produce
                    identical MD5 hashes. This uses known colliding values discovered by researchers in 2004.
                </div>
            </div>

            <div id="md5-result" class="result-box"></div>

            <div class="defense-section">
                <div class="defense-title">üõ°Ô∏è Defense Strategy</div>
                <div class="defense-content">
                    <p>MD5 must not be used for any security purpose:</p>
                    <ul>
                        <li>Replace MD5 with SHA-256 or SHA-3</li>
                        <li>Never use MD5 for password hashing, digital signatures, or integrity verification</li>
                        <li>Use bcrypt, scrypt, or Argon2 for password hashing</li>
                        <li>MD5 is acceptable only for non-security purposes (checksums for data integrity in trusted environments)</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Exercise 4: Padding Oracle -->
        <div class="exercise-card" data-exercise="4">
            <div class="exercise-header">
                <div class="exercise-title-section">
                    <div class="exercise-number">4</div>
                    <h2 class="exercise-title">Exploit a Padding Oracle</h2>
                </div>
                <span class="exercise-status pending">Pending</span>
            </div>

            <p class="exercise-description">
                A padding oracle reveals whether decrypted ciphertext has valid padding. This tiny information
                leak allows complete decryption. Simulate attacking a vulnerable server.
            </p>

            <div class="exercise-objective">
                <h4>Objective:</h4>
                <p>Understand the attack flow: Modify ciphertext ‚Üí Submit to oracle ‚Üí Oracle reveals padding validity ‚Üí Deduce plaintext</p>
            </div>

            <div class="code-block">
<span class="comment"># Simulated vulnerable server</span>
<span class="keyword">def</span> decrypt_and_check_padding(ciphertext):
    plaintext = aes_cbc_decrypt(ciphertext, key)
    <span class="keyword">if</span> valid_pkcs7_padding(plaintext):
        <span class="keyword">return</span> <span class="string">"Valid padding"</span>  <span class="comment"># ‚ö†Ô∏è Info leak!</span>
    <span class="keyword">else</span>:
        <span class="keyword">return</span> <span class="string">"Invalid padding"</span>
            </code>

            <button class="btn" onclick="simulatePaddingOracle()">Simulate Attack</button>
            <button class="btn btn-hint" onclick="showHint(4)">Show Hint</button>

            <div id="padding-hint" class="hint-box">
                <div class="hint-title">üí° Hint</div>
                <div class="hint-content">
                    The oracle tells us if padding is valid. By systematically modifying ciphertext bytes and
                    observing the oracle's response, we can deduce plaintext byte-by-byte. Each byte requires
                    an average of 128 requests (256 possible values, 50% chance on average).
                </div>
            </div>

            <div id="padding-result" class="result-box"></div>

            <div class="defense-section">
                <div class="defense-title">üõ°Ô∏è Defense Strategy</div>
                <div class="defense-content">
                    <p>Prevent padding oracle attacks:</p>
                    <ul>
                        <li>Use authenticated encryption (AES-GCM, ChaCha20-Poly1305) instead of CBC</li>
                        <li>Return identical error messages for all decryption failures</li>
                        <li>Implement constant-time padding validation</li>
                        <li>Use TLS 1.3 which uses only AEAD ciphers</li>
                        <li>Never reveal padding validity to clients</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Exercise 5: Bit-Flipping Attack -->
        <div class="exercise-card" data-exercise="5">
            <div class="exercise-header">
                <div class="exercise-title-section">
                    <div class="exercise-number">5</div>
                    <h2 class="exercise-title">Perform CBC Bit-Flipping Attack</h2>
                </div>
                <span class="exercise-status pending">Pending</span>
            </div>

            <p class="exercise-description">
                CBC mode is malleable: modifying ciphertext block C<sub>i</sub> causes predictable changes in
                plaintext block P<sub>i+1</sub>. Demonstrate changing "user=guest" to "user=admin".
            </p>

            <div class="exercise-objective">
                <h4>Objective:</h4>
                <p>Calculate the XOR modification needed to flip "guest" to "admin" in CBC ciphertext.</p>
            </div>

            <div class="code-block">
<span class="comment"># CBC decryption: P[i] = Decrypt(C[i]) ‚äï C[i-1]</span>
<span class="comment"># To change P[i] from "guest" to "admin":</span>
<span class="comment"># C[i-1]' = C[i-1] ‚äï "guest" ‚äï "admin"</span>

original = <span class="string">"guest"</span>
target = <span class="string">"admin"</span>
xor_diff = original ‚äï target
            </div>

            <div class="input-group">
                <label class="input-label">What is "guest" XOR "admin" in hex? (Hint: 'g' XOR 'a' = 0x67 XOR 0x61)</label>
                <input type="text" id="bitflip-answer" class="text-input" placeholder="06 05 04 12 13" style="min-height: auto;">
            </div>

            <button class="btn" onclick="checkBitFlip()">Check Answer</button>
            <button class="btn btn-hint" onclick="showHint(5)">Show Hint</button>

            <div id="bitflip-hint" class="hint-box">
                <div class="hint-title">üí° Hint</div>
                <div class="hint-content">
                    XOR each character: 'g'(0x67) ‚äï 'a'(0x61) = 0x06, 'u'(0x75) ‚äï 'd'(0x64) = 0x11, etc.
                    Calculate all five bytes and enter them in hex format separated by spaces.
                </div>
            </div>

            <div id="bitflip-result" class="result-box"></div>

            <div class="defense-section">
                <div class="defense-title">üõ°Ô∏è Defense Strategy</div>
                <div class="defense-content">
                    <p>Prevent bit-flipping attacks:</p>
                    <ul>
                        <li>Use authenticated encryption (AES-GCM) which detects any modification</li>
                        <li>Implement MAC (HMAC) to verify ciphertext integrity</li>
                        <li>Always encrypt-then-MAC, never MAC-then-encrypt</li>
                        <li>Reject any ciphertext that fails authentication</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Exercise 6: Timing Attack -->
        <div class="exercise-card" data-exercise="6">
            <div class="exercise-header">
                <div class="exercise-title-section">
                    <div class="exercise-number">6</div>
                    <h2 class="exercise-title">Identify Timing Leak</h2>
                </div>
                <span class="exercise-status pending">Pending</span>
            </div>

            <p class="exercise-description">
                Timing attacks exploit execution time differences that leak secret information. Identify
                the vulnerability in this password comparison function.
            </p>

            <div class="exercise-objective">
                <h4>Objective:</h4>
                <p>Identify which line of code creates a timing vulnerability that leaks password information.</p>
            </div>

            <div class="code-block">
1  <span class="keyword">def</span> check_password(user_input, stored_password):
2      <span class="keyword">if</span> len(user_input) != len(stored_password):
3          <span class="keyword">return</span> False
4      <span class="keyword">for</span> i <span class="keyword">in</span> range(len(user_input)):
5          <span class="keyword">if</span> user_input[i] != stored_password[i]:
6              <span class="keyword">return</span> False  <span class="comment"># ‚ö†Ô∏è Early return</span>
7      <span class="keyword">return</span> True
            </div>

            <div class="input-group">
                <label class="input-label">Which line number creates the timing vulnerability?</label>
                <input type="number" id="timing-answer" class="text-input" placeholder="6" style="min-height: auto;">
            </div>

            <button class="btn" onclick="checkTiming()">Check Answer</button>
            <button class="btn btn-hint" onclick="showHint(6)">Show Hint</button>

            <div id="timing-hint" class="hint-box">
                <div class="hint-title">üí° Hint</div>
                <div class="hint-content">
                    The vulnerability is the early return on line 6. When a character mismatches, the function
                    returns immediately. By measuring response time, attackers can determine how many characters
                    are correct. If "a***" takes 1ms but "ab**" takes 2ms, they know the second character is correct.
                </div>
            </div>

            <div id="timing-result" class="result-box"></div>

            <div class="defense-section">
                <div class="defense-title">üõ°Ô∏è Defense Strategy</div>
                <div class="defense-content">
                    <p>Implement constant-time comparison:</p>
                    <ul>
                        <li>Always compare all bytes, never return early</li>
                        <li>Use constant-time comparison functions (crypto.subtle.timingSafeEqual in Node.js)</li>
                        <li>Accumulate differences using bitwise OR, check result at end</li>
                        <li>Add random delays (less reliable, not recommended as sole defense)</li>
                        <li>Use hash comparison with constant-time equality check</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Exercise 7: Fix Vulnerable Code -->
        <div class="exercise-card" data-exercise="7">
            <div class="exercise-header">
                <div class="exercise-title-section">
                    <div class="exercise-number">7</div>
                    <h2 class="exercise-title">Fix Vulnerable Authentication</h2>
                </div>
                <span class="exercise-status pending">Pending</span>
            </div>

            <p class="exercise-description">
                This code attempts to authenticate messages but is vulnerable to length extension attacks.
                Fix it using the proper cryptographic construction.
            </p>

            <div class="exercise-objective">
                <h4>Objective:</h4>
                <p>Identify what secure construction should replace the vulnerable hash(secret||message) pattern.</p>
            </div>

            <div class="code-block">
<span class="comment"># VULNERABLE CODE</span>
<span class="keyword">def</span> authenticate_message(secret, message):
    signature = SHA256(secret + message)  <span class="comment"># ‚ö†Ô∏è Vulnerable!</span>
    <span class="keyword">return</span> signature

<span class="comment"># What should replace SHA256(secret + message)?</span>
            </div>

            <div class="input-group">
                <label class="input-label">Enter the correct construction (e.g., "HMAC-SHA256"):</label>
                <input type="text" id="fix-answer" class="text-input" placeholder="HMAC-SHA256" style="min-height: auto;">
            </div>

            <button class="btn" onclick="checkFix()">Check Answer</button>
            <button class="btn btn-hint" onclick="showHint(7)">Show Hint</button>

            <div id="fix-hint" class="hint-box">
                <div class="hint-title">üí° Hint</div>
                <div class="hint-content">
                    The construction hash(secret||message) is vulnerable to length extension attacks in
                    Merkle-Damg√•rd hash functions (MD5, SHA-1, SHA-256). Use HMAC (Hash-based Message
                    Authentication Code) instead, which is specifically designed for message authentication.
                </div>
            </div>

            <div id="fix-result" class="result-box"></div>

            <div class="defense-section">
                <div class="defense-title">üõ°Ô∏è Defense Strategy</div>
                <div class="defense-content">
                    <p>Secure message authentication:</p>
                    <ul>
                        <li>Always use HMAC-SHA256 or HMAC-SHA3 for message authentication</li>
                        <li>Never use hash(secret||message) or hash(message||secret)</li>
                        <li>SHA-3 is immune to length extension but still use HMAC for standardization</li>
                        <li>For encryption+authentication, use AEAD modes (AES-GCM, ChaCha20-Poly1305)</li>
                        <li>If implementing MAC manually, use encrypt-then-MAC construction</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Completion Section -->
        <section class="complete-section">
            <h2 style="color: var(--house-color); margin-bottom: 15px;">Lab Assessment</h2>
            <p style="color: var(--text-secondary); margin-bottom: 30px;">
                Complete all exercises to finish the Cryptanalysis Attack Lab
            </p>
            <button class="complete-btn" id="complete-btn" onclick="completeLab()" disabled>
                Complete Lab
            </button>
        </section>
    </main>

    <script>
        // Track completed exercises
        let completed = {
            1: false, 2: false, 3: false, 4: false, 5: false, 6: false, 7: false
        };

        // Update progress
        function updateProgress() {
            const total = Object.keys(completed).length;
            const done = Object.values(completed).filter(v => v).length;
            const percentage = (done / total) * 100;

            document.getElementById('progress-text').textContent = `${done}/${total} Complete`;
            document.getElementById('progress-fill').style.width = percentage + '%';

            // Enable complete button if all done
            document.getElementById('complete-btn').disabled = (done < total);
        }

        // Mark exercise complete
        function markComplete(exerciseNum) {
            if (!completed[exerciseNum]) {
                completed[exerciseNum] = true;
                const card = document.querySelector(`[data-exercise="${exerciseNum}"]`);
                card.classList.add('completed');
                const status = card.querySelector('.exercise-status');
                status.classList.remove('pending');
                status.classList.add('completed');
                status.textContent = 'Completed';
                updateProgress();
            }
        }

        // Show hint
        function showHint(exerciseNum) {
            const hint = document.getElementById(`${getExerciseId(exerciseNum)}-hint`);
            hint.classList.add('show');
        }

        // Get exercise ID
        function getExerciseId(num) {
            const ids = ['', 'caesar', 'birthday', 'md5', 'padding', 'bitflip', 'timing', 'fix'];
            return ids[num];
        }

        // Show result
        function showResult(exerciseNum, success, title, content) {
            const id = getExerciseId(exerciseNum);
            const result = document.getElementById(`${id}-result`);
            result.className = 'result-box show ' + (success ? 'success' : 'error');
            result.innerHTML = `
                <div class="result-icon">${success ? '‚úì' : '‚úó'}</div>
                <div class="result-title" style="color: ${success ? 'var(--success-green)' : 'var(--warning-red)'}">${title}</div>
                <div class="result-content">${content}</div>
            `;
            if (success) markComplete(exerciseNum);
        }

        // Exercise 1: Caesar Cipher
        function checkCaesar() {
            const answer = document.getElementById('caesar-answer').value.toLowerCase().trim();
            const correct = "that is a secret message encrypted with a simple caesar cipher";
            if (answer === correct) {
                showResult(1, true, 'Correct!', 'The plaintext is: "That is a secret message encrypted with a simple Caesar cipher"<br>The shift was 3 (or -23). Well done!');
            } else {
                showResult(1, false, 'Incorrect', 'Try again. Count the most frequent letter in the ciphertext and compare to English frequency.');
            }
        }

        // Exercise 2: Birthday Attack
        function checkBirthday() {
            const answer = parseInt(document.getElementById('birthday-answer').value);
            if (answer === 32) {
                showResult(2, true, 'Correct!', '2^32 ‚âà 4.3 billion hash operations give ~50% collision probability for a 64-bit hash. This is why 64-bit hashes are insecure against birthday attacks.');
            } else {
                showResult(2, false, 'Incorrect', 'Remember: birthday attack reduces security from 2^n to 2^(n/2). For 64-bit hash, that\'s 2^32.');
            }
        }

        // Exercise 3: MD5 Collision
        function demonstrateMD5Collision() {
            // Known MD5 collision hex strings
            const msg1 = "d131dd02c5e6eec4693d9a0698aff95c2fcab58712467eab4004583eb8fb7f8955ad340609f4b30283e488832571415a085125e8f7cdc99fd91dbdf280373c5bd8823e3156348f5bae6dacd436c919c6dd53e2b487da03fd02396306d248cda0e99f33420f577ee8ce54b67080a80d1ec69821bcb6a8839396f9652b6ff72a70";
            const msg2 = "d131dd02c5e6eec4693d9a0698aff95c2fcab50712467eab4004583eb8fb7f8955ad340609f4b30283e4888325f1415a085125e8f7cdc99fd91dbd7280373c5bd8823e3156348f5bae6dacd436c919c6dd53e23487da03fd02396306d248cda0e99f33420f577ee8ce54b67080280d1ec69821bcb6a8839396f965ab6ff72a70";

            const hash1 = CryptoJS.MD5(CryptoJS.enc.Hex.parse(msg1)).toString();
            const hash2 = CryptoJS.MD5(CryptoJS.enc.Hex.parse(msg2)).toString();

            const content = `
                <strong>Message 1 (first 64 hex chars):</strong><br>
                <code style="font-size: 0.85rem; color: var(--text-secondary);">${msg1.substring(0, 64)}...</code><br><br>
                <strong>Message 2 (first 64 hex chars):</strong><br>
                <code style="font-size: 0.85rem; color: var(--text-secondary);">${msg2.substring(0, 64)}...</code><br><br>
                <strong>MD5(Message 1):</strong><br>
                <code style="color: var(--success-green); font-weight: 600;">${hash1}</code><br><br>
                <strong>MD5(Message 2):</strong><br>
                <code style="color: var(--success-green); font-weight: 600;">${hash2}</code><br><br>
                ${hash1 === hash2 ? 'üö® <strong>COLLISION CONFIRMED!</strong> Two different messages produce identical hashes.' : ''}
            `;

            showResult(3, true, 'MD5 Collision Demonstrated', content);
        }

        // Exercise 4: Padding Oracle
        function simulatePaddingOracle() {
            const content = `
                <strong>Padding Oracle Attack Simulation:</strong><br><br>
                <strong>Step 1:</strong> Original ciphertext (2 blocks): C0 | C1<br>
                Target: Decrypt C1 without knowing the key<br><br>
                <strong>Step 2:</strong> Modify last byte of C0 from 0x00 to 0xFF<br>
                Submit to oracle: "Invalid padding" (255 times)<br>
                When oracle says "Valid padding" at 0x7B, we know P1[15] ‚äï 0x7B = 0x01<br><br>
                <strong>Step 3:</strong> Calculate: P1[15] = 0x7B ‚äï 0x01 = 0x7A = 'z'<br>
                One byte decrypted! Average: 128 requests per byte<br><br>
                <strong>Step 4:</strong> Repeat for all 16 bytes<br>
                Total requests: ~2,048 (128 √ó 16)<br><br>
                <strong>Result:</strong> Complete decryption without the key!
            `;
            showResult(4, true, 'Attack Successful', content);
        }

        // Exercise 5: Bit-Flipping
        function checkBitFlip() {
            const answer = document.getElementById('bitflip-answer').value.toLowerCase().trim();
            // "guest" XOR "admin" = [0x06, 0x11, 0x08, 0x12, 0x13]
            const correct = ["06 11 08 12 13", "0x06 0x11 0x08 0x12 0x13", "061108 1213"];
            const isCorrect = correct.some(c => answer.replace(/[^0-9a-f]/g, '') === c.replace(/[^0-9a-f]/g, ''));

            if (isCorrect) {
                showResult(5, true, 'Correct!', '"guest" XOR "admin" = [0x06, 0x11, 0x08, 0x12, 0x13]<br>By XORing the previous ciphertext block with this value, you change "guest" to "admin" in the next plaintext block!');
            } else {
                showResult(5, false, 'Incorrect', 'Calculate: g(0x67)‚äïa(0x61)=0x06, u(0x75)‚äïd(0x64)=0x11, etc. Enter as hex bytes.');
            }
        }

        // Exercise 6: Timing Attack
        function checkTiming() {
            const answer = parseInt(document.getElementById('timing-answer').value);
            if (answer === 6) {
                showResult(6, true, 'Correct!', 'Line 6 creates a timing vulnerability by returning immediately when a character mismatches. Execution time reveals how many characters are correct, allowing attackers to guess passwords character-by-character.');
            } else {
                showResult(6, false, 'Incorrect', 'Look for the early return statement that causes execution time to vary based on the secret data.');
            }
        }

        // Exercise 7: Fix Vulnerable Code
        function checkFix() {
            const answer = document.getElementById('fix-answer').value.toLowerCase().trim();
            const correct = ["hmac-sha256", "hmac-sha-256", "hmac", "hmac sha256"];
            if (correct.some(c => answer.includes(c))) {
                showResult(7, true, 'Correct!', 'HMAC-SHA256 is the correct construction for message authentication. It prevents length extension attacks and provides proper cryptographic authentication. Never use hash(secret||message) for authentication!');
            } else {
                showResult(7, false, 'Incorrect', 'The answer is a hash-based message authentication code. Think about the standard construction designed specifically to prevent length extension attacks.');
            }
        }

        // Complete lab
        function completeLab() {
            if (typeof ModuleProgress !== 'undefined') {
                ModuleProgress.complete('key', 'key-cryptanalysis-lab');
            }

            if (typeof AchievementManager !== 'undefined') {
                AchievementManager.unlock('crypto-breaker', {
                    title: 'Crypto Breaker',
                    description: 'Completed the Cryptanalysis Attack Lab',
                    house: 'key',
                    icon: 'üîì'
                });
            }

            alert('Congratulations! You have completed the Cryptanalysis Attack Lab.\n\nYou now understand how cryptographic systems can be attacked and how to defend against these attacks.');

            setTimeout(() => {
                window.location.href = '../../index.html';
            }, 1000);
        }

        // Initialize
        updateProgress();
    </script>
</body>
</html>
