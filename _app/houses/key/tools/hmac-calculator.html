<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <!-- Access Control -->
    <script src="../../../components/AccessGuard.js"></script>
    <script>
        AccessGuard.require('sorted');
    </script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HMAC Calculator - House of the Key</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --house-color: #06b6d4;
            --house-glow: rgba(6, 182, 212, 0.4);
            --bg-dark: #0a0a12;
            --bg-card: rgba(15, 15, 25, 0.8);
            --text-primary: #e8e8f0;
            --text-secondary: #8888aa;
            --input-bg: rgba(20, 20, 30, 0.8);
            --success-green: #10b981;
            --warning-red: #ef4444;
            --info-blue: #3b82f6;
        }

        body {
            min-height: 100vh;
            background: var(--bg-dark);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: var(--text-primary);
            overflow-x: hidden;
        }

        /* Header */
        .module-header {
            padding: 20px 30px;
            background: rgba(10, 10, 18, 0.95);
            border-bottom: 1px solid rgba(6, 182, 212, 0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .back-btn {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            border: 1px solid rgba(6, 182, 212, 0.3);
            background: transparent;
            color: var(--house-color);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            font-size: 1.2rem;
        }

        .back-btn:hover {
            background: rgba(6, 182, 212, 0.1);
        }

        .module-title {
            font-size: 1rem;
            font-weight: 500;
            color: var(--text-primary);
        }

        .house-badge {
            font-size: 0.7rem;
            padding: 4px 12px;
            background: rgba(6, 182, 212, 0.15);
            border: 1px solid rgba(6, 182, 212, 0.3);
            border-radius: 20px;
            color: var(--house-color);
            letter-spacing: 0.1em;
        }

        /* Container */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 40px 30px;
        }

        /* Intro */
        .intro {
            text-align: center;
            margin-bottom: 40px;
        }

        .intro-icon {
            font-size: 3rem;
            margin-bottom: 15px;
            filter: drop-shadow(0 0 15px var(--house-glow));
        }

        .intro-title {
            font-size: 2rem;
            font-weight: 300;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #fff, var(--house-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .intro-subtitle {
            color: var(--text-secondary);
            max-width: 600px;
            margin: 0 auto;
        }

        /* Tab Navigation */
        .tab-nav {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            border-bottom: 1px solid rgba(6, 182, 212, 0.2);
            padding-bottom: 0;
        }

        .tab-btn {
            background: transparent;
            border: none;
            padding: 12px 24px;
            color: var(--text-secondary);
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.3s ease;
            font-size: 0.95rem;
        }

        .tab-btn:hover {
            color: var(--house-color);
        }

        .tab-btn.active {
            color: var(--house-color);
            border-bottom-color: var(--house-color);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Tool Panel */
        .tool-panel {
            background: var(--bg-card);
            border: 1px solid rgba(6, 182, 212, 0.2);
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
        }

        .panel-title {
            font-size: 1.3rem;
            color: var(--house-color);
            margin-bottom: 20px;
            font-weight: 500;
        }

        .panel-description {
            color: var(--text-secondary);
            margin-bottom: 25px;
            line-height: 1.6;
        }

        /* Form Controls */
        .control-group {
            margin-bottom: 20px;
        }

        .control-label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-secondary);
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .control-input,
        .control-textarea,
        .control-select {
            width: 100%;
            background: var(--input-bg);
            border: 1px solid rgba(6, 182, 212, 0.3);
            border-radius: 6px;
            padding: 12px;
            color: var(--text-primary);
            font-family: 'Courier New', monospace;
            font-size: 0.95rem;
        }

        .control-textarea {
            resize: vertical;
            min-height: 100px;
        }

        .control-select {
            cursor: pointer;
        }

        .control-input:focus,
        .control-textarea:focus,
        .control-select:focus {
            outline: none;
            border-color: var(--house-color);
            box-shadow: 0 0 0 3px rgba(6, 182, 212, 0.1);
        }

        /* Buttons */
        .btn-primary {
            background: linear-gradient(135deg, var(--house-color), #22d3ee);
            border: none;
            border-radius: 6px;
            padding: 12px 30px;
            color: #0a0a12;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease;
            font-size: 0.95rem;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: rgba(6, 182, 212, 0.1);
            border: 1px solid rgba(6, 182, 212, 0.3);
            border-radius: 6px;
            padding: 12px 30px;
            color: var(--house-color);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.95rem;
        }

        .btn-secondary:hover {
            background: rgba(6, 182, 212, 0.2);
        }

        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        /* Output Display */
        .output-section {
            background: rgba(6, 182, 212, 0.05);
            border: 1px solid rgba(6, 182, 212, 0.2);
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
        }

        .output-label {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .output-value {
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(6, 182, 212, 0.3);
            border-radius: 6px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            color: #22d3ee;
            word-break: break-all;
            font-size: 0.9rem;
        }

        .output-meta {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        /* Visual Diagram */
        .visual-diagram {
            background: rgba(6, 182, 212, 0.05);
            border: 1px solid rgba(6, 182, 212, 0.2);
            border-radius: 10px;
            padding: 25px;
            margin: 20px 0;
        }

        .diagram-title {
            font-size: 1rem;
            color: var(--house-color);
            margin-bottom: 20px;
            text-align: center;
            font-weight: 500;
        }

        .flow-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
            align-items: center;
        }

        .flow-row {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .flow-box {
            background: rgba(6, 182, 212, 0.1);
            border: 1px solid rgba(6, 182, 212, 0.3);
            border-radius: 8px;
            padding: 12px 16px;
            text-align: center;
            min-width: 100px;
        }

        .flow-box-label {
            font-size: 0.7rem;
            color: var(--text-secondary);
            margin-bottom: 5px;
            text-transform: uppercase;
        }

        .flow-box-value {
            font-family: 'Courier New', monospace;
            color: var(--text-primary);
            font-size: 0.85rem;
            word-break: break-all;
        }

        .flow-arrow {
            color: var(--house-color);
            font-size: 1.5rem;
        }

        /* Alert Boxes */
        .alert {
            padding: 15px 20px;
            border-radius: 6px;
            margin: 15px 0;
            border-left: 4px solid;
        }

        .alert-success {
            background: rgba(16, 185, 129, 0.1);
            border-color: var(--success-green);
            color: var(--success-green);
        }

        .alert-error {
            background: rgba(239, 68, 68, 0.1);
            border-color: var(--warning-red);
            color: var(--warning-red);
        }

        .alert-info {
            background: rgba(6, 182, 212, 0.1);
            border-color: var(--house-color);
            color: var(--house-color);
        }

        /* Timing Attack Simulator */
        .timing-display {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }

        .timing-column {
            background: rgba(6, 182, 212, 0.05);
            border: 1px solid rgba(6, 182, 212, 0.2);
            border-radius: 8px;
            padding: 20px;
        }

        .timing-title {
            font-size: 1rem;
            color: var(--house-color);
            margin-bottom: 15px;
            font-weight: 500;
        }

        .timing-bar {
            background: rgba(6, 182, 212, 0.1);
            border-radius: 4px;
            height: 30px;
            margin: 10px 0;
            position: relative;
            overflow: hidden;
        }

        .timing-fill {
            background: linear-gradient(90deg, var(--house-color), #22d3ee);
            height: 100%;
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 10px;
            font-size: 0.8rem;
            color: #0a0a12;
            font-weight: 600;
        }

        /* JWT Display */
        .jwt-display {
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(6, 182, 212, 0.3);
            border-radius: 6px;
            padding: 20px;
            margin: 15px 0;
            font-family: 'Courier New', monospace;
        }

        .jwt-part {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
        }

        .jwt-header {
            background: rgba(239, 68, 68, 0.1);
            border-left: 3px solid var(--warning-red);
        }

        .jwt-payload {
            background: rgba(16, 185, 129, 0.1);
            border-left: 3px solid var(--success-green);
        }

        .jwt-signature {
            background: rgba(6, 182, 212, 0.1);
            border-left: 3px solid var(--house-color);
        }

        .jwt-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-bottom: 5px;
            text-transform: uppercase;
        }

        .jwt-value {
            color: #22d3ee;
            word-break: break-all;
            font-size: 0.85rem;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 30px 20px;
            }

            .timing-display {
                grid-template-columns: 1fr;
            }

            .tab-nav {
                overflow-x: auto;
            }

            .flow-row {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="module-header">
        <div class="header-left">
            <button class="back-btn" onclick="window.location.href='../../../index.html'" title="Back to Key House">‚Üê</button>
            <h1 class="module-title">HMAC Calculator</h1>
            <span class="house-badge">KEY HOUSE</span>
        </div>
    </header>

    <!-- Main Container -->
    <div class="container">
        <!-- Intro -->
        <div class="intro">
            <div class="intro-icon">üîê</div>
            <h1 class="intro-title">Interactive HMAC Tool</h1>
            <p class="intro-subtitle">
                Explore message authentication codes through hands-on experimentation with HMAC algorithms,
                timing attack simulations, and JWT signature verification.
            </p>
        </div>

        <!-- Tab Navigation -->
        <div class="tab-nav">
            <button class="tab-btn active" onclick="switchTab('calculator')">HMAC Calculator</button>
            <button class="tab-btn" onclick="switchTab('construction')">Construction Visualizer</button>
            <button class="tab-btn" onclick="switchTab('timing')">Timing Attack Demo</button>
            <button class="tab-btn" onclick="switchTab('verification')">MAC Verification</button>
            <button class="tab-btn" onclick="switchTab('aead')">Encrypt-then-MAC</button>
            <button class="tab-btn" onclick="switchTab('jwt')">JWT Tool</button>
        </div>

        <!-- Tab 1: HMAC Calculator -->
        <div id="calculator" class="tab-content active">
            <div class="tool-panel">
                <h2 class="panel-title">HMAC Generator</h2>
                <p class="panel-description">
                    Generate HMAC signatures using different hash algorithms. The secret key and message are
                    combined cryptographically to produce a fixed-size authentication tag.
                </p>

                <div class="control-group">
                    <label class="control-label">Hash Algorithm</label>
                    <select class="control-select" id="calc-algorithm">
                        <option value="SHA-256">HMAC-SHA256 (Most Common)</option>
                        <option value="SHA-384">HMAC-SHA384</option>
                        <option value="SHA-512">HMAC-SHA512</option>
                        <option value="SHA-1">HMAC-SHA1 (Deprecated)</option>
                    </select>
                </div>

                <div class="control-group">
                    <label class="control-label">Secret Key</label>
                    <input type="text" class="control-input" id="calc-key" placeholder="Enter secret key..." value="my-secret-key-2024">
                </div>

                <div class="control-group">
                    <label class="control-label">Message</label>
                    <textarea class="control-textarea" id="calc-message" placeholder="Enter message to authenticate...">The quick brown fox jumps over the lazy dog</textarea>
                </div>

                <div class="btn-group">
                    <button class="btn-primary" onclick="calculateHMAC()">Generate HMAC</button>
                    <button class="btn-secondary" onclick="copyToClipboard('calc-output')">Copy Result</button>
                </div>

                <div class="output-section" id="calc-output-section" style="display: none;">
                    <div class="output-label">HMAC Output</div>
                    <div class="output-value" id="calc-output"></div>
                    <div class="output-meta">
                        <span id="calc-output-length"></span>
                        <span id="calc-output-time"></span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab 2: Construction Visualizer -->
        <div id="construction" class="tab-content">
            <div class="tool-panel">
                <h2 class="panel-title">HMAC Construction Visualizer</h2>
                <p class="panel-description">
                    See how HMAC combines the key and message using nested hashing with inner and outer padding.
                    Formula: HMAC(K, m) = H((K ‚äï opad) || H((K ‚äï ipad) || m))
                </p>

                <div class="control-group">
                    <label class="control-label">Key (will be padded to block size)</label>
                    <input type="text" class="control-input" id="const-key" placeholder="Enter key..." value="secret">
                </div>

                <div class="control-group">
                    <label class="control-label">Message</label>
                    <input type="text" class="control-input" id="const-message" placeholder="Enter message..." value="data">
                </div>

                <button class="btn-primary" onclick="visualizeConstruction()">Visualize Construction</button>

                <div id="const-diagram" style="display: none;">
                    <div class="visual-diagram">
                        <div class="diagram-title">HMAC-SHA256 Construction Steps</div>

                        <div class="flow-container">
                            <!-- Step 1: Key Padding -->
                            <div style="width: 100%;">
                                <div style="color: var(--house-color); margin-bottom: 10px; font-weight: 500;">Step 1: Key Preparation</div>
                                <div class="flow-row">
                                    <div class="flow-box">
                                        <div class="flow-box-label">Original Key</div>
                                        <div class="flow-box-value" id="const-key-original"></div>
                                    </div>
                                    <div class="flow-arrow">‚Üí</div>
                                    <div class="flow-box">
                                        <div class="flow-box-label">Padded Key (64 bytes)</div>
                                        <div class="flow-box-value" id="const-key-padded"></div>
                                    </div>
                                </div>
                            </div>

                            <!-- Step 2: Inner Hash -->
                            <div style="width: 100%; margin-top: 20px;">
                                <div style="color: var(--house-color); margin-bottom: 10px; font-weight: 500;">Step 2: Inner Hash</div>
                                <div class="flow-row">
                                    <div class="flow-box">
                                        <div class="flow-box-label">K ‚äï ipad</div>
                                        <div class="flow-box-value" id="const-ipad-xor"></div>
                                    </div>
                                    <div class="flow-arrow">||</div>
                                    <div class="flow-box">
                                        <div class="flow-box-label">Message</div>
                                        <div class="flow-box-value" id="const-message-display"></div>
                                    </div>
                                    <div class="flow-arrow">‚Üí</div>
                                    <div class="flow-box" style="background: rgba(6, 182, 212, 0.2);">
                                        <div class="flow-box-label">Inner Hash</div>
                                        <div class="flow-box-value" id="const-inner-hash"></div>
                                    </div>
                                </div>
                            </div>

                            <!-- Step 3: Outer Hash -->
                            <div style="width: 100%; margin-top: 20px;">
                                <div style="color: var(--house-color); margin-bottom: 10px; font-weight: 500;">Step 3: Outer Hash (Final HMAC)</div>
                                <div class="flow-row">
                                    <div class="flow-box">
                                        <div class="flow-box-label">K ‚äï opad</div>
                                        <div class="flow-box-value" id="const-opad-xor"></div>
                                    </div>
                                    <div class="flow-arrow">||</div>
                                    <div class="flow-box" style="background: rgba(6, 182, 212, 0.2);">
                                        <div class="flow-box-label">Inner Hash</div>
                                        <div class="flow-box-value" id="const-inner-display"></div>
                                    </div>
                                    <div class="flow-arrow">‚Üí</div>
                                    <div class="flow-box" style="background: rgba(16, 185, 129, 0.2); border-color: #10b981;">
                                        <div class="flow-box-label">Final HMAC</div>
                                        <div class="flow-box-value" id="const-final-hmac"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab 3: Timing Attack Demo -->
        <div id="timing" class="tab-content">
            <div class="tool-panel">
                <h2 class="panel-title">Timing Attack Simulator</h2>
                <p class="panel-description">
                    Understand why constant-time comparison is critical. A naive comparison leaks information
                    through execution time differences based on where the first mismatch occurs.
                </p>

                <div class="control-group">
                    <label class="control-label">Expected MAC (Correct)</label>
                    <input type="text" class="control-input" id="timing-expected" value="a1b2c3d4e5f6" readonly>
                </div>

                <div class="control-group">
                    <label class="control-label">Attacker's Attempt</label>
                    <input type="text" class="control-input" id="timing-attempt" placeholder="Try to guess the MAC..." value="000000000000">
                </div>

                <button class="btn-primary" onclick="simulateTimingAttack()">Compare MACs</button>

                <div class="timing-display" id="timing-results" style="display: none;">
                    <div class="timing-column">
                        <div class="timing-title">‚ö†Ô∏è Vulnerable: Early Exit</div>
                        <p style="color: var(--text-secondary); font-size: 0.85rem; margin-bottom: 15px;">
                            Returns immediately on first mismatch
                        </p>
                        <div class="timing-bar">
                            <div class="timing-fill" id="timing-vulnerable-bar"></div>
                        </div>
                        <div style="margin-top: 10px; color: var(--text-secondary); font-size: 0.85rem;">
                            <span id="timing-vulnerable-text"></span>
                        </div>
                    </div>

                    <div class="timing-column">
                        <div class="timing-title">‚úì Secure: Constant Time</div>
                        <p style="color: var(--text-secondary); font-size: 0.85rem; margin-bottom: 15px;">
                            Always examines every byte
                        </p>
                        <div class="timing-bar">
                            <div class="timing-fill" id="timing-secure-bar"></div>
                        </div>
                        <div style="margin-top: 10px; color: var(--text-secondary); font-size: 0.85rem;">
                            <span id="timing-secure-text"></span>
                        </div>
                    </div>
                </div>

                <div class="alert alert-info" style="margin-top: 20px;">
                    Notice how the vulnerable comparison time changes based on how many characters match,
                    while the constant-time version always takes the same time regardless of where differences occur.
                </div>
            </div>
        </div>

        <!-- Tab 4: MAC Verification -->
        <div id="verification" class="tab-content">
            <div class="tool-panel">
                <h2 class="panel-title">MAC Verification Tool</h2>
                <p class="panel-description">
                    Verify message authenticity by comparing a received MAC against the expected value.
                    Try modifying the message or MAC to see verification fail.
                </p>

                <div class="control-group">
                    <label class="control-label">Secret Key</label>
                    <input type="text" class="control-input" id="verify-key" placeholder="Enter secret key..." value="shared-secret-key">
                </div>

                <div class="control-group">
                    <label class="control-label">Message</label>
                    <textarea class="control-textarea" id="verify-message" placeholder="Enter received message...">Transfer $100 to Alice</textarea>
                </div>

                <div class="control-group">
                    <label class="control-label">Received MAC</label>
                    <input type="text" class="control-input" id="verify-mac" placeholder="Paste MAC to verify...">
                </div>

                <div class="btn-group">
                    <button class="btn-primary" onclick="generateMACForVerification()">Generate Expected MAC</button>
                    <button class="btn-secondary" onclick="verifyMAC()">Verify MAC</button>
                </div>

                <div id="verify-result"></div>
            </div>
        </div>

        <!-- Tab 5: Encrypt-then-MAC -->
        <div id="aead" class="tab-content">
            <div class="tool-panel">
                <h2 class="panel-title">Encrypt-then-MAC Visualizer</h2>
                <p class="panel-description">
                    Demonstrate the recommended pattern for authenticated encryption: encrypt the plaintext,
                    then compute MAC over the ciphertext.
                </p>

                <div class="control-group">
                    <label class="control-label">Plaintext</label>
                    <textarea class="control-textarea" id="aead-plaintext" placeholder="Enter plaintext...">Secret message contents</textarea>
                </div>

                <div class="control-group">
                    <label class="control-label">Encryption Key</label>
                    <input type="text" class="control-input" id="aead-enc-key" placeholder="Encryption key..." value="encryption-key-123">
                </div>

                <div class="control-group">
                    <label class="control-label">MAC Key (must be different!)</label>
                    <input type="text" class="control-input" id="aead-mac-key" placeholder="MAC key..." value="mac-key-456">
                </div>

                <button class="btn-primary" onclick="demonstrateEncryptThenMAC()">Encrypt then MAC</button>

                <div id="aead-result" style="display: none;">
                    <div class="visual-diagram">
                        <div class="diagram-title">Encrypt-then-MAC Process</div>

                        <div class="output-section">
                            <div class="output-label">1. Plaintext</div>
                            <div class="output-value" id="aead-plain-display"></div>
                        </div>

                        <div class="output-section">
                            <div class="output-label">2. Ciphertext (after encryption)</div>
                            <div class="output-value" id="aead-cipher-display"></div>
                        </div>

                        <div class="output-section">
                            <div class="output-label">3. MAC Tag (HMAC of ciphertext)</div>
                            <div class="output-value" id="aead-mac-display"></div>
                        </div>

                        <div class="output-section">
                            <div class="output-label">4. Final Message (Ciphertext || MAC)</div>
                            <div class="output-value" id="aead-final-display"></div>
                            <div style="margin-top: 10px; color: var(--text-secondary); font-size: 0.85rem;">
                                Recipient verifies MAC before attempting decryption
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab 6: JWT Tool -->
        <div id="jwt" class="tab-content">
            <div class="tool-panel">
                <h2 class="panel-title">JWT Signature Generator</h2>
                <p class="panel-description">
                    Create and verify JSON Web Tokens (JWTs) using HMAC signatures. JWTs are widely used
                    for API authentication and session management.
                </p>

                <div class="control-group">
                    <label class="control-label">Payload (JSON)</label>
                    <textarea class="control-textarea" id="jwt-payload" placeholder='{"user": "alice", "role": "admin"}'>{"sub": "user123", "name": "Alice", "exp": 1735689600}</textarea>
                </div>

                <div class="control-group">
                    <label class="control-label">Secret Key</label>
                    <input type="text" class="control-input" id="jwt-secret" placeholder="Enter JWT secret..." value="jwt-secret-key-2024">
                </div>

                <div class="btn-group">
                    <button class="btn-primary" onclick="generateJWT()">Generate JWT</button>
                    <button class="btn-secondary" onclick="verifyJWT()">Verify JWT</button>
                </div>

                <div id="jwt-result"></div>
            </div>
        </div>
    </div>

    <script>
        // Tab switching
        function switchTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            // Show selected tab
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
        }

        // Tab 1: HMAC Calculator
        async function calculateHMAC() {
            const algorithm = document.getElementById('calc-algorithm').value;
            const key = document.getElementById('calc-key').value;
            const message = document.getElementById('calc-message').value;

            if (!key || !message) {
                alert('Please enter both key and message');
                return;
            }

            const startTime = performance.now();

            try {
                const encoder = new TextEncoder();
                const keyData = encoder.encode(key);
                const messageData = encoder.encode(message);

                const cryptoKey = await crypto.subtle.importKey(
                    'raw',
                    keyData,
                    { name: 'HMAC', hash: algorithm },
                    false,
                    ['sign']
                );

                const signature = await crypto.subtle.sign('HMAC', cryptoKey, messageData);
                const hashArray = Array.from(new Uint8Array(signature));
                const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');

                const endTime = performance.now();
                const duration = (endTime - startTime).toFixed(2);

                document.getElementById('calc-output').textContent = hashHex;
                document.getElementById('calc-output-length').textContent = `Length: ${hashArray.length} bytes`;
                document.getElementById('calc-output-time').textContent = `Computed in ${duration}ms`;
                document.getElementById('calc-output-section').style.display = 'block';
            } catch (error) {
                alert('Error computing HMAC: ' + error.message);
            }
        }

        // Tab 2: Construction Visualizer
        async function visualizeConstruction() {
            const key = document.getElementById('const-key').value;
            const message = document.getElementById('const-message').value;

            if (!key || !message) {
                alert('Please enter both key and message');
                return;
            }

            const encoder = new TextEncoder();

            // Show original inputs
            document.getElementById('const-key-original').textContent = key;
            document.getElementById('const-message-display').textContent = message;
            document.getElementById('const-message-display').textContent = message;

            // Simplified visualization (actual HMAC is more complex)
            const keyBytes = encoder.encode(key);
            const messageBytes = encoder.encode(message);

            // Show key in hex (truncated for display)
            const keyHex = Array.from(keyBytes).map(b => b.toString(16).padStart(2, '0')).join('');
            document.getElementById('const-key-padded').textContent = keyHex.substring(0, 32) + '...';

            // ipad XOR (0x36 repeated)
            const ipadXor = Array.from(keyBytes.slice(0, 8)).map(b => (b ^ 0x36).toString(16).padStart(2, '0')).join('');
            document.getElementById('const-ipad-xor').textContent = ipadXor + '...';

            // opad XOR (0x5c repeated)
            const opadXor = Array.from(keyBytes.slice(0, 8)).map(b => (b ^ 0x5c).toString(16).padStart(2, '0')).join('');
            document.getElementById('const-opad-xor').textContent = opadXor + '...';

            // Compute actual HMAC and show intermediate values
            const cryptoKey = await crypto.subtle.importKey(
                'raw',
                keyBytes,
                { name: 'HMAC', hash: 'SHA-256' },
                false,
                ['sign']
            );

            const signature = await crypto.subtle.sign('HMAC', cryptoKey, messageBytes);
            const hashHex = Array.from(new Uint8Array(signature)).map(b => b.toString(16).padStart(2, '0')).join('');

            // Display inner hash (simplified - showing final result)
            const innerHash = hashHex.substring(0, 16) + '...';
            document.getElementById('const-inner-hash').textContent = innerHash;
            document.getElementById('const-inner-display').textContent = innerHash;

            // Display final HMAC
            document.getElementById('const-final-hmac').textContent = hashHex.substring(0, 16) + '...';

            document.getElementById('const-diagram').style.display = 'block';
        }

        // Tab 3: Timing Attack Simulator
        function simulateTimingAttack() {
            const expected = document.getElementById('timing-expected').value;
            const attempt = document.getElementById('timing-attempt').value;

            // Vulnerable comparison (early exit)
            let vulnerableTime = 0;
            let matchedBytes = 0;
            const minLen = Math.min(expected.length, attempt.length);

            for (let i = 0; i < minLen; i++) {
                vulnerableTime += 10; // 10ms per byte comparison
                if (expected[i] !== attempt[i]) {
                    break;
                }
                matchedBytes++;
            }

            // Constant-time comparison
            const constantTime = Math.max(expected.length, attempt.length) * 10;

            // Update display
            const maxTime = constantTime;
            const vulnerablePercent = (vulnerableTime / maxTime) * 100;
            const constantPercent = 100;

            document.getElementById('timing-vulnerable-bar').style.width = vulnerablePercent + '%';
            document.getElementById('timing-vulnerable-bar').textContent = vulnerableTime + 'ms';
            document.getElementById('timing-vulnerable-text').textContent =
                `Matched ${matchedBytes} of ${expected.length} bytes before failing`;

            document.getElementById('timing-secure-bar').style.width = constantPercent + '%';
            document.getElementById('timing-secure-bar').textContent = constantTime + 'ms';
            document.getElementById('timing-secure-text').textContent =
                `Always checks all ${Math.max(expected.length, attempt.length)} bytes`;

            document.getElementById('timing-results').style.display = 'grid';

            // Show alert if mismatch
            if (vulnerableTime !== constantTime) {
                setTimeout(() => {
                    alert('Notice: Vulnerable comparison took ' + vulnerableTime + 'ms, revealing that ' +
                          matchedBytes + ' bytes matched. An attacker can use this timing difference to guess the MAC byte by byte!');
                }, 500);
            }
        }

        // Tab 4: MAC Verification
        async function generateMACForVerification() {
            const key = document.getElementById('verify-key').value;
            const message = document.getElementById('verify-message').value;

            if (!key || !message) {
                alert('Please enter both key and message');
                return;
            }

            const encoder = new TextEncoder();
            const keyData = encoder.encode(key);
            const messageData = encoder.encode(message);

            const cryptoKey = await crypto.subtle.importKey(
                'raw',
                keyData,
                { name: 'HMAC', hash: 'SHA-256' },
                false,
                ['sign']
            );

            const signature = await crypto.subtle.sign('HMAC', cryptoKey, messageData);
            const hashHex = Array.from(new Uint8Array(signature)).map(b => b.toString(16).padStart(2, '0')).join('');

            document.getElementById('verify-mac').value = hashHex;

            document.getElementById('verify-result').innerHTML = `
                <div class="alert alert-info" style="margin-top: 20px;">
                    Expected MAC generated. Now you can verify it or try modifying the message/MAC to see verification fail.
                </div>
            `;
        }

        async function verifyMAC() {
            const key = document.getElementById('verify-key').value;
            const message = document.getElementById('verify-message').value;
            const receivedMAC = document.getElementById('verify-mac').value;

            if (!key || !message || !receivedMAC) {
                alert('Please fill in all fields and generate/paste a MAC');
                return;
            }

            // Generate expected MAC
            const encoder = new TextEncoder();
            const keyData = encoder.encode(key);
            const messageData = encoder.encode(message);

            const cryptoKey = await crypto.subtle.importKey(
                'raw',
                keyData,
                { name: 'HMAC', hash: 'SHA-256' },
                false,
                ['sign']
            );

            const signature = await crypto.subtle.sign('HMAC', cryptoKey, messageData);
            const expectedMAC = Array.from(new Uint8Array(signature)).map(b => b.toString(16).padStart(2, '0')).join('');

            // Constant-time comparison simulation
            const isValid = expectedMAC === receivedMAC;

            if (isValid) {
                document.getElementById('verify-result').innerHTML = `
                    <div class="alert alert-success" style="margin-top: 20px;">
                        ‚úì <strong>MAC Verification Successful</strong><br>
                        The message is authentic and has not been tampered with.
                    </div>
                `;
            } else {
                document.getElementById('verify-result').innerHTML = `
                    <div class="alert alert-error" style="margin-top: 20px;">
                        ‚úó <strong>MAC Verification Failed</strong><br>
                        The message has been tampered with or the key is incorrect.<br>
                        <div style="margin-top: 10px; font-family: 'Courier New', monospace; font-size: 0.85rem;">
                            Expected: ${expectedMAC}<br>
                            Received: ${receivedMAC}
                        </div>
                    </div>
                `;
            }
        }

        // Tab 5: Encrypt-then-MAC
        async function demonstrateEncryptThenMAC() {
            const plaintext = document.getElementById('aead-plaintext').value;
            const encKey = document.getElementById('aead-enc-key').value;
            const macKey = document.getElementById('aead-mac-key').value;

            if (!plaintext || !encKey || !macKey) {
                alert('Please fill in all fields');
                return;
            }

            if (encKey === macKey) {
                alert('Warning: Encryption and MAC keys should be different! Using the same key is a security risk.');
            }

            const encoder = new TextEncoder();
            const plaintextBytes = encoder.encode(plaintext);

            // Simulate encryption (using simple XOR for demo - not secure!)
            const encKeyBytes = encoder.encode(encKey);
            const ciphertext = Array.from(plaintextBytes).map((b, i) =>
                b ^ encKeyBytes[i % encKeyBytes.length]
            );
            const ciphertextHex = ciphertext.map(b => b.toString(16).padStart(2, '0')).join('');

            // Compute MAC over ciphertext
            const ciphertextBytes = new Uint8Array(ciphertext);
            const macKeyData = encoder.encode(macKey);

            const cryptoKey = await crypto.subtle.importKey(
                'raw',
                macKeyData,
                { name: 'HMAC', hash: 'SHA-256' },
                false,
                ['sign']
            );

            const signature = await crypto.subtle.sign('HMAC', cryptoKey, ciphertextBytes);
            const macHex = Array.from(new Uint8Array(signature)).map(b => b.toString(16).padStart(2, '0')).join('');

            // Display results
            document.getElementById('aead-plain-display').textContent = plaintext;
            document.getElementById('aead-cipher-display').textContent = ciphertextHex;
            document.getElementById('aead-mac-display').textContent = macHex;
            document.getElementById('aead-final-display').textContent = ciphertextHex + macHex;

            document.getElementById('aead-result').style.display = 'block';
        }

        // Tab 6: JWT Generator
        async function generateJWT() {
            const payloadStr = document.getElementById('jwt-payload').value;
            const secret = document.getElementById('jwt-secret').value;

            if (!payloadStr || !secret) {
                alert('Please enter both payload and secret');
                return;
            }

            try {
                // Validate JSON
                JSON.parse(payloadStr);

                // Create header
                const header = {
                    alg: 'HS256',
                    typ: 'JWT'
                };

                // Base64 encode
                const base64Header = btoa(JSON.stringify(header));
                const base64Payload = btoa(payloadStr);
                const unsignedToken = base64Header + '.' + base64Payload;

                // Generate signature
                const encoder = new TextEncoder();
                const keyData = encoder.encode(secret);
                const messageData = encoder.encode(unsignedToken);

                const cryptoKey = await crypto.subtle.importKey(
                    'raw',
                    keyData,
                    { name: 'HMAC', hash: 'SHA-256' },
                    false,
                    ['sign']
                );

                const signature = await crypto.subtle.sign('HMAC', cryptoKey, messageData);
                const signatureArray = Array.from(new Uint8Array(signature));
                const base64Signature = btoa(String.fromCharCode(...signatureArray))
                    .replace(/\+/g, '-').replace(/\//g, '_').replace(/=/g, '');

                const jwt = unsignedToken + '.' + base64Signature;

                // Display JWT
                document.getElementById('jwt-result').innerHTML = `
                    <div class="jwt-display">
                        <div class="jwt-part jwt-header">
                            <div class="jwt-label">Header (Algorithm & Type)</div>
                            <div class="jwt-value">${base64Header}</div>
                            <div style="margin-top: 5px; color: var(--text-secondary); font-size: 0.8rem;">
                                Decoded: ${JSON.stringify(header)}
                            </div>
                        </div>

                        <div class="jwt-part jwt-payload">
                            <div class="jwt-label">Payload (Claims)</div>
                            <div class="jwt-value">${base64Payload}</div>
                            <div style="margin-top: 5px; color: var(--text-secondary); font-size: 0.8rem;">
                                Decoded: ${payloadStr}
                            </div>
                        </div>

                        <div class="jwt-part jwt-signature">
                            <div class="jwt-label">Signature (HMAC-SHA256)</div>
                            <div class="jwt-value">${base64Signature}</div>
                        </div>

                        <div style="margin-top: 20px; padding: 15px; background: rgba(6, 182, 212, 0.1); border-radius: 6px;">
                            <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 10px;">Complete JWT:</div>
                            <div style="word-break: break-all; color: #22d3ee; font-size: 0.9rem;">${jwt}</div>
                        </div>
                    </div>
                `;
            } catch (error) {
                alert('Error generating JWT: ' + error.message);
            }
        }

        async function verifyJWT() {
            const jwt = prompt('Paste JWT to verify:');
            if (!jwt) return;

            const secret = document.getElementById('jwt-secret').value;
            if (!secret) {
                alert('Please enter the secret key first');
                return;
            }

            try {
                const parts = jwt.split('.');
                if (parts.length !== 3) {
                    throw new Error('Invalid JWT format');
                }

                const [header, payload, signature] = parts;

                // Verify signature
                const unsignedToken = header + '.' + payload;
                const encoder = new TextEncoder();
                const keyData = encoder.encode(secret);
                const messageData = encoder.encode(unsignedToken);

                const cryptoKey = await crypto.subtle.importKey(
                    'raw',
                    keyData,
                    { name: 'HMAC', hash: 'SHA-256' },
                    false,
                    ['sign']
                );

                const expectedSig = await crypto.subtle.sign('HMAC', cryptoKey, messageData);
                const expectedSigArray = Array.from(new Uint8Array(expectedSig));
                const expectedBase64 = btoa(String.fromCharCode(...expectedSigArray))
                    .replace(/\+/g, '-').replace(/\//g, '_').replace(/=/g, '');

                const isValid = signature === expectedBase64;

                // Decode payload
                const decodedPayload = JSON.parse(atob(payload));

                document.getElementById('jwt-result').innerHTML = `
                    <div class="alert ${isValid ? 'alert-success' : 'alert-error'}" style="margin-top: 20px;">
                        ${isValid ? '‚úì' : '‚úó'} <strong>JWT Signature ${isValid ? 'Valid' : 'Invalid'}</strong><br>
                        <div style="margin-top: 10px; font-family: 'Courier New', monospace; font-size: 0.85rem;">
                            Payload: ${JSON.stringify(decodedPayload, null, 2)}
                        </div>
                    </div>
                `;
            } catch (error) {
                alert('Error verifying JWT: ' + error.message);
            }
        }

        // Utility: Copy to clipboard
        function copyToClipboard(elementId) {
            const element = document.getElementById(elementId);
            const text = element.textContent;

            navigator.clipboard.writeText(text).then(() => {
                alert('Copied to clipboard!');
            }).catch(err => {
                alert('Failed to copy: ' + err);
            });
        }
    </script>
<script src="../../../components/FluxCapacitor.js"></script>
</body>
</html>
