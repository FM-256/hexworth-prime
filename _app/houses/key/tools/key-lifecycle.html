<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <!-- Access Control -->
    <script src="../../../../components/AccessGuard.js"></script>
    <script>
        AccessGuard.require('sorted');
    </script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Key Lifecycle Manager - House of the Key</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --house-color: #f59e0b;
            --house-glow: rgba(245, 158, 11, 0.4);
            --bg-dark: #0a0a12;
            --bg-card: rgba(15, 15, 25, 0.8);
            --text-primary: #e8e8f0;
            --text-secondary: #8888aa;
            --input-bg: rgba(20, 20, 30, 0.8);
            --success-green: #10b981;
            --warning-orange: #f59e0b;
            --danger-red: #ef4444;
            --info-blue: #3b82f6;
            --purple: #8b5cf6;
            --cyan: #06b6d4;
        }

        body {
            min-height: 100vh;
            background: var(--bg-dark);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: var(--text-primary);
            overflow-x: hidden;
        }

        /* Header */
        .module-header {
            padding: 20px 30px;
            background: rgba(10, 10, 18, 0.95);
            border-bottom: 1px solid rgba(245, 158, 11, 0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .back-btn {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            border: 1px solid rgba(245, 158, 11, 0.3);
            background: transparent;
            color: var(--house-color);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            font-size: 1.2rem;
        }

        .back-btn:hover {
            background: rgba(245, 158, 11, 0.1);
        }

        .module-title {
            font-size: 1rem;
            font-weight: 500;
            color: var(--text-primary);
        }

        .house-badge {
            font-size: 0.7rem;
            padding: 4px 12px;
            background: rgba(245, 158, 11, 0.15);
            border: 1px solid rgba(245, 158, 11, 0.3);
            border-radius: 20px;
            color: var(--house-color);
            letter-spacing: 0.1em;
        }

        /* Container */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 40px 30px;
        }

        /* Intro */
        .intro {
            text-align: center;
            margin-bottom: 40px;
        }

        .intro-icon {
            font-size: 3rem;
            margin-bottom: 15px;
        }

        .intro-title {
            font-size: 2rem;
            font-weight: 300;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #fff, var(--house-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .intro-subtitle {
            font-size: 1rem;
            color: var(--text-secondary);
            max-width: 700px;
            margin: 0 auto;
        }

        /* Tab Navigation */
        .tab-nav {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            flex-wrap: wrap;
        }

        .tab-btn {
            padding: 12px 24px;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.3s ease;
            font-size: 0.95rem;
        }

        .tab-btn:hover {
            color: var(--text-primary);
        }

        .tab-btn.active {
            color: var(--house-color);
            border-bottom-color: var(--house-color);
        }

        /* Tab Content */
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Tool Card */
        .tool-card {
            background: var(--bg-card);
            border: 1px solid rgba(245, 158, 11, 0.2);
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 20px;
        }

        .tool-card-title {
            font-size: 1.3rem;
            margin-bottom: 15px;
            color: var(--house-color);
        }

        /* Form Elements */
        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-primary);
            font-size: 0.9rem;
        }

        .form-input,
        .form-select {
            width: 100%;
            padding: 12px;
            background: var(--input-bg);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 0.95rem;
        }

        .form-input:focus,
        .form-select:focus {
            outline: none;
            border-color: var(--house-color);
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        /* Button */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--house-color);
            color: #000;
        }

        .btn-primary:hover {
            background: var(--cyan);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(245, 158, 11, 0.3);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        /* Lifecycle Visualizer */
        .lifecycle-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 30px 0;
            flex-wrap: wrap;
            gap: 20px;
        }

        .lifecycle-state {
            text-align: center;
            flex: 1;
            min-width: 120px;
            cursor: pointer;
            transition: all 0.3s ease;
            padding: 15px;
            border-radius: 10px;
        }

        .lifecycle-state:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .lifecycle-state.active {
            background: rgba(245, 158, 11, 0.2);
        }

        .lifecycle-icon {
            width: 80px;
            height: 80px;
            margin: 0 auto 10px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            border: 3px solid;
            transition: all 0.3s ease;
        }

        .lifecycle-state.active .lifecycle-icon {
            transform: scale(1.1);
            box-shadow: 0 0 30px currentColor;
        }

        .state-generated .lifecycle-icon { border-color: var(--success-green); color: var(--success-green); }
        .state-active .lifecycle-icon { border-color: var(--cyan); color: var(--cyan); }
        .state-suspended .lifecycle-icon { border-color: var(--warning-orange); color: var(--warning-orange); }
        .state-compromised .lifecycle-icon { border-color: var(--danger-red); color: var(--danger-red); }
        .state-destroyed .lifecycle-icon { border-color: #666; color: #666; }

        .lifecycle-label {
            font-size: 0.9rem;
            font-weight: 500;
            margin-bottom: 5px;
        }

        .lifecycle-desc {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .lifecycle-arrow {
            font-size: 2rem;
            color: var(--text-secondary);
            flex-shrink: 0;
        }

        /* HSM Diagram */
        .hsm-diagram {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(245, 158, 11, 0.3);
            border-radius: 10px;
            padding: 40px;
            margin: 20px 0;
        }

        .hsm-layer {
            margin: 20px 0;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid;
        }

        .hsm-layer-app {
            border-color: var(--info-blue);
            background: rgba(59, 130, 246, 0.1);
        }

        .hsm-layer-api {
            border-color: var(--cyan);
            background: rgba(6, 182, 212, 0.1);
        }

        .hsm-layer-hsm {
            border-color: var(--house-color);
            background: rgba(245, 158, 11, 0.1);
        }

        .hsm-layer-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .hsm-layer-desc {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        /* Key Hierarchy Builder */
        .hierarchy-builder {
            margin: 30px 0;
        }

        .hierarchy-level {
            margin: 15px 0;
            padding: 20px;
            border-radius: 8px;
            border: 2px dashed rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
        }

        .hierarchy-level:hover {
            border-color: var(--house-color);
            background: rgba(245, 158, 11, 0.05);
        }

        .hierarchy-level-title {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .key-item {
            display: inline-block;
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            margin: 5px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .key-item:hover {
            background: rgba(245, 158, 11, 0.2);
            border-color: var(--house-color);
        }

        /* Rotation Calculator */
        .rotation-result {
            background: rgba(6, 182, 212, 0.1);
            border-left: 3px solid var(--cyan);
            padding: 20px;
            border-radius: 6px;
            margin-top: 20px;
        }

        .rotation-result h4 {
            color: var(--cyan);
            margin-bottom: 10px;
        }

        .rotation-schedule {
            display: grid;
            gap: 10px;
            margin-top: 15px;
        }

        .rotation-item {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 6px;
        }

        /* Compliance Checker */
        .compliance-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .compliance-checkbox {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .compliance-checkbox:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .compliance-checkbox input {
            width: 18px;
            height: 18px;
        }

        .compliance-requirements {
            background: rgba(245, 158, 11, 0.1);
            border-left: 3px solid var(--house-color);
            padding: 20px;
            border-radius: 6px;
            margin-top: 20px;
        }

        .requirement-item {
            padding: 10px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .requirement-item:last-child {
            border-bottom: none;
        }

        /* Envelope Encryption Simulator */
        .encryption-flow {
            display: grid;
            grid-template-columns: 1fr auto 1fr auto 1fr;
            gap: 20px;
            align-items: center;
            margin: 30px 0;
        }

        .encryption-box {
            padding: 20px;
            border-radius: 8px;
            border: 2px solid;
            text-align: center;
        }

        .encryption-box.data {
            border-color: var(--info-blue);
            background: rgba(59, 130, 246, 0.1);
        }

        .encryption-box.dek {
            border-color: var(--cyan);
            background: rgba(6, 182, 212, 0.1);
        }

        .encryption-box.kek {
            border-color: var(--house-color);
            background: rgba(245, 158, 11, 0.1);
        }

        .encryption-arrow {
            font-size: 2rem;
            color: var(--text-secondary);
        }

        .encryption-label {
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .encryption-value {
            font-family: monospace;
            font-size: 0.8rem;
            color: var(--text-secondary);
            word-break: break-all;
        }

        /* Policy Builder */
        .policy-editor {
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 20px;
            font-family: monospace;
            font-size: 0.9rem;
            color: var(--cyan);
            min-height: 300px;
            overflow-x: auto;
        }

        .policy-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        /* Info Box */
        .info-box {
            background: rgba(59, 130, 246, 0.1);
            border-left: 3px solid var(--info-blue);
            padding: 15px 20px;
            margin: 20px 0;
            border-radius: 6px;
        }

        .info-box-title {
            font-weight: 600;
            color: var(--info-blue);
            margin-bottom: 8px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .encryption-flow {
                grid-template-columns: 1fr;
            }

            .encryption-arrow {
                transform: rotate(90deg);
            }

            .lifecycle-container {
                flex-direction: column;
            }

            .lifecycle-arrow {
                transform: rotate(90deg);
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="module-header">
        <div class="header-left">
            <button class="back-btn" onclick="window.location.href='../../index.html'">‚Üê</button>
            <div>
                <div class="module-title">Key Lifecycle Manager</div>
                <div class="house-badge">HOUSE OF THE KEY</div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="container">
        <!-- Intro -->
        <div class="intro">
            <div class="intro-icon">üîß</div>
            <h1 class="intro-title">Interactive Key Management Tools</h1>
            <p class="intro-subtitle">
                Explore key lifecycle states, build key hierarchies, simulate envelope encryption,
                and design enterprise key management architectures.
            </p>
        </div>

        <!-- Tab Navigation -->
        <div class="tab-nav">
            <button class="tab-btn active" data-tab="lifecycle">Lifecycle Visualizer</button>
            <button class="tab-btn" data-tab="hsm">HSM Architecture</button>
            <button class="tab-btn" data-tab="hierarchy">Key Hierarchy</button>
            <button class="tab-btn" data-tab="envelope">Envelope Encryption</button>
            <button class="tab-btn" data-tab="rotation">Rotation Calculator</button>
            <button class="tab-btn" data-tab="policy">Access Policy</button>
            <button class="tab-btn" data-tab="compliance">Compliance Checker</button>
        </div>

        <!-- Tab 1: Lifecycle Visualizer -->
        <div class="tab-content active" id="tab-lifecycle">
            <div class="tool-card">
                <h2 class="tool-card-title">Key Lifecycle States</h2>
                <p style="color: var(--text-secondary); margin-bottom: 30px;">
                    Click on each state to learn about key lifecycle transitions and management requirements.
                </p>

                <div class="lifecycle-container">
                    <div class="lifecycle-state state-generated active" data-state="generated">
                        <div class="lifecycle-icon">üî®</div>
                        <div class="lifecycle-label">Generated</div>
                        <div class="lifecycle-desc">Key created</div>
                    </div>
                    <div class="lifecycle-arrow">‚Üí</div>
                    <div class="lifecycle-state state-active" data-state="active">
                        <div class="lifecycle-icon">‚úì</div>
                        <div class="lifecycle-label">Active</div>
                        <div class="lifecycle-desc">In use</div>
                    </div>
                    <div class="lifecycle-arrow">‚Üí</div>
                    <div class="lifecycle-state state-suspended" data-state="suspended">
                        <div class="lifecycle-icon">‚è∏</div>
                        <div class="lifecycle-label">Suspended</div>
                        <div class="lifecycle-desc">Temporarily disabled</div>
                    </div>
                    <div class="lifecycle-arrow">‚Üí</div>
                    <div class="lifecycle-state state-compromised" data-state="compromised">
                        <div class="lifecycle-icon">‚ö†Ô∏è</div>
                        <div class="lifecycle-label">Compromised</div>
                        <div class="lifecycle-desc">Security incident</div>
                    </div>
                    <div class="lifecycle-arrow">‚Üí</div>
                    <div class="lifecycle-state state-destroyed" data-state="destroyed">
                        <div class="lifecycle-icon">üí•</div>
                        <div class="lifecycle-label">Destroyed</div>
                        <div class="lifecycle-desc">Permanently deleted</div>
                    </div>
                </div>

                <div id="state-info" class="info-box">
                    <div class="info-box-title">Generated State</div>
                    <div>
                        <strong>Description:</strong> Key has been created using a CSRNG (cryptographically secure random number generator).<br><br>
                        <strong>Requirements:</strong>
                        <ul style="margin-left: 20px; margin-top: 10px;">
                            <li>Generated in HSM or secure environment</li>
                            <li>Adequate key strength (AES-256, RSA-4096)</li>
                            <li>Entropy source validated</li>
                            <li>Generation event logged</li>
                        </ul>
                        <strong style="display: block; margin-top: 10px;">Next Actions:</strong> Activate key for use, or securely distribute to endpoints.
                    </div>
                </div>

                <div class="form-group" style="margin-top: 30px;">
                    <label class="form-label">Simulate State Transition</label>
                    <div class="form-row">
                        <select class="form-select" id="transition-select">
                            <option value="activate">Activate Key</option>
                            <option value="suspend">Suspend Key</option>
                            <option value="compromise">Report Compromise</option>
                            <option value="destroy">Destroy Key</option>
                        </select>
                        <button class="btn btn-primary" onclick="simulateTransition()">
                            <span>üîÑ</span> Execute Transition
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab 2: HSM Architecture -->
        <div class="tab-content" id="tab-hsm">
            <div class="tool-card">
                <h2 class="tool-card-title">HSM Integration Architecture</h2>
                <p style="color: var(--text-secondary); margin-bottom: 30px;">
                    How applications integrate with Hardware Security Modules for cryptographic operations.
                </p>

                <div class="hsm-diagram">
                    <div class="hsm-layer hsm-layer-app">
                        <div class="hsm-layer-title">Application Layer</div>
                        <div class="hsm-layer-desc">
                            Web apps, microservices, databases request crypto operations.
                            Applications never see plaintext keys.
                        </div>
                        <div style="margin-top: 10px; font-family: monospace; font-size: 0.85rem;">
                            app.encrypt(data) ‚Üí API call ‚Üí KMS/HSM
                        </div>
                    </div>

                    <div style="text-align: center; color: var(--cyan); margin: 15px 0;">
                        ‚Üì TLS/mTLS Connection ‚Üì
                    </div>

                    <div class="hsm-layer hsm-layer-api">
                        <div class="hsm-layer-title">KMS API Layer</div>
                        <div class="hsm-layer-desc">
                            AWS KMS, Azure Key Vault, Google Cloud KMS, or PKCS#11 interface.
                            Authenticates requests, enforces access policies.
                        </div>
                        <div style="margin-top: 10px; font-family: monospace; font-size: 0.85rem;">
                            Validate IAM ‚Üí Check policy ‚Üí Forward to HSM
                        </div>
                    </div>

                    <div style="text-align: center; color: var(--cyan); margin: 15px 0;">
                        ‚Üì Secure Channel ‚Üì
                    </div>

                    <div class="hsm-layer hsm-layer-hsm">
                        <div class="hsm-layer-title">HSM Hardware Layer (FIPS 140-2 L3)</div>
                        <div class="hsm-layer-desc">
                            Tamper-resistant hardware. Keys generated, stored, and used entirely within HSM.
                            Plaintext keys never cross the boundary.
                        </div>
                        <div style="margin-top: 10px; font-family: monospace; font-size: 0.85rem;">
                            Perform crypto ‚Üí Return result ‚Üí Audit log
                        </div>
                    </div>
                </div>

                <div class="info-box">
                    <div class="info-box-title">Key Protection Boundaries</div>
                    <div>
                        <strong>Inside HSM:</strong> Keys exist in plaintext, but within tamper-resistant hardware.
                        Physical attacks trigger zeroization (key destruction).<br><br>
                        <strong>Outside HSM:</strong> Keys only exist encrypted (wrapped) by HSM master keys.
                        Applications receive ciphertext results, never plaintext keys.
                    </div>
                </div>

                <h3 style="margin-top: 30px; margin-bottom: 15px; color: var(--house-color);">Common Integration Patterns</h3>
                <div class="form-row">
                    <div style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: 8px;">
                        <strong>Direct HSM Integration</strong><br>
                        <span style="font-size: 0.9rem; color: var(--text-secondary);">
                            App uses PKCS#11 library to communicate directly with HSM.
                            High performance, complex to manage.
                        </span>
                    </div>
                    <div style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: 8px;">
                        <strong>Cloud KMS (HSM-backed)</strong><br>
                        <span style="font-size: 0.9rem; color: var(--text-secondary);">
                            App calls KMS API, KMS uses HSM backend. Managed service,
                            easier to use, slight latency increase.
                        </span>
                    </div>
                    <div style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: 8px;">
                        <strong>Hybrid (BYOK/HYOK)</strong><br>
                        <span style="font-size: 0.9rem; color: var(--text-secondary);">
                            Keys in on-premises HSM, cloud services call back for crypto ops.
                            Maximum control, operational complexity.
                        </span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab 3: Key Hierarchy Builder -->
        <div class="tab-content" id="tab-hierarchy">
            <div class="tool-card">
                <h2 class="tool-card-title">Build Your Key Hierarchy</h2>
                <p style="color: var(--text-secondary); margin-bottom: 30px;">
                    Design a multi-tier key hierarchy for an enterprise architecture. Click to add keys at each level.
                </p>

                <div class="hierarchy-builder">
                    <div class="hierarchy-level" style="border-color: var(--purple); background: rgba(139, 92, 246, 0.1);">
                        <div class="hierarchy-level-title">
                            <span>üîê</span>
                            <span>Root Master Keys (HSM-Protected)</span>
                            <button class="btn btn-secondary" style="margin-left: auto; padding: 6px 12px; font-size: 0.85rem;" onclick="addKey('master')">+ Add Key</button>
                        </div>
                        <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 10px;">
                            Rarely used. Rotated annually. Lives in HSM Level 3+.
                        </div>
                        <div id="master-keys"></div>
                    </div>

                    <div style="text-align: center; color: var(--cyan); margin: 15px 0; font-size: 1.5rem;">‚Üì</div>

                    <div class="hierarchy-level" style="border-color: var(--cyan); background: rgba(6, 182, 212, 0.1);">
                        <div class="hierarchy-level-title">
                            <span>üîë</span>
                            <span>Key Encryption Keys (KEKs)</span>
                            <button class="btn btn-secondary" style="margin-left: auto; padding: 6px 12px; font-size: 0.85rem;" onclick="addKey('kek')">+ Add Key</button>
                        </div>
                        <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 10px;">
                            Per-service or per-region. Rotated quarterly. Protected by Master Keys.
                        </div>
                        <div id="kek-keys"></div>
                    </div>

                    <div style="text-align: center; color: var(--cyan); margin: 15px 0; font-size: 1.5rem;">‚Üì</div>

                    <div class="hierarchy-level" style="border-color: var(--house-color); background: rgba(245, 158, 11, 0.1);">
                        <div class="hierarchy-level-title">
                            <span>üîì</span>
                            <span>Data Encryption Keys (DEKs)</span>
                            <button class="btn btn-secondary" style="margin-left: auto; padding: 6px 12px; font-size: 0.85rem;" onclick="addKey('dek')">+ Add Key</button>
                        </div>
                        <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 10px;">
                            Per-file, per-record, or per-transaction. Generated on demand. Encrypted by KEKs.
                        </div>
                        <div id="dek-keys"></div>
                    </div>
                </div>

                <button class="btn btn-primary" onclick="exportHierarchy()" style="margin-top: 20px;">
                    <span>üìã</span> Export Hierarchy Design
                </button>
                <button class="btn btn-secondary" onclick="clearHierarchy()" style="margin-top: 20px;">
                    <span>üóëÔ∏è</span> Clear All
                </button>
            </div>
        </div>

        <!-- Tab 4: Envelope Encryption Simulator -->
        <div class="tab-content" id="tab-envelope">
            <div class="tool-card">
                <h2 class="tool-card-title">Envelope Encryption Simulator</h2>
                <p style="color: var(--text-secondary); margin-bottom: 30px;">
                    Watch how envelope encryption works: data encrypted with DEK, DEK encrypted with KEK.
                </p>

                <div class="form-group">
                    <label class="form-label">Enter Plaintext Data</label>
                    <input type="text" class="form-input" id="envelope-plaintext" placeholder="Secret customer data..." value="Credit card: 4532-****-****-1234">
                </div>

                <button class="btn btn-primary" onclick="runEnvelopeEncryption()">
                    <span>üîí</span> Encrypt with Envelope Pattern
                </button>

                <div id="envelope-result" style="display: none; margin-top: 30px;">
                    <h3 style="color: var(--house-color); margin-bottom: 20px;">Encryption Flow</h3>

                    <div class="encryption-flow">
                        <div class="encryption-box data">
                            <div class="encryption-label">1. Plaintext Data</div>
                            <div class="encryption-value" id="env-plaintext"></div>
                        </div>
                        <div class="encryption-arrow">‚Üí</div>
                        <div class="encryption-box dek">
                            <div class="encryption-label">2. Encrypt with DEK</div>
                            <div class="encryption-value" id="env-encrypted-data"></div>
                            <div style="margin-top: 10px; font-size: 0.8rem; color: var(--cyan);">
                                ‚Üì Generated: <span id="env-dek-plain"></span>
                            </div>
                        </div>
                        <div class="encryption-arrow">‚Üí</div>
                        <div class="encryption-box kek">
                            <div class="encryption-label">3. Wrap DEK with KEK</div>
                            <div class="encryption-value" id="env-wrapped-dek"></div>
                        </div>
                    </div>

                    <div class="info-box" style="margin-top: 30px;">
                        <div class="info-box-title">Storage Result</div>
                        <div>
                            <strong>Stored in Database/S3:</strong><br>
                            ‚Ä¢ Encrypted Data: <code id="env-stored-data" style="color: var(--cyan);"></code><br>
                            ‚Ä¢ Wrapped DEK: <code id="env-stored-dek" style="color: var(--house-color);"></code><br><br>
                            <strong>KEK stays in KMS/HSM.</strong> To decrypt: send wrapped DEK to KMS to unwrap, use unwrapped DEK to decrypt data locally.
                        </div>
                    </div>

                    <button class="btn btn-secondary" onclick="runEnvelopeDecryption()" style="margin-top: 15px;">
                        <span>üîì</span> Simulate Decryption
                    </button>
                </div>
            </div>
        </div>

        <!-- Tab 5: Rotation Calculator -->
        <div class="tab-content" id="tab-rotation">
            <div class="tool-card">
                <h2 class="tool-card-title">Key Rotation Schedule Calculator</h2>
                <p style="color: var(--text-secondary); margin-bottom: 30px;">
                    Calculate recommended rotation frequencies based on data sensitivity and compliance requirements.
                </p>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Data Classification</label>
                        <select class="form-select" id="data-classification">
                            <option value="public">Public (Marketing data)</option>
                            <option value="internal">Internal (Business data)</option>
                            <option value="confidential" selected>Confidential (Customer PII)</option>
                            <option value="restricted">Restricted (Payment data, PHI)</option>
                            <option value="top-secret">Top Secret (Cryptographic keys)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Compliance Framework</label>
                        <select class="form-select" id="compliance-framework">
                            <option value="none">None</option>
                            <option value="pci">PCI-DSS</option>
                            <option value="hipaa">HIPAA</option>
                            <option value="soc2">SOC 2</option>
                            <option value="gdpr">GDPR</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Key Usage Volume</label>
                        <select class="form-select" id="key-usage">
                            <option value="low">Low (< 1K ops/day)</option>
                            <option value="medium" selected>Medium (1K-100K ops/day)</option>
                            <option value="high">High (100K-1M ops/day)</option>
                            <option value="very-high">Very High (> 1M ops/day)</option>
                        </select>
                    </div>
                </div>

                <button class="btn btn-primary" onclick="calculateRotation()">
                    <span>üìä</span> Calculate Rotation Schedule
                </button>

                <div id="rotation-output"></div>
            </div>
        </div>

        <!-- Tab 6: Access Policy Builder -->
        <div class="tab-content" id="tab-policy">
            <div class="tool-card">
                <h2 class="tool-card-title">KMS Access Policy Builder</h2>
                <p style="color: var(--text-secondary); margin-bottom: 30px;">
                    Build AWS KMS key policies with common access patterns and least privilege principles.
                </p>

                <div class="policy-controls">
                    <button class="btn btn-secondary" onclick="addPolicyStatement('encrypt')">+ Allow Encrypt</button>
                    <button class="btn btn-secondary" onclick="addPolicyStatement('decrypt')">+ Allow Decrypt</button>
                    <button class="btn btn-secondary" onclick="addPolicyStatement('admin')">+ Key Admin</button>
                    <button class="btn btn-secondary" onclick="addPolicyStatement('condition')">+ Add Condition</button>
                </div>

                <div class="form-row" style="margin-bottom: 15px;">
                    <div class="form-group">
                        <label class="form-label">Principal (ARN)</label>
                        <input type="text" class="form-input" id="policy-principal" placeholder="arn:aws:iam::123456789:role/app-role">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Statement ID</label>
                        <input type="text" class="form-input" id="policy-sid" placeholder="AllowApplicationEncrypt">
                    </div>
                </div>

                <div class="policy-editor" id="policy-output">{
  "Version": "2012-10-17",
  "Statement": []
}</div>

                <button class="btn btn-primary" onclick="validatePolicy()" style="margin-top: 15px;">
                    <span>‚úì</span> Validate Policy
                </button>
                <button class="btn btn-secondary" onclick="copyPolicy()" style="margin-top: 15px;">
                    <span>üìã</span> Copy to Clipboard
                </button>
            </div>
        </div>

        <!-- Tab 7: Compliance Checker -->
        <div class="tab-content" id="tab-compliance">
            <div class="tool-card">
                <h2 class="tool-card-title">Compliance Requirements Checker</h2>
                <p style="color: var(--text-secondary); margin-bottom: 30px;">
                    Select applicable compliance frameworks to see required key management controls.
                </p>

                <div class="compliance-grid">
                    <label class="compliance-checkbox">
                        <input type="checkbox" value="pci" onchange="updateCompliance()">
                        <span>PCI-DSS 4.0</span>
                    </label>
                    <label class="compliance-checkbox">
                        <input type="checkbox" value="hipaa" onchange="updateCompliance()">
                        <span>HIPAA</span>
                    </label>
                    <label class="compliance-checkbox">
                        <input type="checkbox" value="soc2" onchange="updateCompliance()">
                        <span>SOC 2 Type II</span>
                    </label>
                    <label class="compliance-checkbox">
                        <input type="checkbox" value="gdpr" onchange="updateCompliance()">
                        <span>GDPR</span>
                    </label>
                    <label class="compliance-checkbox">
                        <input type="checkbox" value="fedramp" onchange="updateCompliance()">
                        <span>FedRAMP</span>
                    </label>
                    <label class="compliance-checkbox">
                        <input type="checkbox" value="iso27001" onchange="updateCompliance()">
                        <span>ISO 27001</span>
                    </label>
                </div>

                <div id="compliance-output"></div>
            </div>
        </div>
    </div>

    <script>
        // Tab switching
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const targetTab = btn.dataset.tab;

                // Update buttons
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');

                // Update content
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                document.getElementById('tab-' + targetTab).classList.add('active');
            });
        });

        // Lifecycle state info
        const stateInfo = {
            generated: {
                title: 'Generated State',
                desc: 'Key has been created using a CSRNG (cryptographically secure random number generator).',
                requirements: [
                    'Generated in HSM or secure environment',
                    'Adequate key strength (AES-256, RSA-4096)',
                    'Entropy source validated',
                    'Generation event logged'
                ],
                next: 'Activate key for use, or securely distribute to endpoints.'
            },
            active: {
                title: 'Active State',
                desc: 'Key is in production use, performing encrypt/decrypt operations.',
                requirements: [
                    'Access controls enforced (RBAC, least privilege)',
                    'All operations audit logged',
                    'Key usage monitored for anomalies',
                    'Rotation schedule defined and tracked'
                ],
                next: 'Monitor usage. Rotate according to schedule. Suspend if anomalies detected.'
            },
            suspended: {
                title: 'Suspended State',
                desc: 'Key temporarily disabled due to investigation, maintenance, or precautionary measures.',
                requirements: [
                    'Reason for suspension documented',
                    'Incident ticket created if security-related',
                    'Application impact assessed',
                    'Reactivation procedure defined'
                ],
                next: 'Investigate issue. Either reactivate or mark as compromised.'
            },
            compromised: {
                title: 'Compromised State',
                desc: 'Key suspected or confirmed to have been exposed, stolen, or accessed by unauthorized parties.',
                requirements: [
                    'IMMEDIATE key rotation',
                    'Incident response initiated',
                    'Affected data identified and re-encrypted',
                    'Root cause analysis',
                    'Breach notification if required by law'
                ],
                next: 'Generate new key, rotate all encrypted data, destroy compromised key.'
            },
            destroyed: {
                title: 'Destroyed State',
                desc: 'Key has been permanently and securely deleted. Cannot be recovered.',
                requirements: [
                    'Cryptographic erasure (overwrite with random data)',
                    'HSM zeroization command executed',
                    'Physical destruction of backup media if applicable',
                    'Destruction event logged and archived',
                    'Compliance officer notified'
                ],
                next: 'No further actions. Key lifecycle complete.'
            }
        };

        document.querySelectorAll('.lifecycle-state').forEach(state => {
            state.addEventListener('click', () => {
                const stateName = state.dataset.state;
                const info = stateInfo[stateName];

                // Update active state
                document.querySelectorAll('.lifecycle-state').forEach(s => s.classList.remove('active'));
                state.classList.add('active');

                // Update info box
                const infoBox = document.getElementById('state-info');
                let reqList = info.requirements.map(r => `<li>${r}</li>`).join('');
                infoBox.innerHTML = `
                    <div class="info-box-title">${info.title}</div>
                    <div>
                        <strong>Description:</strong> ${info.desc}<br><br>
                        <strong>Requirements:</strong>
                        <ul style="margin-left: 20px; margin-top: 10px;">
                            ${reqList}
                        </ul>
                        <strong style="display: block; margin-top: 10px;">Next Actions:</strong> ${info.next}
                    </div>
                `;
            });
        });

        function simulateTransition() {
            const transition = document.getElementById('transition-select').value;
            const messages = {
                activate: 'Key activated. Now available for cryptographic operations. Access policies enforced.',
                suspend: 'Key suspended. All operations blocked. Incident ticket #KMS-2024-001 created.',
                compromise: 'ALERT: Key marked as compromised! Initiating emergency rotation. IR team notified.',
                destroy: 'Key scheduled for destruction in 30 days (grace period). Confirm to execute immediately.'
            };
            alert(messages[transition]);
        }

        // Key Hierarchy Builder
        let keyCounters = { master: 0, kek: 0, dek: 0 };

        function addKey(level) {
            keyCounters[level]++;
            const keyNames = {
                master: `Root-Master-${keyCounters[level]}`,
                kek: `KEK-${['Production', 'Staging', 'DR', 'Backup', 'Analytics'][keyCounters[level] % 5]}-${keyCounters[level]}`,
                dek: `DEK-${['UserData', 'Transactions', 'Files', 'Logs', 'Backups'][keyCounters[level] % 5]}-${keyCounters[level]}`
            };

            const container = document.getElementById(`${level}-keys`);
            const keyElement = document.createElement('span');
            keyElement.className = 'key-item';
            keyElement.textContent = keyNames[level];
            keyElement.onclick = () => keyElement.remove();
            container.appendChild(keyElement);
        }

        function exportHierarchy() {
            const master = Array.from(document.querySelectorAll('#master-keys .key-item')).map(k => k.textContent);
            const kek = Array.from(document.querySelectorAll('#kek-keys .key-item')).map(k => k.textContent);
            const dek = Array.from(document.querySelectorAll('#dek-keys .key-item')).map(k => k.textContent);

            const hierarchy = {
                "Master Keys (HSM)": master,
                "Key Encryption Keys": kek,
                "Data Encryption Keys": dek
            };

            alert('Hierarchy Design:\n\n' + JSON.stringify(hierarchy, null, 2));
        }

        function clearHierarchy() {
            document.getElementById('master-keys').innerHTML = '';
            document.getElementById('kek-keys').innerHTML = '';
            document.getElementById('dek-keys').innerHTML = '';
            keyCounters = { master: 0, kek: 0, dek: 0 };
        }

        // Envelope Encryption Simulator
        function generateKey() {
            return Array.from({length: 32}, () => Math.random().toString(36)[2]).join('').substring(0, 32);
        }

        function simpleEncrypt(text, key) {
            // Simple XOR-based encryption for demo purposes
            return btoa(text.split('').map((c, i) =>
                String.fromCharCode(c.charCodeAt(0) ^ key.charCodeAt(i % key.length))
            ).join(''));
        }

        function runEnvelopeEncryption() {
            const plaintext = document.getElementById('envelope-plaintext').value;
            const dek = generateKey();
            const kek = generateKey();

            const encryptedData = simpleEncrypt(plaintext, dek);
            const wrappedDek = simpleEncrypt(dek, kek);

            document.getElementById('env-plaintext').textContent = plaintext;
            document.getElementById('env-dek-plain').textContent = dek.substring(0, 16) + '...';
            document.getElementById('env-encrypted-data').textContent = encryptedData.substring(0, 40) + '...';
            document.getElementById('env-wrapped-dek').textContent = wrappedDek.substring(0, 40) + '...';
            document.getElementById('env-stored-data').textContent = encryptedData.substring(0, 30) + '...';
            document.getElementById('env-stored-dek').textContent = wrappedDek.substring(0, 30) + '...';

            document.getElementById('envelope-result').style.display = 'block';
        }

        function runEnvelopeDecryption() {
            alert('Decryption Flow:\n\n1. Retrieve Encrypted Data + Wrapped DEK from storage\n2. Call KMS API to unwrap DEK using KEK\n3. Use unwrapped DEK to decrypt data locally\n4. Return plaintext to application\n5. Securely delete DEK from memory\n\nKEK never leaves KMS/HSM!');
        }

        // Rotation Calculator
        function calculateRotation() {
            const classification = document.getElementById('data-classification').value;
            const compliance = document.getElementById('compliance-framework').value;
            const usage = document.getElementById('key-usage').value;

            const rotationFrequencies = {
                'public': 730,
                'internal': 365,
                'confidential': 180,
                'restricted': 90,
                'top-secret': 30
            };

            const complianceOverrides = {
                'pci': 365,
                'hipaa': 365,
                'soc2': 180,
                'gdpr': 365
            };

            let baseDays = rotationFrequencies[classification];
            if (compliance !== 'none' && complianceOverrides[compliance]) {
                baseDays = Math.min(baseDays, complianceOverrides[compliance]);
            }

            // Adjust for usage
            const usageMultiplier = {
                'low': 1.0,
                'medium': 0.75,
                'high': 0.5,
                'very-high': 0.33
            };
            baseDays = Math.round(baseDays * usageMultiplier[usage]);

            const output = document.getElementById('rotation-output');
            output.innerHTML = `
                <div class="rotation-result">
                    <h4>Recommended Rotation Schedule</h4>
                    <div style="font-size: 2rem; color: var(--cyan); margin: 15px 0;">${baseDays} days</div>
                    <p style="color: var(--text-secondary);">
                        Based on ${classification} data classification, ${compliance || 'no specific'} compliance requirements,
                        and ${usage} usage volume.
                    </p>
                    <div class="rotation-schedule">
                        <div class="rotation-item">
                            <span>Master Keys:</span>
                            <strong>${baseDays * 4} days (annually)</strong>
                        </div>
                        <div class="rotation-item">
                            <span>KEKs:</span>
                            <strong>${baseDays * 2} days (semi-annually)</strong>
                        </div>
                        <div class="rotation-item">
                            <span>DEKs:</span>
                            <strong>${baseDays} days</strong>
                        </div>
                        <div class="rotation-item">
                            <span>Emergency Rotation:</span>
                            <strong>Immediate (< 24 hours)</strong>
                        </div>
                    </div>
                </div>
            `;
        }

        // Policy Builder
        let policyStatements = [];

        function addPolicyStatement(type) {
            const principal = document.getElementById('policy-principal').value || 'arn:aws:iam::ACCOUNT:role/ROLE';
            const sid = document.getElementById('policy-sid').value || 'Statement' + (policyStatements.length + 1);

            const templates = {
                encrypt: {
                    Sid: sid,
                    Effect: 'Allow',
                    Principal: { AWS: principal },
                    Action: ['kms:Encrypt', 'kms:GenerateDataKey', 'kms:GenerateDataKeyWithoutPlaintext'],
                    Resource: '*'
                },
                decrypt: {
                    Sid: sid,
                    Effect: 'Allow',
                    Principal: { AWS: principal },
                    Action: ['kms:Decrypt', 'kms:DescribeKey'],
                    Resource: '*'
                },
                admin: {
                    Sid: sid,
                    Effect: 'Allow',
                    Principal: { AWS: principal },
                    Action: ['kms:*'],
                    Resource: '*'
                },
                condition: {
                    Sid: sid,
                    Effect: 'Allow',
                    Principal: { AWS: principal },
                    Action: ['kms:Decrypt'],
                    Resource: '*',
                    Condition: {
                        StringEquals: {
                            'kms:ViaService': 's3.us-east-1.amazonaws.com'
                        }
                    }
                }
            };

            policyStatements.push(templates[type]);
            updatePolicyDisplay();
        }

        function updatePolicyDisplay() {
            const policy = {
                Version: '2012-10-17',
                Statement: policyStatements
            };
            document.getElementById('policy-output').textContent = JSON.stringify(policy, null, 2);
        }

        function validatePolicy() {
            if (policyStatements.length === 0) {
                alert('‚ùå Policy has no statements. Add at least one statement.');
            } else {
                alert('‚úì Policy structure is valid!\n\n' + policyStatements.length + ' statement(s) defined.');
            }
        }

        function copyPolicy() {
            const policyText = document.getElementById('policy-output').textContent;
            navigator.clipboard.writeText(policyText).then(() => {
                alert('‚úì Policy copied to clipboard!');
            });
        }

        // Compliance Checker
        function updateCompliance() {
            const selected = Array.from(document.querySelectorAll('.compliance-checkbox input:checked'))
                .map(cb => cb.value);

            if (selected.length === 0) {
                document.getElementById('compliance-output').innerHTML = '';
                return;
            }

            const requirements = {
                pci: [
                    'Requirement 3.5: Document key management procedures',
                    'Requirement 3.6: Key custodians with split knowledge (M-of-N)',
                    'Requirement 3.6.1: Keys stored securely, separate from encrypted data',
                    'Requirement 3.6.4: Annual key rotation at minimum',
                    'Requirement 3.6.5: Retirement/replacement of known/suspected compromised keys',
                    'HSM required for PIN encryption (FIPS 140-2 Level 3)'
                ],
                hipaa: [
                    '164.312(a)(2)(iv): Encryption and decryption mechanisms',
                    '164.312(e)(2)(ii): Encryption of ePHI in transit',
                    'Key management processes documented',
                    'Access controls on encryption keys',
                    'Audit logs of key access and usage',
                    'Business Associate Agreements for key management vendors'
                ],
                soc2: [
                    'CC6.1: Logical and physical access controls',
                    'CC6.6: Encryption key management procedures',
                    'CC7.2: System monitoring and anomaly detection',
                    'Separation of duties for key administrators',
                    'Key lifecycle controls (generation, rotation, destruction)',
                    'Audit evidence and documentation'
                ],
                gdpr: [
                    'Article 32: Security of processing (encryption)',
                    'Pseudonymization of personal data',
                    'Ability to restore access (key escrow/backup)',
                    'Regular testing of security measures',
                    'Data breach notification within 72 hours',
                    'Data Protection Impact Assessment (DPIA) for encryption'
                ],
                fedramp: [
                    'SC-12: Cryptographic key management',
                    'SC-13: Cryptographic protection (FIPS 140-2 validated)',
                    'IA-5(7): No embedded unencrypted static credentials',
                    'AU-2: Audit logging of key management events',
                    'Continuous monitoring requirements',
                    'Annual assessment and authorization'
                ],
                iso27001: [
                    'A.10.1.1: Policy on cryptographic controls',
                    'A.10.1.2: Key management procedures',
                    'Protection of cryptographic keys',
                    'Key lifecycle management',
                    'Access control to key management systems',
                    'Regular review and audit'
                ]
            };

            let output = '<div class="compliance-requirements"><h3 style="color: var(--house-color); margin-bottom: 15px;">Required Controls</h3>';

            selected.forEach(framework => {
                output += `<div style="margin-bottom: 20px;">`;
                output += `<h4 style="color: var(--cyan); margin-bottom: 10px;">${framework.toUpperCase()}</h4>`;
                requirements[framework].forEach(req => {
                    output += `<div class="requirement-item">‚Ä¢ ${req}</div>`;
                });
                output += `</div>`;
            });

            output += '</div>';
            document.getElementById('compliance-output').innerHTML = output;
        }
    </script>
</body>
</html>
