<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <!-- Access Control -->
    <script src="../../../components/AccessGuard.js"></script>
    <script>
        AccessGuard.require('sorted');
    </script>
    <!-- Achievement & Progress Integration -->
    <script src="../../../components/AchievementManager.js"></script>
    <script src="../../../components/ModuleProgress.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enterprise Key Management & HSMs - House of the Key</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --house-color: #f59e0b;
            --house-glow: rgba(245, 158, 11, 0.4);
            --bg-dark: #0a0a12;
            --bg-card: rgba(15, 15, 25, 0.8);
            --text-primary: #e8e8f0;
            --text-secondary: #8888aa;
            --accent-cyan: #06b6d4;
            --accent-blue: #3b82f6;
            --accent-purple: #8b5cf6;
            --success-green: #10b981;
            --warning-orange: #f59e0b;
            --danger-red: #ef4444;
        }

        body {
            min-height: 100vh;
            background: var(--bg-dark);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: var(--text-primary);
            overflow-x: hidden;
        }

        /* Header */
        .module-header {
            padding: 20px 30px;
            background: rgba(10, 10, 18, 0.95);
            border-bottom: 1px solid rgba(245, 158, 11, 0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .back-btn {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            border: 1px solid rgba(245, 158, 11, 0.3);
            background: transparent;
            color: var(--house-color);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .back-btn:hover {
            background: rgba(245, 158, 11, 0.1);
        }

        .module-title {
            font-size: 1rem;
            font-weight: 500;
            color: var(--text-primary);
        }

        .house-badge {
            font-size: 0.7rem;
            padding: 4px 12px;
            background: rgba(245, 158, 11, 0.15);
            border: 1px solid rgba(245, 158, 11, 0.3);
            border-radius: 20px;
            color: var(--house-color);
            letter-spacing: 0.1em;
        }

        /* Progress */
        .progress-indicator {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .progress-bar {
            width: 120px;
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--house-color), var(--accent-cyan));
            border-radius: 3px;
            transition: width 0.3s ease;
        }

        /* Main Content */
        .module-content {
            max-width: 1000px;
            margin: 0 auto;
            padding: 40px 30px 100px;
        }

        .intro-section {
            text-align: center;
            margin-bottom: 50px;
        }

        .intro-icon {
            font-size: 4rem;
            margin-bottom: 20px;
            filter: drop-shadow(0 0 20px var(--house-glow));
        }

        .intro-title {
            font-size: 2.5rem;
            font-weight: 300;
            margin-bottom: 15px;
            background: linear-gradient(135deg, #fff, var(--house-color), var(--accent-cyan));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .intro-subtitle {
            font-size: 1.1rem;
            color: var(--text-secondary);
            max-width: 700px;
            margin: 0 auto;
            line-height: 1.6;
        }

        /* Section */
        .content-section {
            margin-bottom: 60px;
            opacity: 0;
            transform: translateY(20px);
            animation: fadeInUp 0.6s ease forwards;
        }

        .content-section:nth-child(2) { animation-delay: 0.1s; }
        .content-section:nth-child(3) { animation-delay: 0.2s; }
        .content-section:nth-child(4) { animation-delay: 0.3s; }
        .content-section:nth-child(5) { animation-delay: 0.4s; }

        @keyframes fadeInUp {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .section-title {
            font-size: 1.8rem;
            font-weight: 400;
            margin-bottom: 20px;
            color: var(--house-color);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .section-icon {
            font-size: 1.5rem;
        }

        .section-content {
            background: var(--bg-card);
            border: 1px solid rgba(245, 158, 11, 0.2);
            border-radius: 12px;
            padding: 30px;
            backdrop-filter: blur(10px);
        }

        .section-text {
            font-size: 1rem;
            line-height: 1.8;
            color: var(--text-secondary);
            margin-bottom: 20px;
        }

        /* Info Box */
        .info-box {
            background: rgba(59, 130, 246, 0.1);
            border-left: 3px solid var(--accent-blue);
            padding: 15px 20px;
            margin: 20px 0;
            border-radius: 6px;
        }

        .info-box-title {
            font-weight: 600;
            color: var(--accent-blue);
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .info-box-content {
            color: var(--text-secondary);
            line-height: 1.6;
        }

        /* Warning Box */
        .warning-box {
            background: rgba(239, 68, 68, 0.1);
            border-left: 3px solid var(--danger-red);
            padding: 15px 20px;
            margin: 20px 0;
            border-radius: 6px;
        }

        .warning-box-title {
            font-weight: 600;
            color: var(--danger-red);
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* List Styles */
        .styled-list {
            list-style: none;
            margin: 15px 0;
        }

        .styled-list li {
            padding: 12px 0 12px 30px;
            position: relative;
            color: var(--text-secondary);
            line-height: 1.6;
        }

        .styled-list li::before {
            content: "‚ñπ";
            position: absolute;
            left: 0;
            color: var(--house-color);
            font-size: 1.2rem;
        }

        /* Grid Layout */
        .grid-2 {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .grid-3 {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        /* Card */
        .feature-card {
            background: rgba(20, 20, 30, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 20px;
            transition: all 0.3s ease;
        }

        .feature-card:hover {
            border-color: var(--house-color);
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(245, 158, 11, 0.2);
        }

        .card-icon {
            font-size: 2rem;
            margin-bottom: 12px;
        }

        .card-title {
            font-size: 1.1rem;
            font-weight: 500;
            margin-bottom: 10px;
            color: var(--text-primary);
        }

        .card-description {
            font-size: 0.9rem;
            color: var(--text-secondary);
            line-height: 1.5;
        }

        /* Table */
        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }

        .comparison-table th,
        .comparison-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .comparison-table th {
            background: rgba(245, 158, 11, 0.1);
            color: var(--house-color);
            font-weight: 500;
        }

        .comparison-table td {
            color: var(--text-secondary);
        }

        .comparison-table tr:hover {
            background: rgba(255, 255, 255, 0.03);
        }

        /* Code Block */
        .code-block {
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            font-family: 'Courier New', monospace;
            overflow-x: auto;
        }

        .code-block pre {
            margin: 0;
            color: var(--accent-cyan);
            font-size: 0.9rem;
            line-height: 1.6;
        }

        /* Diagram */
        .diagram-container {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(245, 158, 11, 0.3);
            border-radius: 10px;
            padding: 30px;
            margin: 30px 0;
            text-align: center;
        }

        .lifecycle-diagram {
            display: flex;
            justify-content: space-around;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
            margin: 20px 0;
        }

        .lifecycle-stage {
            text-align: center;
            position: relative;
        }

        .lifecycle-stage-icon {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: rgba(245, 158, 11, 0.1);
            border: 2px solid var(--house-color);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            margin: 0 auto 10px;
            transition: all 0.3s ease;
        }

        .lifecycle-stage:hover .lifecycle-stage-icon {
            background: rgba(245, 158, 11, 0.2);
            transform: scale(1.1);
            box-shadow: 0 0 20px var(--house-glow);
        }

        .lifecycle-stage-label {
            font-size: 0.9rem;
            color: var(--text-primary);
            font-weight: 500;
        }

        .lifecycle-arrow {
            font-size: 2rem;
            color: var(--accent-cyan);
            opacity: 0.6;
        }

        /* HSM Level Badge */
        .fips-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.85rem;
            font-weight: 600;
            margin: 5px;
        }

        .fips-level-1 {
            background: rgba(16, 185, 129, 0.2);
            border: 1px solid var(--success-green);
            color: var(--success-green);
        }

        .fips-level-2 {
            background: rgba(59, 130, 246, 0.2);
            border: 1px solid var(--accent-blue);
            color: var(--accent-blue);
        }

        .fips-level-3 {
            background: rgba(245, 158, 11, 0.2);
            border: 1px solid var(--warning-orange);
            color: var(--warning-orange);
        }

        .fips-level-4 {
            background: rgba(139, 92, 246, 0.2);
            border: 1px solid var(--accent-purple);
            color: var(--accent-purple);
        }

        /* Navigation */
        .nav-buttons {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 50px;
            padding-top: 30px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .nav-btn {
            padding: 12px 30px;
            border-radius: 8px;
            border: 1px solid var(--house-color);
            background: rgba(245, 158, 11, 0.1);
            color: var(--house-color);
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .nav-btn:hover {
            background: rgba(245, 158, 11, 0.2);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(245, 158, 11, 0.3);
        }

        .nav-btn.primary {
            background: var(--house-color);
            color: #000;
        }

        .nav-btn.primary:hover {
            background: var(--accent-cyan);
        }

        /* Completion Message */
        .completion-message {
            position: fixed;
            bottom: -100px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--success-green);
            color: #fff;
            padding: 15px 30px;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(16, 185, 129, 0.4);
            transition: bottom 0.3s ease;
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .completion-message.show {
            bottom: 30px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .module-content {
                padding: 30px 20px 80px;
            }

            .intro-title {
                font-size: 2rem;
            }

            .section-title {
                font-size: 1.5rem;
            }

            .grid-2,
            .grid-3 {
                grid-template-columns: 1fr;
            }

            .lifecycle-diagram {
                flex-direction: column;
            }

            .lifecycle-arrow {
                transform: rotate(90deg);
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="module-header">
        <div class="header-left">
            <button class="back-btn" onclick="window.location.href='../../../index.html'">‚Üê</button>
            <div>
                <div class="module-title">Enterprise Key Management & HSMs</div>
                <div class="house-badge">HOUSE OF THE KEY</div>
            </div>
        </div>
        <div class="progress-indicator">
            <span id="progress-text">0% Complete</span>
            <div class="progress-bar">
                <div class="progress-fill" id="progress-fill"></div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="module-content">
        <!-- Intro -->
        <div class="intro-section">
            <div class="intro-icon">üîê</div>
            <h1 class="intro-title">Enterprise Key Management & HSMs</h1>
            <p class="intro-subtitle">
                Keys are the crown jewels of cryptography. Learn how enterprises protect, manage,
                and control cryptographic keys across their entire lifecycle using Hardware Security
                Modules (HSMs) and Key Management Services (KMS).
            </p>
        </div>

        <!-- Section 1: Why Key Management Matters -->
        <div class="content-section" data-section="1">
            <h2 class="section-title">
                <span class="section-icon">üëë</span>
                Why Key Management Matters
            </h2>
            <div class="section-content">
                <p class="section-text">
                    In cryptography, <strong>keys are everything</strong>. The strongest encryption
                    algorithm is worthless if keys are poorly managed. A compromised key means
                    compromised data, regardless of encryption strength.
                </p>

                <div class="info-box">
                    <div class="info-box-title">
                        <span>üí°</span> The Fundamental Truth
                    </div>
                    <div class="info-box-content">
                        "Encryption protects data. Key management protects encryption."
                        Breaches often occur not from breaking encryption, but from stolen,
                        exposed, or poorly managed keys.
                    </div>
                </div>

                <h3 style="color: var(--text-primary); margin: 25px 0 15px;">The Stakes</h3>
                <ul class="styled-list">
                    <li><strong>Financial Impact:</strong> A single exposed database encryption key can expose millions of customer records. Average breach cost: $4.45M (IBM 2023).</li>
                    <li><strong>Compliance Penalties:</strong> GDPR fines up to ‚Ç¨20M or 4% of global revenue. PCI-DSS violations can result in losing payment processing rights.</li>
                    <li><strong>Reputation Damage:</strong> Customer trust, once lost, takes years to rebuild. Stock prices can drop 5-8% after major breaches.</li>
                    <li><strong>Operational Disruption:</strong> Ransomware attacks succeed when attackers encrypt data with keys organizations can't recover.</li>
                </ul>

                <div class="warning-box">
                    <div class="warning-box-title">
                        <span>‚ö†Ô∏è</span> Real-World Consequences
                    </div>
                    <div class="info-box-content">
                        <strong>Code Spaces (2014):</strong> Hosting provider permanently shut down after attackers
                        gained access to AWS management keys and deleted all backups. Entire business destroyed.<br><br>
                        <strong>Uber (2016):</strong> $148M settlement after developers stored AWS keys in GitHub,
                        leading to 57M user records exposed.
                    </div>
                </div>
            </div>
        </div>

        <!-- Section 2: Key Lifecycle -->
        <div class="content-section" data-section="2">
            <h2 class="section-title">
                <span class="section-icon">üîÑ</span>
                The Key Lifecycle
            </h2>
            <div class="section-content">
                <p class="section-text">
                    Keys are not static‚Äîthey have a lifecycle from birth to destruction.
                    Every stage must be carefully managed to maintain security.
                </p>

                <div class="diagram-container">
                    <div class="lifecycle-diagram">
                        <div class="lifecycle-stage">
                            <div class="lifecycle-stage-icon">üî®</div>
                            <div class="lifecycle-stage-label">Generation</div>
                        </div>
                        <div class="lifecycle-arrow">‚Üí</div>
                        <div class="lifecycle-stage">
                            <div class="lifecycle-stage-icon">üì§</div>
                            <div class="lifecycle-stage-label">Distribution</div>
                        </div>
                        <div class="lifecycle-arrow">‚Üí</div>
                        <div class="lifecycle-stage">
                            <div class="lifecycle-stage-icon">üîí</div>
                            <div class="lifecycle-stage-label">Storage</div>
                        </div>
                        <div class="lifecycle-arrow">‚Üí</div>
                        <div class="lifecycle-stage">
                            <div class="lifecycle-stage-icon">üîÑ</div>
                            <div class="lifecycle-stage-label">Rotation</div>
                        </div>
                        <div class="lifecycle-arrow">‚Üí</div>
                        <div class="lifecycle-stage">
                            <div class="lifecycle-stage-icon">üí•</div>
                            <div class="lifecycle-stage-label">Destruction</div>
                        </div>
                    </div>
                </div>

                <h3 style="color: var(--text-primary); margin: 25px 0 15px;">1. Generation</h3>
                <p class="section-text">
                    Keys must be generated using cryptographically secure random number generators (CSRNGs).
                    Never use standard random functions like <code>Math.random()</code> or predictable seeds.
                </p>
                <ul class="styled-list">
                    <li><strong>HSM-Generated:</strong> Hardware-based true random number generators (TRNGs)</li>
                    <li><strong>Entropy Sources:</strong> System entropy pools, hardware noise, timing variations</li>
                    <li><strong>Key Length:</strong> AES-256, RSA-4096, P-384 for modern security requirements</li>
                </ul>

                <h3 style="color: var(--text-primary); margin: 25px 0 15px;">2. Distribution</h3>
                <p class="section-text">
                    How do you safely get a key to where it needs to be? This is one of cryptography's
                    hardest problems.
                </p>
                <ul class="styled-list">
                    <li><strong>Key Wrapping:</strong> Encrypt keys with Key Encryption Keys (KEKs) before transmission</li>
                    <li><strong>TLS/mTLS:</strong> Secure channels with certificate-based authentication</li>
                    <li><strong>Out-of-Band:</strong> Physical delivery for root keys (e.g., HSM backup smartcards)</li>
                    <li><strong>Key Agreement:</strong> Diffie-Hellman for establishing shared secrets without transmission</li>
                </ul>

                <h3 style="color: var(--text-primary); margin: 25px 0 15px;">3. Storage</h3>
                <p class="section-text">
                    At-rest key protection is critical. Keys should never be stored in plaintext.
                </p>
                <ul class="styled-list">
                    <li><strong>HSMs:</strong> Tamper-resistant hardware modules (FIPS 140-2 Level 3+)</li>
                    <li><strong>KMS:</strong> Cloud key vaults with hardware-backed key protection</li>
                    <li><strong>Encrypted Storage:</strong> Keys encrypted by master keys stored in HSMs</li>
                    <li><strong>Access Controls:</strong> Role-based access (RBAC), separation of duties</li>
                </ul>

                <h3 style="color: var(--text-primary); margin: 25px 0 15px;">4. Rotation</h3>
                <p class="section-text">
                    Regular key rotation limits the impact of compromise and meets compliance requirements.
                </p>
                <ul class="styled-list">
                    <li><strong>Automated Rotation:</strong> AWS KMS automatic 365-day rotation</li>
                    <li><strong>Manual Rotation:</strong> For custom keys and special circumstances</li>
                    <li><strong>Emergency Rotation:</strong> Immediate rotation upon suspected compromise</li>
                    <li><strong>Grace Periods:</strong> Maintain old keys temporarily to decrypt historical data</li>
                </ul>

                <h3 style="color: var(--text-primary); margin: 25px 0 15px;">5. Destruction</h3>
                <p class="section-text">
                    Keys must be securely destroyed when no longer needed. Simple deletion is insufficient.
                </p>
                <ul class="styled-list">
                    <li><strong>Cryptographic Erasure:</strong> Overwrite with random data multiple times</li>
                    <li><strong>HSM Destruction:</strong> Hardware zeroization commands</li>
                    <li><strong>Physical Destruction:</strong> For HSM smartcards and backup media</li>
                    <li><strong>Audit Logging:</strong> Record destruction events for compliance</li>
                </ul>
            </div>
        </div>

        <!-- Section 3: Hardware Security Modules -->
        <div class="content-section" data-section="3">
            <h2 class="section-title">
                <span class="section-icon">üõ°Ô∏è</span>
                Hardware Security Modules (HSMs)
            </h2>
            <div class="section-content">
                <p class="section-text">
                    HSMs are specialized, tamper-resistant hardware devices designed to protect cryptographic
                    keys and perform cryptographic operations. They're the gold standard for key protection.
                </p>

                <h3 style="color: var(--text-primary); margin: 25px 0 15px;">What HSMs Provide</h3>
                <ul class="styled-list">
                    <li><strong>Tamper Resistance:</strong> Physical attacks trigger key zeroization (automatic destruction)</li>
                    <li><strong>Secure Crypto Processor:</strong> Keys never leave the HSM boundary in plaintext</li>
                    <li><strong>True Random Number Generation:</strong> Hardware-based entropy for key generation</li>
                    <li><strong>High Performance:</strong> Dedicated crypto acceleration for thousands of operations/second</li>
                    <li><strong>Compliance Certification:</strong> FIPS 140-2/3, Common Criteria, PCI HSM validation</li>
                </ul>

                <div class="info-box">
                    <div class="info-box-title">
                        <span>üîê</span> The HSM Promise
                    </div>
                    <div class="info-box-content">
                        "Keys are born in the HSM, live in the HSM, and die in the HSM. They never
                        exist in plaintext outside the secure boundary." Even with physical access
                        to the HSM, keys remain protected by tamper-detection mechanisms.
                    </div>
                </div>

                <h3 style="color: var(--text-primary); margin: 25px 0 15px;">FIPS 140-2/3 Security Levels</h3>
                <p class="section-text">
                    The Federal Information Processing Standard defines four security levels for
                    cryptographic modules:
                </p>

                <table class="comparison-table">
                    <thead>
                        <tr>
                            <th>Level</th>
                            <th>Requirements</th>
                            <th>Use Cases</th>
                            <th>Badge</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong>Level 1</strong></td>
                            <td>Software cryptography, basic security</td>
                            <td>General applications, development</td>
                            <td><span class="fips-badge fips-level-1">FIPS 140-2 L1</span></td>
                        </tr>
                        <tr>
                            <td><strong>Level 2</strong></td>
                            <td>Tamper-evident seals, role-based auth</td>
                            <td>Enterprise key storage, TLS</td>
                            <td><span class="fips-badge fips-level-2">FIPS 140-2 L2</span></td>
                        </tr>
                        <tr>
                            <td><strong>Level 3</strong></td>
                            <td>Tamper-detection circuits, identity-based auth</td>
                            <td>Payment processing, PKI root CAs</td>
                            <td><span class="fips-badge fips-level-3">FIPS 140-2 L3</span></td>
                        </tr>
                        <tr>
                            <td><strong>Level 4</strong></td>
                            <td>Environmental attack protection (voltage, temp)</td>
                            <td>Military, intelligence, critical infrastructure</td>
                            <td><span class="fips-badge fips-level-4">FIPS 140-2 L4</span></td>
                        </tr>
                    </tbody>
                </table>

                <h3 style="color: var(--text-primary); margin: 25px 0 15px;">Major HSM Vendors</h3>
                <div class="grid-2">
                    <div class="feature-card">
                        <div class="card-icon">üî∑</div>
                        <div class="card-title">Thales Luna HSMs</div>
                        <div class="card-description">
                            Industry leader. Luna Network HSM 7 offers FIPS 140-2 Level 3,
                            10,000+ RSA-2048 ops/sec. Used by major financial institutions.
                            On-premises and cloud options.
                        </div>
                    </div>
                    <div class="feature-card">
                        <div class="card-icon">üüß</div>
                        <div class="card-title">AWS CloudHSM</div>
                        <div class="card-description">
                            Managed HSM service in AWS VPC. FIPS 140-2 Level 3 certified.
                            Full customer control of keys. Integrates with AWS KMS for hybrid
                            architectures. ~$1/hour base cost.
                        </div>
                    </div>
                    <div class="feature-card">
                        <div class="card-icon">üîµ</div>
                        <div class="card-title">Azure Dedicated HSM</div>
                        <div class="card-description">
                            Thales Luna deployed in Azure. Full single-tenant control.
                            FIPS 140-2 Level 3. For customers needing physical isolation
                            beyond Azure Key Vault Premium.
                        </div>
                    </div>
                    <div class="feature-card">
                        <div class="card-icon">üî¥</div>
                        <div class="card-title">Google Cloud HSM</div>
                        <div class="card-description">
                            Integrated with Cloud KMS. FIPS 140-2 Level 3. Automatic key
                            rotation, global availability. Transparent to applications using
                            Cloud KMS APIs.
                        </div>
                    </div>
                </div>

                <h3 style="color: var(--text-primary); margin: 25px 0 15px;">HSM Use Cases</h3>
                <ul class="styled-list">
                    <li><strong>Public Key Infrastructure (PKI):</strong> Protect Certificate Authority (CA) root keys. Compromise = entire PKI trust chain destroyed.</li>
                    <li><strong>Code Signing:</strong> Protect private keys that sign software, firmware, drivers. Stolen keys = malware signed as legitimate.</li>
                    <li><strong>Payment Processing:</strong> PCI-DSS requires HSMs for PIN encryption, key management in payment systems.</li>
                    <li><strong>Database Encryption:</strong> Transparent Data Encryption (TDE) master keys stored in HSMs (SQL Server EKM, Oracle TDE).</li>
                    <li><strong>SSL/TLS Offloading:</strong> High-volume web servers offload TLS handshakes to HSMs for performance and key protection.</li>
                    <li><strong>Document Signing:</strong> Legal e-signature platforms use HSMs to meet qualified signature standards (eIDAS, ESIGN).</li>
                </ul>
            </div>
        </div>

        <!-- Section 4: Key Management Services -->
        <div class="content-section" data-section="4">
            <h2 class="section-title">
                <span class="section-icon">‚òÅÔ∏è</span>
                Key Management Services (KMS)
            </h2>
            <div class="section-content">
                <p class="section-text">
                    Cloud-based Key Management Services provide centralized key management with
                    hardware-backed key protection, without requiring you to own and operate HSMs.
                </p>

                <div class="grid-3">
                    <div class="feature-card">
                        <div class="card-icon">üüß</div>
                        <div class="card-title">AWS KMS</div>
                        <div class="card-description">
                            Integrated with 100+ AWS services. Automatic key rotation.
                            FIPS 140-2 Level 2 (Level 3 in some regions). Envelope encryption
                            for data keys. $1/key/month + API calls.
                        </div>
                    </div>
                    <div class="feature-card">
                        <div class="card-icon">üîµ</div>
                        <div class="card-title">Azure Key Vault</div>
                        <div class="card-description">
                            Standard (software) and Premium (HSM-backed). Stores keys, secrets,
                            certificates. Integration with Azure AD for access control.
                            Managed HSM for dedicated FIPS 140-2 L3.
                        </div>
                    </div>
                    <div class="feature-card">
                        <div class="card-icon">üî¥</div>
                        <div class="card-title">Google Cloud KMS</div>
                        <div class="card-description">
                            Global key management. Software and HSM protection levels.
                            External Key Manager (EKM) for keys outside Google.
                            Automatic rotation, versioning.
                        </div>
                    </div>
                    <div class="feature-card">
                        <div class="card-icon">üü£</div>
                        <div class="card-title">HashiCorp Vault</div>
                        <div class="card-description">
                            Multi-cloud secrets management. Dynamic secrets, encryption as
                            a service. Auto-unseal with cloud KMS. Transit secrets engine
                            for application encryption.
                        </div>
                    </div>
                </div>

                <h3 style="color: var(--text-primary); margin: 25px 0 15px;">Customer Key Control Models</h3>
                <table class="comparison-table">
                    <thead>
                        <tr>
                            <th>Model</th>
                            <th>Description</th>
                            <th>Control Level</th>
                            <th>Use Case</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong>Cloud-Managed</strong></td>
                            <td>Provider generates and manages keys</td>
                            <td>Convenience</td>
                            <td>Standard encryption at rest</td>
                        </tr>
                        <tr>
                            <td><strong>CMK</strong></td>
                            <td>Customer Master Key - you control lifecycle</td>
                            <td>Moderate</td>
                            <td>Compliance requirements</td>
                        </tr>
                        <tr>
                            <td><strong>BYOK</strong></td>
                            <td>Bring Your Own Key - import your keys</td>
                            <td>High</td>
                            <td>Regulatory, data sovereignty</td>
                        </tr>
                        <tr>
                            <td><strong>HYOK</strong></td>
                            <td>Hold Your Own Key - keys never in cloud</td>
                            <td>Maximum</td>
                            <td>Government, defense, banking</td>
                        </tr>
                    </tbody>
                </table>

                <div class="info-box">
                    <div class="info-box-title">
                        <span>üí°</span> BYOK vs HYOK Trade-offs
                    </div>
                    <div class="info-box-content">
                        <strong>BYOK:</strong> You generate keys on-premises (in your HSM), then import
                        to cloud KMS. Keys reside in cloud but you control the source.<br><br>
                        <strong>HYOK:</strong> Keys never leave your infrastructure. Cloud services call
                        your key server for crypto operations. Maximum control but adds latency and
                        operational complexity.
                    </div>
                </div>
            </div>
        </div>

        <!-- Section 5: Key Hierarchy & Envelope Encryption -->
        <div class="content-section" data-section="5">
            <h2 class="section-title">
                <span class="section-icon">üèóÔ∏è</span>
                Key Hierarchy & Envelope Encryption
            </h2>
            <div class="section-content">
                <p class="section-text">
                    Enterprise key management uses a hierarchical structure where master keys protect
                    encryption keys, which protect data keys. This is called <strong>envelope encryption</strong>.
                </p>

                <h3 style="color: var(--text-primary); margin: 25px 0 15px;">The Key Hierarchy</h3>
                <div class="diagram-container">
                    <div style="text-align: left; max-width: 600px; margin: 0 auto;">
                        <div style="padding: 15px; background: rgba(139, 92, 246, 0.2); border-left: 3px solid var(--accent-purple); margin-bottom: 10px; border-radius: 6px;">
                            <strong style="color: var(--accent-purple);">Master Key (HSM-Protected)</strong><br>
                            <span style="font-size: 0.9rem; color: var(--text-secondary);">
                                Rarely used. Lives in HSM. Rotated annually. Example: AWS KMS Master Key
                            </span>
                        </div>
                        <div style="text-align: center; color: var(--accent-cyan); margin: 10px 0;">‚Üì encrypts ‚Üì</div>
                        <div style="padding: 15px; background: rgba(59, 130, 246, 0.2); border-left: 3px solid var(--accent-blue); margin-bottom: 10px; border-radius: 6px;">
                            <strong style="color: var(--accent-blue);">Key Encryption Keys (KEKs)</strong><br>
                            <span style="font-size: 0.9rem; color: var(--text-secondary);">
                                Per-service or per-application. Rotated quarterly. Protected by Master Key.
                            </span>
                        </div>
                        <div style="text-align: center; color: var(--accent-cyan); margin: 10px 0;">‚Üì encrypts ‚Üì</div>
                        <div style="padding: 15px; background: rgba(245, 158, 11, 0.2); border-left: 3px solid var(--warning-orange); border-radius: 6px;">
                            <strong style="color: var(--warning-orange);">Data Encryption Keys (DEKs)</strong><br>
                            <span style="font-size: 0.9rem; color: var(--text-secondary);">
                                Per-record or per-file. Generated frequently. Used to encrypt actual data.
                            </span>
                        </div>
                    </div>
                </div>

                <h3 style="color: var(--text-primary); margin: 25px 0 15px;">How Envelope Encryption Works</h3>
                <div class="code-block">
                    <pre>
ENCRYPTION FLOW:
1. Generate random DEK (AES-256 key)
2. Encrypt plaintext data with DEK ‚Üí Encrypted Data
3. Call KMS to encrypt DEK with KEK ‚Üí Wrapped DEK
4. Store: Encrypted Data + Wrapped DEK
5. Delete plaintext DEK from memory

DECRYPTION FLOW:
1. Retrieve Encrypted Data + Wrapped DEK
2. Call KMS to decrypt Wrapped DEK ‚Üí Plaintext DEK
3. Decrypt Encrypted Data with DEK ‚Üí Plaintext Data
4. Delete plaintext DEK from memory
                    </pre>
                </div>

                <h3 style="color: var(--text-primary); margin: 25px 0 15px;">Benefits of Envelope Encryption</h3>
                <ul class="styled-list">
                    <li><strong>Performance:</strong> Only small DEK sent to KMS, not entire dataset. Local AES encryption is fast.</li>
                    <li><strong>Scalability:</strong> Unlimited data encryption without KMS throughput limits.</li>
                    <li><strong>Key Rotation:</strong> Rotate KEK without re-encrypting all data. Only re-wrap DEKs.</li>
                    <li><strong>Granular Control:</strong> Different DEKs for different files/records. Compromise of one DEK doesn't expose all data.</li>
                    <li><strong>Network Efficiency:</strong> Large files encrypted locally. Only DEK transmitted over network.</li>
                </ul>

                <div class="info-box">
                    <div class="info-box-title">
                        <span>üîê</span> Real-World Example: S3 Encryption
                    </div>
                    <div class="info-box-content">
                        When you enable S3 server-side encryption with AWS KMS (SSE-KMS):<br>
                        1. S3 generates a unique DEK for each object<br>
                        2. S3 encrypts your file with the DEK (AES-256-GCM)<br>
                        3. S3 calls KMS to encrypt the DEK with your CMK<br>
                        4. S3 stores the encrypted object + wrapped DEK<br>
                        5. On retrieval, KMS unwraps the DEK, S3 decrypts the object<br><br>
                        Your KMS CMK never leaves AWS KMS. It only encrypts/decrypts DEKs.
                    </div>
                </div>

                <h3 style="color: var(--text-primary); margin: 25px 0 15px;">Key Wrapping Algorithms</h3>
                <ul class="styled-list">
                    <li><strong>AES-KW (RFC 3394):</strong> NIST-approved key wrapping. Adds integrity check. Used by AWS KMS.</li>
                    <li><strong>RSA-OAEP:</strong> Asymmetric key wrapping. KEK is RSA public key. Good for key distribution.</li>
                    <li><strong>AES-GCM:</strong> AEAD mode provides encryption + authentication. Modern alternative to AES-KW.</li>
                </ul>
            </div>
        </div>

        <!-- Section 6: Access Control & Audit -->
        <div class="content-section" data-section="6">
            <h2 class="section-title">
                <span class="section-icon">üö¶</span>
                Access Control & Audit Logging
            </h2>
            <div class="section-content">
                <p class="section-text">
                    Keys are useless if anyone can access them. Strict access control and comprehensive
                    audit logging are essential to key management.
                </p>

                <h3 style="color: var(--text-primary); margin: 25px 0 15px;">Access Control Principles</h3>
                <ul class="styled-list">
                    <li><strong>Least Privilege:</strong> Grant minimum permissions required. Separate encrypt/decrypt permissions.</li>
                    <li><strong>Separation of Duties:</strong> Key administrators ‚â† key users. Prevent single-person compromise.</li>
                    <li><strong>Role-Based Access (RBAC):</strong> Assign permissions to roles, not individuals. Easier to manage at scale.</li>
                    <li><strong>Time-Based Access:</strong> Just-in-time (JIT) elevation. Temporary credentials with short TTLs.</li>
                    <li><strong>Context-Aware:</strong> IP restrictions, MFA requirements, device trust signals.</li>
                </ul>

                <h3 style="color: var(--text-primary); margin: 25px 0 15px;">AWS KMS Key Policies</h3>
                <div class="code-block">
                    <pre>
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Sid": "Enable IAM User Permissions",
      "Effect": "Allow",
      "Principal": {"AWS": "arn:aws:iam::123456789:root"},
      "Action": "kms:*",
      "Resource": "*"
    },
    {
      "Sid": "Allow application to encrypt",
      "Effect": "Allow",
      "Principal": {"AWS": "arn:aws:iam::123456789:role/app-role"},
      "Action": ["kms:Encrypt", "kms:GenerateDataKey"],
      "Resource": "*"
    },
    {
      "Sid": "Allow application to decrypt",
      "Effect": "Allow",
      "Principal": {"AWS": "arn:aws:iam::123456789:role/app-role"},
      "Action": "kms:Decrypt",
      "Resource": "*",
      "Condition": {
        "StringEquals": {
          "kms:ViaService": "s3.us-east-1.amazonaws.com"
        }
      }
    }
  ]
}
                    </pre>
                </div>

                <h3 style="color: var(--text-primary); margin: 25px 0 15px;">Audit Logging Requirements</h3>
                <p class="section-text">
                    Every cryptographic operation must be logged for compliance and security monitoring.
                </p>
                <ul class="styled-list">
                    <li><strong>AWS CloudTrail:</strong> Logs all KMS API calls (Encrypt, Decrypt, GenerateDataKey, etc.)</li>
                    <li><strong>Azure Monitor:</strong> Key Vault audit logs with Log Analytics integration</li>
                    <li><strong>Google Cloud Audit Logs:</strong> Admin activity and data access logs for Cloud KMS</li>
                    <li><strong>SIEM Integration:</strong> Forward logs to Splunk, Datadog, or Sentinel for analysis</li>
                </ul>

                <div class="warning-box">
                    <div class="warning-box-title">
                        <span>‚ö†Ô∏è</span> Audit Log Protection
                    </div>
                    <div class="info-box-content">
                        Audit logs themselves must be protected. Attackers often try to delete logs
                        to hide their tracks. Use write-once storage (S3 Object Lock), separate AWS
                        accounts for log aggregation, and alert on log deletion attempts.
                    </div>
                </div>

                <h3 style="color: var(--text-primary); margin: 25px 0 15px;">Monitoring & Alerts</h3>
                <ul class="styled-list">
                    <li><strong>Unusual Access Patterns:</strong> Alert on decrypt operations from new IPs or at unusual times</li>
                    <li><strong>High Volume:</strong> Spike in GenerateDataKey calls might indicate data exfiltration</li>
                    <li><strong>Failed Operations:</strong> Multiple failed decrypt attempts = potential attack</li>
                    <li><strong>Administrative Changes:</strong> Key policy modifications, key deletions, disable key schedule</li>
                    <li><strong>Cross-Region Activity:</strong> Key used from unexpected AWS regions</li>
                </ul>
            </div>
        </div>

        <!-- Section 7: Compliance Requirements -->
        <div class="content-section" data-section="7">
            <h2 class="section-title">
                <span class="section-icon">üìã</span>
                Compliance Requirements
            </h2>
            <div class="section-content">
                <p class="section-text">
                    Regulations like PCI-DSS, HIPAA, and SOC 2 have specific key management requirements.
                    Non-compliance can result in fines, loss of certifications, and business disruption.
                </p>

                <div class="grid-2">
                    <div class="feature-card">
                        <div class="card-icon">üí≥</div>
                        <div class="card-title">PCI-DSS 4.0</div>
                        <div class="card-description">
                            <strong>Requirement 3:</strong> Protect stored cardholder data<br>
                            ‚Ä¢ Key management procedures documented<br>
                            ‚Ä¢ Keys stored securely, separated from encrypted data<br>
                            ‚Ä¢ Key custodians with split knowledge<br>
                            ‚Ä¢ Annual key rotation<br>
                            ‚Ä¢ HSMs required for PIN encryption (Level 3)
                        </div>
                    </div>
                    <div class="feature-card">
                        <div class="card-icon">üè•</div>
                        <div class="card-title">HIPAA</div>
                        <div class="card-description">
                            <strong>164.312(a)(2)(iv):</strong> Encryption and decryption<br>
                            ‚Ä¢ Implement mechanisms to encrypt/decrypt ePHI<br>
                            ‚Ä¢ Key management processes documented<br>
                            ‚Ä¢ Access controls on encryption keys<br>
                            ‚Ä¢ Audit logs of key access<br>
                            ‚Ä¢ Note: Encryption is "addressable" not required
                        </div>
                    </div>
                    <div class="feature-card">
                        <div class="card-icon">üîí</div>
                        <div class="card-title">SOC 2 Type II</div>
                        <div class="card-description">
                            <strong>CC6.1 - Logical Access:</strong><br>
                            ‚Ä¢ Encryption key management procedures<br>
                            ‚Ä¢ Separation of duties for key administrators<br>
                            ‚Ä¢ Key lifecycle controls (generation, rotation, destruction)<br>
                            ‚Ä¢ Audit evidence of key management activities<br>
                            ‚Ä¢ Third-party attestation of controls
                        </div>
                    </div>
                    <div class="feature-card">
                        <div class="card-icon">üåç</div>
                        <div class="card-title">GDPR</div>
                        <div class="card-description">
                            <strong>Article 32:</strong> Security of processing<br>
                            ‚Ä¢ Encryption of personal data (pseudonymization)<br>
                            ‚Ä¢ Ability to restore access (key escrow/backup)<br>
                            ‚Ä¢ Testing and evaluation of effectiveness<br>
                            ‚Ä¢ Data breach notification within 72 hours<br>
                            ‚Ä¢ Fines up to ‚Ç¨20M or 4% global revenue
                        </div>
                    </div>
                </div>

                <h3 style="color: var(--text-primary); margin: 25px 0 15px;">Common Compliance Controls</h3>
                <table class="comparison-table">
                    <thead>
                        <tr>
                            <th>Control</th>
                            <th>Description</th>
                            <th>Evidence</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Key Generation</td>
                            <td>CSRNGs, adequate key strength</td>
                            <td>HSM certifications, entropy testing</td>
                        </tr>
                        <tr>
                            <td>Key Storage</td>
                            <td>Encrypted, access-controlled</td>
                            <td>FIPS 140-2 certs, access logs</td>
                        </tr>
                        <tr>
                            <td>Key Distribution</td>
                            <td>Secure channels, authentication</td>
                            <td>TLS configs, key wrapping procedures</td>
                        </tr>
                        <tr>
                            <td>Key Rotation</td>
                            <td>Regular rotation schedule</td>
                            <td>Rotation logs, change tickets</td>
                        </tr>
                        <tr>
                            <td>Key Destruction</td>
                            <td>Secure deletion procedures</td>
                            <td>Destruction logs, certificates</td>
                        </tr>
                        <tr>
                            <td>Access Control</td>
                            <td>RBAC, least privilege, MFA</td>
                            <td>IAM policies, access reviews</td>
                        </tr>
                        <tr>
                            <td>Audit Logging</td>
                            <td>All key operations logged</td>
                            <td>CloudTrail, SIEM dashboards</td>
                        </tr>
                        <tr>
                            <td>Disaster Recovery</td>
                            <td>Key backup and recovery procedures</td>
                            <td>DR tests, escrow agreements</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Section 8: Disaster Recovery -->
        <div class="content-section" data-section="8">
            <h2 class="section-title">
                <span class="section-icon">üî•</span>
                Disaster Recovery & Key Escrow
            </h2>
            <div class="section-content">
                <p class="section-text">
                    What happens if your key management infrastructure is destroyed? If keys are lost,
                    encrypted data is permanently inaccessible. DR planning for keys is critical.
                </p>

                <div class="warning-box">
                    <div class="warning-box-title">
                        <span>‚ö†Ô∏è</span> The Key Recovery Paradox
                    </div>
                    <div class="info-box-content">
                        You need to backup keys to prevent data loss, but backing up keys creates
                        additional attack surface. The backup itself becomes a high-value target.
                        This is why HSM backup procedures are so strictly controlled.
                    </div>
                </div>

                <h3 style="color: var(--text-primary); margin: 25px 0 15px;">HSM Backup Strategies</h3>
                <ul class="styled-list">
                    <li><strong>HSM-to-HSM Backup:</strong> Replicate keys to backup HSM using secure channels. Both HSMs must be from same vendor/family.</li>
                    <li><strong>Smartcard Backup:</strong> Export wrapped keys to FIPS-certified smartcards. Store in physical safe with M-of-N access control.</li>
                    <li><strong>Key Shares (Shamir Secret Sharing):</strong> Split master key into N shares, require M shares to reconstruct. Distribute to trusted custodians.</li>
                    <li><strong>Geographically Distributed:</strong> Store backup HSMs or key shares in separate physical locations to survive regional disasters.</li>
                </ul>

                <h3 style="color: var(--text-primary); margin: 25px 0 15px;">M-of-N Controls</h3>
                <p class="section-text">
                    Quorum-based access ensures no single person can access critical keys. Common in
                    financial and government deployments.
                </p>
                <div class="info-box">
                    <div class="info-box-title">
                        <span>üîê</span> Example: 3-of-5 Master Key Recovery
                    </div>
                    <div class="info-box-content">
                        Master key is split into 5 shares held by: CISO, CTO, VP Engineering,
                        Security Architect, and external auditor. Any 3 must physically be present
                        with their key shares to reconstruct the master key. Prevents insider threats
                        and ensures separation of duties.
                    </div>
                </div>

                <h3 style="color: var(--text-primary); margin: 25px 0 15px;">Cloud KMS Disaster Recovery</h3>
                <ul class="styled-list">
                    <li><strong>Multi-Region Replication:</strong> AWS KMS multi-region keys automatically replicate to backup regions</li>
                    <li><strong>Cross-Account Backup:</strong> Grant backup AWS account access to KMS keys for isolation</li>
                    <li><strong>Export to HSM:</strong> Some KMS services allow exporting wrapped keys to on-premises HSM for offline backup</li>
                    <li><strong>Key Material Import:</strong> Import your own key material (BYOK), maintain copy in your HSM</li>
                </ul>

                <h3 style="color: var(--text-primary); margin: 25px 0 15px;">Key Escrow Considerations</h3>
                <p class="section-text">
                    Key escrow = third party holds copy of your keys. Common in legal/compliance scenarios
                    but introduces significant risk.
                </p>
                <ul class="styled-list">
                    <li><strong>Law Enforcement Access:</strong> Some jurisdictions require key escrow for lawful intercept (controversial)</li>
                    <li><strong>Enterprise Key Recovery:</strong> HR may need to access encrypted files when employee leaves unexpectedly</li>
                    <li><strong>Escrow Agent Security:</strong> Third-party escrow services must meet or exceed your security standards</li>
                    <li><strong>Escrow Agreement:</strong> Legal contracts defining access conditions, audit rights, liability</li>
                </ul>

                <div class="warning-box">
                    <div class="warning-box-title">
                        <span>‚ö†Ô∏è</span> Key Escrow Risks
                    </div>
                    <div class="info-box-content">
                        Every copy of a key is a potential point of compromise. Escrowed keys have
                        been stolen (RSA 2011 breach), subpoenaed without customer knowledge, and
                        used for mass surveillance. Minimize escrow usage and ensure strict controls.
                    </div>
                </div>
            </div>
        </div>

        <!-- Section 9: Common Mistakes -->
        <div class="content-section" data-section="9">
            <h2 class="section-title">
                <span class="section-icon">üí•</span>
                Common Key Management Mistakes
            </h2>
            <div class="section-content">
                <p class="section-text">
                    Even with the best tools, poor practices can undermine security. Here are the
                    most common and dangerous key management mistakes.
                </p>

                <h3 style="color: var(--text-primary); margin: 25px 0 15px;">1. Hardcoded Keys</h3>
                <div class="warning-box">
                    <div class="warning-box-title">
                        <span>‚ö†Ô∏è</span> Critical Vulnerability
                    </div>
                    <div class="info-box-content">
                        Embedding encryption keys directly in source code is the #1 key management
                        failure. Code is version controlled, shared with developers, and often
                        ends up in public repositories.
                    </div>
                </div>
                <div class="code-block">
                    <pre>
// NEVER DO THIS
const encryptionKey = "a3f8b2c1d4e5f6a7b8c9d0e1f2a3b4c5";
const encrypted = AES.encrypt(data, encryptionKey);

// INSTEAD: Use environment variables or KMS
const kmsClient = new AWS.KMS();
const { Plaintext } = await kmsClient.decrypt({
    CiphertextBlob: process.env.ENCRYPTED_KEY
});
const encryptionKey = Plaintext.toString();
                    </pre>
                </div>

                <h3 style="color: var(--text-primary); margin: 25px 0 15px;">2. Weak Key Generation</h3>
                <ul class="styled-list">
                    <li><strong>Using Math.random():</strong> Not cryptographically secure. Predictable. Use crypto.randomBytes() or equivalent.</li>
                    <li><strong>Insufficient Entropy:</strong> Generating keys on VMs with low entropy. Use /dev/urandom or hardware RNG.</li>
                    <li><strong>Predictable Seeds:</strong> Seeding RNG with timestamp or sequential values. Attacker can reproduce.</li>
                    <li><strong>Weak Key Lengths:</strong> Using AES-128 when 256 is available. RSA-2048 when 4096 is standard.</li>
                </ul>

                <h3 style="color: var(--text-primary); margin: 25px 0 15px;">3. No Key Rotation</h3>
                <p class="section-text">
                    "Set and forget" keys remain in use for years, even decades. The longer a key
                    is used, the more data it protects and the more valuable it becomes to attackers.
                </p>
                <ul class="styled-list">
                    <li><strong>Data Exposure Window:</strong> Compromised 5-year-old key exposes 5 years of data</li>
                    <li><strong>Compliance Violations:</strong> PCI-DSS requires annual rotation minimum</li>
                    <li><strong>Cryptanalysis Risk:</strong> More ciphertext = easier cryptanalysis (especially for stream ciphers)</li>
                </ul>

                <h3 style="color: var(--text-primary); margin: 25px 0 15px;">4. Keys in Version Control</h3>
                <div class="warning-box">
                    <div class="warning-box-title">
                        <span>‚ö†Ô∏è</span> The Git History Problem
                    </div>
                    <div class="info-box-content">
                        Committing keys to Git (even temporarily) is permanent. Git history is immutable.
                        Even after removing the file, the key remains in git history forever. Attackers
                        scan GitHub for patterns like "-----BEGIN PRIVATE KEY-----" or AWS access keys.
                    </div>
                </div>
                <p class="section-text">
                    Solutions: Use .gitignore for config files, pre-commit hooks to scan for secrets
                    (git-secrets, truffleHog), and secret scanning services (GitHub Secret Scanning, GitGuardian).
                </p>

                <h3 style="color: var(--text-primary); margin: 25px 0 15px;">5. Storing Keys With Encrypted Data</h3>
                <p class="section-text">
                    Storing the encryption key in the same database/filesystem as the encrypted data
                    defeats the purpose. If an attacker gains access to the data, they get the key too.
                </p>
                <div class="code-block">
                    <pre>
‚ùå BAD: Database schema
users
  - id
  - encrypted_ssn
  - encryption_key  ‚Üê Key in same table as data!

‚úÖ GOOD: Separation of concerns
users
  - id
  - encrypted_ssn
  - key_id          ‚Üê Reference to KMS key

AWS KMS (separate service)
  - Master key encrypts DEKs
  - DEKs stored wrapped, separate from data
                    </pre>
                </div>

                <h3 style="color: var(--text-primary); margin: 25px 0 15px;">6. Unencrypted Key Backups</h3>
                <p class="section-text">
                    Backing up keys to S3, network shares, or backup tapes in plaintext. Backup
                    systems often have weaker access controls than production.
                </p>

                <h3 style="color: var(--text-primary); margin: 25px 0 15px;">7. Insufficient Access Controls</h3>
                <ul class="styled-list">
                    <li><strong>Overly Permissive IAM:</strong> Granting kms:* instead of specific operations</li>
                    <li><strong>No MFA on Key Admin:</strong> Allow key deletion without multi-factor authentication</li>
                    <li><strong>Shared Service Accounts:</strong> Multiple apps using same KMS key</li>
                    <li><strong>No Network Restrictions:</strong> KMS accessible from any IP address</li>
                </ul>

                <h3 style="color: var(--text-primary); margin: 25px 0 15px;">8. Missing Audit Logging</h3>
                <p class="section-text">
                    Not enabling CloudTrail for KMS, or not monitoring logs. You can't detect or
                    investigate key compromise without comprehensive logging.
                </p>

                <h3 style="color: var(--text-primary); margin: 25px 0 15px;">9. No Disaster Recovery Testing</h3>
                <p class="section-text">
                    Having a DR plan on paper but never testing key recovery. During an actual disaster,
                    you discover the backup HSM password was never documented, or the key shares are
                    stored with people who left the company.
                </p>
            </div>
        </div>

        <!-- Section 10: Summary -->
        <div class="content-section" data-section="10">
            <h2 class="section-title">
                <span class="section-icon">üéØ</span>
                Key Takeaways
            </h2>
            <div class="section-content">
                <ul class="styled-list">
                    <li><strong>Keys are the crown jewels.</strong> Protect them with the same rigor as the data they encrypt.</li>
                    <li><strong>Lifecycle management is mandatory.</strong> Generation, distribution, storage, rotation, and destruction must all be controlled.</li>
                    <li><strong>HSMs provide the gold standard.</strong> FIPS 140-2 Level 3+ for high-value keys (PKI roots, code signing, payments).</li>
                    <li><strong>Cloud KMS for scale.</strong> AWS KMS, Azure Key Vault, Google Cloud KMS provide enterprise key management without HSM operations.</li>
                    <li><strong>Envelope encryption is the pattern.</strong> Master keys encrypt KEKs, KEKs encrypt DEKs, DEKs encrypt data.</li>
                    <li><strong>Compliance is non-negotiable.</strong> PCI-DSS, HIPAA, SOC 2 have specific key management requirements with legal consequences.</li>
                    <li><strong>Access control and audit logging.</strong> Who can use keys, for what, and comprehensive logging of all operations.</li>
                    <li><strong>Disaster recovery planning.</strong> Key backups, M-of-N controls, tested recovery procedures.</li>
                    <li><strong>Avoid common mistakes.</strong> No hardcoded keys, no keys in git, always rotate, separate keys from data.</li>
                    <li><strong>Defense in depth.</strong> Key management is one layer. Combine with network security, access controls, and monitoring.</li>
                </ul>

                <div class="info-box" style="margin-top: 30px;">
                    <div class="info-box-title">
                        <span>üéì</span> Next Steps
                    </div>
                    <div class="info-box-content">
                        Practice with the interactive tools and labs. Design a key hierarchy for a
                        fictional e-commerce platform. Review your organization's current key management
                        practices against these principles. Understand the trade-offs between security,
                        convenience, and cost.
                    </div>
                </div>
            </div>
        </div>

        <!-- Navigation -->
        <div class="nav-buttons">
            <a href="../tools/key-lifecycle.html" class="nav-btn">
                <span>üîß</span> Interactive Tools
            </a>
            <a href="../labs/hsm-lab.html" class="nav-btn">
                <span>üß™</span> Hands-On Lab
            </a>
            <a href="../quizzes/hsm-quiz.html" class="nav-btn primary">
                <span>üìù</span> Take Quiz
            </a>
        </div>
    </div>

    <!-- Completion Message -->
    <div class="completion-message" id="completion-message">
        <span style="font-size: 1.5rem;">‚úì</span>
        <span>Module completed! Progress saved.</span>
    </div>

    <script>
        // Progress tracking
        let currentSection = 0;
        const totalSections = document.querySelectorAll('.content-section').length;

        function updateProgress() {
            const progress = Math.round((currentSection / totalSections) * 100);
            document.getElementById('progress-text').textContent = `${progress}% Complete`;
            document.getElementById('progress-fill').style.width = `${progress}%`;
        }

        // Intersection Observer for scroll-based progress
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    const section = parseInt(entry.target.dataset.section);
                    if (section > currentSection) {
                        currentSection = section;
                        updateProgress();

                        // Mark complete when reaching final section
                        if (currentSection === totalSections) {
                            setTimeout(() => {
                                markComplete();
                            }, 2000);
                        }
                    }
                }
            });
        }, { threshold: 0.5 });

        document.querySelectorAll('.content-section').forEach(section => {
            observer.observe(section);
        });

        // Mark module as complete
        function markComplete() {
            if (typeof ModuleProgress !== 'undefined') {
                ModuleProgress.complete('key', 'key-management');
            }

            // Show completion message
            const msg = document.getElementById('completion-message');
            msg.classList.add('show');
            setTimeout(() => {
                msg.classList.remove('show');
            }, 3000);

            // Award achievement
            if (typeof AchievementManager !== 'undefined') {
                AchievementManager.unlock('key_master');
            }
        }

        // Initialize
        updateProgress();

        // Smooth scroll for navigation
        document.querySelectorAll('a[href^="#"]').forEach(anchor => {
            anchor.addEventListener('click', function (e) {
                e.preventDefault();
                const target = document.querySelector(this.getAttribute('href'));
                if (target) {
                    target.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            });
        });
    </script>
<script src="../../../components/FluxCapacitor.js"></script>
</body>
</html>
