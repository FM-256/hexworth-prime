<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <!-- Access Control -->
    <script src="../../../components/AccessGuard.js"></script>
    <script>
        AccessGuard.require('sorted');
    </script>
    <!-- Achievement & Progress Integration -->
    <script src="../../../components/AchievementManager.js"></script>
    <script src="../../../components/ModuleProgress.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Terraform Fundamentals Quiz - House of the Code</title>
    <style>
        :root {
            --bg: #0f172a;
            --panel: #111827ee;
            --ink: #e5e7eb;
            --muted: #9ca3af;
            --accent: #7B42BC;
            --accent-2: #6366F1;
            --good: #10b981;
            --bad: #ef4444;
            --warn: #f59e0b;
        }

        * {
            box-sizing: border-box;
        }

        html, body {
            height: 100%;
        }

        body {
            margin: 0;
            background: radial-gradient(1200px 800px at 110% -10%, #1f2937, transparent 60%),
                       radial-gradient(1200px 800px at -10% 110%, #111827, transparent 60%),
                       var(--bg);
            color: var(--ink);
            font-family: Inter, system-ui, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
            line-height: 1.55;
        }

        .container {
            max-width: 1050px;
            margin: 0 auto;
            padding: 28px;
        }

        header {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }

        .title {
            font-weight: 800;
            font-size: clamp(22px, 2.3vw, 34px);
            letter-spacing: 0.3px;
        }

        .panel {
            background: linear-gradient(180deg, #0b1220 0%, #0b1120 10%, #0b1020 100%);
            border: 1px solid #1f2937;
            border-radius: 16px;
            box-shadow: 0 15px 45px #0008;
            overflow: hidden;
        }

        .toolbar {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            align-items: center;
        }

        button {
            appearance: none;
            border: none;
            border-radius: 12px;
            padding: 10px 14px;
            font-weight: 650;
            color: #0b1120;
            background: var(--accent);
            cursor: pointer;
            transition: transform 0.08s ease, filter 0.15s ease;
        }

        button.secondary {
            background: #1f2937;
            color: var(--ink);
            border: 1px solid #2b3444;
        }

        button:hover {
            filter: brightness(1.05);
        }

        button:active {
            transform: translateY(1px);
        }

        .row {
            display: flex;
            gap: 18px;
            flex-wrap: wrap;
        }

        .card {
            background: var(--panel);
            border: 1px solid #202b41;
            border-radius: 16px;
            padding: 18px;
        }

        .meta {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .chip {
            padding: 6px 10px;
            border-radius: 999px;
            border: 1px solid #2b3444;
            color: var(--muted);
            font-size: 12px;
        }

        .progress {
            height: 10px;
            background: #111827;
            border: 1px solid #2b3444;
            border-radius: 999px;
            overflow: hidden;
        }

        .progress > span {
            display: block;
            height: 100%;
            background: linear-gradient(90deg, var(--accent), var(--accent-2));
            width: 0;
        }

        .hidden {
            display: none;
        }

        .q {
            margin: 2px 0 10px;
            font-weight: 700;
        }

        .opt {
            display: flex;
            gap: 10px;
            align-items: flex-start;
            padding: 10px 12px;
            border: 1px solid #2b3444;
            border-radius: 12px;
            margin: 8px 0;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .opt:hover {
            background: rgba(123, 66, 188, 0.05);
            border-color: var(--accent);
        }

        .opt input {
            margin-top: 4px;
        }

        .opt.correct {
            border-color: color-mix(in hsl, var(--good), #fff 20%);
            background: #052e1a;
        }

        .opt.wrong {
            border-color: color-mix(in hsl, var(--bad), #fff 30%);
            background: #2a0b0b;
        }

        .msg {
            font-size: 14px;
            color: var(--muted);
        }

        .grid {
            display: grid;
            gap: 18px;
        }

        @media(min-width: 860px) {
            .grid {
                grid-template-columns: 1.2fr 0.8fr;
            }
        }

        .score-good {
            color: var(--good);
        }

        .score-mid {
            color: var(--warn);
        }

        .score-bad {
            color: var(--bad);
        }

        .footer {
            color: #94a3b8;
            font-size: 13px;
            margin-top: 8px;
        }

        .timer {
            font-variant-numeric: tabular-nums;
            font-weight: 800;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="title">Terraform Fundamentals Quiz <span style="opacity:.55">— Test Your Knowledge</span></div>
            <div class="toolbar">
                <button id="startBtn">Start</button>
                <button id="resetBtn" class="secondary" title="Clear answers and restart">Reset</button>
            </div>
        </header>

        <div class="panel card" id="intro">
            <div class="row" style="align-items:flex-start">
                <div style="flex:1;min-width:260px">
                    <h2 style="margin:.2rem 0 0">Instructions</h2>
                    <ul style="margin:.4rem 0 1rem; line-height:1.8">
                        <li>This quiz contains <strong>10 questions</strong> covering Terraform fundamentals.</li>
                        <li>Total points: <strong>100</strong> (<em>10 points</em> each)</li>
                        <li>Time limit: <strong>20 minutes</strong></li>
                        <li>Your progress autosaves locally.</li>
                    </ul>
                    <div class="meta">
                        <span class="chip">Infrastructure as Code</span>
                        <span class="chip">HCL Syntax</span>
                        <span class="chip">Time-boxed</span>
                        <span class="chip">Autosave</span>
                    </div>
                </div>
                <div style="flex:1;min-width:260px">
                    <div class="card" style="background:#0b1220;border-color:#1f2937">
                        <div class="row" style="justify-content:space-between;align-items:center">
                            <div>
                                <div class="msg">Timer</div>
                                <div class="timer" id="timer">20:00</div>
                            </div>
                            <div style="flex:1"></div>
                            <div style="min-width:55%;">
                                <div class="msg">Progress</div>
                                <div class="progress" aria-label="Quiz completion">
                                    <span id="progressBar" style="width:0%"></span>
                                </div>
                                <div class="msg" id="progressText" aria-live="polite">0 / 10 answered</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <main class="grid" id="quizArea" aria-live="polite">
            <section id="questions"></section>
            <aside>
                <div class="card">
                    <h3 style="margin-top:0">Your Status</h3>
                    <p class="msg">Answer all questions, then submit.</p>
                    <div class="row">
                        <button id="submitBtn">Submit Quiz</button>
                        <button id="reviewBtn" class="secondary">Review Answers</button>
                    </div>
                    <hr style="border-color:#253049;margin:16px 0">
                    <div class="msg">Score</div>
                    <div id="scoreDisplay" style="font-size:28px;font-weight:800">—</div>
                    <div id="scoreNote" class="footer">Not graded yet</div>
                </div>
            </aside>
        </main>

        <section class="panel card hidden" id="results">
            <h2 style="margin-top:0">Results</h2>
            <p id="resultsSummary"></p>
            <div id="resultsList"></div>
            <div class="row" style="margin-top:10px">
                <button id="retryBtn">Retry</button>
                <button id="showKeyBtn" class="secondary">Show Answer Key</button>
            </div>
        </section>

        <footer class="footer">Terraform Fundamentals Quiz • House of the Code • Hexworth Prime</footer>
    </div>

    <script>
        const STORAGE_KEY = "terraform_quiz_v1";
        const TOTAL_TIME_SECONDS = 20 * 60;
        let remaining = TOTAL_TIME_SECONDS;
        let timerId = null;
        let submitted = false;

        const quiz = [
            {
                id: 1,
                type: "mc",
                points: 10,
                stem: "What does IaC stand for in the context of Terraform?",
                choices: [
                    "Infrastructure as Code",
                    "Integration as Configuration",
                    "Internet Architecture Cloud",
                    "Internal Application Container"
                ],
                answer: 0
            },
            {
                id: 2,
                type: "mc",
                points: 10,
                stem: "What language does Terraform use for configuration files?",
                choices: [
                    "YAML",
                    "JSON",
                    "HCL (HashiCorp Configuration Language)",
                    "XML"
                ],
                answer: 2
            },
            {
                id: 3,
                type: "mc",
                points: 10,
                stem: "Which Terraform command initializes a working directory and downloads provider plugins?",
                choices: [
                    "terraform start",
                    "terraform init",
                    "terraform setup",
                    "terraform install"
                ],
                answer: 1
            },
            {
                id: 4,
                type: "mc",
                points: 10,
                stem: "What is the purpose of 'terraform plan'?",
                choices: [
                    "Execute changes to infrastructure",
                    "Preview what changes will be made without applying them",
                    "Delete all resources",
                    "Initialize the Terraform backend"
                ],
                answer: 1
            },
            {
                id: 5,
                type: "mc",
                points: 10,
                stem: "What does the Terraform state file (terraform.tfstate) contain?",
                choices: [
                    "Only configuration code",
                    "A record of infrastructure resources and their current state",
                    "Provider installation packages",
                    "User credentials and passwords"
                ],
                answer: 1
            },
            {
                id: 6,
                type: "tf",
                points: 10,
                stem: "Terraform is cloud-agnostic and can manage infrastructure across multiple cloud providers (AWS, Azure, GCP, etc.).",
                answer: true
            },
            {
                id: 7,
                type: "mc",
                points: 10,
                stem: "In Terraform, what keyword is used to define infrastructure components you want to create?",
                choices: [
                    "module",
                    "provider",
                    "resource",
                    "variable"
                ],
                answer: 2
            },
            {
                id: 8,
                type: "mc",
                points: 10,
                stem: "What is the best practice for storing Terraform state in a team environment?",
                choices: [
                    "Commit the state file to Git",
                    "Store it locally on each developer's machine",
                    "Use a remote backend like S3 with state locking",
                    "Email it to team members after each change"
                ],
                answer: 2
            },
            {
                id: 9,
                type: "mc",
                points: 10,
                stem: "What is a Terraform module?",
                choices: [
                    "A plugin for cloud providers",
                    "A container for multiple resources that are used together",
                    "A type of variable",
                    "A command-line tool"
                ],
                answer: 1
            },
            {
                id: 10,
                type: "tf",
                points: 10,
                stem: "The 'terraform destroy' command removes all infrastructure resources managed by the current Terraform configuration.",
                answer: true
            }
        ];

        const el = sel => document.querySelector(sel);
        const els = sel => Array.from(document.querySelectorAll(sel));

        function renderQuestions() {
            const container = el('#questions');
            container.innerHTML = '';
            quiz.forEach((q, idx) => {
                const wrap = document.createElement('article');
                wrap.className = 'card';
                wrap.setAttribute('data-qid', q.id);

                const header = document.createElement('div');
                header.className = 'meta';
                header.innerHTML = `<span class="chip">Question ${idx + 1}</span><span class="chip">${q.points} pts</span>`;

                const h = document.createElement('h3');
                h.className = 'q';
                h.textContent = q.stem;

                const area = document.createElement('div');

                if (q.type === 'mc') {
                    q.choices.forEach((c, i) => {
                        const id = `q${q.id}_opt${i}`;
                        const lab = document.createElement('label');
                        lab.className = 'opt';
                        lab.innerHTML = `<input type="radio" name="q${q.id}" id="${id}" value="${i}" aria-label="${c}"><div>${String.fromCharCode(65 + i)}) ${c}</div>`;
                        area.appendChild(lab);
                    });
                }

                if (q.type === 'tf') {
                    ["True", "False"].forEach((c, i) => {
                        const id = `q${q.id}_tf${i}`;
                        const lab = document.createElement('label');
                        lab.className = 'opt';
                        lab.innerHTML = `<input type="radio" name="q${q.id}" id="${id}" value="${i === 0}"><div>${c}</div>`;
                        area.appendChild(lab);
                    });
                }

                wrap.appendChild(header);
                wrap.appendChild(h);
                wrap.appendChild(area);
                container.appendChild(wrap);
            });
        }

        function getAnswers() {
            const answers = {};
            quiz.forEach(q => {
                const picked = el(`input[name="q${q.id}"]:checked`);
                answers[q.id] = picked ? picked.value : null;
            });
            return answers;
        }

        function gradeQuiz() {
            const answers = getAnswers();
            let correct = 0;
            let total = 0;

            quiz.forEach(q => {
                const userAnswer = answers[q.id];
                if (userAnswer === null) return;

                const isCorrect = (q.type === 'mc')
                    ? parseInt(userAnswer) === q.answer
                    : (userAnswer === 'true') === q.answer;

                if (isCorrect) {
                    correct += q.points;
                }
                total += q.points;

                const opts = els(`input[name="q${q.id}"]`);
                opts.forEach(opt => {
                    const lab = opt.closest('.opt');
                    const isUserChoice = opt.checked;
                    const isRightAnswer = (q.type === 'mc')
                        ? parseInt(opt.value) === q.answer
                        : (opt.value === 'true') === q.answer;

                    if (isUserChoice && isCorrect) {
                        lab.classList.add('correct');
                    } else if (isUserChoice && !isCorrect) {
                        lab.classList.add('wrong');
                    }
                    if (isRightAnswer && !isCorrect) {
                        lab.style.borderColor = 'color-mix(in hsl, var(--good), #fff 40%)';
                    }
                });
            });

            return { correct, total };
        }

        function showResults(score, total) {
            const pct = (score / total) * 100;
            const colorClass = pct >= 80 ? 'score-good' : pct >= 60 ? 'score-mid' : 'score-bad';
            const msg = pct >= 80 ? 'Excellent!' : pct >= 60 ? 'Good job!' : 'Keep practicing!';

            el('#scoreDisplay').textContent = `${score} / ${total}`;
            el('#scoreDisplay').className = colorClass;
            el('#scoreNote').textContent = `${pct.toFixed(0)}% - ${msg}`;

            el('#intro').classList.add('hidden');
            el('#quizArea').classList.add('hidden');
            el('#results').classList.remove('hidden');

            el('#resultsSummary').textContent = `You scored ${score} out of ${total} points (${pct.toFixed(0)}%).`;

            // Complete module if passed
            if (pct >= 70) {
                ModuleProgress.completeQuiz('code', 'code-terraform-quiz', {
                    score: score,
                    total: total,
                    percentage: pct
                });
            }
        }

        function updateTimer() {
            const m = Math.floor(remaining / 60);
            const s = remaining % 60;
            el('#timer').textContent = `${m}:${s.toString().padStart(2, '0')}`;
            if (remaining <= 0) {
                clearInterval(timerId);
                submitQuiz();
            }
            remaining--;
        }

        function updateProgress() {
            const answers = getAnswers();
            const answered = Object.values(answers).filter(a => a !== null).length;
            const pct = (answered / quiz.length) * 100;
            el('#progressBar').style.width = pct + '%';
            el('#progressText').textContent = `${answered} / ${quiz.length} answered`;
        }

        function submitQuiz() {
            if (submitted) return;
            submitted = true;
            clearInterval(timerId);

            const { correct, total } = gradeQuiz();
            showResults(correct, total);

            localStorage.removeItem(STORAGE_KEY);
        }

        function startQuiz() {
            el('#intro').classList.add('hidden');
            el('#quizArea').classList.remove('hidden');
            renderQuestions();
            loadState();

            timerId = setInterval(updateTimer, 1000);
            updateTimer();

            document.addEventListener('change', () => {
                updateProgress();
                saveState();
            });
        }

        function resetQuiz() {
            if (!confirm('Reset quiz and clear all answers?')) return;
            localStorage.removeItem(STORAGE_KEY);
            location.reload();
        }

        function retryQuiz() {
            localStorage.removeItem(STORAGE_KEY);
            location.reload();
        }

        function saveState() {
            const answers = getAnswers();
            localStorage.setItem(STORAGE_KEY, JSON.stringify({
                answers,
                remaining
            }));
        }

        function loadState() {
            const saved = localStorage.getItem(STORAGE_KEY);
            if (!saved) return;

            const { answers, remaining: savedTime } = JSON.parse(saved);
            remaining = savedTime;

            Object.entries(answers).forEach(([qid, val]) => {
                if (val !== null) {
                    const inp = el(`input[name="q${qid}"][value="${val}"]`);
                    if (inp) inp.checked = true;
                }
            });

            updateProgress();
        }

        el('#startBtn').addEventListener('click', startQuiz);
        el('#resetBtn').addEventListener('click', resetQuiz);
        el('#submitBtn').addEventListener('click', submitQuiz);
        el('#reviewBtn').addEventListener('click', () => {
            document.querySelector('#questions').scrollIntoView({ behavior: 'smooth' });
        });
        el('#retryBtn').addEventListener('click', retryQuiz);
        el('#showKeyBtn').addEventListener('click', () => {
            alert('Terraform Quiz Answer Key:\n\n' + quiz.map((q, i) => {
                const ans = q.type === 'mc' ? String.fromCharCode(65 + q.answer) + ') ' + q.choices[q.answer] : (q.answer ? 'True' : 'False');
                return `${i+1}. ${ans}`;
            }).join('\n'));
        });
    </script>
<script src="../../../components/FluxCapacitor.js"></script>
</body>
</html>
