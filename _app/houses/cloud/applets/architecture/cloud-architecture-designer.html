<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <!-- Access Control -->
    <script src="../../../../components/AccessGuard.js"></script>
    <script>
        AccessGuard.require('sorted');
    </script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cloud Architecture Designer - Network Essentials</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: #e0e0e0;
            overflow: hidden;
            height: 100vh;
        }

        .container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            padding: 20px;
            gap: 20px;
        }

        header {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.18);
        }

        h1 {
            font-size: 28px;
            margin-bottom: 8px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .subtitle {
            font-size: 14px;
            color: #b0b0b0;
        }

        .main-content {
            display: flex;
            gap: 20px;
            flex: 1;
            overflow: hidden;
        }

        .sidebar {
            width: 280px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.18);
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .sidebar::-webkit-scrollbar {
            width: 8px;
        }

        .sidebar::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }

        .sidebar::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 10px;
        }

        .category {
            margin-bottom: 15px;
        }

        .category-title {
            font-size: 14px;
            font-weight: 600;
            color: #4fc3f7;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .components {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }

        .component-item {
            background: rgba(255, 255, 255, 0.15);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            padding: 12px 8px;
            text-align: center;
            cursor: grab;
            transition: all 0.3s ease;
            font-size: 11px;
            user-select: none;
        }

        .component-item:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .component-item:active {
            cursor: grabbing;
        }

        .component-icon {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .workspace {
            flex: 1;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.18);
            overflow: hidden;
            position: relative;
        }

        .toolbar {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px 20px;
            display: flex;
            gap: 15px;
            align-items: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            flex-wrap: wrap;
        }

        .tool-group {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .toolbar button, .toolbar select {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: #fff;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.3s ease;
        }

        .toolbar button:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-1px);
        }

        .toolbar button.active {
            background: #667eea;
            border-color: #667eea;
        }

        .toolbar select {
            cursor: pointer;
            padding: 8px 12px;
        }

        .toolbar label {
            font-size: 12px;
            color: #b0b0b0;
            margin-right: 5px;
        }

        .canvas-container {
            position: relative;
            width: 100%;
            height: calc(100% - 60px);
            overflow: hidden;
            background-image:
                repeating-linear-gradient(0deg, rgba(255,255,255,0.03) 0px, rgba(255,255,255,0.03) 1px, transparent 1px, transparent 20px),
                repeating-linear-gradient(90deg, rgba(255,255,255,0.03) 0px, rgba(255,255,255,0.03) 1px, transparent 1px, transparent 20px);
        }

        #canvas {
            width: 100%;
            height: 100%;
            cursor: default;
        }

        .canvas-component {
            cursor: move;
            user-select: none;
        }

        .canvas-component rect {
            transition: all 0.2s ease;
        }

        .canvas-component:hover rect {
            filter: brightness(1.2);
        }

        .canvas-component.selected rect {
            stroke: #ffd700;
            stroke-width: 3;
        }

        .connection-line {
            pointer-events: stroke;
            cursor: pointer;
        }

        .connection-line:hover {
            filter: brightness(1.3);
        }

        .delete-button {
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .canvas-component:hover .delete-button {
            opacity: 1;
        }

        .templates-section {
            margin-top: auto;
            padding-top: 15px;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
        }

        .template-btn {
            width: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: #fff;
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
            margin-bottom: 8px;
            transition: all 0.3s ease;
        }

        .template-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: rgba(30, 60, 114, 0.95);
            border-radius: 15px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
        }

        .modal-content h2 {
            margin-bottom: 20px;
            color: #4fc3f7;
        }

        .modal-content textarea {
            width: 100%;
            height: 300px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: #e0e0e0;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            resize: vertical;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            justify-content: flex-end;
        }

        .modal-buttons button {
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: #667eea;
            color: #fff;
        }

        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.2);
            color: #fff;
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .info-panel {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.7);
            padding: 12px 18px;
            border-radius: 10px;
            font-size: 12px;
            color: #b0b0b0;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .info-panel div {
            margin-bottom: 4px;
        }

        .info-panel div:last-child {
            margin-bottom: 0;
        }

        .color-indicator {
            display: inline-block;
            width: 20px;
            height: 3px;
            margin-right: 5px;
            vertical-align: middle;
        }

        @media (max-width: 1024px) {
            .sidebar {
                width: 240px;
            }

            .components {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Cloud Architecture Designer</h1>
            <p class="subtitle">Design and visualize cloud infrastructure architectures with drag-and-drop components</p>
        </header>

        <div class="main-content">
            <aside class="sidebar">
                <div class="category">
                    <div class="category-title">Compute</div>
                    <div class="components">
                        <div class="component-item" draggable="true" data-type="vm" data-category="compute">
                            <div class="component-icon">üñ•Ô∏è</div>
                            <div>VM</div>
                        </div>
                        <div class="component-item" draggable="true" data-type="container" data-category="compute">
                            <div class="component-icon">üì¶</div>
                            <div>Container</div>
                        </div>
                        <div class="component-item" draggable="true" data-type="serverless" data-category="compute">
                            <div class="component-icon">‚ö°</div>
                            <div>Serverless</div>
                        </div>
                        <div class="component-item" draggable="true" data-type="kubernetes" data-category="compute">
                            <div class="component-icon">‚ò∏Ô∏è</div>
                            <div>Kubernetes</div>
                        </div>
                    </div>
                </div>

                <div class="category">
                    <div class="category-title">Storage</div>
                    <div class="components">
                        <div class="component-item" draggable="true" data-type="object-storage" data-category="storage">
                            <div class="component-icon">üóÑÔ∏è</div>
                            <div>Object Store</div>
                        </div>
                        <div class="component-item" draggable="true" data-type="block-storage" data-category="storage">
                            <div class="component-icon">üíæ</div>
                            <div>Block Store</div>
                        </div>
                        <div class="component-item" draggable="true" data-type="file-storage" data-category="storage">
                            <div class="component-icon">üìÅ</div>
                            <div>File Store</div>
                        </div>
                    </div>
                </div>

                <div class="category">
                    <div class="category-title">Database</div>
                    <div class="components">
                        <div class="component-item" draggable="true" data-type="sql" data-category="database">
                            <div class="component-icon">üóÉÔ∏è</div>
                            <div>SQL DB</div>
                        </div>
                        <div class="component-item" draggable="true" data-type="nosql" data-category="database">
                            <div class="component-icon">üìä</div>
                            <div>NoSQL DB</div>
                        </div>
                        <div class="component-item" draggable="true" data-type="cache" data-category="database">
                            <div class="component-icon">‚ö°</div>
                            <div>Cache</div>
                        </div>
                        <div class="component-item" draggable="true" data-type="warehouse" data-category="database">
                            <div class="component-icon">üèõÔ∏è</div>
                            <div>Warehouse</div>
                        </div>
                    </div>
                </div>

                <div class="category">
                    <div class="category-title">Networking</div>
                    <div class="components">
                        <div class="component-item" draggable="true" data-type="vpc" data-category="networking">
                            <div class="component-icon">üåê</div>
                            <div>VPC</div>
                        </div>
                        <div class="component-item" draggable="true" data-type="loadbalancer" data-category="networking">
                            <div class="component-icon">‚öñÔ∏è</div>
                            <div>Load Balancer</div>
                        </div>
                        <div class="component-item" draggable="true" data-type="cdn" data-category="networking">
                            <div class="component-icon">üåç</div>
                            <div>CDN</div>
                        </div>
                        <div class="component-item" draggable="true" data-type="dns" data-category="networking">
                            <div class="component-icon">üì°</div>
                            <div>DNS</div>
                        </div>
                        <div class="component-item" draggable="true" data-type="firewall" data-category="networking">
                            <div class="component-icon">üõ°Ô∏è</div>
                            <div>Firewall</div>
                        </div>
                        <div class="component-item" draggable="true" data-type="gateway" data-category="networking">
                            <div class="component-icon">üö™</div>
                            <div>Gateway</div>
                        </div>
                    </div>
                </div>

                <div class="category">
                    <div class="category-title">Security</div>
                    <div class="components">
                        <div class="component-item" draggable="true" data-type="iam" data-category="security">
                            <div class="component-icon">üîê</div>
                            <div>IAM</div>
                        </div>
                        <div class="component-item" draggable="true" data-type="encryption" data-category="security">
                            <div class="component-icon">üîí</div>
                            <div>Encryption</div>
                        </div>
                        <div class="component-item" draggable="true" data-type="waf" data-category="security">
                            <div class="component-icon">üõ°Ô∏è</div>
                            <div>WAF</div>
                        </div>
                    </div>
                </div>

                <div class="category">
                    <div class="category-title">Users/Clients</div>
                    <div class="components">
                        <div class="component-item" draggable="true" data-type="web-user" data-category="users">
                            <div class="component-icon">üë§</div>
                            <div>Web User</div>
                        </div>
                        <div class="component-item" draggable="true" data-type="mobile-user" data-category="users">
                            <div class="component-icon">üì±</div>
                            <div>Mobile User</div>
                        </div>
                        <div class="component-item" draggable="true" data-type="iot" data-category="users">
                            <div class="component-icon">üìü</div>
                            <div>IoT Device</div>
                        </div>
                    </div>
                </div>

                <div class="templates-section">
                    <div class="category-title">Templates</div>
                    <button class="template-btn" onclick="loadTemplate('3tier')">3-Tier Web App</button>
                    <button class="template-btn" onclick="loadTemplate('serverless')">Serverless API</button>
                    <button class="template-btn" onclick="loadTemplate('datalake')">Data Lake</button>
                    <button class="template-btn" onclick="loadTemplate('microservices')">Microservices</button>
                </div>
            </aside>

            <main class="workspace">
                <div class="toolbar">
                    <div class="tool-group">
                        <button id="selectMode" class="active" onclick="setMode('select')">‚úã Select</button>
                        <button id="connectMode" onclick="setMode('connect')">üîó Connect</button>
                        <button id="deleteMode" onclick="setMode('delete')">üóëÔ∏è Delete</button>
                    </div>

                    <div class="tool-group">
                        <label>Connection:</label>
                        <select id="connectionType">
                            <option value="data">Data Flow</option>
                            <option value="network">Network</option>
                            <option value="auth">Authentication</option>
                        </select>
                    </div>

                    <div class="tool-group">
                        <button onclick="clearCanvas()">üóëÔ∏è Clear All</button>
                        <button onclick="exportJSON()">üíæ Export JSON</button>
                        <button onclick="generateDescription()">üìù Generate Docs</button>
                    </div>

                    <div class="tool-group">
                        <button onclick="zoomIn()">üîç+</button>
                        <button onclick="zoomOut()">üîç-</button>
                        <button onclick="resetZoom()">‚ü≤ Reset</button>
                    </div>
                </div>

                <div class="canvas-container" id="canvasContainer">
                    <svg id="canvas" width="2000" height="2000" xmlns="http://www.w3.org/2000/svg">
                        <defs>
                            <marker id="arrowhead-data" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
                                <polygon points="0 0, 10 3, 0 6" fill="#4fc3f7" />
                            </marker>
                            <marker id="arrowhead-network" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
                                <polygon points="0 0, 10 3, 0 6" fill="#66bb6a" />
                            </marker>
                            <marker id="arrowhead-auth" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
                                <polygon points="0 0, 10 3, 0 6" fill="#ffa726" />
                            </marker>
                        </defs>
                        <g id="connectionsLayer"></g>
                        <g id="componentsLayer"></g>
                    </svg>

                    <div class="info-panel">
                        <div><span class="color-indicator" style="background: #4fc3f7;"></span>Data Flow (solid)</div>
                        <div><span class="color-indicator" style="background: #66bb6a; opacity: 0.7;"></span>Network (dashed)</div>
                        <div><span class="color-indicator" style="background: #ffa726; opacity: 0.7;"></span>Auth (dotted)</div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <div id="exportModal" class="modal">
        <div class="modal-content">
            <h2>Export Architecture</h2>
            <textarea id="exportContent" readonly></textarea>
            <div class="modal-buttons">
                <button class="btn-secondary" onclick="closeModal()">Close</button>
                <button class="btn-primary" onclick="copyToClipboard()">Copy to Clipboard</button>
            </div>
        </div>
    </div>

    <div id="descriptionModal" class="modal">
        <div class="modal-content">
            <h2>Architecture Description</h2>
            <textarea id="descriptionContent" readonly></textarea>
            <div class="modal-buttons">
                <button class="btn-secondary" onclick="closeModal()">Close</button>
                <button class="btn-primary" onclick="copyDescription()">Copy to Clipboard</button>
            </div>
        </div>
    </div>

    <script>
        // Application state
        let state = {
            mode: 'select',
            components: [],
            connections: [],
            nextId: 1,
            selectedComponent: null,
            connectingFrom: null,
            isDragging: false,
            draggedComponent: null,
            offset: { x: 0, y: 0 },
            zoom: 1,
            pan: { x: 0, y: 0 }
        };

        // Component color mapping
        const componentColors = {
            compute: '#667eea',
            storage: '#f093fb',
            database: '#4facfe',
            networking: '#43e97b',
            security: '#fa709a',
            users: '#feca57'
        };

        // Component icon mapping
        const componentIcons = {
            vm: 'üñ•Ô∏è', container: 'üì¶', serverless: '‚ö°', kubernetes: '‚ò∏Ô∏è',
            'object-storage': 'üóÑÔ∏è', 'block-storage': 'üíæ', 'file-storage': 'üìÅ',
            sql: 'üóÉÔ∏è', nosql: 'üìä', cache: '‚ö°', warehouse: 'üèõÔ∏è',
            vpc: 'üåê', loadbalancer: '‚öñÔ∏è', cdn: 'üåç', dns: 'üì°', firewall: 'üõ°Ô∏è', gateway: 'üö™',
            iam: 'üîê', encryption: 'üîí', waf: 'üõ°Ô∏è',
            'web-user': 'üë§', 'mobile-user': 'üì±', iot: 'üìü'
        };

        // Component display names
        const componentNames = {
            vm: 'Virtual Machine', container: 'Container', serverless: 'Serverless Function', kubernetes: 'Kubernetes',
            'object-storage': 'Object Storage', 'block-storage': 'Block Storage', 'file-storage': 'File Storage',
            sql: 'SQL Database', nosql: 'NoSQL Database', cache: 'Cache', warehouse: 'Data Warehouse',
            vpc: 'VPC', loadbalancer: 'Load Balancer', cdn: 'CDN', dns: 'DNS', firewall: 'Firewall', gateway: 'API Gateway',
            iam: 'IAM', encryption: 'Encryption', waf: 'WAF',
            'web-user': 'Web User', 'mobile-user': 'Mobile User', iot: 'IoT Device'
        };

        // Initialize drag and drop from palette
        document.querySelectorAll('.component-item').forEach(item => {
            item.addEventListener('dragstart', handleDragStart);
        });

        const canvasContainer = document.getElementById('canvasContainer');
        canvasContainer.addEventListener('dragover', handleDragOver);
        canvasContainer.addEventListener('drop', handleDrop);

        const canvas = document.getElementById('canvas');
        canvas.addEventListener('mousedown', handleCanvasMouseDown);
        canvas.addEventListener('mousemove', handleCanvasMouseMove);
        canvas.addEventListener('mouseup', handleCanvasMouseUp);

        function handleDragStart(e) {
            const type = e.target.closest('.component-item').dataset.type;
            const category = e.target.closest('.component-item').dataset.category;
            e.dataTransfer.setData('type', type);
            e.dataTransfer.setData('category', category);
        }

        function handleDragOver(e) {
            e.preventDefault();
        }

        function handleDrop(e) {
            e.preventDefault();
            const type = e.dataTransfer.getData('type');
            const category = e.dataTransfer.getData('category');

            if (!type) return;

            const rect = canvasContainer.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;

            addComponent(type, category, x, y);
        }

        function addComponent(type, category, x, y) {
            const component = {
                id: state.nextId++,
                type: type,
                category: category,
                x: x,
                y: y,
                width: 120,
                height: 80
            };

            state.components.push(component);
            renderComponent(component);
        }

        function renderComponent(component) {
            const g = document.createElementNS('http://www.w3.org/2000/svg', 'g');
            g.setAttribute('class', 'canvas-component');
            g.setAttribute('data-id', component.id);
            g.setAttribute('transform', `translate(${component.x}, ${component.y})`);

            const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
            rect.setAttribute('width', component.width);
            rect.setAttribute('height', component.height);
            rect.setAttribute('rx', 10);
            rect.setAttribute('fill', componentColors[component.category] || '#666');
            rect.setAttribute('stroke', 'rgba(255, 255, 255, 0.3)');
            rect.setAttribute('stroke-width', 2);

            const icon = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            icon.setAttribute('x', component.width / 2);
            icon.setAttribute('y', 30);
            icon.setAttribute('text-anchor', 'middle');
            icon.setAttribute('font-size', '28');
            icon.textContent = componentIcons[component.type] || 'üì¶';

            const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            text.setAttribute('x', component.width / 2);
            text.setAttribute('y', 60);
            text.setAttribute('text-anchor', 'middle');
            text.setAttribute('fill', '#fff');
            text.setAttribute('font-size', '12');
            text.setAttribute('font-weight', '600');
            text.textContent = componentNames[component.type] || component.type;

            // Delete button
            const deleteBtn = document.createElementNS('http://www.w3.org/2000/svg', 'g');
            deleteBtn.setAttribute('class', 'delete-button');
            deleteBtn.setAttribute('transform', `translate(${component.width - 20}, 5)`);

            const deleteBg = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
            deleteBg.setAttribute('r', 10);
            deleteBg.setAttribute('fill', '#f44336');

            const deleteText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            deleteText.setAttribute('text-anchor', 'middle');
            deleteText.setAttribute('y', 4);
            deleteText.setAttribute('fill', '#fff');
            deleteText.setAttribute('font-size', '14');
            deleteText.textContent = '√ó';

            deleteBtn.appendChild(deleteBg);
            deleteBtn.appendChild(deleteText);
            deleteBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                deleteComponent(component.id);
            });

            g.appendChild(rect);
            g.appendChild(icon);
            g.appendChild(text);
            g.appendChild(deleteBtn);

            document.getElementById('componentsLayer').appendChild(g);
        }

        function handleCanvasMouseDown(e) {
            if (e.target.tagName === 'svg') return;

            const componentEl = e.target.closest('.canvas-component');
            if (!componentEl) return;

            const id = parseInt(componentEl.dataset.id);
            const component = state.components.find(c => c.id === id);
            if (!component) return;

            if (state.mode === 'select') {
                // Start dragging
                state.isDragging = true;
                state.draggedComponent = component;

                const rect = canvasContainer.getBoundingClientRect();
                state.offset.x = e.clientX - rect.left - component.x;
                state.offset.y = e.clientY - rect.top - component.y;

                selectComponent(id);
            } else if (state.mode === 'connect') {
                if (!state.connectingFrom) {
                    state.connectingFrom = component;
                    selectComponent(id);
                } else {
                    createConnection(state.connectingFrom, component);
                    state.connectingFrom = null;
                    clearSelection();
                }
            } else if (state.mode === 'delete') {
                deleteComponent(id);
            }
        }

        function handleCanvasMouseMove(e) {
            if (!state.isDragging || !state.draggedComponent) return;

            const rect = canvasContainer.getBoundingClientRect();
            const x = e.clientX - rect.left - state.offset.x;
            const y = e.clientY - rect.top - state.offset.y;

            state.draggedComponent.x = Math.max(0, Math.min(x, 2000 - state.draggedComponent.width));
            state.draggedComponent.y = Math.max(0, Math.min(y, 2000 - state.draggedComponent.height));

            const componentEl = document.querySelector(`[data-id="${state.draggedComponent.id}"]`);
            componentEl.setAttribute('transform', `translate(${state.draggedComponent.x}, ${state.draggedComponent.y})`);

            updateConnections(state.draggedComponent.id);
        }

        function handleCanvasMouseUp(e) {
            state.isDragging = false;
            state.draggedComponent = null;
        }

        function selectComponent(id) {
            clearSelection();
            state.selectedComponent = id;
            const componentEl = document.querySelector(`[data-id="${id}"]`);
            if (componentEl) {
                componentEl.classList.add('selected');
            }
        }

        function clearSelection() {
            document.querySelectorAll('.canvas-component').forEach(el => {
                el.classList.remove('selected');
            });
            state.selectedComponent = null;
        }

        function deleteComponent(id) {
            // Remove connections
            state.connections = state.connections.filter(conn => {
                if (conn.from === id || conn.to === id) {
                    const lineEl = document.querySelector(`[data-connection-id="${conn.id}"]`);
                    if (lineEl) lineEl.remove();
                    return false;
                }
                return true;
            });

            // Remove component
            state.components = state.components.filter(c => c.id !== id);
            const componentEl = document.querySelector(`[data-id="${id}"]`);
            if (componentEl) componentEl.remove();

            clearSelection();
        }

        function createConnection(fromComponent, toComponent) {
            if (fromComponent.id === toComponent.id) return;

            const connectionType = document.getElementById('connectionType').value;

            const connection = {
                id: `conn-${state.nextId++}`,
                from: fromComponent.id,
                to: toComponent.id,
                type: connectionType
            };

            state.connections.push(connection);
            renderConnection(connection);
        }

        function renderConnection(connection) {
            const fromComp = state.components.find(c => c.id === connection.from);
            const toComp = state.components.find(c => c.id === connection.to);

            if (!fromComp || !toComp) return;

            const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            line.setAttribute('class', 'connection-line');
            line.setAttribute('data-connection-id', connection.id);

            const fromX = fromComp.x + fromComp.width / 2;
            const fromY = fromComp.y + fromComp.height / 2;
            const toX = toComp.x + toComp.width / 2;
            const toY = toComp.y + toComp.height / 2;

            line.setAttribute('x1', fromX);
            line.setAttribute('y1', fromY);
            line.setAttribute('x2', toX);
            line.setAttribute('y2', toY);

            const styles = {
                data: { stroke: '#4fc3f7', strokeDasharray: 'none', marker: 'url(#arrowhead-data)' },
                network: { stroke: '#66bb6a', strokeDasharray: '8,4', marker: 'url(#arrowhead-network)' },
                auth: { stroke: '#ffa726', strokeDasharray: '2,4', marker: 'url(#arrowhead-auth)' }
            };

            const style = styles[connection.type] || styles.data;
            line.setAttribute('stroke', style.stroke);
            line.setAttribute('stroke-width', 3);
            line.setAttribute('stroke-dasharray', style.strokeDasharray);
            line.setAttribute('marker-end', style.marker);
            line.setAttribute('opacity', 0.7);

            line.addEventListener('click', () => {
                if (state.mode === 'delete') {
                    deleteConnection(connection.id);
                }
            });

            document.getElementById('connectionsLayer').appendChild(line);
        }

        function updateConnections(componentId) {
            state.connections.forEach(conn => {
                if (conn.from === componentId || conn.to === componentId) {
                    const lineEl = document.querySelector(`[data-connection-id="${conn.id}"]`);
                    if (lineEl) {
                        lineEl.remove();
                        renderConnection(conn);
                    }
                }
            });
        }

        function deleteConnection(connectionId) {
            state.connections = state.connections.filter(c => c.id !== connectionId);
            const lineEl = document.querySelector(`[data-connection-id="${connectionId}"]`);
            if (lineEl) lineEl.remove();
        }

        function setMode(mode) {
            state.mode = mode;
            state.connectingFrom = null;
            clearSelection();

            document.querySelectorAll('.toolbar button').forEach(btn => {
                btn.classList.remove('active');
            });

            document.getElementById(`${mode}Mode`).classList.add('active');

            if (mode === 'select') {
                canvas.style.cursor = 'default';
            } else if (mode === 'connect') {
                canvas.style.cursor = 'crosshair';
            } else if (mode === 'delete') {
                canvas.style.cursor = 'not-allowed';
            }
        }

        function clearCanvas() {
            if (!confirm('Are you sure you want to clear the entire canvas?')) return;

            state.components = [];
            state.connections = [];
            state.selectedComponent = null;
            state.connectingFrom = null;

            document.getElementById('componentsLayer').innerHTML = '';
            document.getElementById('connectionsLayer').innerHTML = '';
        }

        function exportJSON() {
            const data = {
                components: state.components,
                connections: state.connections,
                metadata: {
                    created: new Date().toISOString(),
                    version: '1.0'
                }
            };

            const json = JSON.stringify(data, null, 2);
            document.getElementById('exportContent').value = json;
            document.getElementById('exportModal').classList.add('active');
        }

        function generateDescription() {
            let description = '# Cloud Architecture Description\n\n';
            description += `Generated: ${new Date().toLocaleString()}\n\n`;

            // Component summary
            description += '## Components\n\n';
            const categoryCounts = {};
            state.components.forEach(comp => {
                categoryCounts[comp.category] = (categoryCounts[comp.category] || 0) + 1;
            });

            Object.entries(categoryCounts).forEach(([category, count]) => {
                description += `- **${category.charAt(0).toUpperCase() + category.slice(1)}**: ${count} component(s)\n`;
            });

            description += '\n## Detailed Component List\n\n';
            state.components.forEach(comp => {
                description += `- **${componentNames[comp.type]}** (ID: ${comp.id})\n`;
            });

            // Connection summary
            description += '\n## Connections\n\n';
            if (state.connections.length === 0) {
                description += 'No connections defined.\n';
            } else {
                state.connections.forEach(conn => {
                    const fromComp = state.components.find(c => c.id === conn.from);
                    const toComp = state.components.find(c => c.id === conn.to);
                    const typeLabel = conn.type === 'data' ? 'Data Flow' : conn.type === 'network' ? 'Network Traffic' : 'Authentication';
                    description += `- **${componentNames[fromComp.type]}** ‚Üí **${componentNames[toComp.type]}** (${typeLabel})\n`;
                });
            }

            // Architecture patterns
            description += '\n## Architecture Patterns\n\n';
            if (state.components.some(c => c.type === 'loadbalancer') && state.components.some(c => c.type === 'vm')) {
                description += '- Load-balanced architecture detected\n';
            }
            if (state.components.some(c => c.type === 'cdn')) {
                description += '- Content delivery optimization enabled\n';
            }
            if (state.components.some(c => c.type === 'cache')) {
                description += '- Caching layer implemented\n';
            }
            if (state.components.some(c => c.type === 'serverless')) {
                description += '- Serverless components utilized\n';
            }

            document.getElementById('descriptionContent').value = description;
            document.getElementById('descriptionModal').classList.add('active');
        }

        function closeModal() {
            document.querySelectorAll('.modal').forEach(modal => {
                modal.classList.remove('active');
            });
        }

        function copyToClipboard() {
            const content = document.getElementById('exportContent');
            content.select();
            document.execCommand('copy');
            alert('JSON copied to clipboard!');
        }

        function copyDescription() {
            const content = document.getElementById('descriptionContent');
            content.select();
            document.execCommand('copy');
            alert('Description copied to clipboard!');
        }

        function zoomIn() {
            state.zoom = Math.min(state.zoom * 1.2, 3);
            applyZoom();
        }

        function zoomOut() {
            state.zoom = Math.max(state.zoom / 1.2, 0.3);
            applyZoom();
        }

        function resetZoom() {
            state.zoom = 1;
            state.pan = { x: 0, y: 0 };
            applyZoom();
        }

        function applyZoom() {
            canvas.style.transform = `scale(${state.zoom}) translate(${state.pan.x}px, ${state.pan.y}px)`;
        }

        // Template loading
        function loadTemplate(templateName) {
            clearCanvas();

            const templates = {
                '3tier': {
                    components: [
                        { type: 'web-user', category: 'users', x: 100, y: 50 },
                        { type: 'loadbalancer', category: 'networking', x: 100, y: 200 },
                        { type: 'vm', category: 'compute', x: 50, y: 350 },
                        { type: 'vm', category: 'compute', x: 200, y: 350 },
                        { type: 'sql', category: 'database', x: 125, y: 500 }
                    ],
                    connections: [
                        { from: 0, to: 1, type: 'network' },
                        { from: 1, to: 2, type: 'network' },
                        { from: 1, to: 3, type: 'network' },
                        { from: 2, to: 4, type: 'data' },
                        { from: 3, to: 4, type: 'data' }
                    ]
                },
                'serverless': {
                    components: [
                        { type: 'mobile-user', category: 'users', x: 100, y: 50 },
                        { type: 'gateway', category: 'networking', x: 100, y: 200 },
                        { type: 'serverless', category: 'compute', x: 50, y: 350 },
                        { type: 'serverless', category: 'compute', x: 200, y: 350 },
                        { type: 'nosql', category: 'database', x: 125, y: 500 },
                        { type: 'object-storage', category: 'storage', x: 350, y: 350 }
                    ],
                    connections: [
                        { from: 0, to: 1, type: 'network' },
                        { from: 1, to: 2, type: 'data' },
                        { from: 1, to: 3, type: 'data' },
                        { from: 2, to: 4, type: 'data' },
                        { from: 3, to: 5, type: 'data' }
                    ]
                },
                'datalake': {
                    components: [
                        { type: 'iot', category: 'users', x: 50, y: 50 },
                        { type: 'web-user', category: 'users', x: 200, y: 50 },
                        { type: 'gateway', category: 'networking', x: 125, y: 200 },
                        { type: 'object-storage', category: 'storage', x: 125, y: 350 },
                        { type: 'warehouse', category: 'database', x: 125, y: 500 }
                    ],
                    connections: [
                        { from: 0, to: 2, type: 'data' },
                        { from: 1, to: 2, type: 'data' },
                        { from: 2, to: 3, type: 'data' },
                        { from: 3, to: 4, type: 'data' }
                    ]
                },
                'microservices': {
                    components: [
                        { type: 'web-user', category: 'users', x: 250, y: 50 },
                        { type: 'gateway', category: 'networking', x: 250, y: 200 },
                        { type: 'container', category: 'compute', x: 50, y: 350 },
                        { type: 'container', category: 'compute', x: 200, y: 350 },
                        { type: 'container', category: 'compute', x: 350, y: 350 },
                        { type: 'cache', category: 'database', x: 500, y: 350 },
                        { type: 'nosql', category: 'database', x: 200, y: 500 }
                    ],
                    connections: [
                        { from: 0, to: 1, type: 'network' },
                        { from: 1, to: 2, type: 'network' },
                        { from: 1, to: 3, type: 'network' },
                        { from: 1, to: 4, type: 'network' },
                        { from: 2, to: 5, type: 'data' },
                        { from: 3, to: 5, type: 'data' },
                        { from: 4, to: 6, type: 'data' }
                    ]
                }
            };

            const template = templates[templateName];
            if (!template) return;

            // Add components
            template.components.forEach((comp, index) => {
                const component = {
                    id: index,
                    type: comp.type,
                    category: comp.category,
                    x: comp.x,
                    y: comp.y,
                    width: 120,
                    height: 80
                };
                state.components.push(component);
                renderComponent(component);
            });

            // Add connections with delay for visual effect
            setTimeout(() => {
                template.connections.forEach(conn => {
                    const connectionType = conn.type || 'data';
                    const connection = {
                        id: `conn-${state.nextId++}`,
                        from: conn.from,
                        to: conn.to,
                        type: connectionType
                    };
                    state.connections.push(connection);
                    renderConnection(connection);
                });
            }, 300);

            state.nextId = template.components.length + template.connections.length + 1;
        }

        // Close modals on outside click
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeModal();
                }
            });
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeModal();
                state.connectingFrom = null;
                clearSelection();
            }
            if (e.key === 'Delete' && state.selectedComponent) {
                deleteComponent(state.selectedComponent);
            }
            if (e.ctrlKey || e.metaKey) {
                if (e.key === 's') {
                    e.preventDefault();
                    exportJSON();
                }
            }
        });
    </script>
<script src="../../../../components/FluxCapacitor.js"></script>
</body>
</html>