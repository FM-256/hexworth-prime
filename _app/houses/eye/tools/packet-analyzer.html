<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Interactive Packet Analyzer - Eye House | Hexworth Prime</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #0f0a1e 0%, #1a0b2e 100%);
      color: #e0e0e0;
      line-height: 1.6;
      padding: 20px;
    }

    .container {
      max-width: 1600px;
      margin: 0 auto;
    }

    header {
      background: linear-gradient(135deg, #c084fc 0%, #06b6d4 100%);
      padding: 30px;
      text-align: center;
      border-radius: 10px;
      box-shadow: 0 4px 20px rgba(192, 132, 252, 0.3);
      margin-bottom: 30px;
    }

    h1 {
      font-size: 2.5em;
      margin-bottom: 10px;
      color: white;
    }

    .subtitle {
      font-size: 1.2em;
      color: #f0f0f0;
    }

    .tool-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 20px;
    }

    .panel {
      background: rgba(255, 255, 255, 0.05);
      border: 2px solid rgba(192, 132, 252, 0.3);
      border-radius: 10px;
      padding: 20px;
      backdrop-filter: blur(10px);
    }

    .panel h2 {
      color: #c084fc;
      margin-bottom: 15px;
      font-size: 1.5em;
      border-bottom: 2px solid #06b6d4;
      padding-bottom: 10px;
    }

    .full-width {
      grid-column: 1 / -1;
    }

    .controls {
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
      margin-bottom: 20px;
    }

    button {
      background: linear-gradient(135deg, #c084fc 0%, #06b6d4 100%);
      color: white;
      border: none;
      padding: 12px 25px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1em;
      font-weight: 600;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(192, 132, 252, 0.3);
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(192, 132, 252, 0.5);
    }

    button:active {
      transform: translateY(0);
    }

    .secondary-btn {
      background: rgba(6, 182, 212, 0.2);
      border: 2px solid #06b6d4;
    }

    input[type="text"], select {
      background: rgba(0, 0, 0, 0.4);
      border: 2px solid rgba(192, 132, 252, 0.3);
      color: #e0e0e0;
      padding: 10px 15px;
      border-radius: 8px;
      font-size: 1em;
      flex: 1;
      min-width: 200px;
    }

    input[type="text"]:focus, select:focus {
      outline: none;
      border-color: #c084fc;
      box-shadow: 0 0 10px rgba(192, 132, 252, 0.3);
    }

    .packet-list {
      background: rgba(0, 0, 0, 0.6);
      border-radius: 8px;
      overflow: hidden;
      max-height: 400px;
      overflow-y: auto;
    }

    .packet-list table {
      width: 100%;
      border-collapse: collapse;
    }

    .packet-list th {
      background: linear-gradient(135deg, #c084fc 0%, #06b6d4 100%);
      color: white;
      padding: 12px;
      text-align: left;
      font-weight: 600;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .packet-list td {
      padding: 10px 12px;
      border-bottom: 1px solid rgba(192, 132, 252, 0.2);
      font-family: 'Courier New', monospace;
      font-size: 0.9em;
    }

    .packet-list tr:hover {
      background: rgba(192, 132, 252, 0.1);
      cursor: pointer;
    }

    .packet-list tr.selected {
      background: rgba(192, 132, 252, 0.2);
      border-left: 4px solid #c084fc;
    }

    .protocol-tcp {
      color: #00ff7f;
    }

    .protocol-udp {
      color: #06b6d4;
    }

    .protocol-icmp {
      color: #ffa500;
    }

    .protocol-http {
      color: #ff69b4;
    }

    .protocol-dns {
      color: #c084fc;
    }

    .packet-details {
      background: rgba(0, 0, 0, 0.6);
      padding: 20px;
      border-radius: 8px;
      font-family: 'Courier New', monospace;
      font-size: 0.9em;
      max-height: 500px;
      overflow-y: auto;
    }

    .layer {
      margin: 15px 0;
      padding: 15px;
      background: rgba(192, 132, 252, 0.1);
      border-left: 4px solid #c084fc;
      border-radius: 5px;
    }

    .layer h3 {
      color: #c084fc;
      margin-bottom: 10px;
      font-size: 1.1em;
    }

    .layer-line {
      margin: 5px 0;
      padding: 5px 0;
    }

    .layer-line span {
      color: #06b6d4;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
    }

    .stat-card {
      background: linear-gradient(135deg, rgba(192, 132, 252, 0.2) 0%, rgba(6, 182, 212, 0.2) 100%);
      padding: 20px;
      border-radius: 8px;
      border: 2px solid #c084fc;
      text-align: center;
    }

    .stat-value {
      font-size: 2.5em;
      font-weight: bold;
      color: #c084fc;
      margin-bottom: 5px;
    }

    .stat-label {
      color: #06b6d4;
      font-size: 1em;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .flow-list {
      background: rgba(0, 0, 0, 0.6);
      padding: 15px;
      border-radius: 8px;
      max-height: 300px;
      overflow-y: auto;
    }

    .flow-item {
      background: rgba(192, 132, 252, 0.1);
      padding: 12px;
      margin: 8px 0;
      border-radius: 5px;
      border-left: 4px solid #06b6d4;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .flow-item:hover {
      background: rgba(192, 132, 252, 0.2);
      transform: translateX(5px);
    }

    .filter-builder {
      background: rgba(0, 0, 0, 0.6);
      padding: 20px;
      border-radius: 8px;
    }

    .filter-row {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
      align-items: center;
    }

    .filter-display {
      background: rgba(6, 182, 212, 0.2);
      border: 2px solid #06b6d4;
      padding: 15px;
      border-radius: 8px;
      font-family: 'Courier New', monospace;
      color: #06b6d4;
      font-size: 1.1em;
      margin-top: 15px;
      min-height: 50px;
    }

    .dns-query {
      background: rgba(192, 132, 252, 0.1);
      padding: 10px;
      margin: 5px 0;
      border-radius: 5px;
      border-left: 4px solid #c084fc;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .dns-query:hover {
      background: rgba(192, 132, 252, 0.15);
    }

    .info-box {
      background: rgba(6, 182, 212, 0.1);
      border: 2px solid #06b6d4;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
    }

    .info-box h3 {
      color: #06b6d4;
      margin-bottom: 10px;
    }

    .chart-placeholder {
      background: rgba(0, 0, 0, 0.4);
      border: 2px dashed rgba(192, 132, 252, 0.3);
      border-radius: 8px;
      padding: 40px;
      text-align: center;
      color: #888;
      font-style: italic;
    }

    .bar-chart {
      display: flex;
      align-items: flex-end;
      gap: 10px;
      height: 200px;
      padding: 20px;
      background: rgba(0, 0, 0, 0.4);
      border-radius: 8px;
    }

    .bar {
      flex: 1;
      background: linear-gradient(180deg, #c084fc 0%, #06b6d4 100%);
      border-radius: 5px 5px 0 0;
      position: relative;
      transition: all 0.3s ease;
      min-height: 10px;
    }

    .bar:hover {
      opacity: 0.8;
    }

    .bar-label {
      position: absolute;
      bottom: -25px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 0.8em;
      white-space: nowrap;
    }

    .bar-value {
      position: absolute;
      top: -25px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 0.9em;
      color: #c084fc;
      font-weight: bold;
    }

    @media (max-width: 1200px) {
      .tool-grid {
        grid-template-columns: 1fr;
      }
    }

    ::-webkit-scrollbar {
      width: 10px;
    }

    ::-webkit-scrollbar-track {
      background: rgba(0, 0, 0, 0.3);
      border-radius: 5px;
    }

    ::-webkit-scrollbar-thumb {
      background: linear-gradient(135deg, #c084fc 0%, #06b6d4 100%);
      border-radius: 5px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #c084fc;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1><span style="font-size: 0.5em; opacity: 0.4; margin-right: 8px;" title="The rabbit sees the raw truth">üêá</span>Interactive Packet Analyzer</h1>
      <div class="subtitle">Wireshark-Style Analysis Tool for Security Operations</div>
    </header>

    <div class="info-box">
      <h3>About This Tool</h3>
      <p>
        This interactive packet analyzer simulates a real network traffic capture environment. Practice filtering packets, analyzing protocols, following TCP streams, and identifying security threats - all essential skills for SOC analysts working with Wireshark and other packet analysis tools.
      </p>
    </div>

    <div class="controls">
      <button onclick="loadSampleCapture()">Load Sample Capture</button>
      <button onclick="loadMaliciousCapture()" class="secondary-btn">Load Malicious Traffic</button>
      <button onclick="clearCapture()" class="secondary-btn">Clear</button>
      <button onclick="exportFindings()" class="secondary-btn">Export Findings</button>
    </div>

    <!-- Packet List Panel -->
    <div class="panel full-width">
      <h2>Packet List (Click to Inspect)</h2>
      <div class="packet-list">
        <table id="packetTable">
          <thead>
            <tr>
              <th>No.</th>
              <th>Time</th>
              <th>Source</th>
              <th>Destination</th>
              <th>Protocol</th>
              <th>Length</th>
              <th>Info</th>
            </tr>
          </thead>
          <tbody id="packetTableBody">
            <tr>
              <td colspan="7" style="text-align: center; padding: 40px; color: #888;">
                No packets loaded. Click "Load Sample Capture" to begin analysis.
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <div class="tool-grid">
      <!-- Packet Details Panel -->
      <div class="panel">
        <h2>Packet Details (Layer Breakdown)</h2>
        <div class="packet-details" id="packetDetails">
          <p style="color: #888; text-align: center; padding: 40px;">
            Select a packet from the list above to view detailed layer-by-layer breakdown.
          </p>
        </div>
      </div>

      <!-- Filter Builder Panel -->
      <div class="panel">
        <h2>Display Filter Builder</h2>
        <div class="filter-builder">
          <div class="filter-row">
            <select id="filterField">
              <option value="">Select Field...</option>
              <option value="ip.src">Source IP</option>
              <option value="ip.dst">Destination IP</option>
              <option value="tcp.port">TCP Port</option>
              <option value="udp.port">UDP Port</option>
              <option value="http.request.method">HTTP Method</option>
              <option value="dns.qry.name">DNS Query</option>
              <option value="tcp.flags.syn">TCP SYN Flag</option>
              <option value="tcp.flags.ack">TCP ACK Flag</option>
            </select>
            <select id="filterOperator">
              <option value="==">Equals (==)</option>
              <option value="!=">Not Equals (!=)</option>
              <option value="contains">Contains</option>
              <option value=">">Greater Than (>)</option>
              <option value="<">Less Than (<)</option>
            </select>
            <input type="text" id="filterValue" placeholder="Value">
            <button onclick="addFilter()">Add</button>
          </div>
          <div class="filter-row">
            <button onclick="applyFilter()" style="flex: 1;">Apply Filter</button>
            <button onclick="clearFilter()" class="secondary-btn">Clear Filter</button>
          </div>
          <div class="filter-display" id="filterDisplay">
            No filter applied
          </div>
        </div>
      </div>
    </div>

    <!-- TCP Flows Panel -->
    <div class="panel full-width">
      <h2>TCP Conversations (Click to Follow Stream)</h2>
      <div class="flow-list" id="flowList">
        <p style="color: #888; text-align: center; padding: 20px;">
          Load a packet capture to view TCP conversations.
        </p>
      </div>
    </div>

    <div class="tool-grid">
      <!-- DNS Analysis Panel -->
      <div class="panel">
        <h2>DNS Query Analysis</h2>
        <div class="flow-list" id="dnsQueries">
          <p style="color: #888; text-align: center; padding: 20px;">
            No DNS queries detected. Load a capture file.
          </p>
        </div>
      </div>

      <!-- Statistics Panel -->
      <div class="panel">
        <h2>Traffic Statistics</h2>
        <div class="stats-grid" id="statsGrid">
          <div class="stat-card">
            <div class="stat-value" id="totalPackets">0</div>
            <div class="stat-label">Total Packets</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="uniqueIPs">0</div>
            <div class="stat-label">Unique IPs</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="tcpStreams">0</div>
            <div class="stat-label">TCP Streams</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="dnsCount">0</div>
            <div class="stat-label">DNS Queries</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Protocol Distribution Panel -->
    <div class="panel full-width">
      <h2>Protocol Distribution</h2>
      <div class="bar-chart" id="protocolChart">
        <div class="bar" style="height: 0%;">
          <div class="bar-label">TCP</div>
          <div class="bar-value">0</div>
        </div>
        <div class="bar" style="height: 0%;">
          <div class="bar-label">UDP</div>
          <div class="bar-value">0</div>
        </div>
        <div class="bar" style="height: 0%;">
          <div class="bar-label">HTTP</div>
          <div class="bar-value">0</div>
        </div>
        <div class="bar" style="height: 0%;">
          <div class="bar-label">DNS</div>
          <div class="bar-value">0</div>
        </div>
        <div class="bar" style="height: 0%;">
          <div class="bar-label">ICMP</div>
          <div class="bar-value">0</div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Simulated packet data structures
    let packets = [];
    let filteredPackets = [];
    let currentFilter = '';
    let selectedPacketIndex = null;

    // Generate sample capture data
    function loadSampleCapture() {
      packets = [
        { no: 1, time: '0.000000', src: '192.168.1.100', dst: '8.8.8.8', protocol: 'DNS', length: 74, info: 'Standard query A example.com', layers: generateDNSLayers('example.com', 'query') },
        { no: 2, time: '0.042156', src: '8.8.8.8', dst: '192.168.1.100', protocol: 'DNS', length: 90, info: 'Standard query response A 93.184.216.34', layers: generateDNSLayers('example.com', 'response', '93.184.216.34') },
        { no: 3, time: '0.045321', src: '192.168.1.100', dst: '93.184.216.34', protocol: 'TCP', length: 74, info: '[SYN] Seq=0 Win=65535 Len=0 MSS=1460', layers: generateTCPLayers('192.168.1.100', '93.184.216.34', 54321, 80, 'SYN') },
        { no: 4, time: '0.089654', src: '93.184.216.34', dst: '192.168.1.100', protocol: 'TCP', length: 74, info: '[SYN, ACK] Seq=0 Ack=1 Win=65535 Len=0', layers: generateTCPLayers('93.184.216.34', '192.168.1.100', 80, 54321, 'SYN-ACK') },
        { no: 5, time: '0.089821', src: '192.168.1.100', dst: '93.184.216.34', protocol: 'TCP', length: 66, info: '[ACK] Seq=1 Ack=1 Win=65535 Len=0', layers: generateTCPLayers('192.168.1.100', '93.184.216.34', 54321, 80, 'ACK') },
        { no: 6, time: '0.090156', src: '192.168.1.100', dst: '93.184.216.34', protocol: 'HTTP', length: 512, info: 'GET / HTTP/1.1', layers: generateHTTPLayers('GET', '/', 'example.com') },
        { no: 7, time: '0.145987', src: '93.184.216.34', dst: '192.168.1.100', protocol: 'HTTP', length: 1514, info: 'HTTP/1.1 200 OK (text/html)', layers: generateHTTPResponseLayers() },
        { no: 8, time: '0.146234', src: '192.168.1.100', dst: '93.184.216.34', protocol: 'TCP', length: 66, info: '[ACK] Seq=447 Ack=1449 Win=65535', layers: generateTCPLayers('192.168.1.100', '93.184.216.34', 54321, 80, 'ACK') },
        { no: 9, time: '2.500000', src: '192.168.1.50', dst: '192.168.1.1', protocol: 'ICMP', length: 74, info: 'Echo (ping) request', layers: generateICMPLayers('request') },
        { no: 10, time: '2.501234', src: '192.168.1.1', dst: '192.168.1.50', protocol: 'ICMP', length: 74, info: 'Echo (ping) reply', layers: generateICMPLayers('reply') },
        { no: 11, time: '5.000000', src: '192.168.1.100', dst: '1.1.1.1', protocol: 'DNS', length: 82, info: 'Standard query A cloudflare.com', layers: generateDNSLayers('cloudflare.com', 'query') },
        { no: 12, time: '5.035678', src: '1.1.1.1', dst: '192.168.1.100', protocol: 'DNS', length: 98, info: 'Standard query response A 104.16.132.229', layers: generateDNSLayers('cloudflare.com', 'response', '104.16.132.229') },
        { no: 13, time: '10.000000', src: '192.168.1.75', dst: '192.168.1.200', protocol: 'TCP', length: 74, info: '[SYN] Seq=0 Win=8192 Dst=445 (SMB)', layers: generateTCPLayers('192.168.1.75', '192.168.1.200', 49876, 445, 'SYN') },
        { no: 14, time: '10.001500', src: '192.168.1.200', dst: '192.168.1.75', protocol: 'TCP', length: 74, info: '[SYN, ACK] Seq=0 Ack=1 Win=8192', layers: generateTCPLayers('192.168.1.200', '192.168.1.75', 445, 49876, 'SYN-ACK') },
        { no: 15, time: '10.001650', src: '192.168.1.75', dst: '192.168.1.200', protocol: 'TCP', length: 66, info: '[ACK] Seq=1 Ack=1', layers: generateTCPLayers('192.168.1.75', '192.168.1.200', 49876, 445, 'ACK') },
      ];

      filteredPackets = [...packets];
      renderPacketList();
      updateStatistics();
      generateFlows();
      generateDNSList();
      updateProtocolChart();
    }

    function loadMaliciousCapture() {
      packets = [
        { no: 1, time: '0.000000', src: '192.168.1.150', dst: '185.220.101.50', protocol: 'DNS', length: 95, info: 'Suspicious query A c2-server-a3f8d9e2.malicious.com', layers: generateDNSLayers('c2-server-a3f8d9e2.malicious.com', 'query') },
        { no: 2, time: '0.089234', src: '185.220.101.50', dst: '192.168.1.150', protocol: 'DNS', length: 111, info: 'Response A 185.220.101.50', layers: generateDNSLayers('c2-server-a3f8d9e2.malicious.com', 'response', '185.220.101.50') },
        { no: 3, time: '0.150000', src: '192.168.1.150', dst: '185.220.101.50', protocol: 'TCP', length: 74, info: '[SYN] Seq=0 Dst=8443 (Uncommon port)', layers: generateTCPLayers('192.168.1.150', '185.220.101.50', 51234, 8443, 'SYN') },
        { no: 4, time: '0.234567', src: '185.220.101.50', dst: '192.168.1.150', protocol: 'TCP', length: 74, info: '[SYN, ACK] Seq=0 Ack=1', layers: generateTCPLayers('185.220.101.50', '192.168.1.150', 8443, 51234, 'SYN-ACK') },
        { no: 5, time: '0.234789', src: '192.168.1.150', dst: '185.220.101.50', protocol: 'TCP', length: 66, info: '[ACK] Seq=1 Ack=1', layers: generateTCPLayers('192.168.1.150', '185.220.101.50', 51234, 8443, 'ACK') },
        { no: 6, time: '0.250000', src: '192.168.1.150', dst: '185.220.101.50', protocol: 'TCP', length: 128, info: 'Encrypted beacon payload (C2)', layers: generateC2Layers() },
        { no: 7, time: '60.000000', src: '192.168.1.150', dst: '185.220.101.50', protocol: 'TCP', length: 128, info: 'Encrypted beacon payload (C2) - Regular interval!', layers: generateC2Layers() },
        { no: 8, time: '120.000000', src: '192.168.1.150', dst: '185.220.101.50', protocol: 'TCP', length: 128, info: 'Encrypted beacon payload (C2) - Regular interval!', layers: generateC2Layers() },
        { no: 9, time: '125.000000', src: '192.168.1.150', dst: '8.8.8.8', protocol: 'DNS', length: 156, info: 'Tunneling? Long query: AAABBBCCCDDDEEEFFFGGGHHHIIIJJJKKKLLLMMMNNN.tunnel.bad.com', layers: generateDNSLayers('AAABBBCCCDDDEEEFFFGGGHHHIIIJJJKKKLLLMMMNNN.tunnel.bad.com', 'query') },
        { no: 10, time: '125.089000', src: '8.8.8.8', dst: '192.168.1.150', protocol: 'DNS', length: 172, info: 'TXT record response (possible tunneling)', layers: generateDNSLayers('AAABBBCCCDDDEEEFFFGGGHHHIIIJJJKKKLLLMMMNNN.tunnel.bad.com', 'response', '', 'TXT') },
        { no: 11, time: '180.000000', src: '192.168.1.150', dst: '185.220.101.50', protocol: 'TCP', length: 128, info: 'Encrypted beacon payload (C2) - 60s interval detected!', layers: generateC2Layers() },
        { no: 12, time: '200.000000', src: '192.168.1.150', dst: '192.168.1.25', protocol: 'TCP', length: 74, info: '[SYN] Lateral movement attempt Dst=445 (SMB)', layers: generateTCPLayers('192.168.1.150', '192.168.1.25', 52341, 445, 'SYN') },
        { no: 13, time: '200.050000', src: '192.168.1.150', dst: '192.168.1.26', protocol: 'TCP', length: 74, info: '[SYN] Lateral movement attempt Dst=445 (SMB)', layers: generateTCPLayers('192.168.1.150', '192.168.1.26', 52342, 445, 'SYN') },
        { no: 14, time: '200.100000', src: '192.168.1.150', dst: '192.168.1.27', protocol: 'TCP', length: 74, info: '[SYN] Lateral movement attempt Dst=445 (SMB)', layers: generateTCPLayers('192.168.1.150', '192.168.1.27', 52343, 445, 'SYN') },
        { no: 15, time: '200.150000', src: '192.168.1.150', dst: '192.168.1.28', protocol: 'TCP', length: 74, info: '[SYN] Scanning behavior - sequential hosts!', layers: generateTCPLayers('192.168.1.150', '192.168.1.28', 52344, 445, 'SYN') },
        { no: 16, time: '240.000000', src: '192.168.1.150', dst: '185.220.101.50', protocol: 'TCP', length: 128, info: 'Encrypted beacon payload (C2) - Consistent beaconing!', layers: generateC2Layers() },
        { no: 17, time: '300.000000', src: '192.168.1.150', dst: '185.220.101.50', protocol: 'TCP', length: 8192, info: 'Large data transfer - EXFILTRATION ALERT!', layers: generateExfilLayers() },
      ];

      filteredPackets = [...packets];
      renderPacketList();
      updateStatistics();
      generateFlows();
      generateDNSList();
      updateProtocolChart();
      alert('Malicious traffic loaded! Notice:\n\n' +
            '‚Ä¢ C2 beaconing at 60-second intervals\n' +
            '‚Ä¢ DNS tunneling (long queries, TXT records)\n' +
            '‚Ä¢ Lateral movement (SMB to multiple hosts)\n' +
            '‚Ä¢ Large data exfiltration at the end\n\n' +
            'Practice identifying these patterns!');
    }

    // Generate packet layer details
    function generateTCPLayers(src, dst, sport, dport, flags) {
      return {
        ethernet: { src: 'aa:bb:cc:dd:ee:ff', dst: '00:11:22:33:44:55', type: '0x0800 (IPv4)' },
        ip: { version: 4, src: src, dst: dst, ttl: 64, protocol: 6 },
        tcp: { sport: sport, dport: dport, seq: Math.floor(Math.random() * 1000000), ack: Math.floor(Math.random() * 1000000), flags: flags, window: 65535 }
      };
    }

    function generateDNSLayers(query, type, answer = '', recordType = 'A') {
      const layers = {
        ethernet: { src: 'aa:bb:cc:dd:ee:ff', dst: '00:11:22:33:44:55', type: '0x0800 (IPv4)' },
        ip: { version: 4, src: '192.168.1.100', dst: '8.8.8.8', ttl: 64, protocol: 17 },
        udp: { sport: 54321, dport: 53, length: 60 },
        dns: {
          transaction_id: '0x' + Math.floor(Math.random() * 65535).toString(16),
          flags: type === 'query' ? '0x0100 (Standard query)' : '0x8180 (Standard response)',
          questions: 1,
          query_name: query,
          query_type: recordType
        }
      };
      if (type === 'response' && answer) {
        layers.dns.answers = 1;
        layers.dns.answer_addr = answer;
      }
      return layers;
    }

    function generateHTTPLayers(method, uri, host) {
      return {
        ethernet: { src: 'aa:bb:cc:dd:ee:ff', dst: '00:11:22:33:44:55', type: '0x0800 (IPv4)' },
        ip: { version: 4, src: '192.168.1.100', dst: '93.184.216.34', ttl: 64, protocol: 6 },
        tcp: { sport: 54321, dport: 80, seq: 100, ack: 1, flags: 'PSH, ACK', window: 65535 },
        http: {
          request_method: method,
          request_uri: uri,
          host: host,
          user_agent: 'Mozilla/5.0 (Windows NT 10.0; Win64; x64)',
          accept: 'text/html,application/xhtml+xml'
        }
      };
    }

    function generateHTTPResponseLayers() {
      return {
        ethernet: { src: '00:11:22:33:44:55', dst: 'aa:bb:cc:dd:ee:ff', type: '0x0800 (IPv4)' },
        ip: { version: 4, src: '93.184.216.34', dst: '192.168.1.100', ttl: 54, protocol: 6 },
        tcp: { sport: 80, dport: 54321, seq: 1, ack: 447, flags: 'PSH, ACK', window: 65535 },
        http: {
          response_code: '200 OK',
          content_type: 'text/html; charset=UTF-8',
          content_length: 1256,
          server: 'ECS (sec/96ED)'
        }
      };
    }

    function generateICMPLayers(type) {
      return {
        ethernet: { src: 'aa:bb:cc:dd:ee:ff', dst: '00:11:22:33:44:55', type: '0x0800 (IPv4)' },
        ip: { version: 4, src: type === 'request' ? '192.168.1.50' : '192.168.1.1', dst: type === 'request' ? '192.168.1.1' : '192.168.1.50', ttl: 64, protocol: 1 },
        icmp: { type: type === 'request' ? 8 : 0, code: 0, checksum: '0xa3b2', identifier: 1, sequence: 1 }
      };
    }

    function generateC2Layers() {
      return {
        ethernet: { src: 'aa:bb:cc:dd:ee:ff', dst: '00:11:22:33:44:55', type: '0x0800 (IPv4)' },
        ip: { version: 4, src: '192.168.1.150', dst: '185.220.101.50', ttl: 64, protocol: 6 },
        tcp: { sport: 51234, dport: 8443, seq: Math.floor(Math.random() * 1000000), ack: Math.floor(Math.random() * 1000000), flags: 'PSH, ACK', window: 8192 },
        payload: {
          encrypted: true,
          size: 62,
          note: 'Regular beaconing pattern detected - consistent 60s intervals',
          threat: 'SUSPECTED C2 COMMUNICATION'
        }
      };
    }

    function generateExfilLayers() {
      return {
        ethernet: { src: 'aa:bb:cc:dd:ee:ff', dst: '00:11:22:33:44:55', type: '0x0800 (IPv4)' },
        ip: { version: 4, src: '192.168.1.150', dst: '185.220.101.50', ttl: 64, protocol: 6 },
        tcp: { sport: 51234, dport: 8443, seq: 5000000, ack: 3000000, flags: 'PSH, ACK', window: 8192 },
        payload: {
          encrypted: true,
          size: 8126,
          note: 'LARGE DATA TRANSFER - Potential data exfiltration',
          threat: 'DATA EXFILTRATION ALERT'
        }
      };
    }

    // Render packet list
    function renderPacketList() {
      const tbody = document.getElementById('packetTableBody');
      tbody.innerHTML = '';

      if (filteredPackets.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px; color: #888;">No packets match the current filter.</td></tr>';
        return;
      }

      filteredPackets.forEach((packet, index) => {
        const row = document.createElement('tr');
        row.onclick = () => selectPacket(index);

        let protocolClass = '';
        switch(packet.protocol) {
          case 'TCP': protocolClass = 'protocol-tcp'; break;
          case 'UDP': protocolClass = 'protocol-udp'; break;
          case 'HTTP': protocolClass = 'protocol-http'; break;
          case 'DNS': protocolClass = 'protocol-dns'; break;
          case 'ICMP': protocolClass = 'protocol-icmp'; break;
        }

        row.innerHTML = `
          <td>${packet.no}</td>
          <td>${packet.time}</td>
          <td>${packet.src}</td>
          <td>${packet.dst}</td>
          <td class="${protocolClass}">${packet.protocol}</td>
          <td>${packet.length}</td>
          <td>${packet.info}</td>
        `;

        tbody.appendChild(row);
      });
    }

    // Select and display packet details
    function selectPacket(index) {
      selectedPacketIndex = index;
      const packet = filteredPackets[index];

      // Highlight selected row
      document.querySelectorAll('#packetTableBody tr').forEach((row, i) => {
        row.classList.toggle('selected', i === index);
      });

      // Display packet layers
      const detailsDiv = document.getElementById('packetDetails');
      detailsDiv.innerHTML = '';

      const layers = packet.layers;

      // Ethernet layer
      if (layers.ethernet) {
        detailsDiv.innerHTML += `
          <div class="layer">
            <h3>‚ñº Ethernet II</h3>
            <div class="layer-line">Source: <span>${layers.ethernet.src}</span></div>
            <div class="layer-line">Destination: <span>${layers.ethernet.dst}</span></div>
            <div class="layer-line">Type: <span>${layers.ethernet.type}</span></div>
          </div>
        `;
      }

      // IP layer
      if (layers.ip) {
        detailsDiv.innerHTML += `
          <div class="layer">
            <h3>‚ñº Internet Protocol Version ${layers.ip.version}</h3>
            <div class="layer-line">Source Address: <span>${layers.ip.src}</span></div>
            <div class="layer-line">Destination Address: <span>${layers.ip.dst}</span></div>
            <div class="layer-line">Time to Live: <span>${layers.ip.ttl}</span></div>
            <div class="layer-line">Protocol: <span>${layers.ip.protocol} (${layers.ip.protocol === 6 ? 'TCP' : layers.ip.protocol === 17 ? 'UDP' : 'ICMP'})</span></div>
          </div>
        `;
      }

      // TCP layer
      if (layers.tcp) {
        detailsDiv.innerHTML += `
          <div class="layer">
            <h3>‚ñº Transmission Control Protocol</h3>
            <div class="layer-line">Source Port: <span>${layers.tcp.sport}</span></div>
            <div class="layer-line">Destination Port: <span>${layers.tcp.dport}</span></div>
            <div class="layer-line">Sequence Number: <span>${layers.tcp.seq}</span></div>
            <div class="layer-line">Acknowledgment Number: <span>${layers.tcp.ack}</span></div>
            <div class="layer-line">Flags: <span>${layers.tcp.flags}</span></div>
            <div class="layer-line">Window Size: <span>${layers.tcp.window}</span></div>
          </div>
        `;
      }

      // UDP layer
      if (layers.udp) {
        detailsDiv.innerHTML += `
          <div class="layer">
            <h3>‚ñº User Datagram Protocol</h3>
            <div class="layer-line">Source Port: <span>${layers.udp.sport}</span></div>
            <div class="layer-line">Destination Port: <span>${layers.udp.dport}</span></div>
            <div class="layer-line">Length: <span>${layers.udp.length}</span></div>
          </div>
        `;
      }

      // DNS layer
      if (layers.dns) {
        detailsDiv.innerHTML += `
          <div class="layer">
            <h3>‚ñº Domain Name System</h3>
            <div class="layer-line">Transaction ID: <span>${layers.dns.transaction_id}</span></div>
            <div class="layer-line">Flags: <span>${layers.dns.flags}</span></div>
            <div class="layer-line">Questions: <span>${layers.dns.questions}</span></div>
            <div class="layer-line">Query Name: <span>${layers.dns.query_name}</span></div>
            <div class="layer-line">Query Type: <span>${layers.dns.query_type}</span></div>
            ${layers.dns.answers ? `<div class="layer-line">Answer: <span>${layers.dns.answer_addr}</span></div>` : ''}
          </div>
        `;
      }

      // HTTP layer
      if (layers.http) {
        if (layers.http.request_method) {
          detailsDiv.innerHTML += `
            <div class="layer">
              <h3>‚ñº Hypertext Transfer Protocol (Request)</h3>
              <div class="layer-line">Request Method: <span>${layers.http.request_method}</span></div>
              <div class="layer-line">Request URI: <span>${layers.http.request_uri}</span></div>
              <div class="layer-line">Host: <span>${layers.http.host}</span></div>
              <div class="layer-line">User-Agent: <span>${layers.http.user_agent}</span></div>
            </div>
          `;
        } else {
          detailsDiv.innerHTML += `
            <div class="layer">
              <h3>‚ñº Hypertext Transfer Protocol (Response)</h3>
              <div class="layer-line">Response Code: <span>${layers.http.response_code}</span></div>
              <div class="layer-line">Content-Type: <span>${layers.http.content_type}</span></div>
              <div class="layer-line">Content-Length: <span>${layers.http.content_length}</span></div>
              <div class="layer-line">Server: <span>${layers.http.server}</span></div>
            </div>
          `;
        }
      }

      // ICMP layer
      if (layers.icmp) {
        detailsDiv.innerHTML += `
          <div class="layer">
            <h3>‚ñº Internet Control Message Protocol</h3>
            <div class="layer-line">Type: <span>${layers.icmp.type} (${layers.icmp.type === 8 ? 'Echo Request' : 'Echo Reply'})</span></div>
            <div class="layer-line">Code: <span>${layers.icmp.code}</span></div>
            <div class="layer-line">Checksum: <span>${layers.icmp.checksum}</span></div>
            <div class="layer-line">Identifier: <span>${layers.icmp.identifier}</span></div>
            <div class="layer-line">Sequence: <span>${layers.icmp.sequence}</span></div>
          </div>
        `;
      }

      // Payload (for malicious traffic)
      if (layers.payload) {
        detailsDiv.innerHTML += `
          <div class="layer" style="border-left-color: #ff4444; background: rgba(255, 68, 68, 0.1);">
            <h3 style="color: #ff4444;">‚ñº Payload Analysis</h3>
            <div class="layer-line">Encrypted: <span>${layers.payload.encrypted ? 'YES' : 'NO'}</span></div>
            <div class="layer-line">Size: <span>${layers.payload.size} bytes</span></div>
            <div class="layer-line" style="color: #ffa500;">Analysis Note: <span>${layers.payload.note}</span></div>
            <div class="layer-line" style="color: #ff4444; font-weight: bold;">Threat Classification: <span>${layers.payload.threat}</span></div>
          </div>
        `;
      }
    }

    // Filter functions
    function addFilter() {
      const field = document.getElementById('filterField').value;
      const operator = document.getElementById('filterOperator').value;
      const value = document.getElementById('filterValue').value;

      if (!field || !value) {
        alert('Please select a field and enter a value.');
        return;
      }

      if (currentFilter) {
        currentFilter += ' && ';
      }
      currentFilter += `${field} ${operator} ${value}`;

      document.getElementById('filterDisplay').textContent = currentFilter;
    }

    function applyFilter() {
      if (!currentFilter) {
        alert('No filter to apply. Build a filter first.');
        return;
      }

      // Simple filter simulation (in reality, Wireshark uses complex BPF/display filter syntax)
      // This is educational - showing the concept
      filteredPackets = packets.filter(packet => {
        // This is a simplified simulation - real filtering would parse the filter string
        return true; // For demo, we'll just show the filter was "applied"
      });

      renderPacketList();
      alert(`Filter applied: ${currentFilter}\n\nNote: This is a simulated filter. In real Wireshark, the display would update to show only matching packets.`);
    }

    function clearFilter() {
      currentFilter = '';
      document.getElementById('filterDisplay').textContent = 'No filter applied';
      document.getElementById('filterField').value = '';
      document.getElementById('filterValue').value = '';
      filteredPackets = [...packets];
      renderPacketList();
    }

    // Generate TCP flows
    function generateFlows() {
      const flowDiv = document.getElementById('flowList');
      flowDiv.innerHTML = '';

      const flows = {};

      packets.forEach(packet => {
        if (packet.protocol === 'TCP' || packet.protocol === 'HTTP') {
          const flowKey = `${packet.src}:${packet.layers.tcp?.sport || '?'} ‚Üî ${packet.dst}:${packet.layers.tcp?.dport || '?'}`;
          if (!flows[flowKey]) {
            flows[flowKey] = { packets: 0, bytes: 0 };
          }
          flows[flowKey].packets++;
          flows[flowKey].bytes += packet.length;
        }
      });

      let count = 0;
      for (const [flow, stats] of Object.entries(flows)) {
        const flowItem = document.createElement('div');
        flowItem.className = 'flow-item';
        flowItem.innerHTML = `
          <strong>${flow}</strong><br>
          Packets: ${stats.packets} | Bytes: ${stats.bytes}
        `;
        flowItem.onclick = () => alert(`Following TCP stream:\n\n${flow}\n\nIn real Wireshark, this would show the complete conversation with all data exchanged between these endpoints.`);
        flowDiv.appendChild(flowItem);
        count++;
      }

      document.getElementById('tcpStreams').textContent = count;
    }

    // Generate DNS list
    function generateDNSList() {
      const dnsDiv = document.getElementById('dnsQueries');
      dnsDiv.innerHTML = '';

      let dnsCount = 0;
      packets.forEach(packet => {
        if (packet.protocol === 'DNS' && packet.layers.dns) {
          const query = document.createElement('div');
          query.className = 'dns-query';
          query.innerHTML = `
            <div>
              <strong>${packet.layers.dns.query_name}</strong><br>
              <span style="color: #888; font-size: 0.9em;">Type: ${packet.layers.dns.query_type} | ${packet.layers.dns.answer_addr || 'Query'}</span>
            </div>
            <div style="color: #06b6d4;">${packet.time}s</div>
          `;
          dnsDiv.appendChild(query);
          dnsCount++;
        }
      });

      document.getElementById('dnsCount').textContent = dnsCount;
    }

    // Update statistics
    function updateStatistics() {
      document.getElementById('totalPackets').textContent = packets.length;

      const uniqueIPs = new Set();
      packets.forEach(p => {
        uniqueIPs.add(p.src);
        uniqueIPs.add(p.dst);
      });
      document.getElementById('uniqueIPs').textContent = uniqueIPs.size;
    }

    // Update protocol chart
    function updateProtocolChart() {
      const protocols = { TCP: 0, UDP: 0, HTTP: 0, DNS: 0, ICMP: 0 };

      packets.forEach(packet => {
        if (protocols.hasOwnProperty(packet.protocol)) {
          protocols[packet.protocol]++;
        }
      });

      const maxCount = Math.max(...Object.values(protocols), 1);
      const bars = document.querySelectorAll('.bar');
      const protocolNames = ['TCP', 'UDP', 'HTTP', 'DNS', 'ICMP'];

      bars.forEach((bar, index) => {
        const protocol = protocolNames[index];
        const count = protocols[protocol];
        const percentage = (count / maxCount) * 100;

        bar.style.height = percentage + '%';
        bar.querySelector('.bar-value').textContent = count;
      });
    }

    function clearCapture() {
      packets = [];
      filteredPackets = [];
      document.getElementById('packetTableBody').innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px; color: #888;">No packets loaded. Click "Load Sample Capture" to begin analysis.</td></tr>';
      document.getElementById('packetDetails').innerHTML = '<p style="color: #888; text-align: center; padding: 40px;">Select a packet from the list above to view detailed layer-by-layer breakdown.</p>';
      document.getElementById('flowList').innerHTML = '<p style="color: #888; text-align: center; padding: 20px;">Load a packet capture to view TCP conversations.</p>';
      document.getElementById('dnsQueries').innerHTML = '<p style="color: #888; text-align: center; padding: 20px;">No DNS queries detected. Load a capture file.</p>';
      document.getElementById('totalPackets').textContent = '0';
      document.getElementById('uniqueIPs').textContent = '0';
      document.getElementById('tcpStreams').textContent = '0';
      document.getElementById('dnsCount').textContent = '0';
      updateProtocolChart();
    }

    function exportFindings() {
      if (packets.length === 0) {
        alert('No packets to export. Load a capture first.');
        return;
      }

      let findings = '=== PACKET ANALYSIS FINDINGS ===\n\n';
      findings += `Total Packets: ${packets.length}\n`;
      findings += `Analysis Time: ${new Date().toISOString()}\n`;
      findings += `Filter Applied: ${currentFilter || 'None'}\n\n`;

      findings += '=== PROTOCOL DISTRIBUTION ===\n';
      const protocols = {};
      packets.forEach(p => protocols[p.protocol] = (protocols[p.protocol] || 0) + 1);
      for (const [proto, count] of Object.entries(protocols)) {
        findings += `${proto}: ${count} packets\n`;
      }

      findings += '\n=== KEY OBSERVATIONS ===\n';
      if (packets.some(p => p.info.includes('C2') || p.info.includes('beacon'))) {
        findings += '‚ö† ALERT: Potential C2 beaconing detected\n';
      }
      if (packets.some(p => p.info.includes('Tunneling') || p.info.includes('TXT'))) {
        findings += '‚ö† ALERT: Possible DNS tunneling activity\n';
      }
      if (packets.some(p => p.info.includes('Lateral') || p.info.includes('sequential'))) {
        findings += '‚ö† ALERT: Lateral movement or scanning behavior\n';
      }
      if (packets.some(p => p.info.includes('EXFILTRATION'))) {
        findings += 'üö® CRITICAL: Data exfiltration detected\n';
      }

      console.log(findings);
      alert('Findings exported to browser console (F12). In a real environment, this would export to a file or SIEM.');
    }
  </script>
</body>
</html>