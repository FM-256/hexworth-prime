<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Correlation Engine - Eye House - Hexworth Prime</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #0f0f23 0%, #1a0a2e 100%);
      color: #e0e0e0;
      line-height: 1.6;
      overflow-x: hidden;
    }

    .container {
      max-width: 1600px;
      margin: 0 auto;
      padding: 20px;
    }

    header {
      text-align: center;
      padding: 30px 20px;
      background: linear-gradient(135deg, rgba(192, 132, 252, 0.1) 0%, rgba(6, 182, 212, 0.1) 100%);
      border-radius: 15px;
      margin-bottom: 30px;
      border: 2px solid rgba(192, 132, 252, 0.3);
    }

    h1 {
      font-size: 2.5em;
      margin-bottom: 10px;
      background: linear-gradient(135deg, #c084fc 0%, #06b6d4 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .subtitle {
      font-size: 1.1em;
      color: #06b6d4;
    }

    .tool-tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .tab-btn {
      background: rgba(192, 132, 252, 0.2);
      color: #c084fc;
      border: 2px solid #c084fc;
      padding: 12px 25px;
      border-radius: 10px;
      cursor: pointer;
      font-size: 1em;
      font-weight: 600;
      transition: all 0.3s ease;
    }

    .tab-btn:hover {
      background: rgba(192, 132, 252, 0.3);
      transform: translateY(-2px);
    }

    .tab-btn.active {
      background: linear-gradient(135deg, #c084fc 0%, #06b6d4 100%);
      color: #0f0f23;
    }

    .tool-panel {
      display: none;
      background: rgba(30, 30, 60, 0.6);
      padding: 30px;
      border-radius: 15px;
      border: 2px solid rgba(192, 132, 252, 0.3);
      backdrop-filter: blur(10px);
    }

    .tool-panel.active {
      display: block;
      animation: fadeIn 0.5s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    h2 {
      color: #c084fc;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 2px solid rgba(192, 132, 252, 0.3);
    }

    h3 {
      color: #06b6d4;
      margin: 20px 0 10px 0;
    }

    .control-panel {
      background: rgba(15, 15, 35, 0.6);
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 20px;
      border: 1px solid rgba(192, 132, 252, 0.3);
    }

    .control-row {
      display: flex;
      gap: 15px;
      margin-bottom: 15px;
      flex-wrap: wrap;
      align-items: center;
    }

    .control-row label {
      color: #06b6d4;
      font-weight: 600;
      min-width: 120px;
    }

    input, select, textarea {
      background: rgba(0, 0, 0, 0.4);
      color: #e0e0e0;
      border: 2px solid rgba(192, 132, 252, 0.3);
      padding: 10px;
      border-radius: 8px;
      font-size: 1em;
      font-family: 'Courier New', monospace;
    }

    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: #c084fc;
    }

    button {
      background: linear-gradient(135deg, rgba(192, 132, 252, 0.3) 0%, rgba(6, 182, 212, 0.3) 100%);
      color: #c084fc;
      border: 2px solid #c084fc;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1em;
      font-weight: 600;
      transition: all 0.3s ease;
    }

    button:hover {
      background: linear-gradient(135deg, rgba(192, 132, 252, 0.5) 0%, rgba(6, 182, 212, 0.5) 100%);
      transform: translateY(-2px);
    }

    button:active {
      transform: translateY(0);
    }

    .timeline-container {
      background: rgba(15, 15, 35, 0.8);
      padding: 20px;
      border-radius: 10px;
      margin: 20px 0;
      border: 2px solid rgba(192, 132, 252, 0.3);
      min-height: 400px;
    }

    .timeline {
      position: relative;
      padding: 20px 0;
    }

    .timeline-axis {
      position: absolute;
      left: 50px;
      top: 0;
      bottom: 0;
      width: 3px;
      background: linear-gradient(180deg, #c084fc 0%, #06b6d4 100%);
    }

    .timeline-event {
      position: relative;
      margin: 15px 0 15px 80px;
      padding: 15px;
      background: rgba(192, 132, 252, 0.1);
      border-radius: 8px;
      border-left: 4px solid #c084fc;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .timeline-event:hover {
      background: rgba(192, 132, 252, 0.2);
      transform: translateX(5px);
    }

    .timeline-event.selected {
      border-left-color: #06b6d4;
      background: rgba(6, 182, 212, 0.2);
    }

    .timeline-event::before {
      content: '';
      position: absolute;
      left: -40px;
      top: 50%;
      transform: translateY(-50%);
      width: 12px;
      height: 12px;
      background: #c084fc;
      border: 3px solid #0f0f23;
      border-radius: 50%;
    }

    .timeline-event.selected::before {
      background: #06b6d4;
    }

    .event-time {
      color: #06b6d4;
      font-weight: 600;
      font-family: 'Courier New', monospace;
      margin-bottom: 5px;
    }

    .event-source {
      display: inline-block;
      background: rgba(192, 132, 252, 0.3);
      color: #c084fc;
      padding: 3px 10px;
      border-radius: 5px;
      font-size: 0.85em;
      margin-right: 10px;
    }

    .log-viewer {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 15px;
      margin: 20px 0;
    }

    .log-source-panel {
      background: rgba(15, 15, 35, 0.8);
      border-radius: 10px;
      padding: 15px;
      border: 2px solid rgba(192, 132, 252, 0.3);
    }

    .log-source-panel h4 {
      color: #c084fc;
      margin-bottom: 10px;
      padding-bottom: 8px;
      border-bottom: 1px solid rgba(192, 132, 252, 0.3);
    }

    .log-entry {
      background: rgba(0, 0, 0, 0.4);
      padding: 8px;
      margin: 5px 0;
      border-radius: 5px;
      font-family: 'Courier New', monospace;
      font-size: 0.85em;
      border-left: 3px solid transparent;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .log-entry:hover {
      background: rgba(192, 132, 252, 0.1);
      border-left-color: #c084fc;
    }

    .log-entry.correlated {
      border-left-color: #06b6d4;
      background: rgba(6, 182, 212, 0.1);
    }

    .correlation-viz {
      background: rgba(15, 15, 35, 0.8);
      padding: 20px;
      border-radius: 10px;
      margin: 20px 0;
      border: 2px solid rgba(192, 132, 252, 0.3);
      min-height: 300px;
    }

    .node {
      display: inline-block;
      background: linear-gradient(135deg, rgba(192, 132, 252, 0.3) 0%, rgba(6, 182, 212, 0.3) 100%);
      padding: 15px;
      border-radius: 10px;
      border: 2px solid #c084fc;
      margin: 10px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .node:hover {
      transform: scale(1.05);
      box-shadow: 0 5px 20px rgba(192, 132, 252, 0.5);
    }

    .node.highlighted {
      border-color: #06b6d4;
      background: linear-gradient(135deg, rgba(6, 182, 212, 0.3) 0%, rgba(192, 132, 252, 0.3) 100%);
    }

    .killchain-map {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .killchain-phase {
      background: rgba(30, 30, 60, 0.6);
      padding: 15px;
      border-radius: 8px;
      border-left: 5px solid #666;
      transition: all 0.3s ease;
    }

    .killchain-phase.has-events {
      border-left-color: #f472b6;
      background: rgba(244, 114, 182, 0.1);
    }

    .killchain-phase h4 {
      color: #c084fc;
      margin-bottom: 8px;
    }

    .killchain-events {
      display: none;
      margin-top: 10px;
    }

    .killchain-phase.expanded .killchain-events {
      display: block;
    }

    .rule-editor {
      background: rgba(0, 0, 0, 0.4);
      padding: 15px;
      border-radius: 8px;
      margin: 15px 0;
    }

    .rule-field {
      color: #c084fc;
    }

    .rule-operator {
      color: #f472b6;
      font-weight: bold;
    }

    .rule-value {
      color: #06b6d4;
    }

    .match-result {
      background: rgba(6, 182, 212, 0.1);
      padding: 15px;
      border-radius: 8px;
      margin: 10px 0;
      border-left: 4px solid #06b6d4;
    }

    .no-match {
      background: rgba(244, 114, 182, 0.1);
      border-left-color: #f472b6;
    }

    .stats-panel {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin: 20px 0;
    }

    .stat-card {
      background: linear-gradient(135deg, rgba(192, 132, 252, 0.1) 0%, rgba(6, 182, 212, 0.1) 100%);
      padding: 20px;
      border-radius: 10px;
      border: 2px solid rgba(192, 132, 252, 0.3);
      text-align: center;
    }

    .stat-value {
      font-size: 2.5em;
      font-weight: bold;
      color: #c084fc;
    }

    .stat-label {
      color: #06b6d4;
      margin-top: 5px;
    }

    .draggable {
      cursor: move;
    }

    .drop-zone {
      min-height: 100px;
      border: 2px dashed rgba(192, 132, 252, 0.3);
      border-radius: 8px;
      padding: 20px;
      margin: 10px 0;
    }

    .drop-zone.drag-over {
      border-color: #06b6d4;
      background: rgba(6, 182, 212, 0.1);
    }

    @media (max-width: 768px) {
      .log-viewer {
        grid-template-columns: 1fr;
      }
      .stats-panel {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>‚ö° Correlation Engine</h1>
      <p class="subtitle">Interactive Log Correlation Visualization & Analysis Tool</p>
    </header>

    <div class="tool-tabs">
      <button class="tab-btn active" onclick="showTool('timeline')">Timeline Builder</button>
      <button class="tab-btn" onclick="showTool('multilog')">Multi-Source Viewer</button>
      <button class="tab-btn" onclick="showTool('ruletester')">Rule Tester</button>
      <button class="tab-btn" onclick="showTool('killchain')">Kill Chain Mapper</button>
      <button class="tab-btn" onclick="showTool('pivot')">IP/User Pivot</button>
      <button class="tab-btn" onclick="showTool('timewindow')">Time Window Analyzer</button>
    </div>

    <!-- Timeline Builder Tool -->
    <div class="tool-panel active" id="timeline">
      <h2>Timeline Builder</h2>
      <p>Build a visual timeline of correlated events. Click events to select them and see connections.</p>

      <div class="control-panel">
        <div class="control-row">
          <label>Load Scenario:</label>
          <select id="timelineScenario" onchange="loadTimelineScenario()">
            <option value="">-- Select Scenario --</option>
            <option value="bruteforce">Brute Force ‚Üí Lateral Movement</option>
            <option value="ransomware">Ransomware Attack</option>
            <option value="exfiltration">Data Exfiltration</option>
            <option value="webapp">Web App Compromise</option>
          </select>
          <button onclick="clearTimeline()">Clear Timeline</button>
        </div>
      </div>

      <div class="stats-panel" id="timelineStats">
        <div class="stat-card">
          <div class="stat-value" id="eventCount">0</div>
          <div class="stat-label">Total Events</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="sourceCount">0</div>
          <div class="stat-label">Log Sources</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="timeSpan">0s</div>
          <div class="stat-label">Time Span</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="correlatedCount">0</div>
          <div class="stat-label">Correlated Events</div>
        </div>
      </div>

      <div class="timeline-container">
        <h3>Event Timeline</h3>
        <div class="timeline" id="timelineEvents">
          <div class="timeline-axis"></div>
          <p style="text-align: center; color: #888; margin-top: 50px;">Select a scenario to load events...</p>
        </div>
      </div>
    </div>

    <!-- Multi-Source Log Viewer -->
    <div class="tool-panel" id="multilog">
      <h2>Multi-Source Log Viewer</h2>
      <p>View logs from different sources side-by-side. Click logs to highlight correlated events.</p>

      <div class="control-panel">
        <div class="control-row">
          <label>Load Incident:</label>
          <select onchange="loadMultiSourceLogs(this.value)">
            <option value="">-- Select Incident --</option>
            <option value="incident1">Compromised Account Investigation</option>
            <option value="incident2">Malware Infection</option>
            <option value="incident3">Insider Threat</option>
          </select>
          <label style="margin-left: 20px;">Correlation Key:</label>
          <select id="correlationKey">
            <option value="ip">Source IP</option>
            <option value="user">Username</option>
            <option value="host">Hostname</option>
          </select>
          <button onclick="highlightCorrelated()">Highlight Correlated</button>
        </div>
      </div>

      <div class="log-viewer" id="logViewer">
        <div class="log-source-panel">
          <h4>üî• Firewall Logs</h4>
          <div id="firewallLogs">
            <p style="color: #888; font-size: 0.9em;">No logs loaded</p>
          </div>
        </div>
        <div class="log-source-panel">
          <h4>üõ°Ô∏è IDS Logs</h4>
          <div id="idsLogs">
            <p style="color: #888; font-size: 0.9em;">No logs loaded</p>
          </div>
        </div>
        <div class="log-source-panel">
          <h4>üîê Authentication Logs</h4>
          <div id="authLogs">
            <p style="color: #888; font-size: 0.9em;">No logs loaded</p>
          </div>
        </div>
        <div class="log-source-panel">
          <h4>üíª Endpoint Logs</h4>
          <div id="endpointLogs">
            <p style="color: #888; font-size: 0.9em;">No logs loaded</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Rule Tester -->
    <div class="tool-panel" id="ruletester">
      <h2>Correlation Rule Tester</h2>
      <p>Define a correlation rule and test it against sample events to see which logs match.</p>

      <div class="control-panel">
        <h3>Rule Definition</h3>
        <div class="rule-editor">
          <div class="control-row">
            <label>Event Type:</label>
            <select id="ruleEventType">
              <option value="failed_login">Failed Login</option>
              <option value="successful_login">Successful Login</option>
              <option value="file_access">File Access</option>
              <option value="network_connection">Network Connection</option>
              <option value="process_execution">Process Execution</option>
            </select>
          </div>
          <div class="control-row">
            <label>Condition:</label>
            <select id="ruleCondition">
              <option value="count">COUNT events</option>
              <option value="sequence">Event FOLLOWED BY</option>
              <option value="within">Events WITHIN time</option>
            </select>
          </div>
          <div class="control-row">
            <label>Threshold/Time:</label>
            <input type="text" id="ruleThreshold" placeholder="e.g., 5 or 10 minutes" style="width: 200px;">
          </div>
          <div class="control-row">
            <label>Where Clause:</label>
            <input type="text" id="ruleWhere" placeholder="e.g., source_ip = SAME" style="width: 400px;">
          </div>
          <button onclick="testRule()">Test Rule</button>
          <button onclick="loadSampleRule()">Load Sample Rule</button>
        </div>
      </div>

      <div class="correlation-viz">
        <h3>Rule Matching Results</h3>
        <div id="ruleResults">
          <p style="color: #888; text-align: center;">Define a rule and click "Test Rule" to see matches...</p>
        </div>
      </div>
    </div>

    <!-- Kill Chain Mapper -->
    <div class="tool-panel" id="killchain">
      <h2>Attack Chain Visualizer</h2>
      <p>Map correlated events to MITRE ATT&CK kill chain phases.</p>

      <div class="control-panel">
        <div class="control-row">
          <label>Load Attack:</label>
          <select onchange="loadKillChainAttack(this.value)">
            <option value="">-- Select Attack --</option>
            <option value="apt">APT Campaign</option>
            <option value="ransomware">Ransomware</option>
            <option value="insider">Insider Threat</option>
          </select>
          <button onclick="exportKillChain()">Export Analysis</button>
        </div>
      </div>

      <div class="killchain-map" id="killchainMap">
        <p style="text-align: center; color: #888; padding: 40px;">Load an attack scenario to see kill chain mapping...</p>
      </div>
    </div>

    <!-- IP/User Pivot Tool -->
    <div class="tool-panel" id="pivot">
      <h2>IP/User Pivot Analysis</h2>
      <p>Click on an IP address or username to see all related events across all log sources.</p>

      <div class="control-panel">
        <div class="control-row">
          <label>Pivot Type:</label>
          <select id="pivotType">
            <option value="ip">Source IP Address</option>
            <option value="user">Username</option>
            <option value="host">Hostname</option>
          </select>
          <label style="margin-left: 20px;">Value:</label>
          <input type="text" id="pivotValue" placeholder="e.g., 203.0.113.42 or jsmith" style="width: 250px;">
          <button onclick="performPivot()">Pivot</button>
          <button onclick="loadPivotExample()">Load Example</button>
        </div>
      </div>

      <div class="stats-panel" id="pivotStats" style="display: none;">
        <div class="stat-card">
          <div class="stat-value" id="pivotEventCount">0</div>
          <div class="stat-label">Related Events</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="pivotSourceCount">0</div>
          <div class="stat-label">Log Sources</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="pivotTimeSpan">0</div>
          <div class="stat-label">First to Last Event</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="pivotRisk">-</div>
          <div class="stat-label">Risk Score</div>
        </div>
      </div>

      <div class="timeline-container" id="pivotTimeline" style="display: none;">
        <h3>Pivot Results Timeline</h3>
        <div class="timeline" id="pivotEvents"></div>
      </div>
    </div>

    <!-- Time Window Analyzer -->
    <div class="tool-panel" id="timewindow">
      <h2>Time Window Analyzer</h2>
      <p>Adjust correlation time windows and see how it impacts event matching.</p>

      <div class="control-panel">
        <div class="control-row">
          <label>Correlation Window:</label>
          <input type="range" id="windowSize" min="10" max="3600" value="300" style="width: 300px;">
          <span id="windowDisplay" style="color: #06b6d4; font-weight: bold; margin-left: 10px;">5 minutes</span>
        </div>
        <div class="control-row">
          <label>Event Pattern:</label>
          <select id="patternType" onchange="loadTimeWindowScenario()">
            <option value="bruteforce">Brute Force Detection</option>
            <option value="lateral">Lateral Movement</option>
            <option value="exfil">Data Exfiltration</option>
          </select>
          <button onclick="analyzeWindow()">Analyze Window</button>
        </div>
      </div>

      <div class="stats-panel">
        <div class="stat-card">
          <div class="stat-value" id="windowMatches">0</div>
          <div class="stat-label">Matched Events</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="windowFalsePos">0</div>
          <div class="stat-label">False Positives</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="windowTruePos">0</div>
          <div class="stat-label">True Positives</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="windowAccuracy">0%</div>
          <div class="stat-label">Accuracy</div>
        </div>
      </div>

      <div class="correlation-viz">
        <h3>Window Analysis Visualization</h3>
        <div id="windowViz">
          <p style="text-align: center; color: #888;">Select a pattern and analyze to see results...</p>
        </div>
      </div>
    </div>
  </div>

  <script>
    let currentTool = 'timeline';
    let timelineEvents = [];
    let selectedEvents = [];

    function showTool(toolId) {
      document.querySelectorAll('.tool-panel').forEach(panel => panel.classList.remove('active'));
      document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));

      document.getElementById(toolId).classList.add('active');
      event.target.classList.add('active');
      currentTool = toolId;
    }

    // Timeline Builder Functions
    function loadTimelineScenario() {
      const scenario = document.getElementById('timelineScenario').value;
      if (!scenario) return;

      const scenarios = {
        bruteforce: [
          { time: '10:15:22', source: 'Firewall', event: 'Connection from 203.0.113.42 blocked', severity: 'low' },
          { time: '10:15:25', source: 'Auth', event: 'Failed SSH login from 203.0.113.42 (user: admin)', severity: 'low' },
          { time: '10:15:28', source: 'Auth', event: 'Failed SSH login from 203.0.113.42 (user: admin)', severity: 'low' },
          { time: '10:15:31', source: 'Auth', event: 'Failed SSH login from 203.0.113.42 (user: admin)', severity: 'low' },
          { time: '10:16:44', source: 'IDS', event: 'SSH brute force detected from 203.0.113.42', severity: 'medium' },
          { time: '10:18:15', source: 'Auth', event: 'Successful SSH login from 203.0.113.42 (user: admin)', severity: 'high' },
          { time: '10:22:33', source: 'Network', event: 'SMB connection: compromised_host ‚Üí SRV-DB-01', severity: 'high' },
          { time: '10:23:18', source: 'Auth', event: 'Login to SRV-DB-01 from compromised_host', severity: 'high' },
          { time: '10:25:45', source: 'Network', event: 'SMB connections to 8 additional servers', severity: 'critical' }
        ],
        ransomware: [
          { time: '14:22:15', source: 'Email', event: 'Attachment invoice.exe delivered to user@company.com', severity: 'low' },
          { time: '14:35:44', source: 'Endpoint', event: 'invoice.exe executed from Downloads folder', severity: 'medium' },
          { time: '14:35:48', source: 'Firewall', event: 'Outbound HTTPS to 185.220.101.42:443', severity: 'medium' },
          { time: '14:35:50', source: 'IDS', event: 'Cobalt Strike beacon detected', severity: 'high' },
          { time: '14:36:00+', source: 'Network', event: 'Periodic beacons every 60 seconds', severity: 'high' },
          { time: '15:22:33', source: 'File', event: 'Bulk file access: 1,247 files in 8 minutes', severity: 'high' },
          { time: '15:30:10', source: 'EDR', event: 'Mass file encryption detected', severity: 'critical' },
          { time: '15:32:45', source: 'File', event: 'READ_ME.txt created in all directories', severity: 'critical' }
        ],
        exfiltration: [
          { time: '09:15:33', source: 'Email', event: 'Phishing email delivered', severity: 'low' },
          { time: '09:47:12', source: 'Proxy', event: 'User clicked phishing link', severity: 'medium' },
          { time: '10:12:20', source: 'Firewall', event: 'VPN connection from Russia (93.184.216.34)', severity: 'medium' },
          { time: '10:13:05', source: 'VPN', event: 'Successful VPN login: user@company.com', severity: 'high' },
          { time: '10:15:30', source: 'File', event: 'Bulk file access: 2.3GB in 5 minutes', severity: 'high' },
          { time: '10:22:18', source: 'Firewall', event: 'Outbound connection to mega.nz', severity: 'high' },
          { time: '10:24:55', source: 'DLP', event: '2.3GB transferred to external site', severity: 'critical' }
        ],
        webapp: [
          { time: '11:22:10', source: 'Web', event: 'Multiple 404 errors from 198.51.100.42', severity: 'low' },
          { time: '11:25:33', source: 'IDS', event: 'SQLMap user agent detected', severity: 'medium' },
          { time: '11:28:15', source: 'Web', event: 'SQL injection in login form', severity: 'high' },
          { time: '11:28:22', source: 'App', event: 'Admin dashboard accessed without auth', severity: 'high' },
          { time: '11:30:45', source: 'Database', event: 'UNION SELECT on users table', severity: 'high' },
          { time: '11:32:10', source: 'Database', event: 'INTO OUTFILE shell.php executed', severity: 'critical' },
          { time: '11:35:22', source: 'Web', event: 'POST to shell.php (remote code execution)', severity: 'critical' }
        ]
      };

      timelineEvents = scenarios[scenario] || [];
      renderTimeline();
      updateTimelineStats();
    }

    function renderTimeline() {
      const container = document.getElementById('timelineEvents');
      container.innerHTML = '<div class="timeline-axis"></div>';

      timelineEvents.forEach((event, index) => {
        const eventDiv = document.createElement('div');
        eventDiv.className = 'timeline-event';
        eventDiv.onclick = () => selectEvent(index);
        eventDiv.innerHTML = `
          <div class="event-time">${event.time}</div>
          <span class="event-source">${event.source}</span>
          <span>${event.event}</span>
        `;
        container.appendChild(eventDiv);
      });
    }

    function selectEvent(index) {
      const events = document.querySelectorAll('.timeline-event');
      events[index].classList.toggle('selected');

      if (selectedEvents.includes(index)) {
        selectedEvents = selectedEvents.filter(i => i !== index);
      } else {
        selectedEvents.push(index);
      }

      updateTimelineStats();
    }

    function updateTimelineStats() {
      document.getElementById('eventCount').textContent = timelineEvents.length;

      const sources = new Set(timelineEvents.map(e => e.source));
      document.getElementById('sourceCount').textContent = sources.size;

      document.getElementById('correlatedCount').textContent = selectedEvents.length;

      if (timelineEvents.length > 1) {
        const first = timelineEvents[0].time;
        const last = timelineEvents[timelineEvents.length - 1].time;
        document.getElementById('timeSpan').textContent = calculateTimeSpan(first, last);
      }
    }

    function calculateTimeSpan(start, end) {
      // Simple time span calculation (would be more complex in reality)
      return '~15 min';
    }

    function clearTimeline() {
      timelineEvents = [];
      selectedEvents = [];
      document.getElementById('timelineEvents').innerHTML = '<div class="timeline-axis"></div><p style="text-align: center; color: #888; margin-top: 50px;">Select a scenario to load events...</p>';
      updateTimelineStats();
    }

    // Multi-Source Log Viewer Functions
    function loadMultiSourceLogs(incident) {
      if (!incident) return;

      const incidents = {
        incident1: {
          firewall: [
            '10:15:22 DENY 203.0.113.42 ‚Üí 192.168.1.100:22',
            '10:18:15 ALLOW 203.0.113.42 ‚Üí 192.168.1.100:22',
            '10:22:33 ALLOW 192.168.1.100 ‚Üí 192.168.1.50:445'
          ],
          ids: [
            '10:16:44 SSH brute force from 203.0.113.42',
            '10:23:15 SMB enumeration detected'
          ],
          auth: [
            '10:15:25 FAIL SSH login user=admin from=203.0.113.42',
            '10:15:28 FAIL SSH login user=admin from=203.0.113.42',
            '10:18:15 SUCCESS SSH login user=admin from=203.0.113.42',
            '10:23:18 SUCCESS SMB login to SRV-DB-01'
          ],
          endpoint: [
            '10:20:33 Process: /bin/bash spawned by sshd',
            '10:21:44 Network scan initiated',
            '10:23:50 Credential dumping detected'
          ]
        },
        incident2: {
          firewall: [
            '14:35:48 ALLOW 192.168.1.45 ‚Üí 185.220.101.42:443',
            '14:36:00 ALLOW 192.168.1.45 ‚Üí 185.220.101.42:443 (periodic)'
          ],
          ids: [
            '14:35:50 Cobalt Strike beacon detected',
            '14:36:15 C2 communication pattern identified'
          ],
          auth: [
            '14:22:10 User login: jsmith@192.168.1.45'
          ],
          endpoint: [
            '14:35:44 Process: invoice.exe executed by jsmith',
            '14:35:46 PowerShell download from 185.220.101.42',
            '15:30:10 Mass file encryption detected'
          ]
        },
        incident3: {
          firewall: [
            '16:22:15 ALLOW 192.168.1.75 ‚Üí 10.0.0.1:443 (VPN)'
          ],
          ids: [
            '16:45:33 Unusual data transfer volume'
          ],
          auth: [
            '16:22:15 VPN login: asmith (off-hours)'
          ],
          endpoint: [
            '16:30:22 USB device connected',
            '16:35:44 Bulk file copy to USB',
            '16:40:15 Email forwarding rule created'
          ]
        }
      };

      const data = incidents[incident];
      if (!data) return;

      document.getElementById('firewallLogs').innerHTML = data.firewall.map(log =>
        `<div class="log-entry" data-ip="203.0.113.42">${log}</div>`
      ).join('');

      document.getElementById('idsLogs').innerHTML = data.ids.map(log =>
        `<div class="log-entry" data-ip="203.0.113.42">${log}</div>`
      ).join('');

      document.getElementById('authLogs').innerHTML = data.auth.map(log =>
        `<div class="log-entry" data-ip="203.0.113.42">${log}</div>`
      ).join('');

      document.getElementById('endpointLogs').innerHTML = data.endpoint.map(log =>
        `<div class="log-entry" data-ip="203.0.113.42">${log}</div>`
      ).join('');
    }

    function highlightCorrelated() {
      const key = document.getElementById('correlationKey').value;
      document.querySelectorAll('.log-entry').forEach(entry => {
        entry.classList.remove('correlated');
      });

      // Simple correlation based on IP presence
      document.querySelectorAll('.log-entry[data-ip]').forEach(entry => {
        entry.classList.add('correlated');
      });
    }

    // Rule Tester Functions
    function loadSampleRule() {
      document.getElementById('ruleEventType').value = 'failed_login';
      document.getElementById('ruleCondition').value = 'count';
      document.getElementById('ruleThreshold').value = '5';
      document.getElementById('ruleWhere').value = 'source_ip = SAME AND username = SAME';
    }

    function testRule() {
      const eventType = document.getElementById('ruleEventType').value;
      const condition = document.getElementById('ruleCondition').value;
      const threshold = document.getElementById('ruleThreshold').value;
      const where = document.getElementById('ruleWhere').value;

      const resultsDiv = document.getElementById('ruleResults');
      resultsDiv.innerHTML = `
        <div class="match-result">
          <h4 style="color: #06b6d4; margin-bottom: 10px;">‚úì Rule Matched 3 Event Groups</h4>
          <div style="margin: 10px 0; padding: 10px; background: rgba(0,0,0,0.3); border-radius: 5px;">
            <strong>Match 1:</strong> 10:15:25 - 10:15:31<br>
            Source IP: 203.0.113.42, User: admin<br>
            Events: 5 failed logins within 6 seconds
          </div>
          <div style="margin: 10px 0; padding: 10px; background: rgba(0,0,0,0.3); border-radius: 5px;">
            <strong>Match 2:</strong> 12:44:10 - 12:44:58<br>
            Source IP: 198.51.100.23, User: root<br>
            Events: 8 failed logins within 48 seconds
          </div>
          <div style="margin: 10px 0; padding: 10px; background: rgba(0,0,0,0.3); border-radius: 5px;">
            <strong>Match 3:</strong> 15:22:05 - 15:23:15<br>
            Source IP: 192.0.2.18, User: admin<br>
            Events: 12 failed logins within 70 seconds
          </div>
        </div>
        <div class="match-result no-match">
          <h4 style="color: #f472b6; margin-bottom: 10px;">‚úó 47 Events Did Not Match</h4>
          <p>Single failed logins or groups smaller than threshold</p>
        </div>
      `;
    }

    // Kill Chain Mapper Functions
    function loadKillChainAttack(attack) {
      if (!attack) return;

      const phases = [
        { name: 'Reconnaissance', tactic: 'TA0043', events: [] },
        { name: 'Initial Access', tactic: 'TA0001', events: [] },
        { name: 'Execution', tactic: 'TA0002', events: [] },
        { name: 'Persistence', tactic: 'TA0003', events: [] },
        { name: 'Privilege Escalation', tactic: 'TA0004', events: [] },
        { name: 'Defense Evasion', tactic: 'TA0005', events: [] },
        { name: 'Credential Access', tactic: 'TA0006', events: [] },
        { name: 'Discovery', tactic: 'TA0007', events: [] },
        { name: 'Lateral Movement', tactic: 'TA0008', events: [] },
        { name: 'Collection', tactic: 'TA0009', events: [] },
        { name: 'C2', tactic: 'TA0011', events: [] },
        { name: 'Exfiltration', tactic: 'TA0010', events: [] },
        { name: 'Impact', tactic: 'TA0040', events: [] }
      ];

      const attacks = {
        apt: {
          1: ['Email: Phishing email sent to 5 employees'],
          2: ['T1566.001: Malicious attachment opened'],
          3: ['T1059.001: PowerShell execution'],
          4: ['T1547.001: Registry run key created'],
          5: ['T1055: Process injection into explorer.exe'],
          6: ['T1562.001: Windows Defender disabled'],
          7: ['T1003.001: LSASS memory dump'],
          8: ['T1018: Network enumeration via AD queries'],
          9: ['T1021.002: SMB lateral movement to 3 servers'],
          10: ['T1560.001: Archive sensitive files'],
          11: ['T1071.001: HTTPS C2 beacon to command server'],
          12: ['T1041: 5GB data exfiltrated via C2 channel']
        },
        ransomware: {
          2: ['T1566.001: Malicious email attachment'],
          3: ['T1204.002: User executed invoice.exe'],
          4: ['T1547.001: Registry persistence established'],
          7: ['T1003.001: Credential dumping'],
          9: ['T1021.001: RDP to multiple servers'],
          10: ['T1083: File enumeration across network'],
          11: ['T1071.001: Cobalt Strike C2'],
          13: ['T1486: Ransomware encryption of 2,400 files']
        },
        insider: {
          7: ['T1552.001: Access to credential stores'],
          8: ['T1083: File and directory discovery'],
          10: ['T1005: Data from local system', 'T1025: Data from removable media'],
          12: ['T1052.001: Exfiltration via USB', 'T1567.002: Upload to cloud storage']
        }
      };

      const attackData = attacks[attack];
      const map = document.getElementById('killchainMap');
      map.innerHTML = '';

      phases.forEach((phase, index) => {
        const events = attackData[index] || [];
        const hasEvents = events.length > 0;

        const phaseDiv = document.createElement('div');
        phaseDiv.className = `killchain-phase ${hasEvents ? 'has-events' : ''}`;
        phaseDiv.innerHTML = `
          <h4>${phase.name} (${phase.tactic})</h4>
          ${hasEvents ? `
            <div class="killchain-events">
              ${events.map(e => `<div style="padding: 5px; margin: 5px 0; background: rgba(0,0,0,0.3); border-radius: 5px;">${e}</div>`).join('')}
            </div>
          ` : '<p style="color: #666; font-size: 0.9em;">No events detected in this phase</p>'}
        `;

        if (hasEvents) {
          phaseDiv.onclick = () => phaseDiv.classList.toggle('expanded');
        }

        map.appendChild(phaseDiv);
      });
    }

    function exportKillChain() {
      alert('Kill chain analysis exported to clipboard!\n\nIn a real tool, this would generate a detailed report mapping all events to MITRE ATT&CK techniques with timestamps and evidence.');
    }

    // IP/User Pivot Functions
    function loadPivotExample() {
      document.getElementById('pivotType').value = 'ip';
      document.getElementById('pivotValue').value = '203.0.113.42';
      performPivot();
    }

    function performPivot() {
      const type = document.getElementById('pivotType').value;
      const value = document.getElementById('pivotValue').value;

      if (!value) {
        alert('Please enter a pivot value');
        return;
      }

      // Show stats
      document.getElementById('pivotStats').style.display = 'grid';
      document.getElementById('pivotTimeline').style.display = 'block';

      // Update stats
      document.getElementById('pivotEventCount').textContent = '23';
      document.getElementById('pivotSourceCount').textContent = '6';
      document.getElementById('pivotTimeSpan').textContent = '2h 15m';
      document.getElementById('pivotRisk').textContent = 'HIGH';

      // Render timeline
      const timeline = document.getElementById('pivotEvents');
      timeline.innerHTML = `
        <div class="timeline-axis"></div>
        <div class="timeline-event">
          <div class="event-time">10:15:22</div>
          <span class="event-source">Firewall</span>
          <span>Connection from ${value} blocked</span>
        </div>
        <div class="timeline-event">
          <div class="event-time">10:15:25</div>
          <span class="event-source">Auth</span>
          <span>Failed SSH login from ${value}</span>
        </div>
        <div class="timeline-event">
          <div class="event-time">10:16:44</div>
          <span class="event-source">IDS</span>
          <span>SSH brute force from ${value}</span>
        </div>
        <div class="timeline-event">
          <div class="event-time">10:18:15</div>
          <span class="event-source">Auth</span>
          <span>Successful SSH login from ${value}</span>
        </div>
        <div class="timeline-event">
          <div class="event-time">10:22:33</div>
          <span class="event-source">Network</span>
          <span>SMB connections to multiple servers (source: ${value})</span>
        </div>
        <div class="timeline-event">
          <div class="event-time">12:30:15</div>
          <span class="event-source">EDR</span>
          <span>Credential dumping detected on host from ${value}</span>
        </div>
      `;
    }

    // Time Window Analyzer Functions
    document.getElementById('windowSize').addEventListener('input', (e) => {
      const seconds = parseInt(e.target.value);
      const minutes = Math.floor(seconds / 60);
      const secs = seconds % 60;

      let display;
      if (minutes > 60) {
        const hours = Math.floor(minutes / 60);
        const mins = minutes % 60;
        display = `${hours}h ${mins}m`;
      } else if (minutes > 0) {
        display = `${minutes} min ${secs}s`;
      } else {
        display = `${secs} seconds`;
      }

      document.getElementById('windowDisplay').textContent = display;
    });

    function loadTimeWindowScenario() {
      // Placeholder - would load scenario data
    }

    function analyzeWindow() {
      const windowSize = parseInt(document.getElementById('windowSize').value);

      // Simulate analysis based on window size
      let matches, falsePos, truePos;

      if (windowSize < 60) {
        matches = 2; falsePos = 0; truePos = 2;
      } else if (windowSize < 300) {
        matches = 5; falsePos = 1; truePos = 4;
      } else if (windowSize < 900) {
        matches = 12; falsePos = 4; truePos = 8;
      } else {
        matches = 28; falsePos = 18; truePos = 10;
      }

      const accuracy = Math.round((truePos / matches) * 100);

      document.getElementById('windowMatches').textContent = matches;
      document.getElementById('windowFalsePos').textContent = falsePos;
      document.getElementById('windowTruePos').textContent = truePos;
      document.getElementById('windowAccuracy').textContent = accuracy + '%';

      const viz = document.getElementById('windowViz');
      viz.innerHTML = `
        <div style="padding: 20px; text-align: center;">
          <h4 style="color: ${accuracy > 70 ? '#4ade80' : '#f472b6'}; margin-bottom: 20px;">
            Window Analysis: ${accuracy}% Accuracy
          </h4>
          <p style="margin: 10px 0;">
            With a ${document.getElementById('windowDisplay').textContent} correlation window:
          </p>
          <ul style="text-align: left; max-width: 600px; margin: 20px auto;">
            <li style="margin: 10px 0;">Detected ${truePos} true attack sequences</li>
            <li style="margin: 10px 0;">Generated ${falsePos} false positive alerts</li>
            <li style="margin: 10px 0;">Total correlation matches: ${matches}</li>
          </ul>
          <p style="margin-top: 20px; padding: 15px; background: rgba(${accuracy > 70 ? '74, 222, 128' : '244, 114, 182'}, 0.1); border-radius: 8px;">
            <strong>Recommendation:</strong> ${
              accuracy > 70
                ? 'This window size provides good accuracy with minimal false positives.'
                : 'This window is too large, generating excessive false positives. Consider reducing it.'
            }
          </p>
        </div>
      `;
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      console.log('Correlation Engine initialized');
    });
  </script>
<script src="../../../components/FluxCapacitor.js"></script>
</body>
</html>