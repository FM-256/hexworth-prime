<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Threat Hunting Lab - Eye House</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0f0f23 0%, #1a0b2e 100%);
            color: #e0e0e0;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            text-align: center;
            padding: 30px 20px;
            background: linear-gradient(135deg, #c084fc 0%, #06b6d4 100%);
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(192, 132, 252, 0.3);
        }

        header h1 {
            font-size: 2.5em;
            color: #0f0f23;
            margin-bottom: 10px;
        }

        header p {
            font-size: 1.2em;
            color: #1a0b2e;
        }

        .back-link {
            display: inline-block;
            margin-bottom: 20px;
            padding: 10px 25px;
            background: rgba(192, 132, 252, 0.2);
            border: 2px solid #c084fc;
            border-radius: 8px;
            color: #c084fc;
            text-decoration: none;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .back-link:hover {
            background: rgba(192, 132, 252, 0.3);
            transform: translateX(-5px);
        }

        .progress-bar {
            background: rgba(30, 30, 60, 0.6);
            border: 2px solid #c084fc;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
        }

        .progress-bar h3 {
            color: #c084fc;
            margin-bottom: 15px;
        }

        .progress-track {
            background: rgba(26, 26, 46, 0.8);
            height: 30px;
            border-radius: 15px;
            overflow: hidden;
            position: relative;
        }

        .progress-fill {
            background: linear-gradient(90deg, #c084fc 0%, #06b6d4 100%);
            height: 100%;
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #0f0f23;
            font-weight: bold;
        }

        .exercise {
            background: rgba(30, 30, 60, 0.6);
            border: 2px solid #c084fc;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            backdrop-filter: blur(10px);
        }

        .exercise.completed {
            border-color: #22c55e;
            background: rgba(34, 197, 94, 0.1);
        }

        .exercise h2 {
            color: #c084fc;
            font-size: 2em;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .exercise.completed h2 {
            color: #22c55e;
        }

        .exercise-number {
            background: linear-gradient(135deg, #c084fc 0%, #a78bfa 100%);
            color: #0f0f23;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.3em;
        }

        .exercise.completed .exercise-number {
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
        }

        .exercise h3 {
            color: #06b6d4;
            font-size: 1.4em;
            margin: 20px 0 10px 0;
        }

        .exercise p {
            margin-bottom: 15px;
            font-size: 1.05em;
        }

        .scenario-box {
            background: rgba(6, 182, 212, 0.1);
            border-left: 5px solid #06b6d4;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }

        .scenario-box strong {
            color: #06b6d4;
            display: block;
            margin-bottom: 10px;
            font-size: 1.2em;
        }

        .data-viewer {
            background: #1a1a2e;
            border: 2px solid #c084fc;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            line-height: 1.5;
        }

        .log-entry {
            padding: 8px;
            border-bottom: 1px solid rgba(192, 132, 252, 0.2);
            color: #d0d0d0;
        }

        .log-entry:hover {
            background: rgba(192, 132, 252, 0.1);
        }

        .log-timestamp {
            color: #06b6d4;
            margin-right: 10px;
        }

        .log-suspicious {
            background: rgba(239, 68, 68, 0.1);
            border-left: 3px solid #ef4444;
        }

        .task-list {
            background: rgba(26, 26, 46, 0.8);
            border: 2px solid #c084fc;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }

        .task-list h4 {
            color: #c084fc;
            margin-bottom: 15px;
        }

        .task-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 12px;
            background: rgba(30, 30, 60, 0.6);
            border-radius: 8px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .task-item:hover {
            background: rgba(192, 132, 252, 0.1);
        }

        .task-item.completed {
            background: rgba(34, 197, 94, 0.1);
            border-left: 3px solid #22c55e;
        }

        .task-checkbox {
            width: 25px;
            height: 25px;
            border: 2px solid #c084fc;
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .task-item.completed .task-checkbox {
            background: #22c55e;
            border-color: #22c55e;
        }

        .task-checkbox::after {
            content: '✓';
            color: #0f0f23;
            font-weight: bold;
            display: none;
        }

        .task-item.completed .task-checkbox::after {
            display: block;
        }

        .answer-input {
            width: 100%;
            padding: 12px;
            background: rgba(26, 26, 46, 0.8);
            border: 2px solid #c084fc;
            border-radius: 8px;
            color: #e0e0e0;
            font-size: 1em;
            font-family: 'Courier New', monospace;
            margin: 15px 0;
        }

        .answer-input:focus {
            outline: none;
            border-color: #06b6d4;
            box-shadow: 0 0 10px rgba(6, 182, 212, 0.3);
        }

        .btn {
            padding: 12px 30px;
            background: linear-gradient(135deg, #c084fc 0%, #a78bfa 100%);
            color: #0f0f23;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1em;
            margin-right: 10px;
            margin-top: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(192, 132, 252, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
            color: white;
        }

        .btn-hint {
            background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%);
        }

        .feedback {
            padding: 15px 20px;
            border-radius: 8px;
            margin: 15px 0;
            font-weight: 500;
        }

        .feedback.correct {
            background: rgba(34, 197, 94, 0.2);
            border-left: 5px solid #22c55e;
            color: #22c55e;
        }

        .feedback.incorrect {
            background: rgba(239, 68, 68, 0.2);
            border-left: 5px solid #ef4444;
            color: #ef4444;
        }

        .feedback.hint {
            background: rgba(6, 182, 212, 0.2);
            border-left: 5px solid #06b6d4;
            color: #06b6d4;
        }

        .hint-box {
            background: rgba(6, 182, 212, 0.1);
            border: 2px solid #06b6d4;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            display: none;
        }

        .hint-box.visible {
            display: block;
        }

        .findings-box {
            background: rgba(26, 26, 46, 0.8);
            border: 2px solid #06b6d4;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }

        .findings-box h4 {
            color: #06b6d4;
            margin-bottom: 15px;
        }

        .finding-item {
            background: rgba(239, 68, 68, 0.1);
            border-left: 4px solid #ef4444;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
        }

        .finding-item strong {
            color: #ef4444;
            display: block;
            margin-bottom: 5px;
        }

        .complete-lab-button {
            display: block;
            width: 100%;
            max-width: 500px;
            margin: 40px auto;
            padding: 20px 40px;
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.3em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 20px rgba(34, 197, 94, 0.3);
        }

        .complete-lab-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 30px rgba(34, 197, 94, 0.5);
        }

        .complete-lab-button:disabled {
            background: #666;
            cursor: not-allowed;
            opacity: 0.5;
        }

        .info-box {
            background: rgba(6, 182, 212, 0.1);
            border-left: 5px solid #06b6d4;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }

        @media (max-width: 768px) {
            header h1 {
                font-size: 1.8em;
            }

            .exercise {
                padding: 20px;
            }

            .data-viewer {
                font-size: 0.8em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="../index.html" class="back-link">← Back to Eye House</a>

        <header>
            <h1>Threat Hunting Lab</h1>
            <p>Hands-On Hunting Exercises with Simulated EDR/SIEM Data</p>
        </header>

        <div class="progress-bar">
            <h3>Lab Progress</h3>
            <div class="progress-track">
                <div class="progress-fill" id="progress-fill" style="width: 0%;">0%</div>
            </div>
        </div>

        <!-- Exercise 1: Hypothesis Formation -->
        <div class="exercise" id="exercise1">
            <h2>
                <span class="exercise-number">1</span>
                Form a Hypothesis from Threat Intel
            </h2>

            <div class="scenario-box">
                <strong>Scenario:</strong>
                <p>Your threat intelligence team has reported that APT group "Shadow Dragon" is actively targeting organizations in your industry. Recent campaigns show they use spearphishing to gain initial access, then deploy a custom PowerShell-based backdoor for persistence.</p>
                <p>The backdoor establishes persistence via scheduled tasks and uses Base64-encoded PowerShell for evasion.</p>
            </div>

            <h3>Your Task</h3>
            <p>Create a hunting hypothesis using the IF-AND-THEN-WHERE framework.</p>

            <div class="task-list">
                <h4>Build Your Hypothesis:</h4>
                <div class="task-item" onclick="completeTask(this, 1, 1)">
                    <div class="task-checkbox"></div>
                    <div>Identify the adversary behavior (IF)</div>
                </div>
                <div class="task-item" onclick="completeTask(this, 1, 2)">
                    <div class="task-checkbox"></div>
                    <div>Identify environmental condition (AND)</div>
                </div>
                <div class="task-item" onclick="completeTask(this, 1, 3)">
                    <div class="task-checkbox"></div>
                    <div>Define observable indicator (THEN)</div>
                </div>
                <div class="task-item" onclick="completeTask(this, 1, 4)">
                    <div class="task-checkbox"></div>
                    <div>Specify data sources (WHERE)</div>
                </div>
            </div>

            <h3>Submit Your Hypothesis</h3>
            <p><strong>IF:</strong></p>
            <input type="text" class="answer-input" id="ex1-if" placeholder="Shadow Dragon has gained initial access...">

            <p><strong>THEN:</strong></p>
            <input type="text" class="answer-input" id="ex1-then" placeholder="We would see...">

            <p><strong>WHERE:</strong></p>
            <input type="text" class="answer-input" id="ex1-where" placeholder="Data sources: Windows Event Logs...">

            <button class="btn" onclick="checkExercise1()">Submit Hypothesis</button>
            <button class="btn btn-hint" onclick="showHint(1)">Show Hint</button>

            <div id="hint1" class="hint-box">
                <strong>Hint:</strong>
                <ul style="margin-left: 20px; margin-top: 10px;">
                    <li><strong>IF:</strong> Focus on the persistence mechanism (scheduled tasks)</li>
                    <li><strong>THEN:</strong> What would you see in logs? Think about schtasks.exe, PowerShell, Base64</li>
                    <li><strong>WHERE:</strong> Windows Event 4698, Sysmon Event 1, PowerShell logs</li>
                </ul>
            </div>

            <div id="feedback1"></div>
        </div>

        <!-- Exercise 2: Stack Counting -->
        <div class="exercise" id="exercise2">
            <h2>
                <span class="exercise-number">2</span>
                Hunt for Persistence with Stack Counting
            </h2>

            <div class="scenario-box">
                <strong>Scenario:</strong>
                <p>You're hunting for malicious scheduled tasks created in the last 7 days. You've extracted all scheduled task creation events (Event ID 4698) from your SIEM.</p>
            </div>

            <h3>Scheduled Task Data (50 endpoints)</h3>
            <div class="data-viewer" id="task-data">
                <div class="log-entry"><span class="log-timestamp">2024-03-15 08:23:11</span> TaskName: GoogleUpdateTaskMachine | Creator: SYSTEM | Command: C:\Program Files\Google\Update\GoogleUpdate.exe</div>
                <div class="log-entry"><span class="log-timestamp">2024-03-15 08:45:22</span> TaskName: MicrosoftEdgeUpdateTaskMachine | Creator: SYSTEM | Command: C:\Program Files\Microsoft\EdgeUpdate\MicrosoftEdgeUpdate.exe</div>
                <div class="log-entry"><span class="log-timestamp">2024-03-15 09:12:33</span> TaskName: GoogleUpdateTaskMachine | Creator: SYSTEM | Command: C:\Program Files\Google\Update\GoogleUpdate.exe</div>
                <div class="log-entry"><span class="log-timestamp">2024-03-15 09:34:44</span> TaskName: AdobeUpdateTask | Creator: SYSTEM | Command: C:\Program Files\Adobe\Acrobat\Update.exe</div>
                <div class="log-entry"><span class="log-timestamp">2024-03-15 10:15:55</span> TaskName: GoogleUpdateTaskMachine | Creator: SYSTEM | Command: C:\Program Files\Google\Update\GoogleUpdate.exe</div>
                <div class="log-entry"><span class="log-timestamp">2024-03-15 10:47:06</span> TaskName: MicrosoftEdgeUpdateTaskMachine | Creator: SYSTEM | Command: C:\Program Files\Microsoft\EdgeUpdate\MicrosoftEdgeUpdate.exe</div>
                <div class="log-entry"><span class="log-timestamp">2024-03-15 11:23:17</span> TaskName: GoogleUpdateTaskMachine | Creator: SYSTEM | Command: C:\Program Files\Google\Update\GoogleUpdate.exe</div>
                <div class="log-entry log-suspicious"><span class="log-timestamp">2024-03-15 11:58:28</span> TaskName: SystemHealthCheck | Creator: jsmith | Command: powershell.exe -enc UwB0AGEAcgB0AC0AUwBsAGUAZQBwACAALQBTAGUAYwBvAG4AZABzACAAMQAwAA==</div>
                <div class="log-entry"><span class="log-timestamp">2024-03-15 12:34:39</span> TaskName: AdobeUpdateTask | Creator: SYSTEM | Command: C:\Program Files\Adobe\Acrobat\Update.exe</div>
                <div class="log-entry"><span class="log-timestamp">2024-03-15 13:11:50</span> TaskName: GoogleUpdateTaskMachine | Creator: SYSTEM | Command: C:\Program Files\Google\Update\GoogleUpdate.exe</div>
                <div class="log-entry"><span class="log-timestamp">2024-03-15 13:47:01</span> TaskName: MicrosoftEdgeUpdateTaskMachine | Creator: SYSTEM | Command: C:\Program Files\Microsoft\EdgeUpdate\MicrosoftEdgeUpdate.exe</div>
                <div class="log-entry log-suspicious"><span class="log-timestamp">2024-03-15 14:22:12</span> TaskName: WinDefenderUpdate | Creator: admin | Command: C:\Users\Public\update.exe</div>
                <div class="log-entry"><span class="log-timestamp">2024-03-15 14:58:23</span> TaskName: GoogleUpdateTaskMachine | Creator: SYSTEM | Command: C:\Program Files\Google\Update\GoogleUpdate.exe</div>
            </div>

            <h3>Apply Stack Counting</h3>
            <p>Using the stack counting technique, identify suspicious scheduled tasks.</p>

            <div class="task-list">
                <h4>Hunting Steps:</h4>
                <div class="task-item" onclick="completeTask(this, 2, 1)">
                    <div class="task-checkbox"></div>
                    <div>Count frequency of each TaskName</div>
                </div>
                <div class="task-item" onclick="completeTask(this, 2, 2)">
                    <div class="task-checkbox"></div>
                    <div>Identify tasks with count = 1 (outliers)</div>
                </div>
                <div class="task-item" onclick="completeTask(this, 2, 3)">
                    <div class="task-checkbox"></div>
                    <div>Check Creator field (non-SYSTEM is suspicious)</div>
                </div>
                <div class="task-item" onclick="completeTask(this, 2, 4)">
                    <div class="task-checkbox"></div>
                    <div>Examine Command field for anomalies</div>
                </div>
            </div>

            <h3>Identify Suspicious Tasks</h3>
            <p>How many suspicious scheduled tasks did you find?</p>
            <input type="number" class="answer-input" id="ex2-count" placeholder="Number of suspicious tasks">

            <p>What are the suspicious task names? (comma-separated)</p>
            <input type="text" class="answer-input" id="ex2-names" placeholder="TaskName1, TaskName2">

            <button class="btn" onclick="checkExercise2()">Submit Findings</button>
            <button class="btn btn-hint" onclick="showHint(2)">Show Hint</button>

            <div id="hint2" class="hint-box">
                <strong>Hint:</strong>
                <ul style="margin-left: 20px; margin-top: 10px;">
                    <li>Look for tasks that appear only once in the logs</li>
                    <li>GoogleUpdateTaskMachine and MicrosoftEdgeUpdateTaskMachine appear multiple times (normal)</li>
                    <li>Check for tasks created by users instead of SYSTEM</li>
                    <li>Encoded PowerShell (-enc) is highly suspicious</li>
                    <li>Tasks running from unusual locations (C:\Users\Public\) are suspicious</li>
                </ul>
            </div>

            <div id="feedback2"></div>
        </div>

        <!-- Exercise 3: Lateral Movement Detection -->
        <div class="exercise" id="exercise3">
            <h2>
                <span class="exercise-number">3</span>
                Hunt for Lateral Movement (PsExec)
            </h2>

            <div class="scenario-box">
                <strong>Scenario:</strong>
                <p>Intelligence suggests attackers are using PsExec for lateral movement. Hunt for PsExec activity in your environment.</p>
            </div>

            <h3>Network Authentication Logs</h3>
            <div class="data-viewer">
                <div class="log-entry"><span class="log-timestamp">2024-03-15 14:12:01</span> Source: WS-001 | Dest: DC-01 | Service: LDAP | User: jsmith</div>
                <div class="log-entry"><span class="log-timestamp">2024-03-15 14:12:15</span> Source: WS-002 | Dest: FILE-01 | Service: SMB | User: mjones</div>
                <div class="log-entry log-suspicious"><span class="log-timestamp">2024-03-15 14:13:22</span> Source: WS-005 | Dest: WS-010 | Service: ADMIN$ | User: admin</div>
                <div class="log-entry log-suspicious"><span class="log-timestamp">2024-03-15 14:13:28</span> Source: WS-005 | Dest: WS-010 | Service: PSEXESVC | User: admin</div>
                <div class="log-entry"><span class="log-timestamp">2024-03-15 14:14:33</span> Source: WS-003 | Dest: PRINT-01 | Service: SPOOLER | User: kbrown</div>
                <div class="log-entry log-suspicious"><span class="log-timestamp">2024-03-15 14:15:44</span> Source: WS-005 | Dest: WS-012 | Service: ADMIN$ | User: admin</div>
                <div class="log-entry log-suspicious"><span class="log-timestamp">2024-03-15 14:15:51</span> Source: WS-005 | Dest: WS-012 | Service: PSEXESVC | User: admin</div>
                <div class="log-entry"><span class="log-timestamp">2024-03-15 14:16:05</span> Source: WS-004 | Dest: DC-01 | Service: LDAP | User: agarcia</div>
            </div>

            <h3>Questions</h3>
            <p><strong>1. What is the source workstation of the lateral movement?</strong></p>
            <input type="text" class="answer-input" id="ex3-source" placeholder="WS-XXX">

            <p><strong>2. How many target systems were compromised?</strong></p>
            <input type="number" class="answer-input" id="ex3-targets" placeholder="Number">

            <p><strong>3. What is the key indicator of PsExec usage?</strong></p>
            <input type="text" class="answer-input" id="ex3-indicator" placeholder="Service name">

            <button class="btn" onclick="checkExercise3()">Submit Answers</button>
            <button class="btn btn-hint" onclick="showHint(3)">Show Hint</button>

            <div id="hint3" class="hint-box">
                <strong>Hint:</strong>
                <ul style="margin-left: 20px; margin-top: 10px;">
                    <li>PsExec creates a service called "PSEXESVC" on target systems</li>
                    <li>It also accesses ADMIN$ share before installing the service</li>
                    <li>Look for the pattern: ADMIN$ followed by PSEXESVC from same source</li>
                    <li>Workstation-to-workstation connections are more suspicious than workstation-to-server</li>
                </ul>
            </div>

            <div id="feedback3"></div>
        </div>

        <!-- Exercise 4: C2 Beaconing -->
        <div class="exercise" id="exercise4">
            <h2>
                <span class="exercise-number">4</span>
                Identify C2 Beaconing Patterns
            </h2>

            <div class="scenario-box">
                <strong>Scenario:</strong>
                <p>Analyze network connection data to identify potential command-and-control beaconing. Beacons have regular, periodic intervals.</p>
            </div>

            <h3>Outbound Connection Timeline (Host: WS-007)</h3>
            <div class="data-viewer">
                <div class="log-entry"><span class="log-timestamp">14:00:00</span> Dest: google.com | Bytes: 1,432</div>
                <div class="log-entry"><span class="log-timestamp">14:02:15</span> Dest: microsoft.com | Bytes: 2,156</div>
                <div class="log-entry log-suspicious"><span class="log-timestamp">14:05:00</span> Dest: data-analytics-cdn.com | Bytes: 512</div>
                <div class="log-entry"><span class="log-timestamp">14:07:33</span> Dest: office365.com | Bytes: 3,221</div>
                <div class="log-entry log-suspicious"><span class="log-timestamp">14:10:00</span> Dest: data-analytics-cdn.com | Bytes: 512</div>
                <div class="log-entry"><span class="log-timestamp">14:12:44</span> Dest: amazonaws.com | Bytes: 5,678</div>
                <div class="log-entry log-suspicious"><span class="log-timestamp">14:15:00</span> Dest: data-analytics-cdn.com | Bytes: 512</div>
                <div class="log-entry"><span class="log-timestamp">14:18:22</span> Dest: google.com | Bytes: 987</div>
                <div class="log-entry log-suspicious"><span class="log-timestamp">14:20:00</span> Dest: data-analytics-cdn.com | Bytes: 512</div>
                <div class="log-entry"><span class="log-timestamp">14:23:11</span> Dest: microsoft.com | Bytes: 1,234</div>
                <div class="log-entry log-suspicious"><span class="log-timestamp">14:25:00</span> Dest: data-analytics-cdn.com | Bytes: 512</div>
                <div class="log-entry"><span class="log-timestamp">14:27:55</span> Dest: cloudflare.com | Bytes: 876</div>
                <div class="log-entry log-suspicious"><span class="log-timestamp">14:30:00</span> Dest: data-analytics-cdn.com | Bytes: 512</div>
            </div>

            <h3>Beacon Analysis</h3>

            <p><strong>1. What domain is the C2 server?</strong></p>
            <input type="text" class="answer-input" id="ex4-domain" placeholder="domain.com">

            <p><strong>2. What is the beacon interval in minutes?</strong></p>
            <input type="number" class="answer-input" id="ex4-interval" placeholder="Number">

            <p><strong>3. What characteristic makes this beaconing suspicious?</strong></p>
            <select class="answer-input" id="ex4-characteristic">
                <option value="">Select characteristic...</option>
                <option value="periodic">Perfectly periodic timing</option>
                <option value="size">Consistent packet size</option>
                <option value="both">Both periodic timing and consistent size</option>
                <option value="volume">High volume</option>
            </select>

            <button class="btn" onclick="checkExercise4()">Submit Analysis</button>
            <button class="btn btn-hint" onclick="showHint(4)">Show Hint</button>

            <div id="hint4" class="hint-box">
                <strong>Hint:</strong>
                <ul style="margin-left: 20px; margin-top: 10px;">
                    <li>Look for connections that happen at exact intervals</li>
                    <li>Calculate time between connections to the same domain</li>
                    <li>Beacons often send the same amount of data each time</li>
                    <li>Normal web traffic is irregular in timing and size</li>
                    <li>The suspicious domain connects every 5 minutes (300 seconds)</li>
                </ul>
            </div>

            <div id="feedback4"></div>
        </div>

        <!-- Exercise 5: Credential Access -->
        <div class="exercise" id="exercise5">
            <h2>
                <span class="exercise-number">5</span>
                Hunt for Credential Access (LSASS)
            </h2>

            <div class="scenario-box">
                <strong>Scenario:</strong>
                <p>Hunt for attempts to dump credentials from LSASS memory, a common technique for credential theft.</p>
            </div>

            <h3>Process Access Logs (Sysmon Event ID 10)</h3>
            <div class="data-viewer">
                <div class="log-entry"><span class="log-timestamp">15:22:11</span> SourceProcess: svchost.exe | TargetProcess: lsass.exe | Access: 0x1000</div>
                <div class="log-entry"><span class="log-timestamp">15:23:45</span> SourceProcess: wininit.exe | TargetProcess: lsass.exe | Access: 0x1000</div>
                <div class="log-entry log-suspicious"><span class="log-timestamp">15:24:33</span> SourceProcess: powershell.exe | TargetProcess: lsass.exe | Access: 0x1FFFFF</div>
                <div class="log-entry"><span class="log-timestamp">15:25:12</span> SourceProcess: csrss.exe | TargetProcess: lsass.exe | Access: 0x1000</div>
                <div class="log-entry log-suspicious"><span class="log-timestamp">15:26:55</span> SourceProcess: rundll32.exe | TargetProcess: lsass.exe | Access: 0x1410</div>
                <div class="log-entry"><span class="log-timestamp">15:27:22</span> SourceProcess: svchost.exe | TargetProcess: lsass.exe | Access: 0x1000</div>
                <div class="log-entry"><span class="log-timestamp">15:28:44</span> SourceProcess: wininit.exe | TargetProcess: lsass.exe | Access: 0x1000</div>
            </div>

            <div class="info-box">
                <strong>Access Rights Reference:</strong>
                <ul style="margin-left: 20px; margin-top: 10px;">
                    <li><strong>0x1000:</strong> QUERY_LIMITED_INFORMATION (normal, read-only)</li>
                    <li><strong>0x1410:</strong> VM_READ + QUERY_INFORMATION (can read memory)</li>
                    <li><strong>0x1FFFFF:</strong> PROCESS_ALL_ACCESS (full access, highly suspicious)</li>
                </ul>
            </div>

            <h3>Questions</h3>

            <p><strong>1. How many suspicious LSASS access attempts were detected?</strong></p>
            <input type="number" class="answer-input" id="ex5-count" placeholder="Number">

            <p><strong>2. Which processes accessed LSASS suspiciously? (comma-separated)</strong></p>
            <input type="text" class="answer-input" id="ex5-processes" placeholder="process1.exe, process2.exe">

            <p><strong>3. What makes these accesses suspicious?</strong></p>
            <select class="answer-input" id="ex5-reason">
                <option value="">Select reason...</option>
                <option value="access-rights">Unusual access rights (memory read/full access)</option>
                <option value="process-name">Unusual source process names</option>
                <option value="both">Both unusual access rights and process names</option>
            </select>

            <button class="btn" onclick="checkExercise5()">Submit Findings</button>
            <button class="btn btn-hint" onclick="showHint(5)">Show Hint</button>

            <div id="hint5" class="hint-box">
                <strong>Hint:</strong>
                <ul style="margin-left: 20px; margin-top: 10px;">
                    <li>Normal processes (svchost, wininit, csrss) accessing LSASS with 0x1000 is benign</li>
                    <li>PowerShell, rundll32, cmd.exe accessing LSASS is highly suspicious</li>
                    <li>Access rights 0x1410 or 0x1FFFFF allow reading memory (credential dumping)</li>
                    <li>Attackers use built-in Windows tools (LOLBins) to access LSASS</li>
                </ul>
            </div>

            <div id="feedback5"></div>
        </div>

        <!-- Exercise 6: Document Hunt and Create Detection -->
        <div class="exercise" id="exercise6">
            <h2>
                <span class="exercise-number">6</span>
                Document Hunt and Create Detection Rule
            </h2>

            <div class="scenario-box">
                <strong>Scenario:</strong>
                <p>You've completed a successful hunt finding malicious scheduled tasks. Now operationalize your findings by documenting the hunt and creating a detection rule.</p>
            </div>

            <h3>Hunt Documentation</h3>
            <div class="findings-box">
                <h4>Your Findings from Exercise 2:</h4>
                <div class="finding-item">
                    <strong>Finding 1: SystemHealthCheck Task</strong>
                    <p>Created by user 'jsmith' (not SYSTEM), uses encoded PowerShell (-enc), highly suspicious for persistence backdoor.</p>
                </div>
                <div class="finding-item">
                    <strong>Finding 2: WinDefenderUpdate Task</strong>
                    <p>Created by 'admin', executes from C:\Users\Public\ (unusual location), mimics legitimate Windows Defender naming (typosquatting).</p>
                </div>
            </div>

            <h3>Create Detection Rule</h3>
            <p>Write a SIEM detection query to alert on similar malicious scheduled tasks in the future.</p>

            <div class="task-list">
                <h4>Detection Criteria:</h4>
                <div class="task-item" onclick="completeTask(this, 6, 1)">
                    <div class="task-checkbox"></div>
                    <div>Alert on scheduled tasks NOT created by SYSTEM</div>
                </div>
                <div class="task-item" onclick="completeTask(this, 6, 2)">
                    <div class="task-checkbox"></div>
                    <div>Alert on PowerShell with -enc (encoded)</div>
                </div>
                <div class="task-item" onclick="completeTask(this, 6, 3)">
                    <div class="task-checkbox"></div>
                    <div>Alert on executables in C:\Users\Public\</div>
                </div>
                <div class="task-item" onclick="completeTask(this, 6, 4)">
                    <div class="task-checkbox"></div>
                    <div>Exclude known-good legitimate tasks</div>
                </div>
            </div>

            <h3>Select Detection Logic</h3>
            <p>Which detection rule would be most effective?</p>

            <select class="answer-input" id="ex6-rule" style="height: auto; padding: 15px;">
                <option value="">Select detection rule...</option>
                <option value="rule1">Alert on ANY scheduled task creation (too noisy)</option>
                <option value="rule2">Alert on scheduled task created by non-SYSTEM user AND (contains PowerShell -enc OR executable path contains Users\Public)</option>
                <option value="rule3">Alert only on scheduled tasks with specific malicious names</option>
                <option value="rule4">Alert on all PowerShell execution (too broad)</option>
            </select>

            <h3>Detection Severity</h3>
            <p>What severity should this detection have?</p>
            <select class="answer-input" id="ex6-severity">
                <option value="">Select severity...</option>
                <option value="low">Low</option>
                <option value="medium">Medium</option>
                <option value="high">High</option>
                <option value="critical">Critical</option>
            </select>

            <button class="btn" onclick="checkExercise6()">Submit Detection Rule</button>
            <button class="btn btn-hint" onclick="showHint(6)">Show Hint</button>

            <div id="hint6" class="hint-box">
                <strong>Hint:</strong>
                <ul style="margin-left: 20px; margin-top: 10px;">
                    <li>Good detection rules balance sensitivity and specificity</li>
                    <li>Too broad = too many false positives</li>
                    <li>Too narrow = misses variants of the attack</li>
                    <li>Non-SYSTEM creator + suspicious indicators is a good balance</li>
                    <li>Scheduled task persistence is a serious threat (High severity)</li>
                </ul>
            </div>

            <div id="feedback6"></div>
        </div>

        <!-- Complete Lab Button -->
        <button class="complete-lab-button" id="complete-button" onclick="completeLab()" disabled>
            Complete Threat Hunting Lab
        </button>
    </div>

    <script src="../../../components/AchievementManager.js"></script>
    <script src="../../../components/ModuleProgress.js"></script>
    <script>
        // Progress tracking
        const totalExercises = 6;
        let completedExercises = 0;
        const exerciseCompletion = {
            1: false, 2: false, 3: false, 4: false, 5: false, 6: false
        };

        function updateProgress() {
            const percentage = (completedExercises / totalExercises) * 100;
            const progressFill = document.getElementById('progress-fill');
            progressFill.style.width = percentage + '%';
            progressFill.textContent = Math.round(percentage) + '%';

            // Enable complete button when all exercises done
            if (completedExercises === totalExercises) {
                document.getElementById('complete-button').disabled = false;
            }
        }

        function completeExercise(exerciseNum) {
            if (!exerciseCompletion[exerciseNum]) {
                exerciseCompletion[exerciseNum] = true;
                completedExercises++;
                document.getElementById('exercise' + exerciseNum).classList.add('completed');
                updateProgress();
            }
        }

        function completeTask(element, exercise, task) {
            element.classList.add('completed');
        }

        function showHint(exerciseNum) {
            const hint = document.getElementById('hint' + exerciseNum);
            hint.classList.add('visible');
        }

        function showFeedback(exerciseNum, isCorrect, message) {
            const feedback = document.getElementById('feedback' + exerciseNum);
            feedback.className = isCorrect ? 'feedback correct' : 'feedback incorrect';
            feedback.innerHTML = '<strong>' + (isCorrect ? '✓ Correct!' : '✗ Not quite.') + '</strong><br>' + message;

            if (isCorrect) {
                setTimeout(() => completeExercise(exerciseNum), 1000);
            }
        }

        // Exercise validation functions
        function checkExercise1() {
            const ifPart = document.getElementById('ex1-if').value.toLowerCase();
            const thenPart = document.getElementById('ex1-then').value.toLowerCase();
            const wherePart = document.getElementById('ex1-where').value.toLowerCase();

            const hasIf = ifPart.includes('persistence') || ifPart.includes('scheduled') || ifPart.includes('task');
            const hasThen = (thenPart.includes('powershell') || thenPart.includes('scheduled') || thenPart.includes('task')) &&
                           (thenPart.includes('encoded') || thenPart.includes('base64') || thenPart.includes('enc'));
            const hasWhere = wherePart.includes('event') || wherePart.includes('4698') || wherePart.includes('sysmon');

            if (hasIf && hasThen && hasWhere) {
                showFeedback(1, true, 'Excellent hypothesis! You identified the key elements: scheduled task persistence, encoded PowerShell indicators, and appropriate data sources.');
            } else {
                let hints = [];
                if (!hasIf) hints.push('IF should mention persistence via scheduled tasks');
                if (!hasThen) hints.push('THEN should mention encoded PowerShell in scheduled tasks');
                if (!hasWhere) hints.push('WHERE should mention Windows Event 4698 or Sysmon logs');
                showFeedback(1, false, 'Review your hypothesis: ' + hints.join('. '));
            }
        }

        function checkExercise2() {
            const count = parseInt(document.getElementById('ex2-count').value);
            const names = document.getElementById('ex2-names').value.toLowerCase();

            const correctCount = count === 2;
            const hasSystemHealth = names.includes('systemhealthcheck');
            const hasWinDefender = names.includes('windefenderupdate');

            if (correctCount && hasSystemHealth && hasWinDefender) {
                showFeedback(2, true, 'Perfect stack counting! You identified both suspicious tasks: SystemHealthCheck (encoded PowerShell) and WinDefenderUpdate (unusual location). These are rare outliers with suspicious characteristics.');
            } else {
                showFeedback(2, false, 'Check again. Look for tasks that appear only once, created by users (not SYSTEM), with encoded PowerShell or unusual paths.');
            }
        }

        function checkExercise3() {
            const source = document.getElementById('ex3-source').value.toUpperCase();
            const targets = parseInt(document.getElementById('ex3-targets').value);
            const indicator = document.getElementById('ex3-indicator').value.toUpperCase();

            if (source === 'WS-005' && targets === 2 && indicator.includes('PSEXESVC')) {
                showFeedback(3, true, 'Excellent lateral movement detection! WS-005 used PsExec to move to WS-010 and WS-012. The PSEXESVC service is the key indicator. This shows systematic lateral movement from a compromised workstation.');
            } else {
                showFeedback(3, false, 'Look for the pattern: same source connecting to multiple targets with ADMIN$ followed by PSEXESVC service creation.');
            }
        }

        function checkExercise4() {
            const domain = document.getElementById('ex4-domain').value.toLowerCase();
            const interval = parseInt(document.getElementById('ex4-interval').value);
            const characteristic = document.getElementById('ex4-characteristic').value;

            if (domain.includes('data-analytics-cdn') && interval === 5 && characteristic === 'both') {
                showFeedback(4, true, 'Perfect beaconing analysis! data-analytics-cdn.com beacons every 5 minutes with exactly 512 bytes each time. This perfect periodicity and consistent size are hallmarks of C2 beaconing. Normal traffic is irregular.');
            } else {
                showFeedback(4, false, 'Calculate the time between connections to the same domain. Notice the perfectly regular interval and identical packet sizes.');
            }
        }

        function checkExercise5() {
            const count = parseInt(document.getElementById('ex5-count').value);
            const processes = document.getElementById('ex5-processes').value.toLowerCase();
            const reason = document.getElementById('ex5-reason').value;

            const hasPs = processes.includes('powershell');
            const hasRundll = processes.includes('rundll32');

            if (count === 2 && hasPs && hasRundll && reason === 'both') {
                showFeedback(5, true, 'Excellent credential access hunting! PowerShell and rundll32 accessing LSASS with memory-read permissions is highly indicative of credential dumping attempts (Mimikatz, custom dumpers). Normal system processes don\'t exhibit this behavior.');
            } else {
                showFeedback(5, false, 'Focus on non-system processes (PowerShell, rundll32) accessing LSASS with 0x1410 or 0x1FFFFF access rights. These allow memory reading for credential theft.');
            }
        }

        function checkExercise6() {
            const rule = document.getElementById('ex6-rule').value;
            const severity = document.getElementById('ex6-severity').value;

            if (rule === 'rule2' && severity === 'high') {
                showFeedback(6, true, 'Excellent detection engineering! Your rule balances specificity (non-SYSTEM creator + suspicious indicators) with breadth (catches both encoded PowerShell and unusual paths). High severity is appropriate for scheduled task persistence. This detection will catch variants while minimizing false positives.');
            } else {
                showFeedback(6, false, 'The best detection combines multiple suspicious factors (non-SYSTEM creator + encoded PowerShell OR unusual path). Scheduled task persistence warrants High severity.');
            }
        }

        function completeLab() {
            ModuleProgress.complete('eye', 'eye-hunting-lab', {
                silent: false,
                returnToDashboard: true
            });
        }

        // Initialize
        updateProgress();
    </script>
</body>
</html>
