<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rare Firefly Test</title>
    <style>
        body {
            background: #0a0a0a;
            color: #0f0;
            font-family: monospace;
            padding: 20px;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            font-size: 16px;
            cursor: pointer;
        }
        #log {
            background: #111;
            border: 1px solid #333;
            padding: 10px;
            margin-top: 20px;
            height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .error { color: #f00; }
        .success { color: #0f0; }
        .info { color: #0af; }
    </style>
</head>
<body>
    <h1>Rare Firefly Debug Test</h1>

    <div>
        <button onclick="testLoad()">1. Test Script Loading</button>
        <button onclick="testInit()">2. Initialize System</button>
        <button onclick="testSpawnGolden()">3. Spawn Golden</button>
        <button onclick="testSpawnDiamond()">4. Spawn Diamond</button>
        <button onclick="testSpawnGlitch()">5. Spawn Glitch</button>
        <button onclick="testSpawnAncient()">6. Spawn Ancient</button>
    </div>

    <div id="log"></div>

    <!-- Load scripts one by one to see which fails -->
    <script>
        function log(msg, type = '') {
            const logDiv = document.getElementById('log');
            const line = document.createElement('div');
            line.className = type;
            line.textContent = new Date().toLocaleTimeString() + ' - ' + msg;
            logDiv.appendChild(line);
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(msg);
        }

        log('Page loaded, ready for tests', 'info');
    </script>

    <!-- Core -->
    <script src="digital-life/core/Firefly.js" onerror="log('FAILED to load Firefly.js', 'error')"></script>
    <script>if(typeof Firefly !== 'undefined') log('Firefly.js loaded OK', 'success'); else log('Firefly class undefined', 'error');</script>

    <script src="digital-life/core/Ecosystem.js" onerror="log('FAILED to load Ecosystem.js', 'error')"></script>
    <script>if(typeof Ecosystem !== 'undefined') log('Ecosystem.js loaded OK', 'success'); else log('Ecosystem class undefined', 'error');</script>

    <!-- Effects -->
    <script src="digital-life/effects/Particles.js" onerror="log('FAILED to load Particles.js', 'error')"></script>
    <script>if(typeof ParticleSystem !== 'undefined') log('Particles.js loaded OK', 'success'); else log('ParticleSystem class undefined', 'error');</script>

    <!-- Behaviors - just RareFireflies for this test -->
    <script src="digital-life/behaviors/RareFireflies.js" onerror="log('FAILED to load RareFireflies.js', 'error')"></script>
    <script>if(typeof RareFireflySystem !== 'undefined') log('RareFireflies.js loaded OK', 'success'); else log('RareFireflySystem class undefined', 'error');</script>

    <script>
        let ecosystem = null;
        let particleSystem = null;
        let rareSystem = null;
        let container = null;

        function testLoad() {
            log('=== Testing Script Loading ===', 'info');
            log('Firefly: ' + (typeof Firefly !== 'undefined' ? 'OK' : 'MISSING'), typeof Firefly !== 'undefined' ? 'success' : 'error');
            log('Ecosystem: ' + (typeof Ecosystem !== 'undefined' ? 'OK' : 'MISSING'), typeof Ecosystem !== 'undefined' ? 'success' : 'error');
            log('ParticleSystem: ' + (typeof ParticleSystem !== 'undefined' ? 'OK' : 'MISSING'), typeof ParticleSystem !== 'undefined' ? 'success' : 'error');
            log('RareFireflySystem: ' + (typeof RareFireflySystem !== 'undefined' ? 'OK' : 'MISSING'), typeof RareFireflySystem !== 'undefined' ? 'success' : 'error');
        }

        function testInit() {
            log('=== Initializing Systems ===', 'info');

            try {
                // Create container
                container = document.createElement('div');
                container.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:1;';
                document.body.appendChild(container);
                log('Container created', 'success');

                // Particle system
                particleSystem = new ParticleSystem(container);
                particleSystem.init();
                log('ParticleSystem initialized', 'success');

                // Ecosystem
                ecosystem = new Ecosystem({
                    initialPopulation: 10,
                    minPopulation: 5,
                    maxPopulation: 30
                });
                ecosystem.setParticleSystem(particleSystem);
                ecosystem.init(container);
                log('Ecosystem initialized with ' + ecosystem.fireflies.length + ' fireflies', 'success');

                // Rare system
                rareSystem = new RareFireflySystem({ enabled: true });
                rareSystem.setEcosystem(ecosystem);
                rareSystem.setParticleSystem(particleSystem);
                log('RareFireflySystem initialized', 'success');

                // Inject basic styles
                const style = document.createElement('style');
                style.textContent = '.firefly { position: absolute; font-weight: bold; pointer-events: none; }';
                document.head.appendChild(style);

            } catch (e) {
                log('ERROR: ' + e.message, 'error');
                console.error(e);
            }
        }

        function spawnRare(type) {
            if (!rareSystem) {
                log('ERROR: Run step 2 first to initialize', 'error');
                return;
            }

            log('Attempting to spawn ' + type + ' rare...', 'info');

            try {
                const firefly = rareSystem.forceSpawnRare(type);
                if (firefly) {
                    log('SUCCESS! Spawned ' + type + ': ' + firefly.id, 'success');
                    log('  Symbol: ' + firefly.rareSymbol, 'success');
                    log('  Color: ' + firefly.rareColor, 'success');
                    log('  Position: ' + Math.round(firefly.x) + ', ' + Math.round(firefly.y), 'success');
                } else {
                    log('FAILED: forceSpawnRare returned null', 'error');
                }
            } catch (e) {
                log('ERROR: ' + e.message, 'error');
                console.error(e);
            }
        }

        function testSpawnGolden() { spawnRare('golden'); }
        function testSpawnDiamond() { spawnRare('diamond'); }
        function testSpawnGlitch() { spawnRare('glitch'); }
        function testSpawnAncient() { spawnRare('ancient'); }
    </script>
</body>
</html>
