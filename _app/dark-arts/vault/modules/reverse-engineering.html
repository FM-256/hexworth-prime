<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reverse Engineering Basics - Dark Arts Vault</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Courier New', monospace;
            background: linear-gradient(135deg, #1a0a2e 0%, #0f0520 100%);
            color: #c9b8d9;
            line-height: 1.6;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        /* Header Styles */
        .header {
            text-align: center;
            padding: 40px 0;
            border-bottom: 2px solid #9a7aaa;
            margin-bottom: 40px;
            position: relative;
        }

        .back-button {
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(154, 122, 170, 0.2);
            color: #c9b8d9;
            padding: 10px 20px;
            border: 1px solid #9a7aaa;
            border-radius: 5px;
            cursor: pointer;
            text-decoration: none;
            transition: all 0.3s ease;
        }

        .back-button:hover {
            background: rgba(154, 122, 170, 0.4);
            box-shadow: 0 0 15px rgba(154, 122, 170, 0.5);
        }

        h1 {
            color: #9a7aaa;
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 0 0 20px rgba(154, 122, 170, 0.6);
        }

        .tier-badge {
            display: inline-block;
            background: rgba(154, 122, 170, 0.3);
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            border: 1px solid #9a7aaa;
        }

        /* Section Styles */
        .section {
            background: rgba(154, 122, 170, 0.1);
            border: 1px solid #9a7aaa;
            border-radius: 10px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
        }

        .section:hover {
            box-shadow: 0 5px 30px rgba(154, 122, 170, 0.3);
        }

        h2 {
            color: #9a7aaa;
            font-size: 1.8em;
            margin-bottom: 20px;
            text-shadow: 0 0 10px rgba(154, 122, 170, 0.4);
        }

        h3 {
            color: #c9b8d9;
            font-size: 1.3em;
            margin-top: 20px;
            margin-bottom: 10px;
        }

        p {
            margin-bottom: 15px;
            color: #c9b8d9;
        }

        /* Interactive Elements */
        .interactive-box {
            background: rgba(26, 10, 46, 0.6);
            border: 2px solid #9a7aaa;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }

        .interactive-title {
            color: #9a7aaa;
            font-size: 1.2em;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .interactive-title::before {
            content: "⚡";
            font-size: 1.2em;
        }

        /* Code Block Styles */
        .code-block {
            background: #0f0520;
            border: 1px solid #9a7aaa;
            border-radius: 5px;
            padding: 15px;
            margin: 15px 0;
            overflow-x: auto;
            font-family: 'Courier New', monospace;
            color: #9a7aaa;
        }

        .code-comment {
            color: #6a5a7a;
        }

        /* Register Visualization */
        .register-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .register-card {
            background: rgba(154, 122, 170, 0.2);
            border: 1px solid #9a7aaa;
            border-radius: 5px;
            padding: 15px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .register-card:hover {
            background: rgba(154, 122, 170, 0.3);
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(154, 122, 170, 0.3);
        }

        .register-name {
            color: #9a7aaa;
            font-weight: bold;
            font-size: 1.1em;
            margin-bottom: 5px;
        }

        .register-desc {
            color: #c9b8d9;
            font-size: 0.85em;
        }

        /* Instruction Table */
        .instruction-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }

        .instruction-table th {
            background: rgba(154, 122, 170, 0.3);
            color: #9a7aaa;
            padding: 12px;
            text-align: left;
            border: 1px solid #9a7aaa;
        }

        .instruction-table td {
            background: rgba(26, 10, 46, 0.4);
            color: #c9b8d9;
            padding: 10px;
            border: 1px solid #9a7aaa;
        }

        .instruction-table tr:hover td {
            background: rgba(154, 122, 170, 0.2);
        }

        /* Button Styles */
        .btn {
            background: rgba(154, 122, 170, 0.3);
            color: #c9b8d9;
            padding: 12px 24px;
            border: 1px solid #9a7aaa;
            border-radius: 5px;
            cursor: pointer;
            font-family: 'Courier New', monospace;
            font-size: 1em;
            transition: all 0.3s ease;
            margin: 5px;
        }

        .btn:hover {
            background: rgba(154, 122, 170, 0.5);
            box-shadow: 0 0 15px rgba(154, 122, 170, 0.5);
            transform: translateY(-2px);
        }

        .btn:active {
            transform: translateY(0);
        }

        /* Quiz/Challenge Styles */
        .challenge-option {
            background: rgba(154, 122, 170, 0.2);
            border: 2px solid #9a7aaa;
            border-radius: 5px;
            padding: 15px;
            margin: 10px 0;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .challenge-option:hover {
            background: rgba(154, 122, 170, 0.3);
            transform: translateX(10px);
        }

        .challenge-option.correct {
            border-color: #4ade80;
            background: rgba(74, 222, 128, 0.2);
        }

        .challenge-option.incorrect {
            border-color: #f87171;
            background: rgba(248, 113, 113, 0.2);
        }

        /* Tool Comparison Grid */
        .tool-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .tool-card {
            background: rgba(26, 10, 46, 0.6);
            border: 1px solid #9a7aaa;
            border-radius: 8px;
            padding: 20px;
            transition: all 0.3s ease;
        }

        .tool-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(154, 122, 170, 0.3);
            border-color: #c9b8d9;
        }

        .tool-name {
            color: #9a7aaa;
            font-size: 1.3em;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .tool-feature {
            color: #c9b8d9;
            padding: 5px 0;
            font-size: 0.9em;
        }

        .tool-feature::before {
            content: "▸ ";
            color: #9a7aaa;
        }

        /* Control Flow Diagram */
        .flow-canvas {
            background: #0f0520;
            border: 2px solid #9a7aaa;
            border-radius: 8px;
            width: 100%;
            height: 400px;
            cursor: crosshair;
        }

        .flow-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        /* Progress Indicator */
        .progress-bar {
            background: rgba(26, 10, 46, 0.6);
            border: 1px solid #9a7aaa;
            border-radius: 20px;
            height: 30px;
            margin: 20px 0;
            overflow: hidden;
            position: relative;
        }

        .progress-fill {
            background: linear-gradient(90deg, #9a7aaa, #c9b8d9);
            height: 100%;
            width: 0%;
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #1a0a2e;
            font-weight: bold;
            font-size: 0.9em;
        }

        /* Modal/Popup Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: #1a0a2e;
            border: 2px solid #9a7aaa;
            border-radius: 10px;
            padding: 30px;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 50px rgba(154, 122, 170, 0.5);
        }

        .modal-close {
            float: right;
            font-size: 1.5em;
            color: #9a7aaa;
            cursor: pointer;
            transition: color 0.3s ease;
        }

        .modal-close:hover {
            color: #c9b8d9;
        }

        /* Draggable Elements */
        .draggable {
            cursor: move;
            user-select: none;
        }

        .drop-zone {
            min-height: 50px;
            border: 2px dashed #9a7aaa;
            border-radius: 5px;
            padding: 10px;
            margin: 10px 0;
            transition: all 0.3s ease;
        }

        .drop-zone.drag-over {
            background: rgba(154, 122, 170, 0.3);
            border-color: #c9b8d9;
        }

        /* Warning/Info Boxes */
        .warning-box {
            background: rgba(248, 113, 113, 0.1);
            border-left: 4px solid #f87171;
            padding: 15px;
            margin: 15px 0;
            border-radius: 5px;
        }

        .info-box {
            background: rgba(96, 165, 250, 0.1);
            border-left: 4px solid #60a5fa;
            padding: 15px;
            margin: 15px 0;
            border-radius: 5px;
        }

        .success-box {
            background: rgba(74, 222, 128, 0.1);
            border-left: 4px solid #4ade80;
            padding: 15px;
            margin: 15px 0;
            border-radius: 5px;
        }

        /* List Styles */
        ul {
            margin: 15px 0 15px 30px;
        }

        li {
            margin: 8px 0;
            color: #c9b8d9;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            h1 {
                font-size: 1.8em;
            }

            .back-button {
                position: static;
                transform: none;
                display: block;
                margin-bottom: 20px;
                text-align: center;
            }

            .header {
                padding: 20px 0;
            }

            .section {
                padding: 20px;
            }

            .register-grid {
                grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            }
        }

        /* Animation */
        @keyframes glow {
            0%, 100% {
                box-shadow: 0 0 10px rgba(154, 122, 170, 0.3);
            }
            50% {
                box-shadow: 0 0 20px rgba(154, 122, 170, 0.6);
            }
        }

        .glow-animation {
            animation: glow 2s ease-in-out infinite;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <a href="../index.html" class="back-button">← Back to Vault</a>
            <h1>Reverse Engineering Basics</h1>
            <div class="tier-badge">TIER 2 - REQUIRES GATE 6</div>
        </div>

        <!-- Progress Indicator -->
        <div class="progress-bar">
            <div class="progress-fill" id="progressFill">0%</div>
        </div>

        <!-- Section 1: What is Reverse Engineering? -->
        <div class="section" data-section="1">
            <h2>1. What is Reverse Engineering?</h2>

            <p>
                Reverse engineering is the process of analyzing a system, software, or device to understand its
                internal workings, design, and functionality without access to its source code or documentation.
                In cybersecurity and malware analysis, it's an essential skill for understanding how malicious
                software operates.
            </p>

            <h3>Forward vs Reverse Engineering</h3>
            <div class="code-block">
                FORWARD ENGINEERING:
                Design → Source Code → Binary → Execution
                (You control the entire process)

                REVERSE ENGINEERING:
                Binary → Analysis → Understanding → Recreation
                (You work backwards from the result)
            </div>

            <h3>Applications in Malware Analysis</h3>
            <ul>
                <li><strong>Threat Intelligence:</strong> Understanding attack vectors and techniques</li>
                <li><strong>Vulnerability Research:</strong> Discovering exploitable flaws</li>
                <li><strong>Incident Response:</strong> Analyzing suspicious files and binaries</li>
                <li><strong>Detection Engineering:</strong> Creating signatures and behavioral rules</li>
                <li><strong>Attribution:</strong> Identifying malware families and threat actors</li>
            </ul>

            <div class="warning-box">
                <strong>⚠ Legal Considerations:</strong> Reverse engineering may be restricted by law in some
                jurisdictions (DMCA, CFAA in the US). Always ensure you have proper authorization and are working
                in a controlled environment. Only analyze malware in isolated lab environments.
            </div>

            <div class="info-box">
                <strong>Ethics Note:</strong> Reverse engineering skills are powerful. Use them responsibly
                for defensive security, research, and education - never for unauthorized access or malicious purposes.
            </div>
        </div>

        <!-- Section 2: Assembly Language Fundamentals -->
        <div class="section" data-section="2">
            <h2>2. Assembly Language Fundamentals</h2>

            <p>
                Assembly language is a low-level programming language that provides a human-readable representation
                of machine code. Understanding assembly is crucial for reverse engineering because compiled programs
                are ultimately executed as machine instructions.
            </p>

            <h3>x86/x64 Registers</h3>
            <p>Registers are small, fast storage locations inside the CPU. Click on each register to learn more:</p>

            <div class="register-grid">
                <div class="register-card" onclick="showRegisterInfo('rax')">
                    <div class="register-name">RAX/EAX</div>
                    <div class="register-desc">Accumulator</div>
                </div>
                <div class="register-card" onclick="showRegisterInfo('rbx')">
                    <div class="register-name">RBX/EBX</div>
                    <div class="register-desc">Base</div>
                </div>
                <div class="register-card" onclick="showRegisterInfo('rcx')">
                    <div class="register-name">RCX/ECX</div>
                    <div class="register-desc">Counter</div>
                </div>
                <div class="register-card" onclick="showRegisterInfo('rdx')">
                    <div class="register-name">RDX/EDX</div>
                    <div class="register-desc">Data</div>
                </div>
                <div class="register-card" onclick="showRegisterInfo('rsi')">
                    <div class="register-name">RSI/ESI</div>
                    <div class="register-desc">Source Index</div>
                </div>
                <div class="register-card" onclick="showRegisterInfo('rdi')">
                    <div class="register-name">RDI/EDI</div>
                    <div class="register-desc">Destination Index</div>
                </div>
                <div class="register-card" onclick="showRegisterInfo('rbp')">
                    <div class="register-name">RBP/EBP</div>
                    <div class="register-desc">Base Pointer</div>
                </div>
                <div class="register-card" onclick="showRegisterInfo('rsp')">
                    <div class="register-name">RSP/ESP</div>
                    <div class="register-desc">Stack Pointer</div>
                </div>
                <div class="register-card" onclick="showRegisterInfo('rip')">
                    <div class="register-name">RIP/EIP</div>
                    <div class="register-desc">Instruction Pointer</div>
                </div>
            </div>

            <h3>Common Instructions</h3>
            <table class="instruction-table">
                <thead>
                    <tr>
                        <th>Instruction</th>
                        <th>Syntax</th>
                        <th>Description</th>
                        <th>Example</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><strong>MOV</strong></td>
                        <td>MOV dest, src</td>
                        <td>Copy data from source to destination</td>
                        <td>MOV rax, 5</td>
                    </tr>
                    <tr>
                        <td><strong>PUSH</strong></td>
                        <td>PUSH value</td>
                        <td>Push value onto the stack</td>
                        <td>PUSH rbx</td>
                    </tr>
                    <tr>
                        <td><strong>POP</strong></td>
                        <td>POP dest</td>
                        <td>Pop value from stack to destination</td>
                        <td>POP rcx</td>
                    </tr>
                    <tr>
                        <td><strong>CALL</strong></td>
                        <td>CALL address</td>
                        <td>Call a function at address</td>
                        <td>CALL 0x401000</td>
                    </tr>
                    <tr>
                        <td><strong>RET</strong></td>
                        <td>RET</td>
                        <td>Return from function</td>
                        <td>RET</td>
                    </tr>
                    <tr>
                        <td><strong>JMP</strong></td>
                        <td>JMP address</td>
                        <td>Unconditional jump to address</td>
                        <td>JMP 0x401020</td>
                    </tr>
                    <tr>
                        <td><strong>JE/JZ</strong></td>
                        <td>JE address</td>
                        <td>Jump if equal (or zero)</td>
                        <td>JE 0x401030</td>
                    </tr>
                    <tr>
                        <td><strong>JNE/JNZ</strong></td>
                        <td>JNE address</td>
                        <td>Jump if not equal (or not zero)</td>
                        <td>JNE 0x401040</td>
                    </tr>
                    <tr>
                        <td><strong>CMP</strong></td>
                        <td>CMP op1, op2</td>
                        <td>Compare two operands (sets flags)</td>
                        <td>CMP rax, 10</td>
                    </tr>
                    <tr>
                        <td><strong>TEST</strong></td>
                        <td>TEST op1, op2</td>
                        <td>Bitwise AND (sets flags, doesn't store)</td>
                        <td>TEST rax, rax</td>
                    </tr>
                    <tr>
                        <td><strong>ADD</strong></td>
                        <td>ADD dest, src</td>
                        <td>Add source to destination</td>
                        <td>ADD rax, 5</td>
                    </tr>
                    <tr>
                        <td><strong>SUB</strong></td>
                        <td>SUB dest, src</td>
                        <td>Subtract source from destination</td>
                        <td>SUB rax, 3</td>
                    </tr>
                    <tr>
                        <td><strong>XOR</strong></td>
                        <td>XOR dest, src</td>
                        <td>Exclusive OR operation</td>
                        <td>XOR rax, rax</td>
                    </tr>
                    <tr>
                        <td><strong>LEA</strong></td>
                        <td>LEA dest, [address]</td>
                        <td>Load effective address</td>
                        <td>LEA rax, [rbp-8]</td>
                    </tr>
                </tbody>
            </table>

            <h3>Calling Conventions</h3>
            <div class="code-block">
                <span class="code-comment">; Windows x64 Calling Convention (Microsoft ABI)</span>
                - First 4 integer args: RCX, RDX, R8, R9
                - Floating point args: XMM0, XMM1, XMM2, XMM3
                - Additional args: pushed on stack (right to left)
                - Return value: RAX (or XMM0 for floating point)
                - Caller must allocate 32 bytes of shadow space

                <span class="code-comment">; Linux x64 Calling Convention (System V ABI)</span>
                - First 6 integer args: RDI, RSI, RDX, RCX, R8, R9
                - Floating point args: XMM0-XMM7
                - Additional args: pushed on stack (right to left)
                - Return value: RAX (or XMM0 for floating point)
            </div>

            <div class="interactive-box">
                <div class="interactive-title">Interactive: Assembly Instruction Matcher</div>
                <p>Match the assembly instruction to its purpose:</p>
                <div id="asmMatcherGame"></div>
                <button class="btn" onclick="checkAsmMatcher()">Check Answers</button>
                <button class="btn" onclick="resetAsmMatcher()">Reset</button>
            </div>
        </div>

        <!-- Section 3: Disassemblers and Debuggers -->
        <div class="section" data-section="3">
            <h2>3. Disassemblers and Debuggers</h2>

            <p>
                Tools are essential for reverse engineering. Disassemblers convert machine code back into
                assembly language, while debuggers allow you to execute and inspect programs step-by-step.
            </p>

            <h3>Tool Comparison Chart</h3>
            <div class="tool-grid">
                <div class="tool-card">
                    <div class="tool-name">IDA Pro</div>
                    <div class="tool-feature">Industry standard disassembler</div>
                    <div class="tool-feature">Excellent decompiler (Hex-Rays)</div>
                    <div class="tool-feature">Cross-platform support</div>
                    <div class="tool-feature">Extensive plugin ecosystem</div>
                    <div class="tool-feature">Commercial (expensive)</div>
                </div>

                <div class="tool-card">
                    <div class="tool-name">Ghidra</div>
                    <div class="tool-feature">Free and open source (NSA)</div>
                    <div class="tool-feature">Built-in decompiler</div>
                    <div class="tool-feature">Multi-architecture support</div>
                    <div class="tool-feature">Collaborative features</div>
                    <div class="tool-feature">Java-based (requires JRE)</div>
                </div>

                <div class="tool-card">
                    <div class="tool-name">x64dbg</div>
                    <div class="tool-feature">Modern Windows debugger</div>
                    <div class="tool-feature">User-friendly interface</div>
                    <div class="tool-feature">Active development</div>
                    <div class="tool-feature">Plugin support</div>
                    <div class="tool-feature">Free and open source</div>
                </div>

                <div class="tool-card">
                    <div class="tool-name">OllyDbg</div>
                    <div class="tool-feature">Classic Windows debugger</div>
                    <div class="tool-feature">Simple interface</div>
                    <div class="tool-feature">Good for malware analysis</div>
                    <div class="tool-feature">32-bit focused</div>
                    <div class="tool-feature">Development ceased</div>
                </div>

                <div class="tool-card">
                    <div class="tool-name">GDB</div>
                    <div class="tool-feature">GNU debugger for Linux</div>
                    <div class="tool-feature">Command-line based</div>
                    <div class="tool-feature">Powerful scripting</div>
                    <div class="tool-feature">GEF/PEDA extensions</div>
                    <div class="tool-feature">Free and open source</div>
                </div>

                <div class="tool-card">
                    <div class="tool-name">Binary Ninja</div>
                    <div class="tool-feature">Modern disassembler</div>
                    <div class="tool-feature">Fast and responsive UI</div>
                    <div class="tool-feature">Built-in IL (intermediate language)</div>
                    <div class="tool-feature">Python API</div>
                    <div class="tool-feature">Commercial (affordable)</div>
                </div>
            </div>

            <h3>Typical Workflow</h3>
            <div class="code-block">
                1. Static Analysis (Disassembler)
                   ↓
                   - Load binary into IDA/Ghidra
                   - Analyze strings and imports
                   - Identify interesting functions
                   - Study control flow graphs
                   - Use decompiler for high-level view

                2. Dynamic Analysis (Debugger)
                   ↓
                   - Load binary in x64dbg/GDB
                   - Set breakpoints at key locations
                   - Step through execution
                   - Inspect memory and registers
                   - Monitor API calls and behavior

                3. Iterate between static and dynamic analysis
            </div>

            <div class="info-box">
                <strong>Pro Tip:</strong> Start with static analysis to understand the overall structure,
                then use dynamic analysis to verify your hypotheses and understand runtime behavior.
                The combination of both approaches is more powerful than either alone.
            </div>
        </div>

        <!-- Section 4: Understanding Control Flow -->
        <div class="section" data-section="4">
            <h2>4. Understanding Control Flow</h2>

            <p>
                Control flow refers to the order in which individual instructions are executed. Understanding
                how high-level constructs (if/else, loops) translate to assembly is crucial for reverse engineering.
            </p>

            <h3>If/Else Statements in Assembly</h3>
            <div class="code-block">
                <span class="code-comment">; C Code:</span>
                if (x == 5) {
                    y = 10;
                } else {
                    y = 20;
                }

                <span class="code-comment">; Assembly equivalent:</span>
                CMP    eax, 5          <span class="code-comment">; Compare x with 5</span>
                JNE    else_block      <span class="code-comment">; Jump if not equal</span>
                MOV    ebx, 10         <span class="code-comment">; y = 10 (if block)</span>
                JMP    end_if          <span class="code-comment">; Skip else block</span>
            else_block:
                MOV    ebx, 20         <span class="code-comment">; y = 20 (else block)</span>
            end_if:
                <span class="code-comment">; Continue execution</span>
            </div>

            <h3>Loop Recognition</h3>
            <div class="code-block">
                <span class="code-comment">; C Code: for (i = 0; i < 10; i++)</span>
                XOR    ecx, ecx        <span class="code-comment">; i = 0 (ECX is loop counter)</span>
            loop_start:
                CMP    ecx, 10         <span class="code-comment">; Compare i with 10</span>
                JGE    loop_end        <span class="code-comment">; Jump if greater or equal</span>

                <span class="code-comment">; Loop body here</span>

                INC    ecx             <span class="code-comment">; i++</span>
                JMP    loop_start      <span class="code-comment">; Jump back to start</span>
            loop_end:
                <span class="code-comment">; Continue after loop</span>


                <span class="code-comment">; C Code: while (x > 0)</span>
            while_start:
                CMP    eax, 0          <span class="code-comment">; Compare x with 0</span>
                JLE    while_end       <span class="code-comment">; Jump if less or equal</span>

                <span class="code-comment">; Loop body here</span>

                JMP    while_start     <span class="code-comment">; Jump back to condition</span>
            while_end:
            </div>

            <h3>Function Calls and Returns</h3>
            <div class="code-block">
                <span class="code-comment">; Calling a function</span>
                PUSH   rbp             <span class="code-comment">; Save base pointer</span>
                MOV    rbp, rsp        <span class="code-comment">; Set up new stack frame</span>
                SUB    rsp, 32         <span class="code-comment">; Allocate stack space</span>

                <span class="code-comment">; Function body</span>

                MOV    rsp, rbp        <span class="code-comment">; Restore stack pointer</span>
                POP    rbp             <span class="code-comment">; Restore base pointer</span>
                RET                    <span class="code-comment">; Return to caller</span>
            </div>

            <div class="interactive-box">
                <div class="interactive-title">Interactive: Control Flow Graph Builder</div>
                <p>Create a control flow diagram by clicking to add nodes and connecting them:</p>
                <div class="flow-controls">
                    <button class="btn" onclick="cfgAddNode('start')">Add Start Node</button>
                    <button class="btn" onclick="cfgAddNode('condition')">Add Condition</button>
                    <button class="btn" onclick="cfgAddNode('action')">Add Action</button>
                    <button class="btn" onclick="cfgAddNode('end')">Add End Node</button>
                    <button class="btn" onclick="cfgClear()">Clear Canvas</button>
                </div>
                <canvas id="flowCanvas" class="flow-canvas"></canvas>
            </div>
        </div>

        <!-- Section 5: Recognizing C Constructs -->
        <div class="section" data-section="5">
            <h2>5. Recognizing C Constructs in Assembly</h2>

            <p>
                When reverse engineering, you'll often need to recognize how high-level C constructs
                appear in assembly code. This skill helps you understand the program's logic faster.
            </p>

            <h3>Variables and Data Types</h3>
            <div class="code-block">
                <span class="code-comment">; int x = 5;</span>
                MOV    DWORD PTR [rbp-4], 5

                <span class="code-comment">; char c = 'A';</span>
                MOV    BYTE PTR [rbp-5], 41h  <span class="code-comment">; 0x41 = 'A'</span>

                <span class="code-comment">; long long value = 1000000;</span>
                MOV    QWORD PTR [rbp-16], 0F4240h

                <span class="code-comment">; float f = 3.14;</span>
                MOVSS  xmm0, DWORD PTR [.float_constant]
                MOVSS  DWORD PTR [rbp-20], xmm0
            </div>

            <h3>Structures and Arrays</h3>
            <div class="code-block">
                <span class="code-comment">; struct Person { int age; char name[20]; };</span>
                <span class="code-comment">; person.age = 25;</span>
                LEA    rax, [rbp-32]       <span class="code-comment">; Load address of struct</span>
                MOV    DWORD PTR [rax], 25 <span class="code-comment">; Set age field (offset 0)</span>

                <span class="code-comment">; strcpy(person.name, "John");</span>
                LEA    rax, [rbp-32]       <span class="code-comment">; Load struct address</span>
                ADD    rax, 4              <span class="code-comment">; Offset to name field</span>
                LEA    rdx, [.string]      <span class="code-comment">; Source string</span>
                CALL   strcpy


                <span class="code-comment">; int arr[5]; arr[2] = 10;</span>
                LEA    rax, [rbp-40]       <span class="code-comment">; Load array base address</span>
                MOV    DWORD PTR [rax+8], 10 <span class="code-comment">; arr + (2 * 4 bytes)</span>
            </div>

            <h3>String Operations</h3>
            <div class="code-block">
                <span class="code-comment">; strlen(str) - count characters until null terminator</span>
                MOV    rdi, str_ptr       <span class="code-comment">; String address in RDI</span>
                XOR    rcx, rcx           <span class="code-comment">; Counter = 0</span>
            strlen_loop:
                CMP    BYTE PTR [rdi+rcx], 0
                JE     strlen_done
                INC    rcx
                JMP    strlen_loop
            strlen_done:
                <span class="code-comment">; Length now in RCX</span>


                <span class="code-comment">; strcmp(str1, str2) - compare strings</span>
                MOV    rsi, str1_ptr
                MOV    rdi, str2_ptr
            strcmp_loop:
                MOVZX  rax, BYTE PTR [rsi]
                MOVZX  rdx, BYTE PTR [rdi]
                CMP    rax, rdx
                JNE    strcmp_done
                TEST   rax, rax
                JE     strcmp_done
                INC    rsi
                INC    rdi
                JMP    strcmp_loop
            strcmp_done:
                SUB    rax, rdx          <span class="code-comment">; Return difference</span>
            </div>

            <h3>Pointer Dereferencing</h3>
            <div class="code-block">
                <span class="code-comment">; int *ptr = &x;</span>
                LEA    rax, [rbp-4]       <span class="code-comment">; Get address of x</span>
                MOV    QWORD PTR [rbp-16], rax <span class="code-comment">; Store in ptr</span>

                <span class="code-comment">; *ptr = 10;</span>
                MOV    rax, QWORD PTR [rbp-16]  <span class="code-comment">; Load pointer value</span>
                MOV    DWORD PTR [rax], 10      <span class="code-comment">; Dereference and assign</span>

                <span class="code-comment">; y = *ptr;</span>
                MOV    rax, QWORD PTR [rbp-16]  <span class="code-comment">; Load pointer</span>
                MOV    edx, DWORD PTR [rax]     <span class="code-comment">; Dereference</span>
                MOV    DWORD PTR [rbp-8], edx   <span class="code-comment">; Store in y</span>
            </div>

            <div class="interactive-box">
                <div class="interactive-title">Interactive: Match the C to Assembly</div>
                <p>Drag the C code snippets to their corresponding assembly implementations:</p>
                <div id="cToAsmGame"></div>
                <button class="btn" onclick="checkCToAsm()">Check Answers</button>
                <button class="btn" onclick="resetCToAsm()">Reset</button>
            </div>
        </div>

        <!-- Section 6: Anti-Analysis Techniques -->
        <div class="section" data-section="6">
            <h2>6. Anti-Analysis Techniques</h2>

            <p>
                Malware authors employ various techniques to make analysis difficult. Understanding these
                methods helps you recognize and defeat them during reverse engineering.
            </p>

            <h3>Anti-Debugging Tricks</h3>
            <div class="code-block">
                <span class="code-comment">; Technique 1: IsDebuggerPresent API</span>
                CALL   IsDebuggerPresent
                TEST   eax, eax
                JNE    debugger_detected  <span class="code-comment">; Jump if debugger present</span>


                <span class="code-comment">; Technique 2: PEB (Process Environment Block) check</span>
                MOV    rax, QWORD PTR gs:[60h]  <span class="code-comment">; Get PEB address</span>
                CMP    BYTE PTR [rax+2], 0      <span class="code-comment">; Check BeingDebugged flag</span>
                JNE    debugger_detected


                <span class="code-comment">; Technique 3: Timing check</span>
                RDTSC                      <span class="code-comment">; Read timestamp counter</span>
                MOV    r8, rax             <span class="code-comment">; Save timestamp</span>

                <span class="code-comment">; Some instructions here</span>

                RDTSC                      <span class="code-comment">; Read again</span>
                SUB    rax, r8             <span class="code-comment">; Calculate difference</span>
                CMP    rax, 1000           <span class="code-comment">; Too slow = debugger?</span>
                JA     debugger_detected


                <span class="code-comment">; Technique 4: Exception-based detection</span>
                INT    3                   <span class="code-comment">; Software breakpoint</span>
                <span class="code-comment">; If we reach here, exception was handled by debugger</span>
            </div>

            <h3>Packing and Obfuscation</h3>
            <div class="code-block">
                <span class="code-comment">; UPX-style unpacking stub pattern:</span>
                PUSH   esi
                PUSH   edi
                MOV    esi, packed_data    <span class="code-comment">; Source</span>
                MOV    edi, unpack_dest    <span class="code-comment">; Destination</span>
                MOV    ecx, packed_size    <span class="code-comment">; Size</span>
                CALL   decompress_routine
                JMP    original_entry      <span class="code-comment">; Jump to unpacked code</span>


                <span class="code-comment">; Code obfuscation examples:</span>
                <span class="code-comment">; Instead of: MOV eax, 5</span>
                XOR    eax, eax           <span class="code-comment">; eax = 0</span>
                ADD    eax, 3             <span class="code-comment">; eax = 3</span>
                ADD    eax, 2             <span class="code-comment">; eax = 5 (obfuscated)</span>

                <span class="code-comment">; Junk instructions (never executed):</span>
                JMP    skip_junk
                DB     0E8h, 12h, 34h, 56h <span class="code-comment">; Random bytes</span>
            skip_junk:
                <span class="code-comment">; Real code continues</span>
            </div>

            <h3>VM Detection</h3>
            <div class="code-block">
                <span class="code-comment">; Check for VMware via I/O port</span>
                MOV    eax, 564D5868h     <span class="code-comment">; 'VMXh' magic value</span>
                MOV    ebx, 0
                MOV    ecx, 10
                MOV    edx, 5658h         <span class="code-comment">; 'VX'</span>
                IN     eax, dx            <span class="code-comment">; VMware I/O port</span>
                CMP    ebx, 564D5868h     <span class="code-comment">; Check response</span>
                JE     vm_detected


                <span class="code-comment">; Check for VirtualBox via registry/files</span>
                LEA    rcx, vbox_path
                CALL   GetFileAttributesA
                CMP    eax, -1
                JNE    vm_detected        <span class="code-comment">; File exists = VirtualBox</span>


                <span class="code-comment">; CPUID-based VM detection</span>
                MOV    eax, 1
                CPUID
                BT     ecx, 31            <span class="code-comment">; Check hypervisor bit</span>
                JC     vm_detected
            </code>

            <h3>Common Obfuscation Patterns</h3>
            <ul>
                <li><strong>Dead Code Insertion:</strong> Adding code that never executes</li>
                <li><strong>Opaque Predicates:</strong> Conditional branches with predetermined outcomes</li>
                <li><strong>Control Flow Flattening:</strong> Converting control flow into switch statements</li>
                <li><strong>String Encryption:</strong> Decrypting strings at runtime</li>
                <li><strong>API Hashing:</strong> Resolving APIs by hash instead of name</li>
                <li><strong>Instruction Substitution:</strong> Replacing simple instructions with complex equivalents</li>
            </ul>

            <div class="interactive-box">
                <div class="interactive-title">Interactive: Spot the Anti-Analysis Code</div>
                <p>Identify which code snippets contain anti-analysis techniques:</p>
                <div id="antiAnalysisQuiz"></div>
                <button class="btn" onclick="checkAntiAnalysis()">Check Answers</button>
            </div>

            <div class="warning-box">
                <strong>⚠ Analysis Warning:</strong> When encountering anti-analysis techniques, document them
                carefully. Use patches, plugins, or modified environments to bypass them. Always maintain
                detailed notes about what techniques were used and how you defeated them.
            </div>
        </div>

        <!-- Section 7: Practical Workflow -->
        <div class="section" data-section="7">
            <h2>7. Practical Workflow and Best Practices</h2>

            <p>
                A systematic approach to reverse engineering increases efficiency and ensures you don't
                miss critical details. Here's a proven workflow used by professional malware analysts.
            </p>

            <h3>Triage Process</h3>
            <div class="code-block">
                PHASE 1: Initial Assessment (5-10 minutes)
                ├── File type identification (file, TrID)
                ├── Hash calculation (MD5, SHA256)
                ├── VirusTotal lookup
                ├── String extraction (strings, FLOSS)
                ├── PE analysis (pecheck, pestudio)
                └── Packer detection (Detect It Easy, PEiD)

                PHASE 2: Static Analysis (30-60 minutes)
                ├── Load in disassembler (IDA/Ghidra)
                ├── Analyze imports/exports
                ├── Identify entry point
                ├── Map out main functions
                ├── Study interesting routines
                └── Document findings

                PHASE 3: Dynamic Analysis (30-60 minutes)
                ├── Set up isolated environment
                ├── Configure monitoring tools (Process Monitor, Wireshark)
                ├── Load in debugger
                ├── Set strategic breakpoints
                ├── Step through execution
                ├── Monitor API calls and behavior
                └── Capture artifacts

                PHASE 4: Deep Dive (hours to days)
                ├── Focus on key functionality
                ├── Reverse engineer algorithms
                ├── Extract IOCs (Indicators of Compromise)
                ├── Write detection rules (YARA, Snort)
                ├── Document complete analysis
                └── Create remediation guidance
            </div>

            <h3>String Analysis Strategy</h3>
            <div class="info-box">
                <strong>Start with Strings:</strong> Strings are often the fastest path to understanding
                a binary's purpose. Look for:
                <ul>
                    <li>URLs, IP addresses, domain names</li>
                    <li>File paths and registry keys</li>
                    <li>Error messages and debug strings</li>
                    <li>Cryptographic constants</li>
                    <li>API function names (if dynamically resolved)</li>
                    <li>Command-and-control protocols</li>
                </ul>
            </div>

            <h3>Import Analysis</h3>
            <div class="code-block">
                Key Windows APIs that reveal functionality:

                NETWORK ACTIVITY:
                - WSAStartup, socket, connect, send, recv
                - InternetOpenA, InternetConnectA, HttpSendRequestA
                - URLDownloadToFileA

                FILE OPERATIONS:
                - CreateFileA, ReadFile, WriteFile, DeleteFileA
                - FindFirstFileA, FindNextFileA
                - CopyFileA, MoveFileA

                PROCESS/THREAD MANIPULATION:
                - CreateProcess, CreateRemoteThread
                - VirtualAllocEx, WriteProcessMemory
                - OpenProcess, TerminateProcess

                PERSISTENCE:
                - RegCreateKeyA, RegSetValueExA
                - CreateServiceA, StartServiceA
                - WriteFile (to Startup folder)

                CRYPTOGRAPHY:
                - CryptAcquireContextA, CryptEncrypt, CryptDecrypt
                - BCryptGenRandom, BCryptEncrypt

                ANTI-ANALYSIS:
                - IsDebuggerPresent, CheckRemoteDebuggerPresent
                - NtQueryInformationProcess
                - GetTickCount, QueryPerformanceCounter
            </div>

            <h3>Documenting Findings</h3>
            <div class="code-block">
                ANALYSIS REPORT TEMPLATE:

                1. EXECUTIVE SUMMARY
                   - Sample hash (SHA256)
                   - File type and size
                   - Threat classification
                   - Key behaviors
                   - Risk assessment

                2. TECHNICAL DETAILS
                   - Packer/obfuscation used
                   - Architecture (x86/x64)
                   - Compilation timestamp
                   - Dependencies
                   - Code structure

                3. BEHAVIORAL ANALYSIS
                   - Network communication
                   - File system changes
                   - Registry modifications
                   - Process injection
                   - Privilege escalation

                4. INDICATORS OF COMPROMISE (IOCs)
                   - File hashes
                   - IP addresses / domains
                   - File paths
                   - Registry keys
                   - Mutexes / named objects

                5. DETECTION & MITIGATION
                   - YARA rules
                   - Network signatures (Snort/Suricata)
                   - Host-based detection
                   - Remediation steps
            </div>

            <div class="interactive-box">
                <div class="interactive-title">Interactive: "Analyze This Function" Challenge</div>
                <p>Study this assembly function and answer questions about its behavior:</p>
                <div class="code-block" id="challengeFunction">
                    <span class="code-comment">; Mystery Function</span>
                    push   rbp
                    mov    rbp, rsp
                    sub    rsp, 20h
                    mov    QWORD PTR [rbp-8], rcx    <span class="code-comment">; First parameter</span>
                    mov    QWORD PTR [rbp-10h], rdx  <span class="code-comment">; Second parameter</span>

                    mov    rax, QWORD PTR [rbp-8]
                    movzx  eax, BYTE PTR [rax]
                    test   al, al
                    je     done

                    xor    r8d, r8d                  <span class="code-comment">; Counter = 0</span>
                loop_start:
                    mov    rax, QWORD PTR [rbp-8]
                    add    rax, r8
                    movzx  edx, BYTE PTR [rax]

                    mov    rax, QWORD PTR [rbp-10h]
                    xor    BYTE PTR [rax], dl         <span class="code-comment">; XOR operation</span>

                    inc    r8
                    mov    rax, QWORD PTR [rbp-8]
                    add    rax, r8
                    movzx  eax, BYTE PTR [rax]
                    test   al, al
                    jne    loop_start

                done:
                    mov    rax, QWORD PTR [rbp-10h]
                    leave
                    ret
                </div>
                <div id="functionQuiz"></div>
                <button class="btn" onclick="checkFunctionAnalysis()">Submit Analysis</button>
            </div>

            <h3>Best Practices Checklist</h3>
            <div class="success-box">
                <strong>✓ Professional Reverse Engineering Habits:</strong>
                <ul>
                    <li>Always work in isolated/sandboxed environments</li>
                    <li>Take extensive notes and screenshots throughout analysis</li>
                    <li>Rename functions and variables with descriptive names</li>
                    <li>Add comments to explain non-obvious behavior</li>
                    <li>Cross-reference between static and dynamic analysis</li>
                    <li>Document all anti-analysis techniques encountered</li>
                    <li>Save IDA/Ghidra database regularly with version numbers</li>
                    <li>Create YARA rules for unique code patterns</li>
                    <li>Share findings with the security community (responsibly)</li>
                    <li>Keep learning - malware techniques constantly evolve</li>
                </ul>
            </div>
        </div>

        <!-- Completion Section -->
        <div class="section">
            <h2>Module Complete</h2>
            <p>
                Congratulations! You've completed the Reverse Engineering Basics module. You now have
                foundational knowledge of assembly language, disassemblers, debuggers, and common
                anti-analysis techniques.
            </p>
            <div class="success-box">
                <strong>Next Steps:</strong>
                <ul>
                    <li>Practice analyzing real malware samples in a safe lab environment</li>
                    <li>Learn advanced topics: shellcode analysis, kernel debugging, fuzzing</li>
                    <li>Study malware families: ransomware, trojans, rootkits</li>
                    <li>Participate in CTF challenges and reverse engineering wargames</li>
                    <li>Explore advanced tools: Frida, x64dbg scripting, IDA plugins</li>
                </ul>
            </div>
            <button class="btn" onclick="completeModule()" style="font-size: 1.2em; padding: 15px 30px;">
                Mark Module as Complete
            </button>
        </div>
    </div>

    <!-- Modal for Register Information -->
    <div id="registerModal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeModal('registerModal')">&times;</span>
            <h2 id="registerModalTitle"></h2>
            <div id="registerModalContent"></div>
        </div>
    </div>

    <script>
        // AccessGuard integration
        document.addEventListener('DOMContentLoaded', function() {
            // Check if user has completed gate6
            const userData = JSON.parse(localStorage.getItem('hexworth_user') || '{}');
            const completedGates = userData.completed_gates || [];

            if (!completedGates.includes('gate6_complete') && !completedGates.includes('dark-arts')) {
                alert('Access Denied: This is Tier 2 content. Complete Gate 6 first.');
                window.location.href = '../../index.html';
                return;
            }

            // Initialize module
            initializeModule();
            updateProgress();
        });

        // Module initialization
        function initializeModule() {
            initializeAsmMatcher();
            initializeCToAsmGame();
            initializeAntiAnalysisQuiz();
            initializeFunctionQuiz();
            initializeFlowCanvas();

            // Track section completion
            const sections = document.querySelectorAll('.section');
            sections.forEach((section, index) => {
                section.addEventListener('click', () => markSectionViewed(index + 1));
            });
        }

        // Progress tracking
        let completedSections = JSON.parse(localStorage.getItem('re_completed_sections') || '[]');

        function markSectionViewed(sectionNum) {
            if (!completedSections.includes(sectionNum)) {
                completedSections.push(sectionNum);
                localStorage.setItem('re_completed_sections', JSON.stringify(completedSections));
                updateProgress();
            }
        }

        function updateProgress() {
            const totalSections = 7;
            const progress = (completedSections.length / totalSections) * 100;
            const progressFill = document.getElementById('progressFill');
            progressFill.style.width = progress + '%';
            progressFill.textContent = Math.round(progress) + '%';
        }

        // Register Information Modal
        const registerInfo = {
            'rax': {
                name: 'RAX (Accumulator Register)',
                description: 'Primary register for arithmetic operations and function return values. In x64, it\'s 64-bit. EAX is the 32-bit version, AX is 16-bit, and AL/AH are 8-bit portions.',
                usage: ['Function return values', 'Multiplication/division operations', 'System call numbers', 'General arithmetic']
            },
            'rbx': {
                name: 'RBX (Base Register)',
                description: 'General-purpose register often used as a base pointer for memory access. It\'s a non-volatile register (callee-saved) in most calling conventions.',
                usage: ['Base pointer for data structures', 'Preserved across function calls', 'General computation', 'Loop counters']
            },
            'rcx': {
                name: 'RCX (Counter Register)',
                description: 'Traditionally used as a loop counter. In Windows x64 calling convention, it holds the first integer argument.',
                usage: ['Loop counter (loop, rep instructions)', 'First function argument (Windows x64)', 'Shift count for bit operations', 'String operations']
            },
            'rdx': {
                name: 'RDX (Data Register)',
                description: 'Used for I/O operations and extended arithmetic. In Windows x64, it holds the second integer argument.',
                usage: ['Second function argument (Windows x64)', 'High-order bits in multiplication', 'Remainder in division', 'I/O port access']
            },
            'rsi': {
                name: 'RSI (Source Index)',
                description: 'Source pointer for string and memory operations. In Linux x64, it holds the second function argument.',
                usage: ['Source pointer for string operations', 'Second argument (Linux x64)', 'Array/buffer operations', 'Memory copy operations']
            },
            'rdi': {
                name: 'RDI (Destination Index)',
                description: 'Destination pointer for string and memory operations. In Linux x64, it holds the first function argument.',
                usage: ['Destination pointer for string ops', 'First argument (Linux x64)', 'Memory operations destination', 'Array indexing']
            },
            'rbp': {
                name: 'RBP (Base Pointer)',
                description: 'Points to the base of the current stack frame. Used to access local variables and function parameters. Non-volatile register.',
                usage: ['Stack frame base pointer', 'Access local variables ([rbp-X])', 'Access function parameters ([rbp+X])', 'Frame pointer for debugging']
            },
            'rsp': {
                name: 'RSP (Stack Pointer)',
                description: 'Always points to the top of the stack. Modified by PUSH, POP, CALL, and RET instructions. Critical for function calls.',
                usage: ['Current stack top', 'Modified by PUSH/POP', 'Function call management', 'Local variable allocation']
            },
            'rip': {
                name: 'RIP (Instruction Pointer)',
                description: 'Points to the next instruction to execute. Cannot be directly modified except through control flow instructions (JMP, CALL, RET).',
                usage: ['Program counter', 'Next instruction address', 'Modified by jumps/calls', 'RIP-relative addressing in x64']
            }
        };

        function showRegisterInfo(regName) {
            const info = registerInfo[regName];
            const modal = document.getElementById('registerModal');
            const title = document.getElementById('registerModalTitle');
            const content = document.getElementById('registerModalContent');

            title.textContent = info.name;
            content.innerHTML = `
                <p style="margin-bottom: 15px;">${info.description}</p>
                <h3 style="color: #9a7aaa; margin-top: 20px;">Common Uses:</h3>
                <ul style="margin-left: 20px;">
                    ${info.usage.map(use => `<li style="margin: 8px 0;">${use}</li>`).join('')}
                </ul>
            `;

            modal.style.display = 'flex';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // Assembly Instruction Matcher Game
        let asmMatcherAnswers = {};

        function initializeAsmMatcher() {
            const instructions = [
                { inst: 'MOV rax, 5', options: ['Copy 5 to RAX', 'Compare RAX with 5', 'Move RAX 5 times'], correct: 0 },
                { inst: 'CMP eax, ebx', options: ['Copy EAX to EBX', 'Compare EAX and EBX', 'Call function at EBX'], correct: 1 },
                { inst: 'JE target', options: ['Jump always', 'Jump if equal', 'Jump if error'], correct: 1 },
                { inst: 'PUSH rbp', options: ['Pop RBP from stack', 'Push RBP onto stack', 'Print RBP value'], correct: 1 },
                { inst: 'XOR rax, rax', options: ['Set RAX to zero', 'Multiply RAX by 2', 'Rotate RAX'], correct: 0 }
            ];

            const container = document.getElementById('asmMatcherGame');
            let html = '';

            instructions.forEach((item, idx) => {
                html += `
                    <div style="margin: 15px 0; padding: 15px; background: rgba(26,10,46,0.4); border: 1px solid #9a7aaa; border-radius: 5px;">
                        <div style="color: #9a7aaa; font-weight: bold; margin-bottom: 10px;">${item.inst}</div>
                        ${item.options.map((opt, optIdx) => `
                            <label style="display: block; margin: 5px 0; cursor: pointer;">
                                <input type="radio" name="asm_${idx}" value="${optIdx}" style="margin-right: 10px;">
                                ${opt}
                            </label>
                        `).join('')}
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function checkAsmMatcher() {
            const correctAnswers = [0, 1, 1, 1, 0];
            let correct = 0;

            correctAnswers.forEach((ans, idx) => {
                const selected = document.querySelector(`input[name="asm_${idx}"]:checked`);
                if (selected && parseInt(selected.value) === ans) {
                    correct++;
                    selected.parentElement.style.color = '#4ade80';
                } else {
                    if (selected) selected.parentElement.style.color = '#f87171';
                }
            });

            alert(`You got ${correct} out of ${correctAnswers.length} correct!`);
            if (correct === correctAnswers.length) {
                markSectionViewed(2);
            }
        }

        function resetAsmMatcher() {
            document.querySelectorAll('input[name^="asm_"]').forEach(input => {
                input.checked = false;
                input.parentElement.style.color = '#c9b8d9';
            });
        }

        // C to Assembly Matching Game
        function initializeCToAsmGame() {
            const container = document.getElementById('cToAsmGame');
            const challenges = [
                {
                    c: 'if (x == 0) x = 1;',
                    asm: 'TEST eax, eax\nJNE skip\nMOV eax, 1\nskip:'
                },
                {
                    c: 'x = x + 5;',
                    asm: 'ADD eax, 5'
                },
                {
                    c: 'x = 0;',
                    asm: 'XOR eax, eax'
                }
            ];

            let html = '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">';
            html += '<div><h3 style="color: #9a7aaa;">C Code</h3>';
            challenges.forEach((item, idx) => {
                html += `<div class="challenge-option" draggable="true" ondragstart="drag(event)" id="c_${idx}">${item.c}</div>`;
            });
            html += '</div><div><h3 style="color: #9a7aaa;">Assembly</h3>';
            challenges.forEach((item, idx) => {
                html += `<div class="drop-zone" ondrop="drop(event)" ondragover="allowDrop(event)" id="asm_${idx}">
                    <pre style="color: #9a7aaa; margin: 0;">${item.asm}</pre>
                </div>`;
            });
            html += '</div></div>';

            container.innerHTML = html;
        }

        function allowDrop(ev) {
            ev.preventDefault();
            ev.target.closest('.drop-zone').classList.add('drag-over');
        }

        function drag(ev) {
            ev.dataTransfer.setData("text", ev.target.id);
        }

        function drop(ev) {
            ev.preventDefault();
            const data = ev.dataTransfer.getData("text");
            const dropZone = ev.target.closest('.drop-zone');
            dropZone.classList.remove('drag-over');
            dropZone.appendChild(document.getElementById(data));
        }

        function checkCToAsm() {
            const correct = ['c_0', 'c_1', 'c_2'];
            let score = 0;

            correct.forEach((id, idx) => {
                const dropZone = document.getElementById(`asm_${idx}`);
                const dropped = dropZone.querySelector('[id^="c_"]');
                if (dropped && dropped.id === id) {
                    score++;
                    dropZone.style.borderColor = '#4ade80';
                } else {
                    dropZone.style.borderColor = '#f87171';
                }
            });

            alert(`You matched ${score} out of ${correct.length} correctly!`);
            if (score === correct.length) {
                markSectionViewed(5);
            }
        }

        function resetCToAsm() {
            initializeCToAsmGame();
        }

        // Anti-Analysis Quiz
        function initializeAntiAnalysisQuiz() {
            const container = document.getElementById('antiAnalysisQuiz');
            const snippets = [
                { code: 'CALL IsDebuggerPresent\nTEST eax, eax\nJNE exit', hasAntiAnalysis: true, technique: 'API-based debugger detection' },
                { code: 'MOV eax, 5\nADD eax, 10\nRET', hasAntiAnalysis: false, technique: 'None' },
                { code: 'RDTSC\nMOV r8, rax\n; instructions\nRDTSC\nSUB rax, r8\nCMP rax, 1000\nJA detected', hasAntiAnalysis: true, technique: 'Timing-based detection' },
                { code: 'PUSH rbp\nMOV rbp, rsp\nRET', hasAntiAnalysis: false, technique: 'None' }
            ];

            let html = '';
            snippets.forEach((item, idx) => {
                html += `
                    <div style="margin: 15px 0;">
                        <div class="code-block">${item.code.replace(/\n/g, '<br>')}</div>
                        <label style="cursor: pointer;">
                            <input type="checkbox" id="anti_${idx}" style="margin-right: 10px;">
                            This code contains anti-analysis techniques
                        </label>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function checkAntiAnalysis() {
            const answers = [true, false, true, false];
            let correct = 0;

            answers.forEach((ans, idx) => {
                const checkbox = document.getElementById(`anti_${idx}`);
                if (checkbox.checked === ans) {
                    correct++;
                    checkbox.parentElement.style.color = '#4ade80';
                } else {
                    checkbox.parentElement.style.color = '#f87171';
                }
            });

            alert(`You identified ${correct} out of ${answers.length} correctly!`);
            if (correct === answers.length) {
                markSectionViewed(6);
            }
        }

        // Function Analysis Challenge
        function initializeFunctionQuiz() {
            const container = document.getElementById('functionQuiz');
            const questions = [
                {
                    q: 'What does this function do?',
                    options: ['Copies a string', 'XORs data with a key', 'Calculates string length', 'Sorts an array'],
                    correct: 1
                },
                {
                    q: 'How many parameters does it take?',
                    options: ['1', '2', '3', '4'],
                    correct: 1
                },
                {
                    q: 'What is the first parameter likely to be?',
                    options: ['Destination buffer', 'XOR key string', 'String length', 'Function pointer'],
                    correct: 1
                }
            ];

            let html = '';
            questions.forEach((item, idx) => {
                html += `
                    <div style="margin: 20px 0; padding: 15px; background: rgba(26,10,46,0.4); border: 1px solid #9a7aaa; border-radius: 5px;">
                        <div style="color: #9a7aaa; font-weight: bold; margin-bottom: 10px;">${item.q}</div>
                        ${item.options.map((opt, optIdx) => `
                            <label style="display: block; margin: 5px 0; cursor: pointer;">
                                <input type="radio" name="func_${idx}" value="${optIdx}" style="margin-right: 10px;">
                                ${opt}
                            </label>
                        `).join('')}
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function checkFunctionAnalysis() {
            const correctAnswers = [1, 1, 1];
            let correct = 0;

            correctAnswers.forEach((ans, idx) => {
                const selected = document.querySelector(`input[name="func_${idx}"]:checked`);
                if (selected && parseInt(selected.value) === ans) {
                    correct++;
                    selected.parentElement.style.color = '#4ade80';
                } else {
                    if (selected) selected.parentElement.style.color = '#f87171';
                }
            });

            if (correct === correctAnswers.length) {
                alert('Perfect! This function XORs the second parameter (buffer) with bytes from the first parameter (key string). It\'s a simple XOR encryption/decryption routine.');
                markSectionViewed(7);
            } else {
                alert(`You got ${correct} out of ${correctAnswers.length} correct. Study the XOR operation and the loop structure more carefully.`);
            }
        }

        // Control Flow Canvas
        let cfgCanvas, cfgCtx, cfgNodes = [];

        function initializeFlowCanvas() {
            cfgCanvas = document.getElementById('flowCanvas');
            cfgCtx = cfgCanvas.getContext('2d');
            cfgCanvas.width = cfgCanvas.offsetWidth;
            cfgCanvas.height = 400;

            cfgCanvas.addEventListener('click', cfgCanvasClick);
            drawCFG();
        }

        function cfgAddNode(type) {
            const colors = {
                start: '#4ade80',
                condition: '#60a5fa',
                action: '#c9b8d9',
                end: '#f87171'
            };

            const labels = {
                start: 'START',
                condition: 'IF?',
                action: 'ACTION',
                end: 'END'
            };

            cfgNodes.push({
                x: 100 + (cfgNodes.length % 5) * 100,
                y: 50 + Math.floor(cfgNodes.length / 5) * 80,
                type: type,
                color: colors[type],
                label: labels[type],
                connections: []
            });

            drawCFG();
        }

        function cfgClear() {
            cfgNodes = [];
            drawCFG();
        }

        function cfgCanvasClick(e) {
            const rect = cfgCanvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;

            const clickedNode = cfgNodes.findIndex(node =>
                Math.abs(node.x - x) < 30 && Math.abs(node.y - y) < 30
            );

            if (clickedNode !== -1) {
                // Simple interaction: show node type
                alert(`Node Type: ${cfgNodes[clickedNode].type}`);
            }
        }

        function drawCFG() {
            cfgCtx.clearRect(0, 0, cfgCanvas.width, cfgCanvas.height);

            // Draw connections first
            cfgNodes.forEach(node => {
                node.connections.forEach(targetIdx => {
                    const target = cfgNodes[targetIdx];
                    cfgCtx.strokeStyle = '#9a7aaa';
                    cfgCtx.lineWidth = 2;
                    cfgCtx.beginPath();
                    cfgCtx.moveTo(node.x, node.y);
                    cfgCtx.lineTo(target.x, target.y);
                    cfgCtx.stroke();
                });
            });

            // Draw nodes
            cfgNodes.forEach(node => {
                cfgCtx.fillStyle = node.color;
                cfgCtx.strokeStyle = '#1a0a2e';
                cfgCtx.lineWidth = 2;

                if (node.type === 'condition') {
                    // Draw diamond
                    cfgCtx.beginPath();
                    cfgCtx.moveTo(node.x, node.y - 25);
                    cfgCtx.lineTo(node.x + 25, node.y);
                    cfgCtx.lineTo(node.x, node.y + 25);
                    cfgCtx.lineTo(node.x - 25, node.y);
                    cfgCtx.closePath();
                } else {
                    // Draw rectangle
                    cfgCtx.beginPath();
                    cfgCtx.rect(node.x - 30, node.y - 20, 60, 40);
                }

                cfgCtx.fill();
                cfgCtx.stroke();

                // Draw label
                cfgCtx.fillStyle = '#1a0a2e';
                cfgCtx.font = 'bold 12px "Courier New"';
                cfgCtx.textAlign = 'center';
                cfgCtx.textBaseline = 'middle';
                cfgCtx.fillText(node.label, node.x, node.y);
            });
        }

        // Module completion
        function completeModule() {
            markSectionViewed(7);

            // Save completion to localStorage
            const userData = JSON.parse(localStorage.getItem('hexworth_user') || '{}');
            if (!userData.completed_modules) userData.completed_modules = [];
            if (!userData.completed_modules.includes('reverse-engineering')) {
                userData.completed_modules.push('reverse-engineering');
                localStorage.setItem('hexworth_user', JSON.stringify(userData));
            }

            alert('Congratulations! Reverse Engineering Basics module completed.\n\nYou have gained foundational knowledge in:\n- Assembly language and registers\n- Disassemblers and debuggers\n- Control flow analysis\n- C construct recognition\n- Anti-analysis techniques\n- Practical workflow\n\nContinue your journey in the Dark Arts Vault!');

            window.location.href = '../index.html';
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        }
    </script>
<script src="../../../components/FluxCapacitor.js"></script>
</body>
</html>