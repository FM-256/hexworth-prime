<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>OWASP Top 10 Attack Lab | Hexworth Prime Dark Arts</title>
  <style>
    :root {
      --primary: #a855f7;
      --accent: #dc2626;
      --bg: #0a0a0f;
      --surface: #1a1a2e;
      --surface-light: #252540;
      --text: #e0e0e0;
      --text-dim: #9ca3af;
      --success: #10b981;
      --warning: #f59e0b;
      --critical: #dc2626;
      --high: #f97316;
      --medium: #eab308;
      --border: #3f3f55;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, var(--bg) 0%, #1a0a2e 100%);
      color: var(--text);
      line-height: 1.6;
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    /* Header */
    .header {
      text-align: center;
      margin-bottom: 40px;
      padding: 30px;
      background: linear-gradient(135deg, var(--surface) 0%, var(--surface-light) 100%);
      border-radius: 16px;
      border: 2px solid var(--primary);
      box-shadow: 0 0 40px rgba(168, 85, 247, 0.3);
      position: relative;
      overflow: hidden;
    }

    .header::before {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: radial-gradient(circle, rgba(168, 85, 247, 0.1) 0%, transparent 70%);
      animation: pulse 4s ease-in-out infinite;
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); opacity: 0.5; }
      50% { transform: scale(1.1); opacity: 0.8; }
    }

    .header h1 {
      font-size: 2.8em;
      margin-bottom: 10px;
      color: var(--primary);
      text-shadow: 0 0 20px rgba(168, 85, 247, 0.6);
      position: relative;
      z-index: 1;
    }

    .header p {
      font-size: 1.2em;
      color: var(--text-dim);
      position: relative;
      z-index: 1;
    }

    .owasp-badge {
      display: inline-block;
      margin-top: 15px;
      padding: 10px 20px;
      background: var(--accent);
      color: white;
      border-radius: 8px;
      font-weight: bold;
      text-transform: uppercase;
      font-size: 0.9em;
      letter-spacing: 1px;
      position: relative;
      z-index: 1;
    }

    /* Navigation */
    .nav {
      display: flex;
      gap: 15px;
      margin-bottom: 30px;
      flex-wrap: wrap;
      justify-content: center;
    }

    .nav-btn {
      padding: 12px 24px;
      background: var(--surface);
      color: var(--text);
      border: 2px solid var(--primary);
      border-radius: 8px;
      cursor: pointer;
      font-size: 1em;
      font-weight: 600;
      transition: all 0.3s ease;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .nav-btn:hover {
      background: var(--primary);
      transform: translateY(-2px);
      box-shadow: 0 5px 20px rgba(168, 85, 247, 0.4);
    }

    .nav-btn.active {
      background: var(--primary);
      color: white;
    }

    /* Progress Tracker */
    .progress-tracker {
      background: var(--surface);
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 30px;
      border: 1px solid var(--border);
    }

    .progress-bar {
      width: 100%;
      height: 30px;
      background: var(--bg);
      border-radius: 15px;
      overflow: hidden;
      margin-bottom: 15px;
      border: 2px solid var(--primary);
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--primary) 0%, var(--accent) 100%);
      transition: width 0.5s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
      font-size: 0.9em;
    }

    .progress-stats {
      display: flex;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 15px;
    }

    .stat-item {
      display: flex;
      align-items: center;
      gap: 8px;
      color: var(--text-dim);
    }

    .stat-value {
      color: var(--primary);
      font-weight: bold;
      font-size: 1.2em;
    }

    /* Section Container */
    .section {
      display: none;
    }

    .section.active {
      display: block;
      animation: fadeIn 0.4s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* OWASP Cards Grid */
    .owasp-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 25px;
      margin-bottom: 30px;
    }

    .owasp-card {
      background: var(--surface);
      border: 2px solid var(--border);
      border-radius: 12px;
      padding: 25px;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .owasp-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 4px;
      background: linear-gradient(90deg, var(--primary), var(--accent));
      transform: scaleX(0);
      transition: transform 0.3s ease;
    }

    .owasp-card:hover {
      transform: translateY(-5px);
      border-color: var(--primary);
      box-shadow: 0 10px 30px rgba(168, 85, 247, 0.3);
    }

    .owasp-card:hover::before {
      transform: scaleX(1);
    }

    .owasp-card.completed {
      border-color: var(--success);
    }

    .owasp-card.completed::before {
      background: var(--success);
      transform: scaleX(1);
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 15px;
    }

    .card-number {
      font-size: 2em;
      font-weight: bold;
      color: var(--primary);
      opacity: 0.3;
    }

    .severity-badge {
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 0.8em;
      font-weight: bold;
      text-transform: uppercase;
    }

    .severity-critical {
      background: var(--critical);
      color: white;
    }

    .severity-high {
      background: var(--high);
      color: white;
    }

    .severity-medium {
      background: var(--medium);
      color: var(--bg);
    }

    .card-title {
      font-size: 1.4em;
      margin-bottom: 10px;
      color: var(--primary);
      font-weight: 600;
    }

    .card-description {
      color: var(--text-dim);
      font-size: 0.95em;
      margin-bottom: 15px;
    }

    .card-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .tag {
      padding: 4px 10px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 6px;
      font-size: 0.8em;
      color: var(--text-dim);
    }

    .completion-check {
      position: absolute;
      top: 15px;
      right: 15px;
      width: 30px;
      height: 30px;
      border-radius: 50%;
      background: var(--success);
      display: none;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
    }

    .owasp-card.completed .completion-check {
      display: flex;
    }

    /* Vulnerability Detail View */
    .vuln-detail {
      background: var(--surface);
      border: 2px solid var(--primary);
      border-radius: 12px;
      padding: 30px;
      margin-bottom: 30px;
    }

    .vuln-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 25px;
      flex-wrap: wrap;
      gap: 15px;
    }

    .vuln-title {
      font-size: 2em;
      color: var(--primary);
    }

    .back-btn {
      padding: 10px 20px;
      background: var(--surface-light);
      border: 2px solid var(--border);
      border-radius: 8px;
      color: var(--text);
      cursor: pointer;
      font-size: 1em;
      transition: all 0.3s ease;
    }

    .back-btn:hover {
      background: var(--primary);
      border-color: var(--primary);
    }

    .tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 25px;
      flex-wrap: wrap;
      border-bottom: 2px solid var(--border);
    }

    .tab-btn {
      padding: 12px 24px;
      background: transparent;
      border: none;
      color: var(--text-dim);
      cursor: pointer;
      font-size: 1em;
      font-weight: 600;
      border-bottom: 3px solid transparent;
      transition: all 0.3s ease;
    }

    .tab-btn:hover {
      color: var(--primary);
    }

    .tab-btn.active {
      color: var(--primary);
      border-bottom-color: var(--primary);
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
      animation: fadeIn 0.3s ease;
    }

    .info-section {
      margin-bottom: 25px;
    }

    .info-section h3 {
      color: var(--primary);
      margin-bottom: 12px;
      font-size: 1.3em;
    }

    .info-section p, .info-section ul {
      color: var(--text-dim);
      line-height: 1.8;
    }

    .info-section ul {
      padding-left: 25px;
    }

    .info-section li {
      margin-bottom: 8px;
    }

    /* Code Comparison */
    .code-comparison {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 20px;
      margin-bottom: 25px;
    }

    .code-panel {
      background: var(--bg);
      border-radius: 8px;
      overflow: hidden;
      border: 2px solid var(--border);
    }

    .code-panel.vulnerable {
      border-color: var(--accent);
    }

    .code-panel.secure {
      border-color: var(--success);
    }

    .code-header {
      padding: 12px 15px;
      font-weight: bold;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .code-panel.vulnerable .code-header {
      background: var(--accent);
      color: white;
    }

    .code-panel.secure .code-header {
      background: var(--success);
      color: white;
    }

    .code-block {
      padding: 15px;
      overflow-x: auto;
      font-family: 'Courier New', monospace;
      font-size: 0.9em;
      line-height: 1.6;
    }

    .code-line {
      display: block;
    }

    .code-comment {
      color: #6a9955;
    }

    .code-keyword {
      color: #569cd6;
    }

    .code-string {
      color: #ce9178;
    }

    .code-function {
      color: #dcdcaa;
    }

    .code-variable {
      color: #9cdcfe;
    }

    /* Attack Flow Diagram */
    .attack-flow {
      background: var(--bg);
      padding: 25px;
      border-radius: 12px;
      border: 2px solid var(--border);
      margin-bottom: 25px;
    }

    .flow-step {
      display: flex;
      align-items: center;
      margin-bottom: 20px;
      position: relative;
    }

    .flow-step:not(:last-child)::after {
      content: '↓';
      position: absolute;
      left: 20px;
      bottom: -20px;
      color: var(--primary);
      font-size: 1.5em;
    }

    .flow-number {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--primary);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      margin-right: 15px;
      flex-shrink: 0;
    }

    .flow-content {
      flex: 1;
    }

    .flow-title {
      color: var(--primary);
      font-weight: 600;
      margin-bottom: 5px;
    }

    .flow-description {
      color: var(--text-dim);
      font-size: 0.95em;
    }

    /* Simulator */
    .simulator {
      background: var(--surface);
      border: 2px solid var(--primary);
      border-radius: 12px;
      padding: 25px;
      margin-bottom: 30px;
    }

    .simulator h2 {
      color: var(--primary);
      margin-bottom: 20px;
      font-size: 1.8em;
    }

    .vulnerable-app {
      background: var(--bg);
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
    }

    .app-header {
      background: var(--surface-light);
      padding: 15px;
      border-radius: 8px 8px 0 0;
      margin: -20px -20px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .app-title {
      font-weight: bold;
      color: var(--primary);
    }

    .app-url {
      color: var(--text-dim);
      font-family: monospace;
      font-size: 0.9em;
    }

    .input-group {
      margin-bottom: 20px;
    }

    .input-group label {
      display: block;
      margin-bottom: 8px;
      color: var(--text);
      font-weight: 600;
    }

    .input-group input,
    .input-group textarea {
      width: 100%;
      padding: 12px;
      background: var(--surface);
      border: 2px solid var(--border);
      border-radius: 8px;
      color: var(--text);
      font-size: 1em;
      font-family: inherit;
    }

    .input-group input:focus,
    .input-group textarea:focus {
      outline: none;
      border-color: var(--primary);
    }

    .exploit-btn {
      padding: 12px 30px;
      background: var(--accent);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 1em;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .exploit-btn:hover {
      background: #b91c1c;
      transform: translateY(-2px);
      box-shadow: 0 5px 20px rgba(220, 38, 38, 0.4);
    }

    .result-box {
      margin-top: 20px;
      padding: 15px;
      border-radius: 8px;
      border: 2px solid var(--border);
      display: none;
    }

    .result-box.show {
      display: block;
      animation: fadeIn 0.3s ease;
    }

    .result-box.success {
      background: rgba(16, 185, 129, 0.1);
      border-color: var(--success);
    }

    .result-box.error {
      background: rgba(220, 38, 38, 0.1);
      border-color: var(--accent);
    }

    .result-box.exploited {
      background: rgba(245, 158, 11, 0.1);
      border-color: var(--warning);
    }

    /* Quiz */
    .quiz-container {
      background: var(--surface);
      border: 2px solid var(--primary);
      border-radius: 12px;
      padding: 30px;
    }

    .quiz-progress {
      margin-bottom: 25px;
      text-align: center;
    }

    .quiz-progress-text {
      color: var(--text-dim);
      margin-bottom: 10px;
    }

    .question-card {
      background: var(--bg);
      padding: 25px;
      border-radius: 12px;
      border: 2px solid var(--border);
      margin-bottom: 20px;
    }

    .question-number {
      color: var(--primary);
      font-weight: bold;
      margin-bottom: 10px;
    }

    .question-text {
      font-size: 1.2em;
      margin-bottom: 20px;
      color: var(--text);
    }

    .options {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .option {
      padding: 15px;
      background: var(--surface);
      border: 2px solid var(--border);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .option:hover {
      border-color: var(--primary);
      background: var(--surface-light);
    }

    .option.selected {
      border-color: var(--primary);
      background: var(--surface-light);
    }

    .option.correct {
      border-color: var(--success);
      background: rgba(16, 185, 129, 0.1);
    }

    .option.incorrect {
      border-color: var(--accent);
      background: rgba(220, 38, 38, 0.1);
    }

    .option-letter {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      background: var(--primary);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      flex-shrink: 0;
    }

    .quiz-actions {
      display: flex;
      justify-content: space-between;
      margin-top: 25px;
      flex-wrap: wrap;
      gap: 15px;
    }

    .quiz-btn {
      padding: 12px 30px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 1em;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
      text-transform: uppercase;
    }

    .quiz-btn:hover {
      background: #9333ea;
      transform: translateY(-2px);
    }

    .quiz-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    .quiz-results {
      text-align: center;
      padding: 30px;
    }

    .results-score {
      font-size: 3em;
      color: var(--primary);
      font-weight: bold;
      margin-bottom: 15px;
    }

    .results-message {
      font-size: 1.3em;
      margin-bottom: 25px;
      color: var(--text);
    }

    .results-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 20px;
      margin-bottom: 25px;
    }

    .stat-card {
      background: var(--bg);
      padding: 20px;
      border-radius: 8px;
      border: 2px solid var(--border);
    }

    .stat-label {
      color: var(--text-dim);
      font-size: 0.9em;
      margin-bottom: 5px;
    }

    .stat-number {
      font-size: 2em;
      font-weight: bold;
      color: var(--primary);
    }

    /* Checklist */
    .checklist {
      background: var(--surface);
      border: 2px solid var(--primary);
      border-radius: 12px;
      padding: 30px;
    }

    .checklist h2 {
      color: var(--primary);
      margin-bottom: 25px;
      font-size: 1.8em;
    }

    .checklist-category {
      margin-bottom: 30px;
    }

    .checklist-category h3 {
      color: var(--text);
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 2px solid var(--border);
    }

    .checklist-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      background: var(--bg);
      border-radius: 8px;
      margin-bottom: 10px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .checklist-item:hover {
      background: var(--surface-light);
    }

    .checkbox {
      width: 24px;
      height: 24px;
      border: 2px solid var(--border);
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
      flex-shrink: 0;
    }

    .checklist-item.checked .checkbox {
      background: var(--success);
      border-color: var(--success);
    }

    .checkbox::after {
      content: '✓';
      color: white;
      font-weight: bold;
      display: none;
    }

    .checklist-item.checked .checkbox::after {
      display: block;
    }

    /* Achievements */
    .achievement-popup {
      position: fixed;
      top: 20px;
      right: 20px;
      background: linear-gradient(135deg, var(--primary), var(--accent));
      padding: 20px 25px;
      border-radius: 12px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
      transform: translateX(400px);
      transition: transform 0.5s ease;
      z-index: 1000;
      max-width: 350px;
    }

    .achievement-popup.show {
      transform: translateX(0);
    }

    .achievement-title {
      font-weight: bold;
      margin-bottom: 5px;
      font-size: 1.1em;
    }

    .achievement-text {
      font-size: 0.95em;
      opacity: 0.9;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .header h1 {
        font-size: 2em;
      }

      .owasp-grid {
        grid-template-columns: 1fr;
      }

      .code-comparison {
        grid-template-columns: 1fr;
      }

      .nav {
        flex-direction: column;
      }

      .nav-btn {
        width: 100%;
      }

      .quiz-actions {
        flex-direction: column;
      }

      .quiz-btn {
        width: 100%;
      }
    }

    /* Loading Animation */
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid var(--border);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Utility Classes */
    .hidden {
      display: none !important;
    }

    .text-center {
      text-align: center;
    }

    .mb-20 {
      margin-bottom: 20px;
    }

    .mt-20 {
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <div class="header">
      <h1>OWASP Top 10 Attack Lab</h1>
      <p>Master Web Application Security Vulnerabilities</p>
      <div class="owasp-badge">CEH v12 - 2021 Edition</div>
    </div>

    <!-- Progress Tracker -->
    <div class="progress-tracker">
      <div class="progress-bar">
        <div class="progress-fill" id="progressFill">0%</div>
      </div>
      <div class="progress-stats">
        <div class="stat-item">
          <span>Vulnerabilities Explored:</span>
          <span class="stat-value" id="vulnExplored">0/10</span>
        </div>
        <div class="stat-item">
          <span>Exploits Attempted:</span>
          <span class="stat-value" id="exploitsAttempted">0</span>
        </div>
        <div class="stat-item">
          <span>Quiz Score:</span>
          <span class="stat-value" id="quizScore">0/15</span>
        </div>
        <div class="stat-item">
          <span>XP Earned:</span>
          <span class="stat-value" id="xpEarned">0/85</span>
        </div>
      </div>
    </div>

    <!-- Navigation -->
    <div class="nav">
      <button class="nav-btn active" onclick="showSection('overview')">Overview</button>
      <button class="nav-btn" onclick="showSection('simulator')">Vulnerability Simulator</button>
      <button class="nav-btn" onclick="showSection('checklist')">Security Checklist</button>
      <button class="nav-btn" onclick="showSection('quiz')">Assessment Quiz</button>
      <button class="nav-btn" onclick="returnToVault()">Return to Vault</button>
    </div>

    <!-- Overview Section -->
    <div id="overview" class="section active">
      <div id="overviewMain">
        <div class="owasp-grid" id="owaspGrid">
          <!-- Cards will be generated by JavaScript -->
        </div>
      </div>

      <!-- Vulnerability Detail View -->
      <div id="vulnDetailView" class="hidden">
        <div class="vuln-detail">
          <div class="vuln-header">
            <h2 class="vuln-title" id="vulnDetailTitle"></h2>
            <button class="back-btn" onclick="closeVulnDetail()">← Back to Overview</button>
          </div>

          <div class="tabs">
            <button class="tab-btn active" onclick="showTab('description')">Description</button>
            <button class="tab-btn" onclick="showTab('examples')">Real-World Examples</button>
            <button class="tab-btn" onclick="showTab('exploitation')">Exploitation</button>
            <button class="tab-btn" onclick="showTab('remediation')">Remediation</button>
          </div>

          <div id="tab-description" class="tab-content active">
            <!-- Description content -->
          </div>

          <div id="tab-examples" class="tab-content">
            <!-- Examples content -->
          </div>

          <div id="tab-exploitation" class="tab-content">
            <!-- Exploitation content -->
          </div>

          <div id="tab-remediation" class="tab-content">
            <!-- Remediation content -->
          </div>
        </div>
      </div>
    </div>

    <!-- Simulator Section -->
    <div id="simulator" class="section">
      <div class="simulator">
        <h2>Vulnerable Application Simulator</h2>
        <p style="color: var(--text-dim); margin-bottom: 25px;">
          Interact with these intentionally vulnerable applications to understand how attacks work.
          Try to exploit each vulnerability and observe the results.
        </p>

        <div id="simulatorContent">
          <!-- Simulator apps will be loaded here -->
        </div>
      </div>
    </div>

    <!-- Checklist Section -->
    <div id="checklist" class="section">
      <div class="checklist">
        <h2>Web Application Security Checklist</h2>
        <p style="color: var(--text-dim); margin-bottom: 25px;">
          Use this comprehensive checklist to ensure your applications are protected against the OWASP Top 10 vulnerabilities.
        </p>
        <div id="checklistContent">
          <!-- Checklist items will be generated by JavaScript -->
        </div>
      </div>
    </div>

    <!-- Quiz Section -->
    <div id="quiz" class="section">
      <div class="quiz-container">
        <h2 class="text-center mb-20" style="color: var(--primary); font-size: 2em;">OWASP Top 10 Assessment</h2>

        <div class="quiz-progress">
          <p class="quiz-progress-text">Question <span id="currentQuestion">1</span> of <span id="totalQuestions">15</span></p>
          <div class="progress-bar">
            <div class="progress-fill" id="quizProgressFill">0%</div>
          </div>
        </div>

        <div id="quizQuestions">
          <!-- Quiz questions will be generated here -->
        </div>

        <div class="quiz-actions">
          <button class="quiz-btn" id="prevBtn" onclick="previousQuestion()" disabled>Previous</button>
          <button class="quiz-btn" id="nextBtn" onclick="nextQuestion()">Next</button>
          <button class="quiz-btn hidden" id="submitBtn" onclick="submitQuiz()">Submit Quiz</button>
        </div>

        <div id="quizResults" class="hidden">
          <!-- Results will be shown here -->
        </div>
      </div>
    </div>
  </div>

  <!-- Achievement Popup -->
  <div id="achievementPopup" class="achievement-popup">
    <div class="achievement-title" id="achievementTitle"></div>
    <div class="achievement-text" id="achievementText"></div>
  </div>

  <script>
    // OWASP Top 10 Data Structure
    const owaspData = [
      {
        id: 'A01',
        number: 'A01',
        title: 'Broken Access Control',
        description: 'Allows unauthorized access to resources by bypassing access control checks.',
        severity: 'critical',
        tags: ['IDOR', 'CSRF', 'Privilege Escalation', 'Force Browsing'],
        realWorldExamples: [
          'Facebook IDOR vulnerability exposing user photos (2019)',
          'GitHub OAuth bypass allowing account takeover (2020)',
          'Tesla privilege escalation vulnerability (2020)',
          'Starbucks API IDOR exposing customer data (2019)'
        ],
        vulnerableCode: `// Vulnerable: Direct object reference without authorization
app.get('/api/user/:userId', (req, res) => {
  const userId = req.params.userId;
  const userData = db.getUser(userId);
  res.json(userData); // No check if requester owns this data
});

// Attacker can access any user's data
// GET /api/user/123
// GET /api/user/456`,
        secureCode: `// Secure: Verify user authorization
app.get('/api/user/:userId', (req, res) => {
  const userId = req.params.userId;
  const requesterId = req.session.userId;

  // Check if requester is authorized
  if (userId !== requesterId && !isAdmin(requesterId)) {
    return res.status(403).json({error: 'Unauthorized'});
  }

  const userData = db.getUser(userId);
  res.json(userData);
});`,
        attackFlow: [
          { title: 'Reconnaissance', description: 'Identify URL patterns and predictable IDs' },
          { title: 'Enumeration', description: 'Test different IDs or parameters systematically' },
          { title: 'Exploitation', description: 'Access unauthorized resources using modified IDs' },
          { title: 'Data Exfiltration', description: 'Extract sensitive information from accessed resources' }
        ],
        remediation: [
          'Implement proper authorization checks on every request',
          'Use indirect references (mapping tables) instead of direct IDs',
          'Apply principle of least privilege',
          'Implement rate limiting to prevent enumeration',
          'Use anti-CSRF tokens for state-changing operations',
          'Log and monitor access control failures'
        ]
      },
      {
        id: 'A02',
        number: 'A02',
        title: 'Cryptographic Failures',
        description: 'Exposure of sensitive data due to weak or missing encryption.',
        severity: 'critical',
        tags: ['Weak Encryption', 'Missing TLS', 'Poor Entropy', 'Data Exposure'],
        realWorldExamples: [
          'Equifax breach exposing 147M records due to weak encryption (2017)',
          'Marriott breach of 500M guests with unencrypted passport numbers (2018)',
          'Yahoo breach with unsalted MD5 password hashes (2013)',
          'Adobe password breach with weak encryption (2013)'
        ],
        vulnerableCode: `// Vulnerable: Weak MD5 hashing
const crypto = require('crypto');

function hashPassword(password) {
  return crypto.createHash('md5')
    .update(password)
    .digest('hex');
}

// Storing sensitive data in plain text
const user = {
  username: 'john',
  password: hashPassword('password123'), // MD5 is broken
  ssn: '123-45-6789', // Plain text SSN!
  creditCard: '4532-1234-5678-9012'
};`,
        secureCode: `// Secure: Strong bcrypt hashing with salt
const bcrypt = require('bcrypt');
const crypto = require('crypto');

async function hashPassword(password) {
  const saltRounds = 12;
  return await bcrypt.hash(password, saltRounds);
}

// Encrypt sensitive data at rest
function encrypt(text, key) {
  const iv = crypto.randomBytes(16);
  const cipher = crypto.createCipheriv('aes-256-gcm', key, iv);
  let encrypted = cipher.update(text, 'utf8', 'hex');
  encrypted += cipher.final('hex');
  return {encrypted, iv: iv.toString('hex'), tag: cipher.getAuthTag()};
}

const user = {
  username: 'john',
  password: await hashPassword('password123'),
  ssn: encrypt('123-45-6789', encryptionKey),
  creditCard: encrypt('4532-1234-5678-9012', encryptionKey)
};`,
        attackFlow: [
          { title: 'Identify Target', description: 'Find applications transmitting or storing sensitive data' },
          { title: 'Intercept Traffic', description: 'Use tools like Wireshark to capture unencrypted data' },
          { title: 'Crack Weak Hashes', description: 'Use rainbow tables or GPU crackers for weak algorithms' },
          { title: 'Exploit Leaked Data', description: 'Use credentials or sensitive info for further attacks' }
        ],
        remediation: [
          'Use TLS 1.3 for all data in transit',
          'Encrypt sensitive data at rest with AES-256',
          'Use bcrypt, scrypt, or Argon2 for password hashing',
          'Generate cryptographic keys with sufficient entropy (256-bit minimum)',
          'Implement proper key management and rotation',
          'Never store passwords in plain text or with weak hashing'
        ]
      },
      {
        id: 'A03',
        number: 'A03',
        title: 'Injection',
        description: 'Untrusted data sent to an interpreter as part of a command or query.',
        severity: 'critical',
        tags: ['SQL Injection', 'Command Injection', 'Code Injection', 'LDAP Injection'],
        realWorldExamples: [
          'Sony Pictures SQL injection breach (2011)',
          'TalkTalk SQL injection exposing 157,000 customers (2015)',
          'Heartland Payment Systems SQL injection - 134M cards (2008)',
          'LinkedIn data breach via SQL injection (2012)'
        ],
        vulnerableCode: `// Vulnerable: SQL Injection
app.post('/login', (req, res) => {
  const username = req.body.username;
  const password = req.body.password;

  // Direct string concatenation - VULNERABLE!
  const query = "SELECT * FROM users WHERE " +
    "username = '" + username + "' AND " +
    "password = '" + password + "'";

  db.query(query, (err, results) => {
    // Attacker input: username = "admin'--"
    // Results in: SELECT * FROM users WHERE username = 'admin'--'
  });
});`,
        secureCode: `// Secure: Parameterized queries
app.post('/login', async (req, res) => {
  const username = req.body.username;
  const password = req.body.password;

  // Use parameterized query
  const query = 'SELECT * FROM users WHERE username = ? AND password = ?';

  try {
    const results = await db.query(query, [username, password]);

    if (results.length > 0) {
      // Verify password hash
      const validPassword = await bcrypt.compare(
        password,
        results[0].password_hash
      );
      if (validPassword) {
        res.json({success: true});
      }
    }
    res.status(401).json({error: 'Invalid credentials'});
  } catch (err) {
    res.status(500).json({error: 'Server error'});
  }
});`,
        attackFlow: [
          { title: 'Identify Injection Point', description: 'Find user input that reaches an interpreter' },
          { title: 'Test for Vulnerability', description: "Try payloads like ' OR '1'='1 or ; ls" },
          { title: 'Craft Malicious Payload', description: 'Create injection that achieves attacker goal' },
          { title: 'Execute Attack', description: 'Extract data, execute commands, or modify database' }
        ],
        remediation: [
          'Use parameterized queries (prepared statements) for all database access',
          'Implement input validation with whitelists',
          'Escape special characters when parameterization is not possible',
          'Use ORM frameworks with built-in protection',
          'Apply principle of least privilege for database accounts',
          'Implement WAF rules to detect injection attempts'
        ]
      },
      {
        id: 'A04',
        number: 'A04',
        title: 'Insecure Design',
        description: 'Missing or ineffective security controls in the design phase.',
        severity: 'high',
        tags: ['Threat Modeling', 'SDLC', 'Security Architecture', 'Design Flaws'],
        realWorldExamples: [
          'Zoom design flaw allowing meeting hijacking (2020)',
          'Peloton API design exposing user location data (2021)',
          'SolarWinds design vulnerability in update mechanism (2020)',
          'Log4Shell design flaw in logging library (2021)'
        ],
        vulnerableCode: `// Vulnerable: No rate limiting or account lockout
app.post('/reset-password', (req, res) => {
  const email = req.body.email;
  const code = generateResetCode(); // 4-digit code

  sendEmail(email, code);
  res.json({message: 'Reset code sent'});

  // No rate limiting - attacker can brute force
  // No account lockout after failed attempts
  // Short code is easily guessable
});`,
        secureCode: `// Secure: Comprehensive security design
const rateLimit = require('express-rate-limit');

// Rate limiting
const resetLimiter = rateLimit({
  windowMs: 15 * 60 * 1000, // 15 minutes
  max: 3, // Limit to 3 requests per window
  message: 'Too many reset attempts'
});

app.post('/reset-password', resetLimiter, async (req, res) => {
  const email = req.body.email;

  // Generate cryptographically secure token
  const token = crypto.randomBytes(32).toString('hex');
  const expiry = Date.now() + 3600000; // 1 hour

  await db.storeResetToken(email, token, expiry);

  // Send secure reset link
  const resetUrl = \`https://app.com/reset?token=\${token}\`;
  await sendSecureEmail(email, resetUrl);

  // Always same response (prevent user enumeration)
  res.json({message: 'If email exists, reset link sent'});

  // Log attempt for monitoring
  securityLog.log('password_reset_requested', {email, ip: req.ip});
});`,
        attackFlow: [
          { title: 'Analyze Design', description: 'Identify missing security controls in application design' },
          { title: 'Find Weak Points', description: 'Locate features lacking proper security considerations' },
          { title: 'Exploit Design Flaw', description: 'Abuse the fundamental design weakness' },
          { title: 'Achieve Impact', description: 'Compromise confidentiality, integrity, or availability' }
        ],
        remediation: [
          'Implement threat modeling during design phase',
          'Use secure design patterns and principles',
          'Integrate security requirements into SDLC',
          'Conduct security architecture reviews',
          'Implement defense in depth strategies',
          'Design with failure in mind (fail secure, not fail open)'
        ]
      },
      {
        id: 'A05',
        number: 'A05',
        title: 'Security Misconfiguration',
        description: 'Insecure default configurations, incomplete setups, or verbose error messages.',
        severity: 'high',
        tags: ['Default Credentials', 'Directory Listing', 'Verbose Errors', 'Cloud Storage'],
        realWorldExamples: [
          'Capital One breach via misconfigured AWS S3 (2019) - 106M customers',
          'Elasticsearch server exposing 1.2B records (2019)',
          'MongoDB databases exposed with no authentication (ongoing)',
          'Tesla AWS S3 bucket misconfiguration (2018)'
        ],
        vulnerableCode: `// Vulnerable: Development settings in production
const express = require('express');
const app = express();

// Debug mode enabled in production!
app.set('env', 'development');

// Detailed error messages exposed to users
app.use((err, req, res, next) => {
  res.status(500).json({
    error: err.message,
    stack: err.stack, // Stack trace exposed!
    query: req.query // Sensitive data exposed!
  });
});

// Default admin credentials
const ADMIN_USER = 'admin';
const ADMIN_PASS = 'admin123'; // Never changed!

// Directory listing enabled
app.use(express.static('public', {
  dotfiles: 'allow', // Exposes .git, .env, etc.
  index: false // Shows directory contents
}));`,
        secureCode: `// Secure: Production-hardened configuration
const express = require('express');
const helmet = require('helmet');
const app = express();

// Production mode
app.set('env', 'production');

// Security headers
app.use(helmet());

// Generic error messages only
app.use((err, req, res, next) => {
  // Log detailed error server-side
  logger.error({
    message: err.message,
    stack: err.stack,
    url: req.url
  });

  // Return generic message to user
  res.status(500).json({
    error: 'Internal server error'
  });
});

// Strong credentials from environment
const ADMIN_USER = process.env.ADMIN_USER;
const ADMIN_PASS = process.env.ADMIN_PASS; // Strong, unique

// Disable directory listing, restrict file access
app.use(express.static('public', {
  dotfiles: 'deny',
  index: 'index.html',
  etag: false
}));

// Remove server header
app.disable('x-powered-by');`,
        attackFlow: [
          { title: 'Scan for Misconfigurations', description: 'Use tools to find exposed services and files' },
          { title: 'Enumerate Information', description: 'Gather details from error messages and directory listings' },
          { title: 'Access Sensitive Resources', description: 'Access exposed databases, config files, or APIs' },
          { title: 'Escalate Access', description: 'Use default credentials or exposed secrets' }
        ],
        remediation: [
          'Implement secure configuration baseline',
          'Remove or disable unnecessary features and frameworks',
          'Change all default credentials',
          'Implement proper error handling (generic messages to users)',
          'Disable directory listing and unnecessary HTTP methods',
          'Regular security configuration reviews and updates',
          'Use configuration management tools',
          'Implement proper cloud security (IAM, security groups, etc.)'
        ]
      },
      {
        id: 'A06',
        number: 'A06',
        title: 'Vulnerable & Outdated Components',
        description: 'Using components with known vulnerabilities or outdated versions.',
        severity: 'high',
        tags: ['Outdated Libraries', 'Apache Struts', 'Known CVEs', 'Dependencies'],
        realWorldExamples: [
          'Equifax breach via Apache Struts vulnerability (2017)',
          'Log4Shell affecting millions of applications (2021)',
          'Heartbleed OpenSSL vulnerability (2014)',
          'WannaCry ransomware exploiting Windows SMB (2017)'
        ],
        vulnerableCode: `// package.json - Vulnerable dependencies
{
  "name": "my-app",
  "dependencies": {
    "express": "3.0.0",      // Outdated! Current: 4.18.x
    "lodash": "4.17.15",     // Has known CVEs
    "moment": "2.20.0",      // Deprecated, use dayjs
    "jquery": "1.12.0",      // Multiple XSS vulnerabilities
    "log4js": "6.3.0"        // Vulnerable to injection
  }
}

// Using vulnerable component
const _ = require('lodash');

// CVE-2019-10744: Prototype pollution
app.post('/api/user', (req, res) => {
  const defaults = {role: 'user'};
  const user = _.merge(defaults, req.body);
  // Attacker can inject: {"__proto__": {"isAdmin": true}}
});`,
        secureCode: `// package.json - Updated and audited
{
  "name": "my-app",
  "dependencies": {
    "express": "^4.18.2",    // Latest stable
    "lodash": "^4.17.21",    // Patched version
    "dayjs": "^1.11.7",      // Modern alternative
    "dompurify": "^3.0.0"    // For safe HTML
  },
  "scripts": {
    "audit": "npm audit",
    "update": "npm update",
    "check": "npm outdated"
  }
}

// Secure usage with validation
const _ = require('lodash');

app.post('/api/user', (req, res) => {
  // Validate input schema first
  const schema = {
    username: 'string',
    email: 'string'
  };

  if (!validateSchema(req.body, schema)) {
    return res.status(400).json({error: 'Invalid input'});
  }

  // Use safe merge with whitelist
  const defaults = {role: 'user'};
  const user = Object.assign({}, defaults, {
    username: req.body.username,
    email: req.body.email
  });

  db.createUser(user);
});`,
        attackFlow: [
          { title: 'Identify Components', description: 'Enumerate libraries and versions used by target' },
          { title: 'Search CVE Databases', description: 'Find known vulnerabilities in those versions' },
          { title: 'Craft Exploit', description: 'Use public exploits or create custom payload' },
          { title: 'Compromise System', description: 'Execute code, steal data, or gain access' }
        ],
        remediation: [
          'Maintain inventory of all components and versions',
          'Regularly update dependencies (automated if possible)',
          'Run security scanners (npm audit, Snyk, Dependabot)',
          'Remove unused dependencies',
          'Monitor security advisories for used components',
          'Use components from trusted sources only',
          'Implement Software Composition Analysis (SCA) in CI/CD',
          'Have patch management process for critical vulnerabilities'
        ]
      },
      {
        id: 'A07',
        number: 'A07',
        title: 'Identification & Authentication Failures',
        description: 'Weak authentication mechanisms allowing unauthorized access.',
        severity: 'critical',
        tags: ['Brute Force', 'Weak Passwords', 'No MFA', 'Session Management'],
        realWorldExamples: [
          'Twitter OAuth vulnerability allowing account takeover (2020)',
          'Uber breach via compromised credentials (2016)',
          'Reddit breach via SMS interception (2018)',
          'Dropbox breach from credential stuffing (2012)'
        ],
        vulnerableCode: `// Vulnerable: Weak authentication
app.post('/login', (req, res) => {
  const {username, password} = req.body;

  // No rate limiting - brute force possible
  // No account lockout
  // No password complexity requirements

  const user = db.findUser(username);

  // Plain text password comparison!
  if (user && user.password === password) {
    // Weak session management
    req.session.user = user.username;
    req.session.isAdmin = user.isAdmin;

    // Session never expires
    // No session regeneration after login
    // Session ID predictable

    res.json({success: true});
  } else {
    // Leaks whether username exists
    res.json({error: 'Invalid username or password'});
  }
});`,
        secureCode: `// Secure: Strong authentication
const bcrypt = require('bcrypt');
const speakeasy = require('speakeasy');
const rateLimit = require('express-rate-limit');

// Rate limiting
const loginLimiter = rateLimit({
  windowMs: 15 * 60 * 1000,
  max: 5,
  skipSuccessfulRequests: true
});

app.post('/login', loginLimiter, async (req, res) => {
  const {username, password, totpToken} = req.body;

  try {
    const user = await db.findUser(username);

    if (!user) {
      await delay(randomMs(100, 300)); // Timing attack prevention
      return res.status(401).json({error: 'Invalid credentials'});
    }

    // Check account lockout
    if (user.lockoutUntil && user.lockoutUntil > Date.now()) {
      return res.status(423).json({error: 'Account locked'});
    }

    // Verify password hash
    const validPassword = await bcrypt.compare(password, user.passwordHash);

    if (!validPassword) {
      await db.incrementFailedAttempts(user.id);
      if (user.failedAttempts >= 5) {
        await db.lockAccount(user.id, 30 * 60 * 1000); // 30 min
      }
      return res.status(401).json({error: 'Invalid credentials'});
    }

    // Verify MFA if enabled
    if (user.mfaEnabled) {
      const validToken = speakeasy.totp.verify({
        secret: user.mfaSecret,
        encoding: 'base32',
        token: totpToken,
        window: 1
      });

      if (!validToken) {
        return res.status(401).json({error: 'Invalid MFA token'});
      }
    }

    // Reset failed attempts
    await db.resetFailedAttempts(user.id);

    // Regenerate session
    req.session.regenerate((err) => {
      req.session.userId = user.id;
      req.session.loginTime = Date.now();

      // Set session expiry
      req.session.cookie.maxAge = 3600000; // 1 hour

      res.json({
        success: true,
        requiresMfa: user.mfaEnabled && !user.mfaVerified
      });
    });

  } catch (err) {
    logger.error('Login error', err);
    res.status(500).json({error: 'Server error'});
  }
});`,
        attackFlow: [
          { title: 'Credential Discovery', description: 'Obtain credentials via phishing, breach databases, or social engineering' },
          { title: 'Brute Force Attack', description: 'Try common passwords or use credential stuffing' },
          { title: 'Session Hijacking', description: 'Steal session tokens via XSS or network sniffing' },
          { title: 'Account Takeover', description: 'Gain full access to victim account' }
        ],
        remediation: [
          'Implement multi-factor authentication (MFA)',
          'Enforce strong password policies (length, complexity, not in breach databases)',
          'Use bcrypt/scrypt/Argon2 for password hashing',
          'Implement account lockout after failed attempts',
          'Use secure session management (regenerate after login, proper expiry)',
          'Rate limit authentication endpoints',
          'Monitor for credential stuffing attacks',
          'Implement CAPTCHA for suspicious activity'
        ]
      },
      {
        id: 'A08',
        number: 'A08',
        title: 'Software & Data Integrity Failures',
        description: 'Code and infrastructure that does not protect against integrity violations.',
        severity: 'high',
        tags: ['Supply Chain', 'Deserialization', 'CI/CD', 'Third-party Plugins'],
        realWorldExamples: [
          'SolarWinds supply chain attack (2020) - 18,000 organizations',
          'CodeCov bash uploader compromise (2021)',
          'Event-Stream NPM package backdoor (2018)',
          'CCleaner supply chain attack (2017)'
        ],
        vulnerableCode: `// Vulnerable: Insecure deserialization
const express = require('express');
const serialize = require('node-serialize');

app.post('/api/profile', (req, res) => {
  // Deserializing untrusted data - DANGEROUS!
  const userData = serialize.unserialize(req.body.data);

  // Attacker can inject malicious code:
  // {"rce":"_$$ND_FUNC$$_function(){require('child_process').exec('rm -rf /', function(){})}()"}

  updateProfile(userData);
  res.json({success: true});
});

// Vulnerable: No integrity checks on dependencies
// package.json
{
  "dependencies": {
    "some-package": "*"  // No version pinning!
    // No integrity hashes
    // No signature verification
  }
}

// Loading third-party scripts without SRI
// <script src="https://cdn.example.com/lib.js"></script>`,
        secureCode: `// Secure: Safe data handling
const express = require('express');

app.post('/api/profile', (req, res) => {
  // Use JSON instead of serialization
  const userData = req.body;

  // Validate with schema
  const schema = {
    name: {type: 'string', maxLength: 100},
    email: {type: 'string', format: 'email'},
    age: {type: 'number', min: 0, max: 150}
  };

  if (!validateSchema(userData, schema)) {
    return res.status(400).json({error: 'Invalid data'});
  }

  updateProfile(userData);
  res.json({success: true});
});

// Secure: Version pinning and integrity
// package.json
{
  "dependencies": {
    "some-package": "1.2.3"  // Exact version
  }
}

// package-lock.json includes integrity hashes
// npm ci --only=production

// Use Subresource Integrity for CDN resources
// <script
//   src="https://cdn.example.com/lib.js"
//   integrity="sha384-oqVuAfXRKap7fdgcCY5uykM6+R9GqQ8K/ux..."
//   crossorigin="anonymous">
// </script>`,
        attackFlow: [
          { title: 'Identify Supply Chain', description: 'Map dependencies and third-party components' },
          { title: 'Compromise Component', description: 'Inject malicious code into dependency or update mechanism' },
          { title: 'Wait for Update', description: 'Malicious code distributed via legitimate update channel' },
          { title: 'Execute Payload', description: 'Backdoor activates in all systems using the component' }
        ],
        remediation: [
          'Use package lock files and integrity hashes',
          'Implement Subresource Integrity (SRI) for CDN resources',
          'Sign all releases and verify signatures',
          'Use private package repositories for internal code',
          'Implement CI/CD security (code signing, secure pipelines)',
          'Never deserialize untrusted data',
          'Regular dependency audits',
          'Monitor for unauthorized changes to code repositories'
        ]
      },
      {
        id: 'A09',
        number: 'A09',
        title: 'Security Logging & Monitoring Failures',
        description: 'Insufficient logging and monitoring allowing attacks to go undetected.',
        severity: 'medium',
        tags: ['Auditing', 'Log Management', 'Alerting', 'Incident Response'],
        realWorldExamples: [
          'Equifax breach undetected for 76 days (2017)',
          'Target breach detection delayed by ignored alerts (2013)',
          'Uber breach hidden for a year (2016)',
          'Marriott breach went undetected for 4 years (2014-2018)'
        ],
        vulnerableCode: `// Vulnerable: No logging
app.post('/login', (req, res) => {
  const {username, password} = req.body;
  const user = authenticate(username, password);

  if (user) {
    req.session.user = user;
    res.json({success: true});
    // No logging of successful login
    // No logging of source IP
    // No logging of user agent
  } else {
    res.status(401).json({error: 'Failed'});
    // No logging of failed attempt
    // No alerting on repeated failures
  }
});

// No audit trail
app.delete('/api/user/:id', (req, res) => {
  db.deleteUser(req.params.id);
  // Who deleted? When? Why? Unknown!
});

// Logs contain sensitive data
console.log('User login:', req.body);
// Password logged in plain text!`,
        secureCode: `// Secure: Comprehensive logging
const winston = require('winston');

const logger = winston.createLogger({
  level: 'info',
  format: winston.format.json(),
  transports: [
    new winston.transports.File({filename: 'error.log', level: 'error'}),
    new winston.transports.File({filename: 'security.log'})
  ]
});

app.post('/login', async (req, res) => {
  const {username, password} = req.body;
  const ip = req.ip;
  const userAgent = req.get('user-agent');

  try {
    const user = await authenticate(username, password);

    if (user) {
      // Log successful authentication
      logger.info('Login success', {
        event: 'authentication.success',
        username: username,
        userId: user.id,
        ip: ip,
        userAgent: userAgent,
        timestamp: new Date().toISOString()
      });

      req.session.user = user;
      res.json({success: true});
    }
  } catch (err) {
    // Log failed attempt
    logger.warn('Login failed', {
      event: 'authentication.failure',
      username: username,
      ip: ip,
      userAgent: userAgent,
      timestamp: new Date().toISOString()
    });

    // Check for brute force
    const recentFailures = await getRecentFailures(ip, username);
    if (recentFailures > 5) {
      logger.error('Potential brute force', {
        event: 'security.bruteforce',
        username: username,
        ip: ip,
        attempts: recentFailures
      });

      // Alert security team
      alertSecurityTeam('Brute force detected', {ip, username});
    }

    res.status(401).json({error: 'Invalid credentials'});
  }
});

// Audit trail for sensitive operations
app.delete('/api/user/:id', authorize('admin'), async (req, res) => {
  const targetUserId = req.params.id;
  const actorUserId = req.session.userId;

  logger.warn('User deletion', {
    event: 'user.delete',
    actor: actorUserId,
    target: targetUserId,
    ip: req.ip,
    timestamp: new Date().toISOString()
  });

  await db.deleteUser(targetUserId);
  res.json({success: true});
});`,
        attackFlow: [
          { title: 'Reconnaissance', description: 'Test if security events are logged or monitored' },
          { title: 'Low and Slow Attack', description: 'Perform attack gradually to avoid detection' },
          { title: 'Cover Tracks', description: 'Delete or modify logs if access is gained' },
          { title: 'Extended Presence', description: 'Remain undetected for extended period' }
        ],
        remediation: [
          'Log all authentication events (success and failure)',
          'Log all authorization failures',
          'Log all input validation failures',
          'Log administrative actions',
          'Implement centralized log management (SIEM)',
          'Set up real-time alerting for suspicious activity',
          'Protect log integrity (write-only access, separate system)',
          'Regular log review and analysis',
          'Implement log retention policy',
          'Never log sensitive data (passwords, credit cards, etc.)'
        ]
      },
      {
        id: 'A10',
        number: 'A10',
        title: 'Server-Side Request Forgery (SSRF)',
        description: 'Application fetches remote resources without validating user-supplied URLs.',
        severity: 'medium',
        tags: ['SSRF', 'Internal Access', 'Cloud Metadata', 'Port Scanning'],
        realWorldExamples: [
          'Capital One AWS metadata SSRF (2019)',
          'Shopify SSRF via ImageMagick (2016)',
          'Vend SSRF accessing AWS metadata (2018)',
          'GitLab SSRF via webhooks (2021)'
        ],
        vulnerableCode: `// Vulnerable: Unvalidated URL fetch
app.get('/api/preview', async (req, res) => {
  const url = req.query.url;

  // No validation - SSRF vulnerability!
  const response = await fetch(url);
  const data = await response.text();

  // Attacker can access:
  // - Internal services: http://localhost:6379
  // - AWS metadata: http://169.254.169.254/latest/meta-data/
  // - Internal network: http://192.168.1.5/admin
  // - Port scanning: http://internal-host:22

  res.send(data);
});

// Vulnerable: PDF generation with user URL
app.post('/generate-pdf', (req, res) => {
  const htmlUrl = req.body.url;

  // Fetches arbitrary URLs
  puppeteer.launch().then(browser => {
    const page = browser.newPage();
    page.goto(htmlUrl); // SSRF!
    page.pdf({path: 'output.pdf'});
  });
});`,
        secureCode: `// Secure: URL validation and whitelist
const {URL} = require('url');

const ALLOWED_DOMAINS = [
  'api.example.com',
  'cdn.example.com'
];

const BLOCKED_IPS = [
  '127.0.0.0/8',    // Loopback
  '10.0.0.0/8',     // Private
  '172.16.0.0/12',  // Private
  '192.168.0.0/16', // Private
  '169.254.0.0/16'  // AWS metadata
];

function isUrlSafe(urlString) {
  try {
    const url = new URL(urlString);

    // Only allow HTTP/HTTPS
    if (!['http:', 'https:'].includes(url.protocol)) {
      return false;
    }

    // Check domain whitelist
    if (!ALLOWED_DOMAINS.includes(url.hostname)) {
      return false;
    }

    // Resolve and check IP
    const ip = dns.resolve4(url.hostname);
    if (isBlockedIP(ip)) {
      return false;
    }

    return true;
  } catch {
    return false;
  }
}

app.get('/api/preview', async (req, res) => {
  const url = req.query.url;

  // Validate URL
  if (!isUrlSafe(url)) {
    logger.warn('SSRF attempt blocked', {url, ip: req.ip});
    return res.status(400).json({error: 'Invalid URL'});
  }

  try {
    // Use allowlist for fetch
    const response = await fetch(url, {
      redirect: 'manual', // Don't follow redirects
      timeout: 5000
    });

    // Validate response
    if (response.status === 301 || response.status === 302) {
      return res.status(400).json({error: 'Redirects not allowed'});
    }

    const data = await response.text();
    res.send(data);

  } catch (err) {
    logger.error('Fetch error', {url, error: err.message});
    res.status(500).json({error: 'Fetch failed'});
  }
});`,
        attackFlow: [
          { title: 'Identify SSRF Point', description: 'Find functionality that fetches URLs (webhooks, previews, etc.)' },
          { title: 'Test Internal Access', description: 'Try accessing localhost, private IPs, cloud metadata' },
          { title: 'Enumerate Services', description: 'Port scan internal network using SSRF' },
          { title: 'Exploit Services', description: 'Access internal APIs, databases, or admin panels' }
        ],
        remediation: [
          'Implement URL whitelist (allowed domains/IPs)',
          'Validate and parse URLs before using them',
          'Block requests to private IP ranges and localhost',
          'Disable HTTP redirects or validate redirect targets',
          'Use separate network for external requests',
          'Implement network segmentation',
          'Remove metadata service access from application servers',
          'Monitor and alert on suspicious outbound requests'
        ]
      }
    ];

    // Quiz Questions
    const quizQuestions = [
      {
        question: 'Which OWASP vulnerability allows attackers to access resources without proper authorization checks?',
        options: [
          'Broken Access Control',
          'Security Misconfiguration',
          'Injection',
          'Cryptographic Failures'
        ],
        correct: 0,
        category: 'A01'
      },
      {
        question: 'What is IDOR?',
        options: [
          'Internal Database Object Reference',
          'Insecure Direct Object Reference',
          'Indirect Data Object Retrieval',
          'Internet Domain Object Routing'
        ],
        correct: 1,
        category: 'A01'
      },
      {
        question: 'Which hashing algorithm should NEVER be used for passwords?',
        options: [
          'bcrypt',
          'Argon2',
          'MD5',
          'scrypt'
        ],
        correct: 2,
        category: 'A02'
      },
      {
        question: 'What is the primary defense against SQL injection?',
        options: [
          'Input validation only',
          'Parameterized queries',
          'Encrypting the database',
          'Using a firewall'
        ],
        correct: 1,
        category: 'A03'
      },
      {
        question: 'Which SQL injection payload bypasses authentication by commenting out the password check?',
        options: [
          "username' OR '1'='1",
          "admin'--",
          "'; DROP TABLE users--",
          "1=1"
        ],
        correct: 1,
        category: 'A03'
      },
      {
        question: 'Insecure Design vulnerabilities are best addressed during which phase?',
        options: [
          'Testing phase',
          'Deployment phase',
          'Design and architecture phase',
          'Maintenance phase'
        ],
        correct: 2,
        category: 'A04'
      },
      {
        question: 'Which of the following is a security misconfiguration?',
        options: [
          'Using strong passwords',
          'Default admin credentials unchanged',
          'Enabling HTTPS',
          'Implementing rate limiting'
        ],
        correct: 1,
        category: 'A05'
      },
      {
        question: 'The Equifax breach in 2017 was caused by which OWASP vulnerability?',
        options: [
          'SQL Injection',
          'Vulnerable Apache Struts component',
          'Broken Authentication',
          'SSRF'
        ],
        correct: 1,
        category: 'A06'
      },
      {
        question: 'Which tool can help identify vulnerable dependencies in Node.js projects?',
        options: [
          'npm audit',
          'netstat',
          'ping',
          'traceroute'
        ],
        correct: 0,
        category: 'A06'
      },
      {
        question: 'What should be implemented to prevent brute force attacks on login endpoints?',
        options: [
          'Longer passwords only',
          'Rate limiting and account lockout',
          'CAPTCHA on every request',
          'Removing password requirements'
        ],
        correct: 1,
        category: 'A07'
      },
      {
        question: 'Which is the strongest password hashing algorithm?',
        options: [
          'MD5',
          'SHA1',
          'bcrypt',
          'Base64'
        ],
        correct: 2,
        category: 'A07'
      },
      {
        question: 'What is the SolarWinds attack an example of?',
        options: [
          'SQL Injection',
          'Supply chain attack',
          'Brute force attack',
          'DDoS attack'
        ],
        correct: 1,
        category: 'A08'
      },
      {
        question: 'Which HTTP header provides Subresource Integrity protection?',
        options: [
          'Content-Type',
          'X-Frame-Options',
          'integrity',
          'Authorization'
        ],
        correct: 2,
        category: 'A08'
      },
      {
        question: 'What should be logged for security monitoring?',
        options: [
          'User passwords',
          'Credit card numbers',
          'Failed authentication attempts',
          'All user input without sanitization'
        ],
        correct: 2,
        category: 'A09'
      },
      {
        question: 'SSRF attacks can be used to access which of the following?',
        options: [
          'Cloud metadata services',
          'Internal network resources',
          'Port scan internal systems',
          'All of the above'
        ],
        correct: 3,
        category: 'A10'
      }
    ];

    // Security Checklist Data
    const checklistData = [
      {
        category: 'Access Control',
        items: [
          'Implement authorization checks on all requests',
          'Use indirect object references',
          'Apply principle of least privilege',
          'Implement anti-CSRF tokens',
          'Log all access control failures'
        ]
      },
      {
        category: 'Cryptography',
        items: [
          'Use TLS 1.3 for data in transit',
          'Encrypt sensitive data at rest with AES-256',
          'Use bcrypt/Argon2 for password hashing',
          'Implement proper key management',
          'Use strong random number generation'
        ]
      },
      {
        category: 'Injection Prevention',
        items: [
          'Use parameterized queries for all database access',
          'Implement input validation with whitelists',
          'Escape output based on context',
          'Use ORM frameworks with built-in protection',
          'Apply principle of least privilege for database accounts'
        ]
      },
      {
        category: 'Secure Design',
        items: [
          'Conduct threat modeling for new features',
          'Integrate security into SDLC',
          'Implement rate limiting on sensitive endpoints',
          'Design with defense in depth',
          'Use secure design patterns'
        ]
      },
      {
        category: 'Configuration',
        items: [
          'Change all default credentials',
          'Disable directory listing',
          'Remove unnecessary features and frameworks',
          'Implement generic error messages',
          'Use security headers (CSP, HSTS, etc.)'
        ]
      },
      {
        category: 'Components',
        items: [
          'Maintain inventory of all dependencies',
          'Regularly update dependencies',
          'Run security scanners (npm audit, Snyk)',
          'Remove unused dependencies',
          'Monitor security advisories'
        ]
      },
      {
        category: 'Authentication',
        items: [
          'Implement multi-factor authentication',
          'Enforce strong password policies',
          'Implement account lockout',
          'Use secure session management',
          'Rate limit authentication endpoints'
        ]
      },
      {
        category: 'Integrity',
        items: [
          'Use package lock files',
          'Implement Subresource Integrity (SRI)',
          'Sign all releases',
          'Never deserialize untrusted data',
          'Use code signing in CI/CD'
        ]
      },
      {
        category: 'Logging & Monitoring',
        items: [
          'Log all authentication events',
          'Log authorization failures',
          'Implement centralized log management',
          'Set up real-time alerting',
          'Protect log integrity'
        ]
      },
      {
        category: 'SSRF Prevention',
        items: [
          'Implement URL whitelist',
          'Validate and parse all URLs',
          'Block private IP ranges',
          'Disable HTTP redirects',
          'Implement network segmentation'
        ]
      }
    ];

    // Application State
    let appState = {
      currentVuln: null,
      exploredVulns: new Set(),
      exploitsAttempted: 0,
      quizAnswers: [],
      currentQuizQuestion: 0,
      quizSubmitted: false,
      checklistProgress: {},
      xpEarned: 0
    };

    // Load saved progress
    function loadProgress() {
      const saved = localStorage.getItem('owaspLabProgress');
      if (saved) {
        const data = JSON.parse(saved);
        appState = {...appState, ...data};
        appState.exploredVulns = new Set(data.exploredVulns || []);
      }
    }

    // Save progress
    function saveProgress() {
      const data = {
        ...appState,
        exploredVulns: Array.from(appState.exploredVulns)
      };
      localStorage.setItem('owaspLabProgress', JSON.stringify(data));
      updateProgress();
    }

    // Update progress display
    function updateProgress() {
      const total = owaspData.length;
      const explored = appState.exploredVulns.size;
      const percentage = Math.round((explored / total) * 100);

      document.getElementById('progressFill').style.width = percentage + '%';
      document.getElementById('progressFill').textContent = percentage + '%';
      document.getElementById('vulnExplored').textContent = `${explored}/${total}`;
      document.getElementById('exploitsAttempted').textContent = appState.exploitsAttempted;
      document.getElementById('quizScore').textContent = `${appState.quizAnswers.filter(a => a.correct).length}/${quizQuestions.length}`;
      document.getElementById('xpEarned').textContent = `${appState.xpEarned}/85`;
    }

    // Initialize
    function init() {
      loadProgress();
      renderOwaspCards();
      renderChecklist();
      renderQuiz();
      updateProgress();

      // Award initial XP if first time
      if (appState.xpEarned === 0) {
        awardXP(5, 'Started OWASP Top 10 Lab');
      }
    }

    // Render OWASP Cards
    function renderOwaspCards() {
      const grid = document.getElementById('owaspGrid');
      grid.innerHTML = owaspData.map(vuln => `
        <div class="owasp-card ${appState.exploredVulns.has(vuln.id) ? 'completed' : ''}"
             onclick="showVulnDetail('${vuln.id}')">
          <div class="completion-check">✓</div>
          <div class="card-header">
            <div class="card-number">${vuln.number}</div>
            <div class="severity-badge severity-${vuln.severity}">${vuln.severity}</div>
          </div>
          <h3 class="card-title">${vuln.title}</h3>
          <p class="card-description">${vuln.description}</p>
          <div class="card-tags">
            ${vuln.tags.map(tag => `<span class="tag">${tag}</span>`).join('')}
          </div>
        </div>
      `).join('');
    }

    // Show vulnerability detail
    function showVulnDetail(id) {
      const vuln = owaspData.find(v => v.id === id);
      if (!vuln) return;

      appState.currentVuln = id;

      // Mark as explored
      if (!appState.exploredVulns.has(id)) {
        appState.exploredVulns.add(id);
        awardXP(5, `Explored ${vuln.title}`);
        saveProgress();
        renderOwaspCards();
      }

      document.getElementById('overviewMain').classList.add('hidden');
      document.getElementById('vulnDetailView').classList.remove('hidden');
      document.getElementById('vulnDetailTitle').textContent = `${vuln.number}: ${vuln.title}`;

      renderVulnTabs(vuln);
    }

    // Render vulnerability tabs
    function renderVulnTabs(vuln) {
      // Description tab
      document.getElementById('tab-description').innerHTML = `
        <div class="info-section">
          <h3>Overview</h3>
          <p>${vuln.description}</p>
        </div>
        <div class="info-section">
          <h3>Common Attack Vectors</h3>
          <ul>
            ${vuln.tags.map(tag => `<li>${tag}</li>`).join('')}
          </ul>
        </div>
      `;

      // Examples tab
      document.getElementById('tab-examples').innerHTML = `
        <div class="info-section">
          <h3>Notable Real-World Breaches</h3>
          <ul>
            ${vuln.realWorldExamples.map(ex => `<li>${ex}</li>`).join('')}
          </ul>
        </div>
      `;

      // Exploitation tab
      document.getElementById('tab-exploitation').innerHTML = `
        <div class="info-section">
          <h3>Attack Flow</h3>
          <div class="attack-flow">
            ${vuln.attackFlow.map((step, i) => `
              <div class="flow-step">
                <div class="flow-number">${i + 1}</div>
                <div class="flow-content">
                  <div class="flow-title">${step.title}</div>
                  <div class="flow-description">${step.description}</div>
                </div>
              </div>
            `).join('')}
          </div>
        </div>
        <div class="info-section">
          <h3>Code Comparison</h3>
          <div class="code-comparison">
            <div class="code-panel vulnerable">
              <div class="code-header">
                <span>⚠️ Vulnerable Code</span>
              </div>
              <pre class="code-block">${escapeHtml(vuln.vulnerableCode)}</pre>
            </div>
            <div class="code-panel secure">
              <div class="code-header">
                <span>✓ Secure Code</span>
              </div>
              <pre class="code-block">${escapeHtml(vuln.secureCode)}</pre>
            </div>
          </div>
        </div>
      `;

      // Remediation tab
      document.getElementById('tab-remediation').innerHTML = `
        <div class="info-section">
          <h3>Mitigation Strategies</h3>
          <ul>
            ${vuln.remediation.map(rem => `<li>${rem}</li>`).join('')}
          </ul>
        </div>
      `;
    }

    // Close vulnerability detail
    function closeVulnDetail() {
      document.getElementById('overviewMain').classList.remove('hidden');
      document.getElementById('vulnDetailView').classList.add('hidden');
      appState.currentVuln = null;
    }

    // Show tab
    function showTab(tabName) {
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
      });

      event.target.classList.add('active');
      document.getElementById(`tab-${tabName}`).classList.add('active');
    }

    // Show section
    function showSection(sectionName) {
      document.querySelectorAll('.section').forEach(section => {
        section.classList.remove('active');
      });
      document.querySelectorAll('.nav-btn').forEach(btn => {
        btn.classList.remove('active');
      });

      document.getElementById(sectionName).classList.add('active');
      event.target.classList.add('active');

      if (sectionName === 'simulator') {
        loadSimulator();
      }
    }

    // Load simulator
    function loadSimulator() {
      const simulators = [
        {
          id: 'sql-injection',
          title: 'SQL Injection Login',
          url: 'http://vulnerable-app.local/login',
          html: `
            <div class="input-group">
              <label>Username:</label>
              <input type="text" id="sql-username" placeholder="Enter username">
            </div>
            <div class="input-group">
              <label>Password:</label>
              <input type="password" id="sql-password" placeholder="Enter password">
            </div>
            <button class="exploit-btn" onclick="testSQLInjection()">Login</button>
            <div id="sql-result" class="result-box"></div>
            <div style="margin-top: 20px; padding: 15px; background: var(--bg); border-radius: 8px;">
              <p style="color: var(--text-dim); margin-bottom: 10px;">💡 Try these payloads:</p>
              <code style="display: block; color: var(--primary); margin-bottom: 5px;">admin'--</code>
              <code style="display: block; color: var(--primary); margin-bottom: 5px;">' OR '1'='1'--</code>
              <code style="display: block; color: var(--primary);">admin' OR '1'='1</code>
            </div>
          `
        },
        {
          id: 'idor',
          title: 'IDOR - User Profile Access',
          url: 'http://vulnerable-app.local/api/user',
          html: `
            <div class="input-group">
              <label>User ID (you are user ID 42):</label>
              <input type="number" id="idor-userid" value="42" placeholder="Enter user ID">
            </div>
            <button class="exploit-btn" onclick="testIDOR()">View Profile</button>
            <div id="idor-result" class="result-box"></div>
            <div style="margin-top: 20px; padding: 15px; background: var(--bg); border-radius: 8px;">
              <p style="color: var(--text-dim); margin-bottom: 10px;">💡 Try accessing other user IDs:</p>
              <code style="display: block; color: var(--primary); margin-bottom: 5px;">Try ID: 1 (admin)</code>
              <code style="display: block; color: var(--primary); margin-bottom: 5px;">Try ID: 100 (another user)</code>
            </div>
          `
        },
        {
          id: 'ssrf',
          title: 'SSRF - URL Preview',
          url: 'http://vulnerable-app.local/api/preview',
          html: `
            <div class="input-group">
              <label>URL to preview:</label>
              <input type="text" id="ssrf-url" placeholder="https://example.com" value="https://example.com">
            </div>
            <button class="exploit-btn" onclick="testSSRF()">Fetch URL</button>
            <div id="ssrf-result" class="result-box"></div>
            <div style="margin-top: 20px; padding: 15px; background: var(--bg); border-radius: 8px;">
              <p style="color: var(--text-dim); margin-bottom: 10px;">💡 Try these internal targets:</p>
              <code style="display: block; color: var(--primary); margin-bottom: 5px;">http://localhost:8080/admin</code>
              <code style="display: block; color: var(--primary); margin-bottom: 5px;">http://169.254.169.254/latest/meta-data/</code>
              <code style="display: block; color: var(--primary);">http://192.168.1.1/</code>
            </div>
          `
        }
      ];

      document.getElementById('simulatorContent').innerHTML = simulators.map(sim => `
        <div class="vulnerable-app">
          <div class="app-header">
            <span class="app-title">${sim.title}</span>
            <span class="app-url">${sim.url}</span>
          </div>
          ${sim.html}
        </div>
      `).join('');
    }

    // Test SQL Injection
    function testSQLInjection() {
      const username = document.getElementById('sql-username').value;
      const password = document.getElementById('sql-password').value;
      const resultBox = document.getElementById('sql-result');

      appState.exploitsAttempted++;
      saveProgress();

      resultBox.classList.remove('success', 'error', 'exploited');
      resultBox.classList.add('show');

      // Check for SQL injection payloads
      const sqlPayloads = ["'--", "' OR '1'='1", "admin'--", "' OR 1=1--"];
      const isInjection = sqlPayloads.some(payload =>
        username.includes(payload) || password.includes(payload)
      );

      if (isInjection) {
        resultBox.classList.add('exploited');
        resultBox.innerHTML = `
          <h4 style="color: var(--warning); margin-bottom: 10px;">⚠️ SQL Injection Successful!</h4>
          <p style="color: var(--text-dim);">Bypassed authentication using SQL injection.</p>
          <p style="margin-top: 10px; color: var(--text);">Executed query:</p>
          <code style="display: block; background: var(--bg); padding: 10px; border-radius: 4px; margin-top: 5px;">
            SELECT * FROM users WHERE username='${username}' AND password='${password}'
          </code>
          <p style="margin-top: 10px; color: var(--success);">✓ Logged in as: ${username.split("'")[0] || 'admin'}</p>
        `;
        awardXP(10, 'Successfully performed SQL Injection');
      } else if (username === 'admin' && password === 'admin') {
        resultBox.classList.add('success');
        resultBox.innerHTML = `
          <h4 style="color: var(--success);">✓ Login Successful</h4>
          <p style="color: var(--text-dim);">Logged in with valid credentials.</p>
        `;
      } else {
        resultBox.classList.add('error');
        resultBox.innerHTML = `
          <h4 style="color: var(--accent);">✗ Login Failed</h4>
          <p style="color: var(--text-dim);">Invalid username or password.</p>
        `;
      }
    }

    // Test IDOR
    function testIDOR() {
      const userId = document.getElementById('idor-userid').value;
      const resultBox = document.getElementById('idor-result');

      appState.exploitsAttempted++;
      saveProgress();

      resultBox.classList.remove('success', 'error', 'exploited');
      resultBox.classList.add('show');

      const users = {
        1: {name: 'Admin User', email: 'admin@company.com', role: 'Administrator', ssn: '123-45-6789'},
        42: {name: 'John Doe', email: 'john@company.com', role: 'User', ssn: '987-65-4321'},
        100: {name: 'Jane Smith', email: 'jane@company.com', role: 'User', ssn: '555-12-3456'}
      };

      const user = users[userId];

      if (userId == 42) {
        resultBox.classList.add('success');
        resultBox.innerHTML = `
          <h4 style="color: var(--success);">✓ Authorized Access</h4>
          <p style="color: var(--text-dim);">Viewing your own profile.</p>
          <div style="margin-top: 10px; background: var(--bg); padding: 10px; border-radius: 4px;">
            <p><strong>Name:</strong> ${user.name}</p>
            <p><strong>Email:</strong> ${user.email}</p>
            <p><strong>Role:</strong> ${user.role}</p>
          </div>
        `;
      } else if (user) {
        resultBox.classList.add('exploited');
        resultBox.innerHTML = `
          <h4 style="color: var(--warning);">⚠️ IDOR Vulnerability Exploited!</h4>
          <p style="color: var(--text-dim);">Accessed another user's data without authorization!</p>
          <div style="margin-top: 10px; background: var(--bg); padding: 10px; border-radius: 4px;">
            <p><strong>Name:</strong> ${user.name}</p>
            <p><strong>Email:</strong> ${user.email}</p>
            <p><strong>Role:</strong> ${user.role}</p>
            <p><strong>SSN:</strong> ${user.ssn}</p>
          </div>
          <p style="margin-top: 10px; color: var(--success);">✓ Sensitive data exposed!</p>
        `;
        awardXP(10, 'Successfully exploited IDOR vulnerability');
      } else {
        resultBox.classList.add('error');
        resultBox.innerHTML = `
          <h4 style="color: var(--accent);">✗ User Not Found</h4>
          <p style="color: var(--text-dim);">No user exists with ID ${userId}.</p>
        `;
      }
    }

    // Test SSRF
    function testSSRF() {
      const url = document.getElementById('ssrf-url').value;
      const resultBox = document.getElementById('ssrf-result');

      appState.exploitsAttempted++;
      saveProgress();

      resultBox.classList.remove('success', 'error', 'exploited');
      resultBox.classList.add('show');

      const internalTargets = [
        'localhost', '127.0.0.1', '192.168.', '10.0.', '172.16.',
        '169.254.169.254', 'metadata', 'internal', 'admin'
      ];

      const isSSRF = internalTargets.some(target => url.toLowerCase().includes(target));

      if (isSSRF) {
        resultBox.classList.add('exploited');
        let content = '';

        if (url.includes('169.254.169.254')) {
          content = `
            <h4 style="color: var(--warning);">⚠️ SSRF Successful - AWS Metadata Accessed!</h4>
            <p style="color: var(--text-dim);">Accessed cloud metadata service!</p>
            <div style="margin-top: 10px; background: var(--bg); padding: 10px; border-radius: 4px; font-family: monospace; font-size: 0.9em;">
              <p>{</p>
              <p>&nbsp;&nbsp;"role": "web-server-role",</p>
              <p>&nbsp;&nbsp;"credentials": {</p>
              <p>&nbsp;&nbsp;&nbsp;&nbsp;"AccessKeyId": "AKIAIOSFODNN7EXAMPLE",</p>
              <p>&nbsp;&nbsp;&nbsp;&nbsp;"SecretAccessKey": "wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY"</p>
              <p>&nbsp;&nbsp;}</p>
              <p>}</p>
            </div>
            <p style="margin-top: 10px; color: var(--success);">✓ Cloud credentials exposed!</p>
          `;
        } else if (url.includes('admin')) {
          content = `
            <h4 style="color: var(--warning);">⚠️ SSRF Successful - Internal Admin Panel!</h4>
            <p style="color: var(--text-dim);">Accessed internal admin interface!</p>
            <div style="margin-top: 10px; background: var(--bg); padding: 10px; border-radius: 4px;">
              <p><strong>Admin Panel</strong></p>
              <p>Logged in users: 1,234</p>
              <p>Database: online</p>
              <p>Internal IP: 192.168.1.100</p>
            </div>
            <p style="margin-top: 10px; color: var(--success);">✓ Internal network access gained!</p>
          `;
        } else {
          content = `
            <h4 style="color: var(--warning);">⚠️ SSRF Successful - Internal Service!</h4>
            <p style="color: var(--text-dim);">Accessed internal network resource!</p>
            <div style="margin-top: 10px; background: var(--bg); padding: 10px; border-radius: 4px;">
              <p>Connected to: ${url}</p>
              <p>Status: 200 OK</p>
              <p>Service: Internal Database</p>
            </div>
            <p style="margin-top: 10px; color: var(--success);">✓ Internal service enumerated!</p>
          `;
        }

        resultBox.innerHTML = content;
        awardXP(10, 'Successfully performed SSRF attack');
      } else {
        resultBox.classList.add('success');
        resultBox.innerHTML = `
          <h4 style="color: var(--success);">✓ URL Fetched</h4>
          <p style="color: var(--text-dim);">Successfully fetched external URL.</p>
          <div style="margin-top: 10px; background: var(--bg); padding: 10px; border-radius: 4px;">
            <p><strong>URL:</strong> ${url}</p>
            <p><strong>Status:</strong> 200 OK</p>
            <p><strong>Content:</strong> Sample webpage content...</p>
          </div>
        `;
      }
    }

    // Render checklist
    function renderChecklist() {
      const container = document.getElementById('checklistContent');
      container.innerHTML = checklistData.map((cat, catIndex) => `
        <div class="checklist-category">
          <h3>${cat.category}</h3>
          ${cat.items.map((item, itemIndex) => {
            const key = `${catIndex}-${itemIndex}`;
            const checked = appState.checklistProgress[key] || false;
            return `
              <div class="checklist-item ${checked ? 'checked' : ''}"
                   onclick="toggleChecklistItem('${key}')">
                <div class="checkbox"></div>
                <span>${item}</span>
              </div>
            `;
          }).join('')}
        </div>
      `).join('');
    }

    // Toggle checklist item
    function toggleChecklistItem(key) {
      appState.checklistProgress[key] = !appState.checklistProgress[key];

      if (appState.checklistProgress[key]) {
        awardXP(1, 'Completed security checklist item');
      } else {
        appState.xpEarned = Math.max(0, appState.xpEarned - 1);
      }

      saveProgress();
      renderChecklist();
    }

    // Render quiz
    function renderQuiz() {
      document.getElementById('totalQuestions').textContent = quizQuestions.length;
      showQuizQuestion();
    }

    // Show quiz question
    function showQuizQuestion() {
      const qIndex = appState.currentQuizQuestion;
      const question = quizQuestions[qIndex];
      const userAnswer = appState.quizAnswers[qIndex];

      document.getElementById('currentQuestion').textContent = qIndex + 1;

      const progress = ((qIndex + 1) / quizQuestions.length) * 100;
      document.getElementById('quizProgressFill').style.width = progress + '%';
      document.getElementById('quizProgressFill').textContent = Math.round(progress) + '%';

      const container = document.getElementById('quizQuestions');
      container.innerHTML = `
        <div class="question-card">
          <div class="question-number">Question ${qIndex + 1} - ${question.category}</div>
          <div class="question-text">${question.question}</div>
          <div class="options">
            ${question.options.map((option, i) => {
              let className = 'option';
              if (userAnswer && appState.quizSubmitted) {
                if (i === question.correct) className += ' correct';
                else if (i === userAnswer.selected) className += ' incorrect';
              } else if (userAnswer && i === userAnswer.selected) {
                className += ' selected';
              }
              return `
                <div class="${className}" onclick="selectQuizOption(${i})">
                  <div class="option-letter">${String.fromCharCode(65 + i)}</div>
                  <span>${option}</span>
                </div>
              `;
            }).join('')}
          </div>
        </div>
      `;

      // Update button states
      document.getElementById('prevBtn').disabled = qIndex === 0;
      document.getElementById('nextBtn').classList.toggle('hidden', qIndex === quizQuestions.length - 1);
      document.getElementById('submitBtn').classList.toggle('hidden', qIndex !== quizQuestions.length - 1 || appState.quizSubmitted);
    }

    // Select quiz option
    function selectQuizOption(optionIndex) {
      if (appState.quizSubmitted) return;

      const qIndex = appState.currentQuizQuestion;
      const question = quizQuestions[qIndex];

      appState.quizAnswers[qIndex] = {
        selected: optionIndex,
        correct: optionIndex === question.correct
      };

      saveProgress();
      showQuizQuestion();
    }

    // Previous question
    function previousQuestion() {
      if (appState.currentQuizQuestion > 0) {
        appState.currentQuizQuestion--;
        showQuizQuestion();
      }
    }

    // Next question
    function nextQuestion() {
      if (appState.currentQuizQuestion < quizQuestions.length - 1) {
        appState.currentQuizQuestion++;
        showQuizQuestion();
      }
    }

    // Submit quiz
    function submitQuiz() {
      appState.quizSubmitted = true;

      const correctAnswers = appState.quizAnswers.filter(a => a && a.correct).length;
      const totalQuestions = quizQuestions.length;
      const percentage = Math.round((correctAnswers / totalQuestions) * 100);

      // Award XP based on performance
      let xp = 0;
      let message = '';

      if (percentage >= 90) {
        xp = 30;
        message = 'Outstanding! You\'re an OWASP expert!';
      } else if (percentage >= 75) {
        xp = 25;
        message = 'Great job! You have strong security knowledge!';
      } else if (percentage >= 60) {
        xp = 20;
        message = 'Good work! Keep studying to improve!';
      } else {
        xp = 10;
        message = 'Review the material and try again!';
      }

      awardXP(xp, `Completed quiz with ${percentage}% score`);
      saveProgress();

      document.getElementById('quizQuestions').classList.add('hidden');
      document.querySelector('.quiz-actions').classList.add('hidden');
      document.querySelector('.quiz-progress').classList.add('hidden');

      document.getElementById('quizResults').classList.remove('hidden');
      document.getElementById('quizResults').innerHTML = `
        <div class="quiz-results">
          <div class="results-score">${percentage}%</div>
          <div class="results-message">${message}</div>
          <div class="results-stats">
            <div class="stat-card">
              <div class="stat-label">Correct</div>
              <div class="stat-number">${correctAnswers}</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Incorrect</div>
              <div class="stat-number">${totalQuestions - correctAnswers}</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Score</div>
              <div class="stat-number">${percentage}%</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">XP Earned</div>
              <div class="stat-number">+${xp}</div>
            </div>
          </div>
          <button class="quiz-btn" onclick="reviewQuiz()">Review Answers</button>
          <button class="quiz-btn" onclick="retakeQuiz()" style="background: var(--accent);">Retake Quiz</button>
        </div>
      `;
    }

    // Review quiz
    function reviewQuiz() {
      document.getElementById('quizResults').classList.add('hidden');
      document.getElementById('quizQuestions').classList.remove('hidden');
      document.querySelector('.quiz-progress').classList.remove('hidden');
      appState.currentQuizQuestion = 0;
      showQuizQuestion();
    }

    // Retake quiz
    function retakeQuiz() {
      appState.quizAnswers = [];
      appState.currentQuizQuestion = 0;
      appState.quizSubmitted = false;

      document.getElementById('quizResults').classList.add('hidden');
      document.getElementById('quizQuestions').classList.remove('hidden');
      document.querySelector('.quiz-actions').classList.remove('hidden');
      document.querySelector('.quiz-progress').classList.remove('hidden');

      saveProgress();
      showQuizQuestion();
    }

    // Award XP
    function awardXP(amount, reason) {
      appState.xpEarned += amount;
      saveProgress();
      showAchievement(`+${amount} XP`, reason);

      // Integration with AchievementManager if available
      if (typeof window.AchievementManager !== 'undefined') {
        window.AchievementManager.addXP(amount);
      }

      // Integration with ModuleProgress if available
      if (typeof window.ModuleProgress !== 'undefined' && appState.xpEarned >= 85) {
        window.ModuleProgress.completeModule('owasp-top10-lab', 85);
      }
    }

    // Show achievement popup
    function showAchievement(title, text) {
      const popup = document.getElementById('achievementPopup');
      document.getElementById('achievementTitle').textContent = title;
      document.getElementById('achievementText').textContent = text;

      popup.classList.add('show');

      setTimeout(() => {
        popup.classList.remove('show');
      }, 3000);
    }

    // Return to vault
    function returnToVault() {
      if (confirm('Return to Dark Arts Vault? Your progress has been saved.')) {
        window.location.href = '../index.html';
      }
    }

    // Utility function
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Initialize on load
    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>